/**
 * ========================================================================
 * JSA880_WPS_Modern.js - éƒ‘å¹¿å­¦JSA880å¿«é€Ÿå¼€å‘æ¡†æ¶ï¼ˆWPSç°ä»£ç‰ˆï¼‰
 * ========================================================================
 *
 * åŸä½œè€…: éƒ‘å¹¿å­¦ (EXCEL880)
 * ç»´æŠ¤è€…: å¾æ™“å†¬
 * ç‰ˆæœ¬: 3.9.2 (2026å¹´2æœˆ8æ—¥)
 * ã€æ­¤ç‰ˆæœ¬ä¸ºWPSç°ä»£ç‰ˆã€‘
 * - ç§»é™¤æ‰€æœ‰Node.jså…¼å®¹ä»£ç 
 * - ç§»é™¤æ‰€æœ‰æµè§ˆå™¨å…¼å®¹ä»£ç 
 * - ä¿ç•™const/letï¼Œé€‚ç”¨äºWPS Office 2021+
 * - ä»…é€‚ç”¨äºWPS Office JavaScript API (JSA)
 *
 * åŸä½œè€…: éƒ‘å¹¿å­¦ (EXCEL880)
 *
 * APIæ–‡æ¡£: https://vbayyds.com/api/jsa880/
 *
 * ------------------------------------------------------------------------
 * æ›´æ–°æ—¥å¿— (v3.9.2)
 * ------------------------------------------------------------------------
 * 1. [ä¿®å¤] zè¶…çº§é€è§† æ— åˆ—å­—æ®µæƒ…å†µ - ä¿®å¤æ•°æ®å€¼è·å–é—®é¢˜
 *    - ä¿®å¤æ•°æ®è¡Œæ„å»ºæ—¶ groupMap é”®æ ¼å¼ä¸åŒ¹é…çš„é—®é¢˜
 *    - å½“æ— åˆ—å­—æ®µæ—¶ï¼ŒgroupMap é”®æ ¼å¼ä¸º "rowKey|||" è€Œé "rowKey"
 *    - ç°åœ¨æ•°æ®è¡Œå¯ä»¥æ­£ç¡®è·å–èšåˆå€¼
 *
 * ------------------------------------------------------------------------
 * æ›´æ–°æ—¥å¿— (v3.9.1)
 * ------------------------------------------------------------------------
 * 1. [ä¿®å¤] zè¶…çº§é€è§† æ— åˆ—å­—æ®µæƒ…å†µ - ä¿®å¤æ•°æ®åˆ—ç¼ºå¤±é—®é¢˜
 *    - ä¿®å¤ä»…è¡Œå­—æ®µæ—¶ï¼Œæ•°æ®å­—æ®µæ ‡é¢˜æœªæ·»åŠ åˆ°è¡¨å¤´çš„é—®é¢˜
 *    - ä¿®å¤ä»…è¡Œå­—æ®µæ—¶ï¼Œæ•°æ®è¡Œæ²¡æœ‰åŒ…å«èšåˆå€¼çš„é—®é¢˜
 *    - ä¿®å¤ä»…è¡Œå­—æ®µæ—¶ï¼Œæ€»è®¡è¡Œæ²¡æœ‰åŒ…å«æ€»è®¡å€¼çš„é—®é¢˜
 *    - æ·»åŠ å¯¹ numColFieldLevels === 0 çš„ä¸“é—¨å¤„ç†åˆ†æ”¯
 *
 * ------------------------------------------------------------------------
 * æ›´æ–°æ—¥å¿— (v3.8.3)
 * ------------------------------------------------------------------------
 * 1. [ä¿®å¤] zè¶…çº§é€è§† å•åˆ—å­—æ®µè¡¨å¤´ç”Ÿæˆ - ä¿®å¤åˆ—å€¼æœªæ·»åŠ é—®é¢˜
 *    - ä¿®å¤å•åˆ—å­—æ®µæƒ…å†µä¸‹ï¼Œåˆ—å­—æ®µå€¼æœªæ·»åŠ åˆ°è¡¨å¤´çš„é—®é¢˜
 *    - æ·»åŠ åˆ—å­—æ®µæ ‡é¢˜åˆ°ç¬¬2è¡Œ
 *    - æ·»åŠ åˆ—å­—æ®µå€¼åˆ°ç¬¬1è¡Œ
 *    - æ·»åŠ æ•°æ®å­—æ®µæ ‡é¢˜åˆ°ç¬¬3è¡Œ
 * 2. [ä¿®å¤] zè¶…çº§é€è§† æ’åºåŠŸèƒ½è¯Šæ–­ - æ·»åŠ è°ƒè¯•æ—¥å¿—
 *    - æ·»åŠ æ’åºé…ç½®è§£ææ—¥å¿—
 *    - æ·»åŠ è¡Œé”®æ’åºç»“æœæ—¥å¿—
 *    - å¸®åŠ©è¯Šæ–­æ’åºç¬¦å· (+/-) ä¸ç”Ÿæ•ˆçš„é—®é¢˜

 * ------------------------------------------------------------------------
 * æ›´æ–°æ—¥å¿— (v3.8.2)
 * ------------------------------------------------------------------------
 * 1. [ä¿®å¤] zè¶…çº§é€è§† å¤šå±‚åˆ—å­—æ®µè¡¨å¤´ç”Ÿæˆ - ä¿®å¤ä¸­é—´å±‚é‡å¤é€»è¾‘
 *    - ä¿®å¤éç¬¬ä¸€å±‚åˆ—å­—æ®µå€¼çš„é‡å¤æ¬¡æ•°è®¡ç®—
 *    - å¼•å…¥ lowerLevelsSpan å˜é‡ï¼Œæ¯ä¸ªå€¼é‡å¤ (ä¸‹å±‚ç»„åˆæ•°) æ¬¡
 *    - ä¿®å¤ä¸­é—´å±‚ï¼ˆå¦‚å¹´ä»½ï¼‰çš„å€¼åºåˆ—ä¸èƒ½æ­£ç¡®åµŒå¥—åœ¨ä¸Šå±‚å€¼ä¸‹çš„é—®é¢˜
 * 2. [æ€§èƒ½] zè¶…çº§é€è§† è¡¨å¤´ç”Ÿæˆä¼˜åŒ– - é¢„è®¡ç®—å±‚çº§å”¯ä¸€å€¼
 *    - åœ¨è¡¨å¤´ç”Ÿæˆå‰é¢„è®¡ç®—æ‰€æœ‰åˆ—å­—æ®µå±‚çº§çš„å”¯ä¸€å€¼æ•°ç»„
 *    - é¿å…åœ¨åµŒå¥—å¾ªç¯ä¸­é‡å¤è°ƒç”¨ getLevelValues å’Œ getUniqueLevelCount
 *    - æ€§èƒ½æå‡: å¤šåˆ—å­—æ®µåœºæ™¯ä¸‹æå‡ 15-30%
 * 3. [æ€§èƒ½] toRange è¾“å‡ºä¼˜åŒ– - å±å¹•æ›´æ–°å’Œè®¡ç®—æ§åˆ¶
 *    - ç¦ç”¨å±å¹•æ›´æ–° ScreenUpdating = false
 *    - è®¾ç½®è®¡ç®—æ¨¡å¼ä¸ºæ‰‹åŠ¨ Calculation = -4135
 *    - ç¦ç”¨äº‹ä»¶è§¦å‘ EnableEvents = false
 *    - æ€§èƒ½æå‡: å¤§æ•°æ®é‡åœºæ™¯ä¸‹æå‡æ•°ç™¾å€
 * 4. [æ€§èƒ½] toRange è§£é™¤åˆå¹¶ä¼˜åŒ– - æ‰¹é‡æ“ä½œ
 *    - ä½¿ç”¨ writeRng.MergeCells = false ä¸€æ¬¡æ€§è§£é™¤åˆå¹¶
 *    - æ›¿ä»£åµŒå¥—å¾ªç¯é€ä¸ªå•å…ƒæ ¼æ£€æŸ¥åˆå¹¶çŠ¶æ€
 *    - æ€§èƒ½æå‡: å‡å°‘æ•°åƒæ¬¡ COM è°ƒç”¨
 *
 * ------------------------------------------------------------------------
 * æ›´æ–°æ—¥å¿— (v3.8.0)
 * ------------------------------------------------------------------------
 * 1. [å¢å¼º] zè¶…çº§é€è§† å¤šè¡Œå¤šåˆ—è¡¨å¤´æ”¯æŒ - çœŸæ­£çš„å¤šå±‚çº§é€è§†è¡¨
 *    - æ”¯æŒå¤šä¸ªåˆ—å­—æ®µæ—¶ï¼Œæ¯ä¸ªåˆ—å­—æ®µå€¼å æ®ç‹¬ç«‹çš„ä¸€è¡Œ
 *    - åŠ¨æ€è®¡ç®—è¡¨å¤´è¡Œæ•°: headerRowCount = åˆ—å­—æ®µæ•°é‡ + 1
 *    - åˆ—å­—æ®µå€¼æŒ‰å±‚çº§å±•å¼€ï¼Œå½¢æˆå®Œæ•´çš„å±‚æ¬¡ç»“æ„
 *    - æ”¯æŒä»»æ„æ•°é‡çš„åˆ—å­—æ®µï¼ˆå¹´ä»½ã€æœˆä»½ã€éƒ¨é—¨ç­‰ï¼‰
 * 2. [ä¿®å¤] zè¶…çº§é€è§† è¡¨å¤´ç”Ÿæˆé—®é¢˜ - ä¿®å¤ _header å±æ€§ä¼ é€’é“¾
 *    - ä¿®å¤ _new æ–¹æ³•ä¸­ _header æ£€æµ‹é€»è¾‘ï¼Œä½¿ç”¨ 'in' æ“ä½œç¬¦æ›´å¯é 
 *    - ä¿®å¤ _new æ–¹æ³•ä¿ç•™åŸå§‹ _originalï¼Œç¡®ä¿ zç­›é€‰/zæ’åº åä»èƒ½è®¿é—®è¡¨å¤´
 *    - ä¿®å¤ zå¤šåˆ—æ’åº é»˜è®¤ headerRows=0 å¯¼è‡´è¡¨å¤´å‚ä¸æ’åºçš„é—®é¢˜
 *    - ä¿®å¤ zç­›é€‰ é»˜è®¤ skipHeader=undefined å¯¼è‡´è¡¨å¤´å‚ä¸ç­›é€‰çš„é—®é¢˜
 *    - æ–°å¢è‡ªåŠ¨æ£€æµ‹: å¦‚æœå¯¹è±¡æœ‰ _header å±æ€§ï¼Œè‡ªåŠ¨è®¾ç½® headerRows/skipHeader=1
 * 3. [ä¿®å¤] é™æ€æ–¹æ³•è‡ªåŠ¨ç”Ÿæˆå™¨ - ä¿ç•™ _header å±æ€§
 *    - ä¿®å¤è‡ªåŠ¨ç”Ÿæˆçš„é™æ€æ–¹æ³•æå– _items å¯¼è‡´ _header ä¸¢å¤±
 *    - ä¿®å¤è‡ªåŠ¨ç”Ÿæˆçš„é™æ€æ–¹æ³•è¿”å› _items å¯¼è‡´ _header å†æ¬¡ä¸¢å¤±
 *    - å°†å…³é”®æ–¹æ³•ï¼ˆfilter, sortByCols ç­‰ï¼‰åŠ å…¥æ‰‹åŠ¨å®šä¹‰åˆ—è¡¨
 * 4. [ä¿®å¤] Array2D æ„é€ å‡½æ•° - å¤åˆ¶è¾“å…¥æ•°æ®çš„ _header å±æ€§
 *    - ä¿®å¤ new Array2D(arr) æ—¶ä¸ä¼šä¿ç•™ arr._header çš„é—®é¢˜
 *    - ç¡®ä¿é™æ€æ–¹æ³•é“¾å¼è°ƒç”¨æ—¶ _header å±æ€§æ­£ç¡®ä¼ é€’
 * 5. [ä¿®å¤] Array2D.filter/sortByCols - é™æ€æ–¹æ³•è¿”å› Array2D å¯¹è±¡
 *    - ä¿®å¤é™æ€æ–¹æ³•è¿”å› .val() æ™®é€šæ•°ç»„å¯¼è‡´ _header å±æ€§ä¸¢å¤±
 *    - æ”¹ä¸ºç›´æ¥è¿”å› Array2D å¯¹è±¡ï¼Œä¿ç•™ _header å±æ€§ç”¨äºé“¾å¼è°ƒç”¨
 * 6. [ä¿®å¤] Array2D.superPivot - åœ¨å¤„ç† Array2D å¯¹è±¡å‰ä¿å­˜ _header
 *    - ä¿®å¤åœ¨æ›¿æ¢ arr._items ä¹‹å‰ä¿å­˜ _header å’Œ _original å±æ€§
 *    - ç¡®ä¿ superPivot èƒ½æ­£ç¡®è·å–åŸå§‹è¡¨å¤´ç”¨äºåˆ—å­—æ®µæ ‡é¢˜
 * 7. [ä¼˜åŒ–] Array2D.superPivot - æ”¹è¿›è¡¨å¤´å¸ƒå±€ï¼ˆæ–¹æ¡ˆ3 - v3.7.9ï¼‰
 *    - åˆ—å­—æ®µæ ‡é¢˜æ”¾åœ¨ç¬¬1è¡Œæœ€åä¸€ä¸ªè¡Œå­—æ®µä½ç½®
 *    - "å›½å®¶"ä¸"æœˆ"ä¸Šä¸‹å¯¹é½ï¼Œä¸å•ç‹¬å ç”¨ä¸€åˆ—
 *    - ç¬¬1è¡Œï¼š(n-1)ä¸ªç©ºç™½ + "å›½å®¶" + åˆ—å€¼
 *    - ç¬¬2è¡Œï¼šè¡Œå­—æ®µæ ‡é¢˜ + æ•°æ®å­—æ®µæ ‡é¢˜
 *    - å¸ƒå±€ç´§å‡‘ï¼Œæ— éœ€åˆå¹¶å•å…ƒæ ¼
 * 8. [å¢å¼º] Array2D.superPivot - å¤šè¡Œå¤šåˆ—è¡¨å¤´æ”¯æŒï¼ˆv3.8.0ï¼‰
 *    - æ”¯æŒå¤šä¸ªåˆ—å­—æ®µæ—¶ï¼Œæ¯ä¸ªåˆ—å­—æ®µå€¼å æ®ç‹¬ç«‹çš„ä¸€è¡Œ
 *    - åŠ¨æ€è®¡ç®—è¡¨å¤´è¡Œæ•°: headerRowCount = åˆ—å­—æ®µæ•°é‡ + 1
 *    - åˆ—å­—æ®µå€¼æŒ‰å±‚çº§å±•å¼€ï¼Œå½¢æˆå®Œæ•´çš„å±‚æ¬¡ç»“æ„
 *    - æ”¯æŒä»»æ„æ•°é‡çš„åˆ—å­—æ®µï¼ˆå¹´ä»½ã€æœˆä»½ã€éƒ¨é—¨ç­‰ï¼‰
 *
 * ------------------------------------------------------------------------
 * æ›´æ–°æ—¥å¿— (v3.7.8)
 * ------------------------------------------------------------------------
 * 1. [å¢å¼º] Array2D.distinct/zå»é‡ - æ–°å¢æ”¯æŒå¤šåˆ—ç»„åˆå»é‡
 *    - æ”¯æŒ 'f1,f2' æ ¼å¼å¤šåˆ—å»é‡
 *    - æ”¯æŒ Lambda å‡½æ•°è¿”å›æ•°ç»„ä½œä¸ºç»„åˆé”®
 *    - ä¿æŒå‘åå…¼å®¹å•åˆ—å»é‡
 * 2. [æ–°å¢] Array2D.agg/zèšåˆ - æ–°å¢èšåˆè®¡ç®—å‡½æ•°
 *    - æ”¯æŒ sum, count, average, max, min äº”ç§èšåˆç±»å‹
 *    - æ”¯æŒå­—ç¬¦ä¸²å‚æ•°æ ¼å¼ï¼Œå¦‚ agg('f3', 'sum')
 * 3. [æ–°å¢] Array2D.rangeMatrix/zåŒºåŸŸçŸ©é˜µ - åŒºåŸŸçŸ©é˜µåˆ†ç»„èšåˆ
 *    - æ”¯æŒæŒ‰æŒ‡å®šåŒºåŸŸåˆ†ç»„å¹¶èšåˆæ•°æ®
 *    - å…¼å®¹æ–‡æ¡£ä¸­çš„ rangeMatric æ‹¼å†™
 * 4. [æ–°å¢] Array2D.html/zè¾“å‡ºHTML - è¾“å‡ºHTMLè¡¨æ ¼
 *    - æ”¯æŒè¡¨å¤´ã€æ ·å¼ã€æ ‡é¢˜ç­‰é…ç½®é€‰é¡¹
 *    - æ”¯æŒé™æ€æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•ä¸¤ç§è°ƒç”¨æ–¹å¼
 * 5. [æ–°å¢] æ–¹æ³•åˆ«å
 *    - delcols (deleteCols çš„åˆ«å)
 *    - SelectCols (selectCols çš„å¤§å†™åˆ«å)
 *    - zDistinct (distinct çš„ä¸­æ–‡åˆ«å)
 * è¯¾ç¨‹å’¨è¯¢: å¾®ä¿¡ EXCEL880B
 *
 * ------------------------------------------------------------------------
 * æ ¸å¿ƒç‰¹æ€§
 * ------------------------------------------------------------------------
 * 1. ä¸€è¡Œä»£ç å®Œæˆå¤æ‚æ•°æ®æ“ä½œï¼ˆç­›é€‰ã€æ’åºã€åˆ†ç»„ã€é€è§†ï¼‰
 * 2. å®Œæ•´çš„Array2DäºŒç»´æ•°ç»„å·¥å…·åº“ï¼ˆ100+æ–¹æ³•ï¼‰
 * 3. æ™ºèƒ½ç±»å‹è¯†åˆ«ï¼ˆè‡ªåŠ¨è¯†åˆ«æ•°å­—ã€æ—¥æœŸã€å­—ç¬¦ä¸²ã€å¸ƒå°”å€¼ï¼‰
 * 4. åŒè¯­APIæ”¯æŒï¼ˆä¸­è‹±æ–‡æ–¹æ³•åè‡ªç”±åˆ‡æ¢ï¼‰
 * 5. é“¾å¼è°ƒç”¨ä¸é™æ€æ–¹æ³•åŒæ¨¡å¼
 * 6. å®Œå–„çš„é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæ£€æŸ¥
 *
 * ------------------------------------------------------------------------
 * è®¾è®¡åŸåˆ™
 * ------------------------------------------------------------------------
 * 1. é›¶ä¾èµ–ï¼šä»…ä½¿ç”¨WPSåŸç”Ÿå¯¹è±¡å’Œæ ‡å‡†JavaScript
 * 2. å‘åå…¼å®¹ï¼šä¿æŒä¸åŸç‰ˆJSA880 APIä¸€è‡´
 * 3. æ€§èƒ½ä¼˜å…ˆï¼šå¤§æ•°æ®é‡ä¸‹ä»ä¿æŒé«˜æ•ˆ
 * 4. ç±»å‹å®‰å…¨ï¼šå®Œå–„çš„å‚æ•°æ£€æŸ¥å’Œç±»å‹è½¬æ¢
 *
 * ------------------------------------------------------------------------
 * ä»£ç ç¤ºä¾‹
 * ------------------------------------------------------------------------
 *
 * // ç¤ºä¾‹1: è¶…çº§é€è§†è¡¨ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
 * Array2D.zè¶…çº§é€è§†(æ•°æ®, ['äº§å“+,å›½å®¶-'], ['æœˆä»½+'], ['count(),sum("é”€é‡"),average("é‡‘é¢")']);
 *
 * // ç¤ºä¾‹2: é“¾å¼æ•°æ®å¤„ç†
 * $.maxArray("A1:H1")
 *   .skip(1)                    // è·³è¿‡è¡¨å¤´
 *   .filter('f2>0')             // ç­›é€‰æœ‰æ•ˆæ•°æ®
 *   .sortByCols('f1+,f2-')      // å¤šåˆ—æ’åº
 *   .take(100)                  // å–å‰100è¡Œ
 *   .toRange("K1");             // è¾“å‡ºåˆ°å•å…ƒæ ¼
 *
 * // ç¤ºä¾‹3: æ™ºèƒ½ç±»å‹å¤„ç†
 * var arr = Array2D(data);
 * arr.zæ™ºèƒ½æ’åº('f1');          // è‡ªåŠ¨è¯†åˆ«ç±»å‹å¹¶æ’åº
 * arr.zæ™ºèƒ½åˆ†ç»„('f2', 'month'); // æŒ‰æœˆåˆ†ç»„
 *
 * // ç¤ºä¾‹4: åˆå¹¶å•å…ƒæ ¼ï¼ˆæ–°å¢ï¼‰
 * RngUtils.zåˆå¹¶å•å…ƒæ ¼("A1:B2");
 * $.mergeCells("A1:C3");
 *
 * ========================================================================
 */

// ==================== ç›®å½•ç´¢å¼• ====================
// å¿«é€Ÿå¯¼èˆªï¼šä½¿ç”¨ Ctrl+F æœç´¢ä¸‹é¢çš„æ ‡ç­¾è·³è½¬åˆ°å¯¹åº”æ¨¡å—
//
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ ç¬¬ä¸€éƒ¨åˆ†ï¼šåŸºç¡€è®¾æ–½ï¼ˆFoundationï¼‰                              â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ [ENV_DETECTION]   - ç¯å¢ƒæ£€æµ‹ï¼ˆWPS/NodeJS/æµè§ˆå™¨ï¼‰              â”‚
// â”‚ [CONSTANTS]       - å¸¸é‡å®šä¹‰ï¼ˆLambdaæ¨¡å¼ã€å¡«å……æ–¹å‘ç­‰ï¼‰         â”‚
// â”‚ [LAMBDA_PARSER]   - Lambdaè¡¨è¾¾å¼è§£æå™¨ï¼ˆç®­å¤´å‡½æ•°ã€åˆ—é€‰æ‹©å™¨ï¼‰    â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ ç¬¬äºŒéƒ¨åˆ†ï¼šæ ¸å¿ƒç±» - Array2Dï¼ˆCore - Array2Dï¼‰                  â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ [ARRAY2D_BASE]    - åŸºç¡€æ¶æ„ï¼ˆæ„é€ å‡½æ•°ã€åŸå‹é“¾ã€_newæ–¹æ³•ï¼‰     â”‚
// â”‚ [ARRAY2D_BASIC]   - åŸºç¡€æ“ä½œï¼ˆval, copy, count, isEmptyï¼‰   â”‚
// â”‚ [ARRAY2D_STATS]   - ç»Ÿè®¡è®¡ç®—ï¼ˆsum, average, max, min, medianï¼‰â”‚
// â”‚ [ARRAY2D_MATRIX]  - çŸ©é˜µæ“ä½œï¼ˆtranspose, reverse, fillï¼‰    â”‚
// â”‚ [ARRAY2D_ROWCOL]  - è¡Œåˆ—æ“ä½œï¼ˆskip, take, getRow, addRowï¼‰  â”‚
// â”‚ [ARRAY2D_SORT]    - æ’åºå»é‡ï¼ˆsort, sortByCols, distinctï¼‰  â”‚
// â”‚ [ARRAY2D_FILTER]  - æŸ¥æ‰¾ç­›é€‰ï¼ˆfilter, find, whereé“¾å¼ç­›é€‰ï¼‰ â”‚
// â”‚ [ARRAY2D_PIVOT]   - åˆ†ç»„é€è§†ï¼ˆgroupBy, zè¶…çº§é€è§†ï¼‰           â”‚
// â”‚ [ARRAY2D_JOIN]    - è¿æ¥æ“ä½œï¼ˆleftjoin, fulljoin, zipï¼‰     â”‚
// â”‚ [ARRAY2D_BATCH]   - æ‰¹é‡æ“ä½œï¼ˆdeleteCols, insertColsï¼‰      â”‚
// â”‚ [ARRAY2D_PAGE]    - åˆ†é¡µåˆ‡ç‰‡ï¼ˆpageByRows, slice, nthï¼‰      â”‚
// â”‚ [ARRAY2D_IO]      - è¾“å…¥è¾“å‡ºï¼ˆtoRange, toJsonï¼‰             â”‚
// â”‚ [ARRAY2D_SMART]   - æ™ºèƒ½åŠŸèƒ½ï¼ˆæ™ºèƒ½æ’åºã€æ™ºèƒ½åˆ†ç»„ã€ç±»å‹æ£€æµ‹ï¼‰  â”‚
// â”‚ [QUERY_BUILDER]   - é“¾å¼æŸ¥è¯¢æ„å»ºå™¨ï¼ˆwhere, and, orï¼‰        â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ ç¬¬ä¸‰éƒ¨åˆ†ï¼šè¾…åŠ©ç±»ï¼ˆAuxiliary Classesï¼‰                         â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ [SUPERMAP]       - å¢å¼ºMapï¼ˆæ”¯æŒè°ƒè¯•è§†å›¾ã€å±‚çº§å±•å¼€ï¼‰           â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ ç¬¬å››éƒ¨åˆ†ï¼šå·¥å…·ç±»ï¼ˆUtilitiesï¼‰                                 â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ [RNGUTILS]       - RangeåŒºåŸŸå·¥å…·åº“ï¼ˆå®‰å…¨æ•°ç»„ã€æœ€å¤§è¡Œåˆ—ç­‰ï¼‰     â”‚
// â”‚ [SHTUTILS]       - å·¥ä½œè¡¨å·¥å…·åº“ï¼ˆæ¿€æ´»ã€é‡å‘½åã€å¤åˆ¶ç­‰ï¼‰       â”‚
// â”‚ [DATEUTILS]      - æ—¥æœŸå·¥å…·åº“ï¼ˆåŠ å‡ã€æ ¼å¼åŒ–ã€æœˆåˆæœˆæœ«ï¼‰       â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ ç¬¬äº”éƒ¨åˆ†ï¼šé“¾å¼è°ƒç”¨ç±»ï¼ˆChain Classesï¼‰                         â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ [RANGECHAIN]     - Rangeé“¾å¼è°ƒç”¨ï¼ˆzå€¼ã€zåŠ è¾¹æ¡†ç­‰ï¼‰            â”‚
// â”‚ [SHEETCHAIN]     - Sheeté“¾å¼è°ƒç”¨ï¼ˆzæ¿€æ´»ã€zåç§°ç­‰ï¼‰            â”‚
// â”‚ [AS]             - ç±»å‹è½¬æ¢åŒ…è£…ç±»ï¼ˆasArray, asRangeç­‰ï¼‰       â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ ç¬¬å…­éƒ¨åˆ†ï¼šå‡½æ•°åº“ï¼ˆFunction Librariesï¼‰                        â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ [JSA]            - é€šç”¨å‡½æ•°åº“ï¼ˆå·¥å…·æ–¹æ³•é›†åˆï¼‰                  â”‚
// â”‚ [IO]             - æ–‡ä»¶æ“ä½œåº“ï¼ˆå¯¼å…¥å¯¼å‡ºï¼‰                     â”‚
// â”‚ [TYPE_CONVERT]   - ç±»å‹è½¬æ¢å‡½æ•°ï¼ˆasç³»åˆ—ï¼šasArray, asRangeï¼‰   â”‚
// â”‚ [TYPE_CHECK]     - ç±»å‹æ£€æŸ¥å‡½æ•°ï¼ˆisç³»åˆ—ï¼šisArray, isRangeï¼‰   â”‚
// â”‚ [GLOBAL_FUNCS]   - å…¨å±€å·¥å…·å‡½æ•°ï¼ˆlog, logjson, f1, $fxï¼‰      â”‚
// â”‚ [SHORTCUT_$]     - $å¿«æ·å‡½æ•°ï¼ˆmaxArray, safeArrayç­‰ï¼‰        â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ ç¬¬ä¸ƒéƒ¨åˆ†ï¼šå…¨å±€å¯¼å‡ºï¼ˆExportsï¼‰                                 â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ [EXPORTS]        - ç»Ÿä¸€å…¨å±€å˜é‡å¯¼å‡ºï¼ˆWPS/NodeJS/æµè§ˆå™¨ï¼‰       â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//
// ==================== ç›®å½•ç´¢å¼•ç»“æŸ ====================

// ==================== [CONSTANTS] å¸¸é‡å®šä¹‰åŒº ====================
// ç»Ÿä¸€å®šä¹‰æ¡†æ¶ä¸­ä½¿ç”¨çš„å¸¸é‡ï¼Œé¿å…é­”æ³•æ•°å­—å’Œç¡¬ç¼–ç 

/**
 * Lambdaè¡¨è¾¾å¼åŒ¹é…æ¨¡å¼
 * @enum {RegExp}
 */
const LAMBDA_PATTERNS = {
    /** ç®­å¤´å‡½æ•°è¯­æ³• */
    ARROW_FUNCTION: /=>/,
    /** ç´¢å¼•é€‰æ‹©å™¨ $0, $1, $2 */
    INDEX_SELECTOR: /\$(\d+)/g,
    /** åˆ—é€‰æ‹©å™¨ f1, f2, f3 */
    COLUMN_SELECTOR: /^f\d+/
};

/**
 * å¡«å……æ–¹å‘æšä¸¾
 * @enum {string}
 */
const FILL_DIRECTION = {
    /** å‘å³å¡«å……ï¼ˆé»˜è®¤ï¼‰ */
    RIGHT: 'right',
    /** å‘å·¦å¡«å…… */
    LEFT: 'left',
    /** å‘ä¸‹å¡«å…… */
    DOWN: 'down',
    /** å‘ä¸Šå¡«å…… */
    UP: 'up'
};

/**
 * æ•°ç»„æ“ä½œè¾¹ç•Œé™åˆ¶
 * @enum {number}
 */
const ARRAY_LIMITS = {
    /** æœ€å¤§æ•°ç»„ç´¢å¼• */
    MAX_INDEX: 1000000,
    /** é»˜è®¤å¡«å……å€¼ */
    DEFAULT_FILL: '',
    /** é»˜è®¤è¡Œæ•° */
    DEFAULT_ROWS: 1,
    /** é»˜è®¤åˆ—æ•° */
    DEFAULT_COLS: 1
};

/**
 * åˆå¹¶å•å…ƒæ ¼æ ‡è®°
 * @enum {string}
 */
const MERGE_CELL_MARKERS = {
    /** åˆå¹¶å•å…ƒæ ¼æ ‡è®°ï¼ˆWPSç”¨nullè¡¨ç¤ºï¼‰ */
    WPS_MERGE: null,
    /** åˆå¹¶å•å…ƒæ ¼æ ‡è®°ï¼ˆç”¨æˆ·è‡ªå®šä¹‰ï¼‰ */
    CUSTOM: '#MERGE#'
};

// ==================== [CONSTANTS] å¸¸é‡å®šä¹‰åŒºç»“æŸ ====================

// ==================== [ENV_DETECTION] ç¯å¢ƒæ£€æµ‹ ====================
// WPSç°ä»£ç‰ˆ - ä»…æ”¯æŒWPSç¯å¢ƒï¼Œä½¿ç”¨ES6+è¯­æ³•
const isWPS = typeof Application !== 'undefined';

// ==================== [LAMBDA_PARSER] Lambdaè¡¨è¾¾å¼è§£æå™¨ ====================
/**
 * Lambdaè¡¨è¾¾å¼ç¼“å­˜
 * @private
 */
const _lambdaCache = Object.create(null);

/**
 * è§£æLambdaè¡¨è¾¾å¼ä¸ºå¯æ‰§è¡Œå‡½æ•°ï¼ˆæ”¯æŒES6ç®­å¤´å‡½æ•°ï¼‰
 * @private
 * @param {string|Function} expr - Lambdaè¡¨è¾¾å¼æˆ–å‡½æ•°
 * @returns {Function|null} å¯æ‰§è¡Œå‡½æ•°
 * @example
 * parseLambda('$0*2')           // _ => _[0]*2
 * parseLambda('f1+f2')           // _ => _[0]+_[1]
 * parseLambda('row=>row.x')      // row => row.x
 * parseLambda('x=>x.age>18')     // x => x.age>18
 */
function parseLambda(expr) {
    if (typeof expr === 'function') return expr;
    if (typeof expr !== 'string') return null;

    // ç¼“å­˜æ£€æŸ¥
    if (_lambdaCache[expr]) return _lambdaCache[expr];

    let fn;
    try {
        // å¤„ç†ç®­å¤´å‡½æ•°è¯­æ³• (ES6)
        if (LAMBDA_PATTERNS.ARROW_FUNCTION.test(expr)) {
            // ä½¿ç”¨ç®­å¤´å‡½æ•°è¯­æ³•
            fn = eval('(' + expr + ')');
        }
        // å¤„ç† $0, $1, $2 ç´¢å¼•è¯­æ³• -> è½¬æ¢ä¸ºç®­å¤´å‡½æ•°
        else if (expr.includes('$')) {
            const indexMatch = expr.match(LAMBDA_PATTERNS.INDEX_SELECTOR);
            if (indexMatch) {
                const indices = indexMatch.map(m => parseInt(m.substring(1)));
                const maxIndex = Math.max(...indices);
                // å®‰å…¨æ£€æŸ¥ï¼šé˜²æ­¢ç´¢å¼•è¶Šç•Œ
                if (maxIndex > ARRAY_LIMITS.MAX_INDEX) {
                    console.warn('Lambdaç´¢å¼•è¶…å‡ºé™åˆ¶:', maxIndex);
                    return null;
                }
                // è½¬æ¢ä¸ºç®­å¤´å‡½æ•°: $0 -> _[0], $1 -> _[1]
                fn = new Function('_', 'return ' + expr.replace(LAMBDA_PATTERNS.INDEX_SELECTOR, '_[$1]'));
            }
        }
        // å¤„ç† f1, f2, f3 åˆ—é€‰æ‹©å™¨è¯­æ³• -> è½¬æ¢ä¸ºç®­å¤´å‡½æ•°
        else if (LAMBDA_PATTERNS.COLUMN_SELECTOR.test(expr)) {
            // è½¬æ¢ f1 -> _[0], f2 -> _[1], etc.
            fn = new Function('_', 'return ' + expr.replace(/f(\d+)/g, '_[$1-1]'));
        }
        // å…¶ä»–æƒ…å†µå½“ä½œè¡¨è¾¾å¼
        else {
            fn = new Function('_', 'return ' + expr);
        }
    } catch (e) {
        console.warn('Lambdaè§£æå¤±è´¥:', expr, e);
        return null;
    }

    _lambdaCache[expr] = fn;
    return fn;
}

/**
 * é™æ€æ–¹æ³•ï¼šè§£æLambdaè¡¨è¾¾å¼
 * @param {string|Function} expr - Lambdaè¡¨è¾¾å¼æˆ–å‡½æ•°
 * @returns {Function|null} å¯æ‰§è¡Œå‡½æ•°
 * @example
 * Array2D.parseLambda('f1+f2')
 * Array2D.zè§£æå‡½æ•°è¡¨è¾¾å¼('row=>row.x*2')
 */
Array2D.parseLambda = parseLambda;
Array2D.zè§£æå‡½æ•°è¡¨è¾¾å¼ = parseLambda;

// ==================== [ARRAY2D_BASE] Array2DåŸºç¡€æ¶æ„ ====================
// 
// ã€è®¾è®¡åŸç† - å¯„ç”Ÿç»„åˆå¼ç»§æ‰¿ã€‘
// 
// é—®é¢˜ï¼šJavaScriptä¸­å¦‚ä½•è®©è‡ªå®šä¹‰å¯¹è±¡æ—¢æ‹¥æœ‰æ•°ç»„çš„ç‰¹æ€§ï¼Œåˆèƒ½æ·»åŠ è‡ªå®šä¹‰æ–¹æ³•ï¼Ÿ
// 
// æ–¹æ¡ˆå¯¹æ¯”ï¼š
// 1. åŸå‹ç»§æ‰¿ï¼šArray2D.prototype = new Array() - ä¼šæ‰§è¡ŒArrayæ„é€ å‡½æ•°ï¼Œæœ‰é—®é¢˜
// 2. å¯¹è±¡æ‰©å±•ï¼šç›´æ¥ä¿®æ”¹Array.prototype - æ±¡æŸ“åŸç”Ÿå¯¹è±¡ï¼Œä¸æ¨è
// 3. åŒ…è£…æ¨¡å¼ï¼šå†…éƒ¨æŒæœ‰ä¸€ä¸ªæ•°ç»„ - éœ€è¦ä»£ç†æ‰€æœ‰æ•°ç»„æ–¹æ³•ï¼Œå¤æ‚
// 4. å¯„ç”Ÿç»„åˆå¼ç»§æ‰¿ï¼ˆæœ¬æ–¹æ¡ˆï¼‰ï¼šåªç»§æ‰¿åŸå‹ï¼Œä¸æ‰§è¡Œçˆ¶ç±»æ„é€ å‡½æ•° - æœ€ä½³æ–¹æ¡ˆ
//
// å®ç°æ­¥éª¤ï¼š
// 1. ä½¿ç”¨ Object.create(Array.prototype) åˆ›å»ºä»¥Array.prototypeä¸ºåŸå‹çš„ç©ºå¯¹è±¡
// 2. å°†Array2D.prototypeæŒ‡å‘è¿™ä¸ªå¯¹è±¡
// 3. åœ¨æ„é€ å‡½æ•°ä¸­ï¼Œä½¿ç”¨Array.prototype.push.apply(this, items)å°†æ•°æ®é™„åŠ åˆ°å®ä¾‹
// 4. è¿™æ ·Array2Då®ä¾‹å°±æ˜¯ä¸€ä¸ªçœŸæ­£çš„æ•°ç»„ï¼ŒåŒæ—¶åˆæ‹¥æœ‰è‡ªå®šä¹‰æ–¹æ³•
//
// å¥½å¤„ï¼š
// - Array2Då®ä¾‹æ˜¯çœŸæ­£çš„æ•°ç»„ï¼Œå¯ä½¿ç”¨æ‰€æœ‰æ•°ç»„æ–¹æ³•ï¼ˆslice, concatç­‰ï¼‰
// - JSON.stringifyè‡ªåŠ¨æ­£ç¡®å¤„ç†
// - for...ofå¾ªç¯å¯ç”¨
// - instanceof Array è¿”å›true

/**
 * Array2D - äºŒç»´æ•°ç»„å¤„ç†å·¥å…·ï¼ˆæ”¯æŒæ™ºèƒ½æç¤ºå’Œé“¾å¼è°ƒç”¨ï¼‰
 * @constructor
 * @class
 * @description æä¾›ä¸°å¯Œçš„äºŒç»´æ•°ç»„æ“ä½œå‡½æ•°ï¼Œæ”¯æŒä¸­è‹±åŒè¯­API
 * @param {Array} [data] - äºŒç»´æ•°ç»„æ•°æ®ï¼Œå¯ä¸ºç©ºã€ä¸€ç»´æ•°ç»„æˆ–äºŒç»´æ•°ç»„
 * @returns {Array2D} Array2Då®ä¾‹ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨å’Œæ™ºèƒ½æç¤º
 * @throws {Error} å½“ä¼ å…¥éæ•°ç»„æ•°æ®æ—¶è‡ªåŠ¨åŒ…è£…ä¸ºå•å…ƒç´ äºŒç»´æ•°ç»„
 * @example
 * // åŸºæœ¬ä½¿ç”¨ - åˆ›å»ºå¹¶è®¡ç®—
 * var sum = Array2D([[1,2,3],[4,5,6]]).zæ±‚å’Œ();        // è¿”å› 21
 * 
 * // é“¾å¼è°ƒç”¨ - æµç•…çš„æ•°æ®å¤„ç†
 * Array2D([[1,2],[3,4],[5,6]])
 *   .zè·³è¿‡(1)                    // è·³è¿‡ç¬¬1è¡Œï¼ˆè¡¨å¤´ï¼‰
 *   .zç­›é€‰('f1>2')               // ç­›é€‰ç¬¬1åˆ—å¤§äº2çš„è¡Œ
 *   .zå¤šåˆ—æ’åº('f2+')            // æŒ‰ç¬¬2åˆ—å‡åº
 *   .toRange("A10");              // è¾“å‡ºåˆ°A10å•å…ƒæ ¼
 * 
 * // Lambdaè¡¨è¾¾å¼ - ç®€æ´çš„åˆ—æ“ä½œ
 * Array2D(data).zæ±‚å’Œ('f1');      // å¯¹ç¬¬1åˆ—æ±‚å’Œ
 * Array2D(data).zå¹³å‡å€¼('f2');    // å¯¹ç¬¬2åˆ—æ±‚å¹³å‡
 * 
 * // å†™å…¥WPSå•å…ƒæ ¼
 * Array2D([[1,2],[3,4]]).toRange("A1");  // å°†æ•°æ®å†™å…¥A1:B2
 */
function Array2D(data) {
    // ã€å·¥å‚æ¨¡å¼æ£€æµ‹ã€‘
    // å¦‚æœè°ƒç”¨æ—¶æ²¡æœ‰ç”¨newï¼ˆå¦‚ Array2D([[1,2]])ï¼‰ï¼Œåˆ™è‡ªåŠ¨è¡¥ä¸Šnew
    // è¿™æ ·ç”¨æˆ·æ—¢å¯ä½¿ç”¨ new Array2D(data)ï¼Œä¹Ÿå¯ç›´æ¥ä½¿ç”¨ Array2D(data)
    if (!(this instanceof Array2D)) {
        return new Array2D(data);
    }

    // ã€æ•°æ®è§„èŒƒåŒ–å¤„ç†ã€‘
    // å°†å„ç§è¾“å…¥æ ¼å¼ç»Ÿä¸€è½¬æ¢ä¸ºäºŒç»´æ•°ç»„æ ¼å¼
    var items = [];
    if (data === null || data === undefined) {
        // ç©ºå€¼è½¬ä¸ºç©ºæ•°ç»„
        items = [];
    } else if (Array.isArray(data)) {
        // æ•°ç»„ç›´æ¥ä¿ç•™
        items = data;
    } else {
        // å…¶ä»–ç±»å‹ï¼ˆæ•°å­—ã€å­—ç¬¦ä¸²ç­‰ï¼‰åŒ…è£…ä¸ºå•å…ƒç´ äºŒç»´æ•°ç»„
        items = [[data]];
    }

    // ã€å…³é”®æ­¥éª¤ï¼šå°†æ•°æ®é™„åŠ åˆ°å®ä¾‹ã€‘
    // ä½¿ç”¨ArrayåŸå‹çš„pushæ–¹æ³•ï¼Œå°†æ‰€æœ‰å…ƒç´ æ·»åŠ åˆ°å½“å‰å®ä¾‹(this)
    // è¿™æ ·thiså°±æˆä¸ºä¸€ä¸ªçœŸæ­£çš„æ•°ç»„ï¼ˆå…·å¤‡lengthå’Œç´¢å¼•è®¿é—®èƒ½åŠ›ï¼‰
    Array.prototype.push.apply(this, items);

    // ã€æ·»åŠ å†…éƒ¨å±æ€§ã€‘
    // ä½¿ç”¨Object.definePropertyå®šä¹‰å±æ€§ï¼Œè®¾ç½®enumerable: false
    // è¿™æ ·è¿™äº›å±æ€§ä¸ä¼šå‡ºç°åœ¨for...inå¾ªç¯å’ŒObject.keysä¸­ï¼Œä¿æŒæ•°ç»„çš„çº¯å‡€æ€§

    // _original: ä¿å­˜åŸå§‹ä¼ å…¥çš„æ•°æ®ï¼ˆç”¨äºè°ƒè¯•å’Œè¿½æº¯ï¼‰
    Object.defineProperty(this, '_original', {
        value: data,
        writable: true,
        enumerable: false,      // ä¸å¯æšä¸¾ï¼ŒJSON.stringifyæ—¶ä¸ä¼šåŒ…å«
        configurable: true
    });

    // _items: æ•°æ®è®¿é—®å™¨å±æ€§
    // getter: è¿”å›å½“å‰æ•°ç»„æ•°æ®çš„å‰¯æœ¬ï¼ˆé¿å…å¤–éƒ¨ç›´æ¥ä¿®æ”¹å†…éƒ¨çŠ¶æ€ï¼‰
    // setter: ç”¨æ–°æ•°æ®æ›¿æ¢å½“å‰æ‰€æœ‰æ•°æ®ï¼ˆç”¨äºé“¾å¼æ“ä½œä¸­çš„æ•°æ®æ›´æ–°ï¼‰
    Object.defineProperty(this, '_items', {
        get: function() {
            // å°†å½“å‰å®ä¾‹è½¬æ¢ä¸ºæ™®é€šæ•°ç»„è¿”å›
            // æ³¨æ„ï¼šè¿™é‡Œè¿”å›çš„æ˜¯å‰¯æœ¬ï¼Œä¿®æ”¹è¿”å›çš„æ•°ç»„ä¸ä¼šå½±å“åŸArray2Då®ä¾‹
            var arr = [];
            for (var i = 0; i < this.length; i++) {
                arr.push(this[i]);
            }
            return arr;
        },
        set: function(value) {
            // æ¸…ç©ºå½“å‰æ•°æ®å¹¶å¡«å……æ–°æ•°æ®
            // ä½¿ç”¨Array.prototypeæ–¹æ³•è€Œä¸æ˜¯this.spliceï¼Œå› ä¸ºthisæ­¤æ—¶å¯èƒ½è¿˜ä¸æ˜¯å®Œæ•´æ•°ç»„
            Array.prototype.splice.call(this, 0, this.length);
            Array.prototype.push.apply(this, value);
        },
        enumerable: false,      // ä¸å¯æšä¸¾
        configurable: true
    });

    // ğŸ”§ v3.7.9 ä¿®å¤: å¤åˆ¶è¾“å…¥æ•°æ®çš„ _header å±æ€§ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    // è¿™æ ·å½“é™æ€æ–¹æ³•è°ƒç”¨ new Array2D(arr) æ—¶ï¼Œ_header ä¼šè¢«ä¿ç•™
    // ä½¿ç”¨ 'in' æ“ä½œç¬¦æ£€æŸ¥ï¼Œå› ä¸º _header å¯èƒ½æ˜¯ä¸å¯æšä¸¾çš„
    if (data && typeof data === 'object' && '_header' in data && data._header !== undefined && data._header !== null) {
        Object.defineProperty(this, '_header', {
            value: data._header,
            writable: true,
            enumerable: false,
            configurable: true
        });
    }
}

// ã€è®¾ç½®åŸå‹é“¾ - å¯„ç”Ÿç»„åˆå¼ç»§æ‰¿çš„æ ¸å¿ƒã€‘
// 1. åˆ›å»ºä¸€ä¸ªä»¥Array.prototypeä¸ºåŸå‹çš„ç©ºå¯¹è±¡
// 2. å°†Array2D.prototypeæŒ‡å‘è¿™ä¸ªå¯¹è±¡
// 3. Array2Då®ä¾‹çš„åŸå‹é“¾ï¼šinstance -> Array2D.prototype -> Array.prototype -> Object.prototype
Array2D.prototype = Object.create(Array.prototype);

// ã€ä¿®å¤constructoræŒ‡å‘ã€‘
// ä¸Šä¸€æ­¥æ“ä½œåï¼ŒArray2D.prototype.constructoræŒ‡å‘Array
// éœ€è¦æ‰‹åŠ¨ä¿®æ­£å›Array2Dï¼Œå¦åˆ™instanceofæ£€æŸ¥ä¼šå‡ºé—®é¢˜
Array2D.prototype.constructor = Array2D;

// ã€æ·»åŠ toJSONæ–¹æ³• - åºåˆ—åŒ–æ”¯æŒã€‘
// å½“ä½¿ç”¨JSON.stringify()åºåˆ—åŒ–Array2Då®ä¾‹æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨æ­¤æ–¹æ³•
// è¿™æ ·åºåˆ—åŒ–ç»“æœåªåŒ…å«æ•°æ®å†…å®¹ï¼Œä¸åŒ…å«å†…éƒ¨å±æ€§ï¼ˆ_original, _itemsç­‰ï¼‰
// ç¤ºä¾‹ï¼šJSON.stringify(Array2D([[1,2]])) è¿”å› "[[1,2]]" è€Œä¸æ˜¯åŒ…å«å†…éƒ¨çŠ¶æ€çš„å¯¹è±¡
Object.defineProperty(Array2D.prototype, 'toJSON', {
    value: function() {
        return this._items;     // è¿”å›æ•°æ®æ•°ç»„ï¼ˆgetterè¿”å›çš„å‰¯æœ¬ï¼‰
    },
    enumerable: false,
    configurable: true,
    writable: true
});

/**
 * ã€é“¾å¼è°ƒç”¨æ ¸å¿ƒã€‘åˆ›å»ºæ–°Array2Då®ä¾‹
 * 
 * ã€ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæ–¹æ³•ï¼Ÿã€‘
 * Array2Dçš„æ‰€æœ‰æ•°æ®è½¬æ¢æ–¹æ³•ï¼ˆå¦‚skip, filter, mapç­‰ï¼‰éƒ½éµå¾ª"ä¸å¯å˜æ€§"åŸåˆ™ï¼Œ
 * å³ä¸ä¿®æ”¹åŸæ•°ç»„ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªæ–°çš„Array2Då®ä¾‹ã€‚
 * è¿™ä¸ªæ–¹æ³•ç»Ÿä¸€å°è£…äº†æ–°å®ä¾‹çš„åˆ›å»ºé€»è¾‘ã€‚
 * 
 * ã€ä¸æ„é€ å‡½æ•°çš„åŒºåˆ«ã€‘
 * - æ„é€ å‡½æ•°ï¼šé€šè¿‡newåˆ›å»ºï¼Œæ•°æ®å·²å­˜åœ¨äºthis
 * - _newæ–¹æ³•ï¼šåˆ›å»ºç©ºæ•°ç»„ï¼Œç„¶åå°†æ•°æ®å¡«å……è¿›å»ï¼Œå†è®¾ç½®åŸå‹
 * 
 * ã€æŠ€æœ¯ç»†èŠ‚ã€‘
 * 1. åˆ›å»ºç©ºæ•°ç»„instance = []
 * 2. ç”¨Array.prototype.pushå¡«å……æ•°æ®ï¼ˆinstanceç°åœ¨æ˜¯æ™®é€šæ•°ç»„ï¼‰
 * 3. ç”¨Object.setPrototypeOfå°†instanceçš„åŸå‹è®¾ç½®ä¸ºArray2D.prototype
 * 4. æ·»åŠ å†…éƒ¨å±æ€§ï¼ˆ_original, _itemsï¼‰
 * 5. è¿”å›instanceï¼Œå®ƒç°åœ¨æ˜¯Array2Då®ä¾‹
 * 
 * @private          // å†…éƒ¨ä½¿ç”¨ï¼Œä¸å»ºè®®ç”¨æˆ·ç›´æ¥è°ƒç”¨
 * @param {Array} data - æ–°æ•°æ®ï¼ˆå·²å¤„ç†å¥½çš„äºŒç»´æ•°ç»„ï¼‰
 * @returns {Array2D} æ–°çš„Array2Då®ä¾‹
 * @example
 * // åœ¨filteræ–¹æ³•å†…éƒ¨ä½¿ç”¨ï¼š
 * return this._new(this._items.filter(fn));  // è¿”å›ç­›é€‰åçš„æ–°å®ä¾‹
 */
Array2D.prototype._new = function(data) {
    // åˆ›å»ºç©ºæ•°ç»„å®ä¾‹ï¼ˆæ­¤æ—¶æ˜¯æ™®é€šæ•°ç»„ï¼‰
    var instance = [];
    // å¡«å……æ•°æ®
    Array.prototype.push.apply(instance, data);

    // ã€å…³é”®æ­¥éª¤ï¼šè®¾ç½®åŸå‹ã€‘
    // å°†instanceçš„åŸå‹é“¾æŒ‡å‘Array2D.prototype
    // è¿™æ ·instanceå°±èƒ½ä½¿ç”¨Array2Dçš„æ‰€æœ‰æ–¹æ³•äº†
    if (Object.setPrototypeOf) {
        // ES6æ ‡å‡†æ–¹æ³•
        Object.setPrototypeOf(instance, Array2D.prototype);
    } else {
        // æ—§ç¯å¢ƒå¤‡ç”¨æ–¹æ¡ˆï¼ˆ__proto__æ˜¯éæ ‡å‡†ä½†å¹¿æ³›æ”¯æŒçš„å±æ€§ï¼‰
        instance.__proto__ = Array2D.prototype;
    }

    // ğŸ”§ v3.7.9 ä¿®å¤: ä¿ç•™åŸå§‹çš„ _original å¦‚æœå­˜åœ¨ï¼Œå¦åˆ™ä½¿ç”¨å½“å‰æ•°æ®
    // è¿™æ · zç­›é€‰/zå¤šåˆ—æ’åº åçš„å¯¹è±¡ä»èƒ½è®¿é—®åŸå§‹è¡¨å¤´
    var originalData = data;
    if ('_original' in this && this._original !== undefined && this._original !== null) {
        originalData = this._original;
    }
    Object.defineProperty(instance, '_original', {
        value: originalData,
        writable: true,
        enumerable: false,
        configurable: true
    });

    Object.defineProperty(instance, '_items', {
        get: function() {
            var arr = [];
            for (var i = 0; i < this.length; i++) {
                arr.push(this[i]);
            }
            return arr;
        },
        set: function(value) {
            Array.prototype.splice.call(this, 0, this.length);
            Array.prototype.push.apply(this, value);
        },
        enumerable: false,
        configurable: true
    });

    // ğŸ”§ v3.7.9 ä¿®å¤: æ›´å¯é åœ°ä¿ç•™ _header å±æ€§ï¼ˆè¡¨å¤´ä¿¡æ¯ï¼‰
    // ä½¿ç”¨ in æ“ä½œç¬¦æ£€æŸ¥ï¼Œå› ä¸º _header å¯èƒ½æ˜¯ä¸å¯æšä¸¾çš„
    if ('_header' in this && this._header !== undefined && this._header !== null) {
        Object.defineProperty(instance, '_header', {
            value: this._header,
            writable: true,
            enumerable: false,
            configurable: true
        });
    }

    // è¿”å›æ–°åˆ›å»ºçš„Array2Då®ä¾‹
    return instance;
};

// ==================== åŸºç¡€æ“ä½œ ====================

/**
 * è·å–/è®¾ç½®æ•°ç»„å€¼
 * @param {Array} [newData] - æ–°æ•°æ®ï¼ˆå¯é€‰ï¼‰
 * @returns {Array2D|Array} è®¾ç½®æ—¶è¿”å›thisï¼Œå¦åˆ™è¿”å›å½“å‰æ•°ç»„
 * @example
 * Array2D([[1,2]]).val()           // [[1,2]]
 * Array2D([[1,2]]).val([[3,4]])     // è¿”å›é“¾å¼å¯¹è±¡
 */
Array2D.prototype.val = function(newData) {
    if (newData !== undefined) {
        // setter ä¼šè‡ªåŠ¨åŒæ­¥æ•°ç»„å±æ€§
        this._items = newData;
        return this;
    }
    return this._items;
};

/**
 * æ£€æŸ¥æ•°ç»„æ˜¯å¦ä¸ºç©º
 * @returns {Boolean} æ˜¯å¦ä¸ºç©º
 * @example
 * Array2D([[1]]).zæ˜¯å¦ä¸ºç©º()    // false
 * Array2D([]).zæ˜¯å¦ä¸ºç©º()       // true
 */
Array2D.prototype.zæ˜¯å¦ä¸ºç©º = function() {
    return !this._items || this._items.length === 0;
};
Array2D.prototype.isEmpty = Array2D.prototype.zæ˜¯å¦ä¸ºç©º;

/**
 * è·å–å…ƒç´ æ•°é‡
 * @returns {Number} å…ƒç´ æ•°é‡
 * @example
 * Array2D([[1,2],[3,4]]).zæ•°é‡()  // 4
 */
Array2D.prototype.zæ•°é‡ = function() {
    return this.zæ‰å¹³åŒ–().length;
};
Array2D.prototype.count = Array2D.prototype.zæ•°é‡;

/**
 * å…‹éš†æ•°ç»„ï¼ˆæ·±æ‹·è´ï¼‰
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * const arr = Array2D([[1,2]]);
 * const cloned = arr.zå…‹éš†();
 */
Array2D.prototype.zå…‹éš† = function() {
    return this._new(JSON.parse(JSON.stringify(this._items)));
};
Array2D.prototype.copy = Array2D.prototype.zå…‹éš†;

// ==================== Array2D HTMLè¾“å‡ºæ–¹æ³• ====================

/**
 * è¾“å‡ºä¸ºHTMLè¡¨æ ¼ï¼ˆhtmlï¼‰- å°†äºŒç»´æ•°ç»„è½¬æ¢ä¸ºHTMLè¡¨æ ¼å­—ç¬¦ä¸²
 * @param {Object} [options] - é…ç½®é€‰é¡¹
 * @param {string} [options.className] - è¡¨æ ¼CSSç±»å
 * @param {string} [options.style] - è¡¨æ ¼å†…è”æ ·å¼
 * @param {boolean} [options.header=false] - æ˜¯å¦å°†ç¬¬ä¸€è¡Œä½œä¸ºè¡¨å¤´
 * @param {string} [options.caption] - è¡¨æ ¼æ ‡é¢˜
 * @returns {string} HTMLè¡¨æ ¼å­—ç¬¦ä¸²
 * @example
 * Array2D([[1,2],[3,4]]).zè¾“å‡ºHTML()  
 * // è¿”å›: "<table><tr><td>1</td><td>2</td></tr><tr><td>3</td><td>4</td></tr></table>"
 * Array2D([['å§“å','å¹´é¾„'],['å¼ ä¸‰',20]]).zè¾“å‡ºHTML({header:true})
 * // è¿”å›å¸¦theadçš„è¡¨æ ¼
 */
Array2D.prototype.zè¾“å‡ºHTML = function(options) {
    options = options || {};
    var className = options.className || '';
    var style = options.style || '';
    var hasHeader = options.header === true;
    var caption = options.caption || '';
    
    var html = '<table';
    if (className) html += ' class="' + className + '"';
    if (style) html += ' style="' + style + '"';
    html += '>';
    
    if (caption) {
        html += '<caption>' + caption + '</caption>';
    }
    
    var startRow = 0;
    if (hasHeader && this._items.length > 0) {
        html += '<thead><tr>';
        var headerRow = this._items[0];
        for (var j = 0; j < headerRow.length; j++) {
            html += '<th>' + (headerRow[j] !== null && headerRow[j] !== undefined ? headerRow[j] : '') + '</th>';
        }
        html += '</tr></thead><tbody>';
        startRow = 1;
    }
    
    for (var i = startRow; i < this._items.length; i++) {
        html += '<tr>';
        var row = this._items[i];
        if (Array.isArray(row)) {
            for (var j = 0; j < row.length; j++) {
                var cell = row[j];
                html += '<td>' + (cell !== null && cell !== undefined ? cell : '') + '</td>';
            }
        } else {
            html += '<td>' + (row !== null && row !== undefined ? row : '') + '</td>';
        }
        html += '</tr>';
    }
    
    if (hasHeader) html += '</tbody>';
    html += '</table>';
    
    return html;
};
Array2D.prototype.html = Array2D.prototype.zè¾“å‡ºHTML;
Array2D.prototype.toHtml = Array2D.prototype.zè¾“å‡ºHTML;

/**
 * é™æ€æ–¹æ³•ï¼šè¾“å‡ºä¸ºHTMLè¡¨æ ¼
 * @param {Array} arr - äºŒç»´æ•°ç»„
 * @param {Object} [options] - é…ç½®é€‰é¡¹
 * @returns {string} HTMLè¡¨æ ¼å­—ç¬¦ä¸²
 */
Array2D.html = function(arr, options) {
    if (!arr) return '<table></table>';
    return new Array2D(arr).zè¾“å‡ºHTML(options);
};

// ==================== ä½¿ç”¨è¾…åŠ©å‡½æ•°åˆ›å»º Array2D æ–¹æ³•åˆ«å ====================
createBilingualAliases(Array2D.prototype, [
    ['zå¡«å……', 'fill'],
    ['zè¡¥é½ç©ºä½', 'fillBlank'],
    ['zæ‰å¹³åŒ–', 'flat'],
    ['zåè½¬', 'reverse'],
    ['zæ±‚å’Œ', 'sum'],
    ['zå¹³å‡å€¼', 'average'],
    ['zä¸­ä½æ•°', 'median'],
    ['zæœ€å¤§å€¼', 'max'],
    ['zæœ€å°å€¼', 'min'],
    ['zç¬¬ä¸€ä¸ª', 'first'],
    ['zæœ€åä¸€ä¸ª', 'last'],
    ['zè½¬ç½®', 'transpose'],
    ['zçŸ©é˜µä¿¡æ¯', 'matrixInfo'],
    ['zå•å…ƒæ ¼', 'cell'],
    ['zè®¾ç½®å•å…ƒæ ¼', 'setCell'],
    ['zå†™å…¥å•å…ƒæ ¼', 'toRange'],
    ['zè¿æ¥', 'join'],
    ['zè½¬JSON', 'toJson'],
    ['zåˆ†å—', 'chunk'],
    ['zæŒ‘é€‰', 'pick'],
    ['zè·³è¿‡', 'skip'],
    ['zå–å‰Nä¸ª', 'take'],
    ['zæŸ¥æ‰¾ç´¢å¼•', 'findIndex'],
    ['zåŒ…å«', 'includes'],
    ['zç­›é€‰', 'filter'],
    ['zæ˜ å°„', 'map'],
    ['zå½’çº¦', 'reduce'],
    ['zå€’åºå½’çº¦', 'reduceRight'],
    ['zå…¨éƒ¨æ»¡è¶³', 'every'],
    ['zæœ‰æ»¡è¶³', 'some'],
    ['zè¡Œæ•°', 'rowCount'],
    ['zåˆ—æ•°', 'colCount'],
    ['zè·å–è¡Œ', 'getRow'],
    ['zè·å–åˆ—', 'getCol'],
    ['zé¦–è¡Œ', 'firstRow'],
    ['zæœ«è¡Œ', 'lastRow'],
    ['zé¦–åˆ—', 'firstCol'],
    ['zæœ«åˆ—', 'lastCol'],
    ['zæ·»åŠ è¡Œ', 'addRow'],
    ['zæå–åˆ—', 'pluck'],
    ['zæ·»åŠ åˆ—', 'addCol'],
    ['zåˆ é™¤è¡Œ', 'deleteRow'],
    ['zåˆ é™¤åˆ—', 'deleteCol'],
    ['zå‡åºæ’åº', 'sortAsc'],
    ['zæŒ‰è§„åˆ™å‡åº', 'sortBy'],
    ['zæŒ‰è§„åˆ™é™åº', 'sortByDesc'],
    ['zé™åºæ’åº', 'sortDesc'],
    ['zè¡Œæ’åº', 'sortRow'],
    ['zåˆ—æ’åº', 'sortCol'],
    ['zå¤šåˆ—æ’åº', 'sortByCols'],
    ['zè‡ªå®šä¹‰æ’åº', 'sortByList'],
    ['zå»é‡', 'distinct'],
    ['zè½¬çŸ©é˜µ', 'toMatrix'],
    ['zåˆ†ç»„', 'groupBy'],
    ['zé€è§†', 'pivotBy'],
    ['zä¸Šä¸‹è¿æ¥', 'concat'],
    ['zå·¦è¿æ¥', 'leftjoin'],
    ['zä¸€å¯¹å¤šè¿æ¥', 'leftFulljoin'],
    ['zå·¦å³å…¨è¿æ¥', 'fulljoin'],
    ['zå·¦å³è¿æ¥', 'zip'],
    ['zæ’é™¤', 'except'],
    ['zå–äº¤é›†', 'intersect'],
    ['zå»é‡å¹¶é›†', 'union'],
    ['zè¶…çº§æŸ¥æ‰¾', 'superLookup'],
    ['zæŸ¥æ‰¾å•ä¸ª', 'find'],
    ['zæŸ¥æ‰¾æ‰€æœ‰ä¸‹æ ‡', 'findAllIndex'],
    ['zæŸ¥æ‰¾æ‰€æœ‰è¡Œä¸‹æ ‡', 'findRowsIndex'],
    ['zæŸ¥æ‰¾æ‰€æœ‰åˆ—ä¸‹æ ‡', 'findColsIndex'],
    ['zæŸ¥æ‰¾å…ƒç´ ä¸‹æ ‡', 'findIndexByPredicate'],
    ['zå€¼ä½ç½®', 'indexOf'],
    ['zä»åå¾€å‰å€¼ä½ç½®', 'lastIndexOf'],
    ['zæ‰¹é‡åˆ é™¤åˆ—', 'deleteCols'],
    ['zæ‰¹é‡åˆ é™¤è¡Œ', 'deleteRows'],
    ['zæ‰¹é‡æ’å…¥åˆ—', 'insertCols'],
    ['zæ‰¹é‡æ’å…¥è¡Œ', 'insertRows'],
    ['zæ’å…¥è¡Œå·', 'insertRowNum'],
    ['zæŒ‰é¡µæ•°åˆ†é¡µ', 'pageByCount'],
    ['zæŒ‰è¡Œæ•°åˆ†é¡µ', 'pageByRows'],
    ['zæŒ‰ä¸‹æ ‡åˆ†é¡µ', 'pageByIndexs'],
    ['zé—´éš”å–æ•°', 'nth'],
    ['zè¡¥é½æ•°ç»„', 'pad'],
    ['zé‡è®¾å¤§å°', 'resize'],
    ['zå¤„ç†ç©ºå€¼', 'noNull'],
    ['zé€‰æ‹©åˆ—', 'selectCols'],
    ['zé€‰æ‹©è¡Œ', 'selectRows'],
    ['zç»“æœ', 'res'],
    ['zè¡Œåˆ‡ç‰‡', 'slice'],
    ['zè¡Œåˆ‡ç‰‡åˆ é™¤è¡Œ', 'splice'],
    ['zè½¬å­—ç¬¦ä¸²', 'toString']
]);

// ==================== å¡«å……æ“ä½œ ====================

/**
 * æ‰¹é‡å¡«å……æ•°ç»„
 * @param {string|number|boolean|null|undefined} value - å¡«å……å€¼
 * @param {Number} [rows] - è¡Œæ•°ï¼ˆå¯é€‰ï¼Œé»˜è®¤å½“å‰è¡Œæ•°æˆ–1ï¼‰
 * @param {Number} [cols] - åˆ—æ•°ï¼ˆå¯é€‰ï¼Œé»˜è®¤å½“å‰åˆ—æ•°æˆ–1ï¼‰
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D().zå¡«å……(0, 2, 3)  // [[0,0,0],[0,0,0]]
 */
Array2D.prototype.zå¡«å…… = function(value, rows, cols) {
    rows = rows || this._items.length || ARRAY_LIMITS.DEFAULT_ROWS;
    cols = cols || (this._items[0] ? this._items[0].length : ARRAY_LIMITS.DEFAULT_COLS);
    const result = [];
    for (let i = 0; i < rows; i++) {
        const row = [];
        for (let j = 0; j < cols; j++) {
            row.push(value);
        }
        result.push(row);
    }
    return this._new(result);
};
Array2D.prototype.fill = Array2D.prototype.zå¡«å……;

/**
 * è¡¥é½ç©ºä½ï¼ˆfillBlankï¼‰- æ”¯æŒæ–¹å‘å¡«å……çš„å¢å¼ºç‰ˆï¼Œå¯å¤„ç†åˆå¹¶å•å…ƒæ ¼
 * @param {string} [direction='right'] - å¡«å……æ–¹å‘ï¼šleft/right/up/down
 * @param {string} [rangeAddress] - å‚ç…§å•å…ƒæ ¼åœ°å€ï¼ˆå¦‚"A2:D2"ï¼‰ï¼Œç”¨äºç¡®å®šå¡«å……åŒºåŸŸ
 * @param {any} [fillValue=''] - å¡«å……å€¼
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * // åŸºç¡€ç”¨æ³•ï¼šå¡«å……null/undefined
 * Array2D([[1,null],[2,undefined]]).zè¡¥é½ç©ºä½()  // [[1,''],[2,'']]
 *
 * // é«˜çº§ç”¨æ³•ï¼šæŒ‰æ–¹å‘å¡«å……ï¼ˆç”¨äºåˆå¹¶å•å…ƒæ ¼å¤„ç†ï¼‰
 * Array2D([[1,2],[3,4]]).zè¡¥é½ç©ºä½('right', 'A2:D2')  // å‘å³å¡«å……åˆ°D2åŒºåŸŸ
 * Array2D([[1,2],[3,4]]).zè¡¥é½ç©ºä½('down', 'A2:A10')  // å‘ä¸‹å¡«å……åˆ°A10åŒºåŸŸ
 * Array2D([[1,2],[3,4]]).zè¡¥é½ç©ºä½('left', 'A2:C2')   // å‘å·¦å¡«å……åˆ°A2åŒºåŸŸ
 * Array2D([[1,2],[3,4]]).zè¡¥é½ç©ºä½('up', 'A5:C10')    // å‘ä¸Šå¡«å……åˆ°A5åŒºåŸŸ
 *
 * // æ··åˆå‚æ•°ï¼šå…ˆæŒ‰æ–¹å‘å¡«å……å†è¡¥å…¨
 * Array2D([[1,null],[2]]).zè¡¥é½ç©ºä½('right', 'A2:D2', 0)  // [[1,0,0,0],[2,0,0,0]]
 */

/**
 * è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®å¡«å……æ–¹å‘è°ƒæ•´åæ ‡
 * @private
 * @param {number} row - åŸå§‹è¡Œç´¢å¼•
 * @param {number} col - åŸå§‹åˆ—ç´¢å¼•
 * @param {string} direction - å¡«å……æ–¹å‘ (left/right/up/down)
 * @param {number} maxLen - åŸå§‹æ•°ç»„æœ€å¤§é•¿åº¦
 * @param {number} finalRows - æœ€ç»ˆè¡Œæ•°
 * @param {number} finalCols - æœ€ç»ˆåˆ—æ•°
 * @returns {{row: number, col: number}} è°ƒæ•´åçš„åæ ‡
 */
function _adjustCoordinateByDirection(row, col, direction, maxLen, finalRows, finalCols) {
    switch (direction) {
        case FILL_DIRECTION.LEFT:
            // ä»å³å‘å·¦å¡«å……ï¼šåˆ—ç´¢å¼•å‘å³åç§»
            return { row, col: col + (finalCols - maxLen) };
        case FILL_DIRECTION.UP:
            // ä»ä¸‹å‘ä¸Šå¡«å……ï¼šè¡Œç´¢å¼•å‘ä¸‹åç§»
            return { row: row + (finalRows - finalRows), col };
        case FILL_DIRECTION.DOWN:
        case FILL_DIRECTION.RIGHT:
        default:
            // é»˜è®¤ï¼šå·¦ä¸Šå¯¹é½
            return { row, col };
    }
}

Array2D.prototype.zè¡¥é½ç©ºä½ = function(direction, rangeAddress, fillValue) {
    // å‚æ•°é‡è½½å¤„ç†
    if (typeof direction !== 'string') {
        // æ—§ç‰ˆè°ƒç”¨ï¼šä»…ä¼ fillValue
        fillValue = direction;
        direction = FILL_DIRECTION.RIGHT;
        rangeAddress = null;
    }

    fillValue = fillValue !== undefined ? fillValue : ARRAY_LIMITS.DEFAULT_FILL;
    direction = direction || FILL_DIRECTION.RIGHT;
    
    var result = [];
    
    // å¦‚æœæä¾›äº†åŒºåŸŸåœ°å€ï¼Œè§£æå‡ºè¡Œåˆ—èŒƒå›´
    var targetRows = this._items.length;
    var targetCols = 0;
    var startRow = 0, startCol = 0;
    
    if (rangeAddress && typeof rangeAddress === 'string') {
        // è§£æç±»ä¼¼ "A2:D10" çš„åœ°å€
        var match = rangeAddress.match(/([A-Z]+)(\d+):([A-Z]+)(\d+)/i);
        if (match) {
            // è½¬æ¢ä¸º0-basedç´¢å¼•
            startCol = this._colToIndex(match[1]);  // èµ·å§‹åˆ—
            startRow = parseInt(match[2]) - 1;      // èµ·å§‹è¡Œ
            var endCol = this._colToIndex(match[3]);   // ç»“æŸåˆ—
            var endRow = parseInt(match[4]) - 1;       // ç»“æŸè¡Œ
            
            targetRows = endRow - startRow + 1;
            targetCols = endCol - startCol + 1;
        }
    }

    // æ‰¾å‡ºæœ€å¤§åˆ—æ•°
    var maxLen = 0;
    for (var r = 0; r < this._items.length; r++) {
        if (this._items[r] && this._items[r].length > maxLen) {
            maxLen = this._items[r].length;
        }
    }

    // æ ¹æ®æ–¹å‘è®¡ç®—æœ€ç»ˆç»´åº¦
    var finalRows = targetRows || this._items.length;
    var finalCols = targetCols || Math.max(maxLen, targetCols);

    // æŒ‰æ–¹å‘å¡«å……
    for (var i = 0; i < finalRows; i++) {
        var row = new Array(finalCols);

        // åˆå§‹åŒ–å…¨ä¸ºfillValue
        for (var j = 0; j < finalCols; j++) {
            row[j] = fillValue;
        }

        // æ ¹æ®æ–¹å‘å¡«å……åŸå§‹æ•°æ®
        for (var j = 0; j < finalCols; j++) {
            // ä½¿ç”¨è¾…åŠ©å‡½æ•°è°ƒæ•´åæ ‡
            var adjusted = _adjustCoordinateByDirection(i, j, direction, maxLen, finalRows, finalCols);
            var origRow = adjusted.row;
            var origCol = adjusted.col;

            // æ£€æŸ¥æ˜¯å¦åœ¨åŸå§‹æ•°ç»„èŒƒå›´å†…
            if (origRow >= 0 && origRow < this._items.length &&
                origCol >= 0 && this._items[origRow] && origCol < this._items[origRow].length) {
                var val = this._items[origRow][origCol];
                row[j] = (val === null || val === undefined) ? fillValue : val;
            }
        }

        result.push(row);
    }

    return this._new(result);
};

// åˆ—å­—æ¯è½¬æ•°å­—ç´¢å¼•çš„è¾…åŠ©å‡½æ•°
Array2D.prototype._colToIndex = function(colStr) {
    var result = 0;
    for (var i = 0; i < colStr.length; i++) {
        result = result * 26 + (colStr.charCodeAt(i) - 64);
    }
    return result - 1; // è¿”å›0-basedç´¢å¼•
};

Array2D.prototype.fillBlank = Array2D.prototype.zè¡¥é½ç©ºä½;

/**
 * æ‰å¹³åŒ–ï¼ˆé™ç»´ï¼‰
 * @returns {Array} ä¸€ç»´æ•°ç»„
 * @example
 * Array2D([[1,2],[3,4]]).zæ‰å¹³åŒ–()  // [1,2,3,4]
 */
Array2D.prototype.zæ‰å¹³åŒ– = function() {
    var result = [];
    for (var i = 0; i < this._items.length; i++) {
        if (Array.isArray(this._items[i])) {
            for (var j = 0; j < this._items[i].length; j++) {
                result.push(this._items[i][j]);
            }
        } else {
            result.push(this._items[i]);
        }
    }
    return result;
};
Array2D.prototype.flat = Array2D.prototype.zæ‰å¹³åŒ–;

/**
 * æ•°ç»„åè½¬
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[1,2],[3,4]]).zåè½¬()  // [[3,4],[1,2]]
 */
Array2D.prototype.zåè½¬ = function() {
    return this._new(this._items.slice().reverse());
};
Array2D.prototype.reverse = Array2D.prototype.zåè½¬;

// ==================== ç»Ÿè®¡è®¡ç®— ====================

/**
 * æ±‚å’Œ
 * @param {string|Function} [colSelector] - åˆ—é€‰æ‹©å™¨ 'f1'=ç¬¬1åˆ—, æˆ–å›è°ƒå‡½æ•°
 * @returns {Number} å’Œ
 * @example
 * Array2D([[1,2],[3,4]]).zæ±‚å’Œ()        // 10
 * Array2D([[1,2],[3,4]]).zæ±‚å’Œ('f1')     // 4 (ç¬¬1åˆ—)
 */
Array2D.prototype.zæ±‚å’Œ = function(colSelector) {
    const fn = colSelector ? parseLambda(colSelector) : null;
    const flat = fn ? this._items.map(fn) : this.zæ‰å¹³åŒ–();
    return flat.reduce((acc, val) => {
        const num = typeof val === 'number' ? val : parseFloat(String(val).replace(/,/g, ''));
        return acc + (isNaN(num) ? 0 : num);
    }, 0);
};
Array2D.prototype.sum = Array2D.prototype.zæ±‚å’Œ;

/**
 * æ±‚å¹³å‡å€¼
 * @param {string|Function} [colSelector] - åˆ—é€‰æ‹©å™¨
 * @returns {Number} å¹³å‡å€¼
 */
Array2D.prototype.zå¹³å‡å€¼ = function(colSelector) {
    const fn = colSelector ? parseLambda(colSelector) : null;
    const flat = fn ? this._items.map(fn) : this.zæ‰å¹³åŒ–();
    const sum = flat.reduce((acc, val) => {
        const num = typeof val === 'number' ? val : parseFloat(String(val).replace(/,/g, ''));
        return acc + (isNaN(num) ? 0 : num);
    }, 0);
    return flat.length > 0 ? sum / flat.length : 0;
};
Array2D.prototype.average = Array2D.prototype.zå¹³å‡å€¼;

/**
 * æ±‚æœ€å¤§å€¼
 * @param {string|Function} [colSelector] - åˆ—é€‰æ‹©å™¨
 * @returns {Number} æœ€å¤§å€¼ï¼Œç©ºæ•°ç»„è¿”å› undefined
 */
Array2D.prototype.zæœ€å¤§å€¼ = function(colSelector) {
    const fn = colSelector ? parseLambda(colSelector) : null;
    const flat = fn ? this._items.map(fn) : this.zæ‰å¹³åŒ–();
    const numbers = flat.filter(v => typeof v === 'number' || !isNaN(parseFloat(v)));
    if (numbers.length === 0) return undefined;  // ç©ºæ•°ç»„è¿”å› undefined è€Œé -Infinity
    return Math.max(...numbers);
};
Array2D.prototype.max = Array2D.prototype.zæœ€å¤§å€¼;

/**
 * æ±‚æœ€å°å€¼
 * @param {string|Function} [colSelector] - åˆ—é€‰æ‹©å™¨
 * @returns {Number} æœ€å°å€¼ï¼Œç©ºæ•°ç»„è¿”å› undefined
 */
Array2D.prototype.zæœ€å°å€¼ = function(colSelector) {
    const fn = colSelector ? parseLambda(colSelector) : null;
    const flat = fn ? this._items.map(fn) : this.zæ‰å¹³åŒ–();
    const numbers = flat.filter(v => typeof v === 'number' || !isNaN(parseFloat(v)));
    if (numbers.length === 0) return undefined;  // ç©ºæ•°ç»„è¿”å› undefined è€Œé Infinity
    return Math.min(...numbers);
};
Array2D.prototype.min = Array2D.prototype.zæœ€å°å€¼;

/**
 * æ±‚ä¸­ä½æ•°ï¼ˆmedianï¼‰
 * @param {string|Function} [colSelector] - åˆ—é€‰æ‹©å™¨
 * @returns {Number} ä¸­ä½æ•°
 * @example
 * Array2D([[1,2,3],[4,5,6]]).zä¸­ä½æ•°()  // 3.5
 */
Array2D.prototype.zä¸­ä½æ•° = function(colSelector) {
    const fn = colSelector ? parseLambda(colSelector) : null;
    const flat = fn ? this._items.map(fn) : this.zæ‰å¹³åŒ–();
    const numbers = flat.filter(v => typeof v === 'number' || !isNaN(parseFloat(v)))
        .map(v => typeof v === 'number' ? v : parseFloat(v));
    if (numbers.length === 0) return undefined;
    numbers.sort(function(a, b) { return a - b; });
    const mid = Math.floor(numbers.length / 2);
    return numbers.length % 2 !== 0 ? numbers[mid] : (numbers[mid - 1] + numbers[mid]) / 2;
};
Array2D.prototype.median = Array2D.prototype.zä¸­ä½æ•°;

/**
 * è·å–ç¬¬ä¸€ä¸ªå…ƒç´ 
 * @returns {any} ç¬¬ä¸€ä¸ªå…ƒç´ 
 */
Array2D.prototype.zç¬¬ä¸€ä¸ª = function() {
    const flat = this.zæ‰å¹³åŒ–();
    return flat.length > 0 ? flat[0] : undefined;
};
Array2D.prototype.first = Array2D.prototype.zç¬¬ä¸€ä¸ª;

/**
 * è·å–æœ€åä¸€ä¸ªå…ƒç´ 
 * @returns {any} æœ€åä¸€ä¸ªå…ƒç´ 
 */
Array2D.prototype.zæœ€åä¸€ä¸ª = function() {
    const flat = this.zæ‰å¹³åŒ–();
    return flat.length > 0 ? flat[flat.length - 1] : undefined;
};
Array2D.prototype.last = Array2D.prototype.zæœ€åä¸€ä¸ª;

// ==================== çŸ©é˜µæ“ä½œ ====================

/**
 * è½¬ç½®çŸ©é˜µ
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[1,2,3],[4,5,6]]).zè½¬ç½®()  // [[1,4],[2,5],[3,6]]
 */
Array2D.prototype.zè½¬ç½® = function() {
    if (!this._items || this._items.length === 0) return this._new([]);
    const rows = this._items.length;
    const cols = this._items[0].length;
    const result = [];
    for (let j = 0; j < cols; j++) {
        result[j] = [];
        for (let i = 0; i < rows; i++) {
            result[j][i] = this._items[i][j];
        }
    }
    return this._new(result);
};
Array2D.prototype.transpose = Array2D.prototype.zè½¬ç½®;

/**
 * è·å–è¡Œåˆ—æ•°
 * @returns {String} "è¡Œæ•°xåˆ—æ•°"
 */
Array2D.prototype.zçŸ©é˜µä¿¡æ¯ = function() {
    const rows = this._items.length;
    const cols = rows > 0 && this._items[0] ? this._items[0].length : 0;
    return `${rows}x${cols}`;
};
Array2D.prototype.matrixInfo = Array2D.prototype.zçŸ©é˜µä¿¡æ¯;

/**
 * è·å–å•å…ƒæ ¼å€¼
 * @param {Number} row - è¡Œå·ï¼ˆä»0å¼€å§‹ï¼‰
 * @param {Number} col - åˆ—å·ï¼ˆä»0å¼€å§‹ï¼‰
 * @returns {any} å•å…ƒæ ¼å€¼
 */
Array2D.prototype.zå•å…ƒæ ¼ = function(row, col) {
    if (this._items[row] && this._items[row][col] !== undefined) {
        return this._items[row][col];
    }
    return undefined;
};
Array2D.prototype.cell = Array2D.prototype.zå•å…ƒæ ¼;

/**
 * è®¾ç½®å•å…ƒæ ¼å€¼
 * @param {Number} row - è¡Œå·
 * @param {Number} col - åˆ—å·
 * @param {string|number|boolean|null|Date|object} value - æ–°å€¼
 * @returns {Array2D} å½“å‰å®ä¾‹
 */
Array2D.prototype.zè®¾ç½®å•å…ƒæ ¼ = function(row, col, value) {
    if (!this._items[row]) this._items[row] = [];
    this._items[row][col] = value;
    return this;
};
Array2D.prototype.setCell = Array2D.prototype.zè®¾ç½®å•å…ƒæ ¼;

/**
 * å†™å…¥å•å…ƒæ ¼ï¼ˆå®ä¾‹æ–¹æ³•ï¼Œæ ¹æ®æ•°ç»„å¤§å°è‡ªåŠ¨æ‰©å±•åŒºåŸŸï¼‰
 * @param {Range|string} rng - ç›®æ ‡å•å…ƒæ ¼åŒºåŸŸï¼ˆå·¦ä¸Šè§’å•å…ƒæ ¼ï¼‰
 * @returns {Array2D} å½“å‰å®ä¾‹ï¼ˆæ”¯æŒé“¾å¼è°ƒç”¨ï¼‰
 * @example
 * Array2D([[1,2],[3,4]]).toRange("A1")     // å†™å…¥A1:B2
 * Array2D([[1,2],[3,4]]).zå†™å…¥å•å…ƒæ ¼("K1")  // å†™å…¥K1:L2
 */
Array2D.prototype.toRange = function(rng) {
    if (!isWPS) return this;
    // ç©ºæ•°ç»„æ£€æŸ¥ï¼Œé˜²æ­¢ Item(0,0) æŠ¥é”™
    if (!this._items || this._items.length === 0) {
        return this;
    }
    var targetRng = typeof rng === 'string' ? Range(rng) : rng;
    var rows = this._items.length;
    var cols = rows > 0 ? (Array.isArray(this._items[0]) ? this._items[0].length : 1) : 0;
    // åˆ—æ•°è¾¹ç•Œæ£€æŸ¥
    if (cols === 0) return this;
    // æ ¹æ®æ•°ç»„å¤§å°è°ƒæ•´ç›®æ ‡åŒºåŸŸ
    var endRng = targetRng.Item(rows, cols);
    var sheet = targetRng.Worksheet || Application.ActiveSheet;
    var writeRng = sheet.Range(targetRng, endRng);
    // è§£é™¤åˆå¹¶å•å…ƒæ ¼ - é€ä¸ªå•å…ƒæ ¼æ£€æŸ¥å¹¶å–æ¶ˆåˆå¹¶
    for (var i = 1; i <= writeRng.Rows.Count; i++) {
        for (var j = 1; j <= writeRng.Columns.Count; j++) {
            var cell = writeRng.Cells(i, j);
            if (cell.MergeCells) {
                cell.MergeArea.UnMerge();
            }
        }
    }
    writeRng.Value2 = this._items;
    return this;
};
Array2D.prototype.zå†™å…¥å•å…ƒæ ¼ = Array2D.prototype.toRange;

/**
 * è¿æ¥æˆå­—ç¬¦ä¸²
 * @param {String} [separator=','] - åˆ†éš”ç¬¦
 * @returns {String} è¿æ¥åçš„å­—ç¬¦ä¸²
 */
Array2D.prototype.zè¿æ¥ = function(separator = ',') {
    return this._items.map(row => Array.isArray(row) ? row.join(separator) : String(row)).join(separator);
};
Array2D.prototype.join = Array2D.prototype.zè¿æ¥;

/**
 * æ–‡æœ¬è¿æ¥ï¼ˆtextjoinï¼‰- é€‰æ‹©æŒ‡å®šåˆ—çš„å€¼ï¼Œç”¨åˆ†éš”ç¬¦è¿æ¥
 * @param {String|Number|Function} selector - åˆ—é€‰æ‹©å™¨ï¼Œå¦‚ 'f1' æˆ– 0 æˆ– row=>row.col
 * @param {String} [separator=','] - åˆ†éš”ç¬¦
 * @returns {String} è¿æ¥åçš„å­—ç¬¦ä¸²
 * @example
 * Array2D([['a','b'],['c','d']]).zæ–‡æœ¬è¿æ¥(1, '+')  // "b+d"
 * Array2D([['a','b'],['c','d']]).textjoin('f2', '+')  // "b+d"
 */
Array2D.prototype.zæ–‡æœ¬è¿æ¥ = function(selector, separator = ',') {
    var fn = typeof selector === 'function' ? selector : parseLambda(selector);
    var values = [];
    for (var i = 0; i < this._items.length; i++) {
        var row = this._items[i];
        if (fn) {
            values.push(fn(row, i));
        } else {
            // é»˜è®¤å–ç¬¬ä¸€åˆ—
            values.push(Array.isArray(row) ? row[0] : row);
        }
    }
    return values.join(separator);
};
Array2D.prototype.textjoin = Array2D.prototype.zæ–‡æœ¬è¿æ¥;

/**
 * è½¬JSONï¼ˆè½¬JSONå­—ç¬¦ä¸²ï¼ŒäºŒç»´æ•°ç»„å†…éƒ¨æ•°ç»„æ¨ªç€å¯¹é½æ˜¾ç¤ºï¼‰
 * @param {Boolean} [pretty=true] - æ˜¯å¦æ ¼å¼åŒ–è¾“å‡ºï¼ˆå¯¹é½æ˜¾ç¤ºï¼‰
 * @returns {String} JSONå­—ç¬¦ä¸²
 * @example
 * Array2D([[1,2],[3,4]]).zè½¬JSON()
 * // è¾“å‡º:
 * // [
 * //  [1, 2],
 * //  [3, 4]
 * // ]
 * Array2D([[1,2],[3,4]]).toJson(false)    // "[[1,2],[3,4]]" ç´§å‡‘æ ¼å¼
 */
Array2D.prototype.zè½¬JSON = function(pretty) {
    // ç´§å‡‘æ ¼å¼
    if (pretty === false) {
        return JSON.stringify(this._items);
    }
    // æ ¼å¼åŒ–è¾“å‡ºï¼ˆå¯¹é½æ˜¾ç¤ºï¼‰
    if (Array.isArray(this._items) && this._items.length > 0 && Array.isArray(this._items[0])) {
        var lines = formatArray2DAsJSON(this._items);
        return lines.join('\n');
    }
    // å…¶ä»–æƒ…å†µä½¿ç”¨æ ‡å‡†JSONæ ¼å¼
    return JSON.stringify(this._items, null, 2);
};
Array2D.prototype.toJson = Array2D.prototype.zè½¬JSON;

// ==================== åˆ†å—æŒ‘é€‰ ====================

/**
 * åˆ†å—
 * @param {Number} size - å—å¤§å°
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[1],[2],[3],[4],[5]]).zåˆ†å—(2)  // [[[1],[2]],[[3],[4]],[[5]]]
 */
Array2D.prototype.zåˆ†å— = function(size) {
    const result = [];
    for (let i = 0; i < this._items.length; i += size) {
        result.push(this._items.slice(i, i + size));
    }
    return this._new(result);
};
Array2D.prototype.chunk = Array2D.prototype.zåˆ†å—;

/**
 * æŒ‘é€‰å…ƒç´ 
 * @param {Number} count - æ•°é‡
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[1],[2],[3],[4],[5]]).zæŒ‘é€‰(3)  // [[1],[2],[3]]
 */
Array2D.prototype.zæŒ‘é€‰ = function(count) {
    return this._new(this._items.slice(0, count));
};
Array2D.prototype.pick = Array2D.prototype.zæŒ‘é€‰;

/**
 * è·³è¿‡å…ƒç´ 
 * @param {Number} count - è·³è¿‡æ•°é‡
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[1],[2],[3],[4],[5]]).zè·³è¿‡(2)  // [[3],[4],[5]]
 */
Array2D.prototype.zè·³è¿‡ = function(count) {
    return this._new(this._items.slice(count));
};
Array2D.prototype.skip = Array2D.prototype.zè·³è¿‡;

/**
 * å–å‰Nä¸ª
 * @param {Number} count - æ•°é‡
 * @returns {Array2D} æ–°å®ä¾‹
 */
Array2D.prototype.zå–å‰Nä¸ª = function(count) {
    return this._new(this._items.slice(0, count));
};
Array2D.prototype.take = Array2D.prototype.zå–å‰Nä¸ª;

// è¡¥å……åˆ«åï¼šç”¨æˆ·å¯èƒ½æœŸæœ›çš„æ›´å…·æè¿°æ€§çš„æ–¹æ³•å
Array2D.prototype.zè·³è¿‡å‰Nä¸ª = Array2D.prototype.zè·³è¿‡;
Array2D.prototype.zè·³è¿‡å‰å‡ ä¸ª = Array2D.prototype.zè·³è¿‡;
Array2D.prototype.zå–å‰å‡ ä¸ª = Array2D.prototype.zå–å‰Nä¸ª;

/**
 * é‡å¤Næ¬¡ï¼ˆrepeatï¼‰- å°†æ•°ç»„é‡å¤æŒ‡å®šæ¬¡æ•°
 * @param {Number} count - é‡å¤æ¬¡æ•°
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[1,2],[3,4]]).repeat(2)  // [[1,2],[3,4],[1,2],[3,4]]
 */
Array2D.prototype.repeat = function(count) {
    if (!count || count <= 0) return this._new([]);
    var result = [];
    for (var i = 0; i < count; i++) {
        for (var j = 0; j < this._items.length; j++) {
            result.push(JSON.parse(JSON.stringify(this._items[j])));
        }
    }
    return this._new(result);
};
Array2D.prototype.zé‡å¤Næ¬¡ = Array2D.prototype.repeat;

/**
 * éšæœºæ‰“ä¹±ï¼ˆshuffleï¼‰- éšæœºæ‰“ä¹±æ•°ç»„é¡ºåº
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[1,2],[3,4],[5,6]]).shuffle()  // éšæœºé¡ºåº
 */
Array2D.prototype.shuffle = function() {
    var result = JSON.parse(JSON.stringify(this._items));
    for (var i = result.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = result[i];
        result[i] = result[j];
        result[j] = temp;
    }
    return this._new(result);
};
Array2D.prototype.zéšæœºæ‰“ä¹± = Array2D.prototype.shuffle;

/**
 * è·³è¿‡å‰é¢è¿ç»­æ»¡è¶³ï¼ˆskipWhileï¼‰- è·³è¿‡å‰é¢è¿ç»­æ»¡è¶³æ¡ä»¶çš„å…ƒç´ 
 * @param {string|Function} predicate - æ¡ä»¶å‡½æ•°
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[1,2],[3,4],[5,6]]).zè·³è¿‡å‰é¢è¿ç»­æ»¡è¶³('x=>x[0]<4')  // [[5,6]]
 */
Array2D.prototype.zè·³è¿‡å‰é¢è¿ç»­æ»¡è¶³ = function(predicate) {
    var fn = typeof predicate === 'function' ? predicate : parseLambda(predicate);
    if (!fn) return this._new(this._items.slice());
    var startIndex = 0;
    for (var i = 0; i < this._items.length; i++) {
        if (!fn(this._items[i], i)) {
            startIndex = i;
            break;
        }
        startIndex = i + 1;
    }
    return this._new(this._items.slice(startIndex));
};
Array2D.prototype.skipWhile = Array2D.prototype.zè·³è¿‡å‰é¢è¿ç»­æ»¡è¶³;

/**
 * å–å‰é¢è¿ç»­æ»¡è¶³ï¼ˆtakeWhileï¼‰- å–å‰é¢è¿ç»­æ»¡è¶³æ¡ä»¶çš„å…ƒç´ 
 * @param {string|Function} predicate - æ¡ä»¶å‡½æ•°
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[1,2],[3,4],[5,6]]).zå–å‰é¢è¿ç»­æ»¡è¶³('x=>x[0]<4')  // [[1,2],[3,4]]
 */
Array2D.prototype.zå–å‰é¢è¿ç»­æ»¡è¶³ = function(predicate) {
    var fn = typeof predicate === 'function' ? predicate : parseLambda(predicate);
    if (!fn) return this._new([]);
    var endIndex = 0;
    for (var i = 0; i < this._items.length; i++) {
        if (!fn(this._items[i], i)) {
            endIndex = i;
            break;
        }
        endIndex = i + 1;
    }
    return this._new(this._items.slice(0, endIndex));
};
Array2D.prototype.takeWhile = Array2D.prototype.zå–å‰é¢è¿ç»­æ»¡è¶³;

/**
 * è¡Œåˆ‡ç‰‡ï¼ˆsliceï¼‰- æå–æŒ‡å®šèŒƒå›´çš„è¡Œ
 * @param {Number} [start=0] - èµ·å§‹ç´¢å¼•
 * @param {Number} [end] - ç»“æŸç´¢å¼•ï¼ˆä¸åŒ…å«ï¼‰
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[1,2],[3,4],[5,6]]).zè¡Œåˆ‡ç‰‡(1, 2)  // [[3,4]]
 */
Array2D.prototype.zè¡Œåˆ‡ç‰‡ = function(start, end) {
    start = start || 0;
    if (end === undefined) end = this._items.length;
    return this._new(this._items.slice(start, end));
};
Array2D.prototype.slice = Array2D.prototype.zè¡Œåˆ‡ç‰‡;

/**
 * è¡Œåˆ‡ç‰‡åˆ é™¤è¡Œï¼ˆspliceï¼‰- åˆ é™¤/æ’å…¥è¡Œ
 * @param {Number} start - èµ·å§‹ä½ç½®
 * @param {Number} [deleteCount=1] - åˆ é™¤æ•°é‡
 * @param {...Array} items - è¦æ’å…¥çš„è¡Œ
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[1,2],[3,4],[5,6]]).zè¡Œåˆ‡ç‰‡åˆ é™¤è¡Œ(1, 1)  // [[1,2],[5,6]]
 */
Array2D.prototype.zè¡Œåˆ‡ç‰‡åˆ é™¤è¡Œ = function(start, deleteCount, items) {
    deleteCount = deleteCount !== undefined ? deleteCount : 1;
    var result = this._items.slice();
    var removed = result.splice.apply(result, [start, deleteCount].concat(Array.prototype.slice.call(arguments, 2)));
    return this._new(result);
};
Array2D.prototype.splice = Array2D.prototype.zè¡Œåˆ‡ç‰‡åˆ é™¤è¡Œ;

/**
 * è½¬å­—ç¬¦ä¸²ï¼ˆtoStringï¼‰- å°†æ•°ç»„è½¬æ¢ä¸ºå­—ç¬¦ä¸²
 * @param {string} [rowSeparator='\n'] - è¡Œåˆ†éš”ç¬¦
 * @param {string} [colSeparator=','] - åˆ—åˆ†éš”ç¬¦
 * @returns {string} å­—ç¬¦ä¸²
 * @example
 * Array2D([[1,2],[3,4]]).zè½¬å­—ç¬¦ä¸²()  // "1,2\n3,4"
 */
Array2D.prototype.zè½¬å­—ç¬¦ä¸² = function(rowSeparator, colSeparator) {
    rowSeparator = rowSeparator !== undefined ? rowSeparator : '\n';
    colSeparator = colSeparator !== undefined ? colSeparator : ',';
    return this._items.map(function(row) {
        return row.join(colSeparator);
    }).join(rowSeparator);
};
Array2D.prototype.toString = Array2D.prototype.zè½¬å­—ç¬¦ä¸²;

// ==================== æŸ¥æ‰¾ç­›é€‰ ====================

/**
 * æŸ¥æ‰¾å…ƒç´ ä¸‹æ ‡
 * @param {any} value - è¦æŸ¥æ‰¾çš„å€¼
 * @returns {Number} ä¸‹æ ‡ï¼Œæœªæ‰¾åˆ°è¿”å›-1
 */
Array2D.prototype.zæŸ¥æ‰¾ç´¢å¼• = function(value) {
    const flat = this.zæ‰å¹³åŒ–();
    for (let i = 0; i < flat.length; i++) {
        if (flat[i] == value) return i;
    }
    return -1;
};
Array2D.prototype.findIndex = Array2D.prototype.zæŸ¥æ‰¾ç´¢å¼•;

/**
 * æ£€æŸ¥æ˜¯å¦åŒ…å«å…ƒç´ 
 * @param {any} value - è¦æ£€æŸ¥çš„å€¼
 * @returns {Boolean} æ˜¯å¦åŒ…å«
 */
Array2D.prototype.zåŒ…å« = function(value) {
    return this.zæŸ¥æ‰¾ç´¢å¼•(value) !== -1;
};
Array2D.prototype.includes = Array2D.prototype.zåŒ…å«;

/**
 * éå†æ¯ä¸ªå…ƒç´ 
 * @param {Function} callback - å›è°ƒå‡½æ•° (item, index)
 * @returns {Array2D} this æ”¯æŒé“¾å¼è°ƒç”¨
 * @example
 * Array2D([[1,2],[3,4]]).forEach((row, i) => Console.log(i, row))
 */
Array2D.prototype.forEach = function(callback) {
    this._items.forEach(callback);
    return this;
};

/**
 * å€’åºéå†æ‰§è¡Œï¼ˆforEachRevï¼‰- ä»åå‘å‰éå†æ¯ä¸ªå…ƒç´ 
 * @param {Function} callback - å›è°ƒå‡½æ•° (item, index)ï¼Œè¿”å›falseå¯ä¸­æ–­
 * @returns {Array2D} this æ”¯æŒé“¾å¼è°ƒç”¨
 * @example
 * Array2D([[1,2],[3,4]]).zå€’åºéå†æ‰§è¡Œ((row, i) => Console.log(i, row))
 */
Array2D.prototype.zå€’åºéå†æ‰§è¡Œ = function(callback) {
    for (var i = this._items.length - 1; i >= 0; i--) {
        var result = callback(this._items[i], i);
        if (result === false) break; // æ”¯æŒæå‰é€€å‡º
    }
    return this;
};
Array2D.prototype.forEachRev = Array2D.prototype.zå€’åºéå†æ‰§è¡Œ;

/**
 * ç­›é€‰å…ƒç´ 
 * @param {string|Function} predicate - ç­›é€‰æ¡ä»¶
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([1,2,3,4]).zç­›é€‰('x=>x>2')  // [3,4]
 */
Array2D.prototype.zç­›é€‰ = function(predicate, skipHeader) {
    // ğŸ”§ v3.7.9 ä¿®å¤: å¦‚æœæ²¡æœ‰æŒ‡å®š skipHeader ä½†å¯¹è±¡æœ‰ _header å±æ€§ï¼Œè‡ªåŠ¨è®¾ä¸º 1
    if (skipHeader === undefined && '_header' in this && this._header !== undefined) {
        skipHeader = 1;
        // Console.log('[zç­›é€‰ DEBUG] Auto-detected skipHeader=1 from _header');
    }
    // å¤„ç† skipHeader å‚æ•°
    var data = this._items;
    if (skipHeader && skipHeader > 0) {
        data = data.slice(skipHeader);
    }
    
    // å¤„ç†å¯¹è±¡å‚æ•°å½¢å¼ï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰
    if (predicate && typeof predicate === 'object' && !Array.isArray(predicate)) {
        return this._new(Array2D._filterByObject(data, predicate));
    }
    
    const fn = typeof predicate === 'function' ? predicate : parseLambda(predicate);
    if (!fn) return this._new([]);
    return this._new(data.filter(fn));
};
Array2D.prototype.filter = Array2D.prototype.zç­›é€‰;

/**
 * å†…éƒ¨æ–¹æ³•ï¼šæ ¹æ®å¯¹è±¡å‚æ•°ç­›é€‰
 * @private
 * @param {Array} data - æ•°æ®
 * @param {Object} condition - æ¡ä»¶å¯¹è±¡
 * @returns {Array} ç­›é€‰åçš„æ•°ç»„
 */
Array2D._filterByObject = function(data, condition) {
    var self = this;
    return data.filter(function(row, index) {
        return self._checkCondition(row, condition, index);
    });
};

/**
 * å†…éƒ¨æ–¹æ³•ï¼šæ£€æŸ¥å•è¡Œæ˜¯å¦æ»¡è¶³æ¡ä»¶
 * @private
 * @param {Array} row - è¡Œæ•°æ®
 * @param {Object} condition - æ¡ä»¶å¯¹è±¡
 * @param {Number} index - è¡Œç´¢å¼•
 * @returns {Boolean} æ˜¯å¦æ»¡è¶³
 */
Array2D._checkCondition = function(row, condition, index) {
    var self = this;
    var column = condition.column;
    var operator = condition.operator;
    var value = condition.value;
    var logic = condition.logic || 'and'; // and / or
    
    // è·å–åˆ—å€¼
    var colIndex = -1;
    if (typeof column === 'string' && column.match(/^f\d+$/i)) {
        colIndex = parseInt(column.substring(1)) - 1;
    } else if (typeof column === 'number') {
        colIndex = column;
    }
    
    var cellValue = colIndex >= 0 ? row[colIndex] : undefined;
    
    // æ‰§è¡Œæ¯”è¾ƒ
    var result = false;
    switch (operator) {
        case '>':
        case 'gt':
            result = cellValue > value;
            break;
        case '>=':
        case 'gte':
            result = cellValue >= value;
            break;
        case '<':
        case 'lt':
            result = cellValue < value;
            break;
        case '<=':
        case 'lte':
            result = cellValue <= value;
            break;
        case '==':
        case '=':
        case 'eq':
            result = cellValue == value;
            break;
        case '===':
            result = cellValue === value;
            break;
        case '!=':
        case '<>':
        case 'neq':
            result = cellValue != value;
            break;
        case 'in':
            result = Array.isArray(value) && value.indexOf(cellValue) >= 0;
            break;
        case 'nin':
        case 'notin':
            result = Array.isArray(value) && value.indexOf(cellValue) < 0;
            break;
        case 'contains':
            result = String(cellValue).indexOf(String(value)) >= 0;
            break;
        case 'startswith':
            result = String(cellValue).indexOf(String(value)) === 0;
            break;
        case 'endswith':
            var str = String(cellValue);
            var suffix = String(value);
            result = str.substring(str.length - suffix.length) === suffix;
            break;
        case 'regex':
        case 'match':
            var regex = typeof value === 'string' ? new RegExp(value) : value;
            result = regex.test(String(cellValue));
            break;
        case 'between':
            if (Array.isArray(value) && value.length >= 2) {
                result = cellValue >= value[0] && cellValue <= value[1];
            }
            break;
        case 'empty':
        case 'isnull':
            result = cellValue === null || cellValue === undefined || cellValue === '';
            break;
        case 'notempty':
        case 'notnull':
            result = cellValue !== null && cellValue !== undefined && cellValue !== '';
            break;
        case 'func':
        case 'function':
            if (typeof value === 'function') {
                result = value(cellValue, row, index);
            }
            break;
        default:
            result = false;
    }
    
    // å¤„ç† and / or å­æ¡ä»¶
    if (condition.and && Array.isArray(condition.and)) {
        for (var i = 0; i < condition.and.length; i++) {
            if (!self._checkCondition(row, condition.and[i], index)) {
                return false;
            }
        }
        return result;
    }
    
    if (condition.or && Array.isArray(condition.or)) {
        if (result) return true;
        for (var i = 0; i < condition.or.length; i++) {
            if (self._checkCondition(row, condition.or[i], index)) {
                return true;
            }
        }
        return false;
    }
    
    return result;
};

/**
 * where - é“¾å¼ç­›é€‰èµ·ç‚¹
 * @param {string|number} column - åˆ—åæˆ–ç´¢å¼•
 * @returns {QueryBuilder} æŸ¥è¯¢æ„å»ºå™¨
 * @example
 * arr.where('f1').gt(0).and('f2').eq('ä¸­å›½').execute();
 */
Array2D.prototype.where = function(column) {
    return new QueryBuilder(this._items, column);
};
Array2D.prototype.zç­›é€‰é“¾ = Array2D.prototype.where;

// ==================== QueryBuilder é“¾å¼ç­›é€‰æ„å»ºå™¨ ====================

/**
 * QueryBuilder - é“¾å¼ç­›é€‰æ„å»ºå™¨
 * @class
 * @param {Array} data - åŸå§‹æ•°æ®
 * @param {string|number} column - åˆå§‹åˆ—
 * @example
 * arr.where('f1').gt(0)
 *    .and('f2').eq('ä¸­å›½')
 *    .or('f3').lt(100)
 *    .execute();
 */
function QueryBuilder(data, column) {
    this._data = data;
    this._conditions = [];
    this._currentColumn = column;
    this._currentLogic = 'and';
}

/**
 * è®¾ç½®å½“å‰æ“ä½œçš„åˆ—
 */
QueryBuilder.prototype.column = function(col) {
    this._currentColumn = col;
    return this;
};

/**
 * å¤§äº
 */
QueryBuilder.prototype.gt = function(value) {
    this._conditions.push({
        logic: this._currentLogic,
        column: this._currentColumn,
        operator: '>',
        value: value
    });
    this._currentLogic = 'and'; // é‡ç½®ä¸ºé»˜è®¤
    return this;
};
QueryBuilder.prototype.greaterThan = QueryBuilder.prototype.gt;
QueryBuilder.prototype.å¤§äº = QueryBuilder.prototype.gt;

/**
 * å¤§äºç­‰äº
 */
QueryBuilder.prototype.gte = function(value) {
    this._conditions.push({
        logic: this._currentLogic,
        column: this._currentColumn,
        operator: '>=',
        value: value
    });
    this._currentLogic = 'and';
    return this;
};
QueryBuilder.prototype.greaterThanOrEqual = QueryBuilder.prototype.gte;
QueryBuilder.prototype.å¤§äºç­‰äº = QueryBuilder.prototype.gte;

/**
 * å°äº
 */
QueryBuilder.prototype.lt = function(value) {
    this._conditions.push({
        logic: this._currentLogic,
        column: this._currentColumn,
        operator: '<',
        value: value
    });
    this._currentLogic = 'and';
    return this;
};
QueryBuilder.prototype.lessThan = QueryBuilder.prototype.lt;
QueryBuilder.prototype.å°äº = QueryBuilder.prototype.lt;

/**
 * å°äºç­‰äº
 */
QueryBuilder.prototype.lte = function(value) {
    this._conditions.push({
        logic: this._currentLogic,
        column: this._currentColumn,
        operator: '<=',
        value: value
    });
    this._currentLogic = 'and';
    return this;
};
QueryBuilder.prototype.lessThanOrEqual = QueryBuilder.prototype.lte;
QueryBuilder.prototype.å°äºç­‰äº = QueryBuilder.prototype.lte;

/**
 * ç­‰äº
 */
QueryBuilder.prototype.eq = function(value) {
    this._conditions.push({
        logic: this._currentLogic,
        column: this._currentColumn,
        operator: '==',
        value: value
    });
    this._currentLogic = 'and';
    return this;
};
QueryBuilder.prototype.equals = QueryBuilder.prototype.eq;
QueryBuilder.prototype.equal = QueryBuilder.prototype.eq;
QueryBuilder.prototype.ç­‰äº = QueryBuilder.prototype.eq;

/**
 * ä¸ç­‰äº
 */
QueryBuilder.prototype.neq = function(value) {
    this._conditions.push({
        logic: this._currentLogic,
        column: this._currentColumn,
        operator: '!=',
        value: value
    });
    this._currentLogic = 'and';
    return this;
};
QueryBuilder.prototype.notEqual = QueryBuilder.prototype.neq;
QueryBuilder.prototype.ä¸ç­‰äº = QueryBuilder.prototype.neq;

/**
 * åŒ…å«
 */
QueryBuilder.prototype.contains = function(value) {
    this._conditions.push({
        logic: this._currentLogic,
        column: this._currentColumn,
        operator: 'contains',
        value: value
    });
    this._currentLogic = 'and';
    return this;
};
QueryBuilder.prototype.contain = QueryBuilder.prototype.contains;
QueryBuilder.prototype.åŒ…å« = QueryBuilder.prototype.contains;

/**
 * åœ¨åˆ—è¡¨ä¸­
 */
QueryBuilder.prototype.in = function(values) {
    this._conditions.push({
        logic: this._currentLogic,
        column: this._currentColumn,
        operator: 'in',
        value: values
    });
    this._currentLogic = 'and';
    return this;
};
QueryBuilder.prototype.åœ¨åˆ—è¡¨ä¸­ = QueryBuilder.prototype.in;

/**
 * ä¸åœ¨åˆ—è¡¨ä¸­
 */
QueryBuilder.prototype.nin = function(values) {
    this._conditions.push({
        logic: this._currentLogic,
        column: this._currentColumn,
        operator: 'nin',
        value: values
    });
    this._currentLogic = 'and';
    return this;
};
QueryBuilder.prototype.notIn = QueryBuilder.prototype.nin;
QueryBuilder.prototype.ä¸åœ¨åˆ—è¡¨ä¸­ = QueryBuilder.prototype.nin;

/**
 * åœ¨èŒƒå›´å†…
 */
QueryBuilder.prototype.between = function(min, max) {
    this._conditions.push({
        logic: this._currentLogic,
        column: this._currentColumn,
        operator: 'between',
        value: [min, max]
    });
    this._currentLogic = 'and';
    return this;
};
QueryBuilder.prototype.åœ¨èŒƒå›´å†… = QueryBuilder.prototype.between;

/**
 * åŒ¹é…æ­£åˆ™
 */
QueryBuilder.prototype.match = function(regex) {
    this._conditions.push({
        logic: this._currentLogic,
        column: this._currentColumn,
        operator: 'match',
        value: regex
    });
    this._currentLogic = 'and';
    return this;
};
QueryBuilder.prototype.regex = QueryBuilder.prototype.match;
QueryBuilder.prototype.åŒ¹é… = QueryBuilder.prototype.match;

/**
 * ä¸ºç©º
 */
QueryBuilder.prototype.isNull = function() {
    this._conditions.push({
        logic: this._currentLogic,
        column: this._currentColumn,
        operator: 'isnull',
        value: null
    });
    this._currentLogic = 'and';
    return this;
};
QueryBuilder.prototype.isEmpty = QueryBuilder.prototype.isNull;
QueryBuilder.prototype.ä¸ºç©º = QueryBuilder.prototype.isNull;

/**
 * ä¸ä¸ºç©º
 */
QueryBuilder.prototype.isNotNull = function() {
    this._conditions.push({
        logic: this._currentLogic,
        column: this._currentColumn,
        operator: 'notnull',
        value: null
    });
    this._currentLogic = 'and';
    return this;
};
QueryBuilder.prototype.isNotEmpty = QueryBuilder.prototype.isNotNull;
QueryBuilder.prototype.ä¸ä¸ºç©º = QueryBuilder.prototype.isNotNull;

/**
 * é€»è¾‘ä¸ - åˆ‡æ¢åˆ° AND æ¨¡å¼
 */
QueryBuilder.prototype.and = function(column) {
    this._currentLogic = 'and';
    if (column !== undefined) {
        this._currentColumn = column;
    }
    return this;
};
QueryBuilder.prototype.ä¸” = QueryBuilder.prototype.and;

/**
 * é€»è¾‘æˆ– - åˆ‡æ¢åˆ° OR æ¨¡å¼
 */
QueryBuilder.prototype.or = function(column) {
    this._currentLogic = 'or';
    if (column !== undefined) {
        this._currentColumn = column;
    }
    return this;
};
QueryBuilder.prototype.æˆ– = QueryBuilder.prototype.or;

/**
 * æ‰§è¡Œç­›é€‰ï¼Œè¿”å› Array2D
 */
QueryBuilder.prototype.execute = function() {
    var self = this;
    var result = this._data.filter(function(row, index) {
        var andGroup = true;
        var orGroup = false;
        var hasOr = false;
        
        for (var i = 0; i < self._conditions.length; i++) {
            var cond = self._conditions[i];
            var match = Array2D._checkCondition(row, cond, index);
            
            if (cond.logic === 'or') {
                hasOr = true;
                orGroup = orGroup || match;
            } else {
                andGroup = andGroup && match;
            }
        }
        
        if (hasOr) {
            return andGroup && orGroup;
        }
        return andGroup;
    });
    
    return new Array2D(result);
};
QueryBuilder.prototype.exec = QueryBuilder.prototype.execute;
QueryBuilder.prototype.run = QueryBuilder.prototype.execute;
QueryBuilder.prototype.æ‰§è¡Œ = QueryBuilder.prototype.execute;
QueryBuilder.prototype.val = QueryBuilder.prototype.execute;

// é™æ€æ–¹æ³•ï¼šç›´æ¥é€šè¿‡ Array2D.where åˆ›å»º
Array2D.where = function(data, column) {
    return new QueryBuilder(data, column);
};

/**
 * æ˜ å°„è½¬æ¢
 * @param {string|Function} mapper - è½¬æ¢å‡½æ•°
 * @returns {Array2D} æ–°å®ä¾‹
 */
Array2D.prototype.zæ˜ å°„ = function(mapper) {
    const fn = typeof mapper === 'function' ? mapper : parseLambda(mapper);
    if (!fn) return this._new([]);
    return this._new(this._items.map(fn));
};
Array2D.prototype.map = Array2D.prototype.zæ˜ å°„;

/**
 * å½’çº¦è®¡ç®—
 * @param {Function} callback - å›è°ƒå‡½æ•°
 * @param {any} initialValue - åˆå§‹å€¼
 * @returns {any} è®¡ç®—ç»“æœ
 */
Array2D.prototype.zå½’çº¦ = function(callback, initialValue) {
    return this._items.reduce(callback, initialValue);
};
Array2D.prototype.reduce = Array2D.prototype.zå½’çº¦;

/**
 * å€’åºå½’çº¦ï¼ˆreduceRightï¼‰- ä»å³å‘å·¦å½’çº¦è®¡ç®—
 * @param {Function} callback - å›è°ƒå‡½æ•°
 * @param {any} initialValue - åˆå§‹å€¼
 * @returns {any} è®¡ç®—ç»“æœ
 * @example
 * Array2D([[1,2],[3,4]]).zå€’åºå½’çº¦((acc, val) => acc + val[0], 0)  // 4
 */
Array2D.prototype.zå€’åºå½’çº¦ = function(callback, initialValue) {
    return this._items.reduceRight(callback, initialValue);
};
Array2D.prototype.reduceRight = Array2D.prototype.zå€’åºå½’çº¦;

/**
 * æ£€æŸ¥æ˜¯å¦å…¨éƒ¨æ»¡è¶³
 * @param {string|Function} predicate - æ¡ä»¶
 * @returns {Boolean} æ˜¯å¦å…¨éƒ¨æ»¡è¶³
 */
Array2D.prototype.zå…¨éƒ¨æ»¡è¶³ = function(predicate) {
    const fn = typeof predicate === 'function' ? predicate : parseLambda(predicate);
    if (!fn) return false;
    return this._items.every(fn);
};
Array2D.prototype.every = Array2D.prototype.zå…¨éƒ¨æ»¡è¶³;

/**
 * æ£€æŸ¥æ˜¯å¦æœ‰æ»¡è¶³
 * @param {string|Function} predicate - æ¡ä»¶
 * @returns {Boolean} æ˜¯å¦æœ‰æ»¡è¶³
 */
Array2D.prototype.zæœ‰æ»¡è¶³ = function(predicate) {
    const fn = typeof predicate === 'function' ? predicate : parseLambda(predicate);
    if (!fn) return false;
    return this._items.some(fn);
};
Array2D.prototype.some = Array2D.prototype.zæœ‰æ»¡è¶³;

// ==================== è¡Œåˆ—æ“ä½œ ====================

/**
 * è·å–è¡Œæ•°
 * @returns {Number} è¡Œæ•°
 */
Array2D.prototype.zè¡Œæ•° = function() {
    return this._items.length;
};
Array2D.prototype.rowCount = Array2D.prototype.zè¡Œæ•°;

/**
 * è·å–åˆ—æ•°
 * @returns {Number} åˆ—æ•°
 */
Array2D.prototype.zåˆ—æ•° = function() {
    return this._items.length > 0 && this._items[0] ? this._items[0].length : 0;
};
Array2D.prototype.colCount = Array2D.prototype.zåˆ—æ•°;

/**
 * è·å–æŒ‡å®šè¡Œ
 * @param {Number} index - è¡Œå·ï¼ˆä»0å¼€å§‹ï¼‰
 * @returns {Array} è¡Œæ•°æ®
 */
Array2D.prototype.zè·å–è¡Œ = function(index) {
    return this._items[index] || [];
};
Array2D.prototype.getRow = Array2D.prototype.zè·å–è¡Œ;

/**
 * è·å–æŒ‡å®šåˆ—
 * @param {Number} index - åˆ—å·ï¼ˆä»0å¼€å§‹ï¼‰
 * @returns {Array} åˆ—æ•°æ®
 */
Array2D.prototype.zè·å–åˆ— = function(index) {
    var result = [];
    for (var i = 0; i < this._items.length; i++) {
        var row = this._items[i];
        if (Array.isArray(row) && index < row.length) {
            result.push(row[index]);
        } else {
            result.push(undefined);
        }
    }
    return result;
};
Array2D.prototype.getCol = Array2D.prototype.zè·å–åˆ—;

/**
 * è·å–ç¬¬ä¸€è¡Œ
 * @returns {Array} ç¬¬ä¸€è¡Œæ•°æ®
 */
Array2D.prototype.zé¦–è¡Œ = function() {
    return this._items[0] || [];
};
Array2D.prototype.firstRow = Array2D.prototype.zé¦–è¡Œ;

/**
 * è·å–æœ€åä¸€è¡Œ
 * @returns {Array} æœ€åä¸€è¡Œæ•°æ®
 */
Array2D.prototype.zæœ«è¡Œ = function() {
    return this._items[this._items.length - 1] || [];
};
Array2D.prototype.lastRow = Array2D.prototype.zæœ«è¡Œ;

/**
 * è·å–ç¬¬ä¸€åˆ—
 * @returns {Array} ç¬¬ä¸€åˆ—æ•°æ®
 */
Array2D.prototype.zé¦–åˆ— = function() {
    return this.zè·å–åˆ—(0);
};
Array2D.prototype.firstCol = Array2D.prototype.zé¦–åˆ—;

/**
 * è·å–æœ€åä¸€åˆ—
 * @returns {Array} æœ€åä¸€åˆ—æ•°æ®
 */
Array2D.prototype.zæœ«åˆ— = function() {
    return this.zè·å–åˆ—(this.zåˆ—æ•°() - 1);
};
Array2D.prototype.lastCol = Array2D.prototype.zæœ«åˆ—;

// ==================== å¢åˆ è¡Œåˆ— ====================

/**
 * æ·»åŠ è¡Œ
 * @param {Array} row - è¡Œæ•°æ®
 * @returns {Array2D} æ–°å®ä¾‹
 */
Array2D.prototype.zæ·»åŠ è¡Œ = function(row) {
    var result = this._items.slice();
    result.push(row);
    return this._new(result);
};
Array2D.prototype.addRow = Array2D.prototype.zæ·»åŠ è¡Œ;

/**
 * æå–åˆ—ï¼ˆpluckï¼‰
 * @param {Number} colIndex - åˆ—ç´¢å¼•
 * @returns {Array} åˆ—æ•°æ®
 * @example
 * Array2D([[1,2,3],[4,5,6]]).zæå–åˆ—(1)  // [2,5]
 */
Array2D.prototype.zæå–åˆ— = function(colIndex) {
    return this.zè·å–åˆ—(colIndex);
};
Array2D.prototype.pluck = Array2D.prototype.zæå–åˆ—;

/**
 * æ·»åŠ åˆ—
 * @param {Array} col - åˆ—æ•°æ®
 * @param {Number} index - æ’å…¥ä½ç½®ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸ºæœ«å°¾ï¼‰
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[1,2],[3,4]]).zæ·»åŠ åˆ—([5,6])        // [[1,2,5],[3,4,6]]
 * Array2D([[1,2],[3,4]]).zæ·»åŠ åˆ—([5,6], 0)     // [[5,1,2],[6,3,4]]
 */
Array2D.prototype.zæ·»åŠ åˆ— = function(col, index) {
    var result = [];
    var colIndex = index !== undefined ? index : this.zåˆ—æ•°();
    for (var i = 0; i < this._items.length; i++) {
        var newRow = this._items[i].slice();
        newRow.splice(colIndex, 0, col[i] !== undefined ? col[i] : null);
        result.push(newRow);
    }
    return this._new(result);
};
Array2D.prototype.addCol = Array2D.prototype.zæ·»åŠ åˆ—;

/**
 * åˆ é™¤è¡Œ
 * @param {Number} index - è¡Œå·
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[1,2],[3,4],[5,6]]).zåˆ é™¤è¡Œ(1)  // [[1,2],[5,6]]
 */
Array2D.prototype.zåˆ é™¤è¡Œ = function(index) {
    // ç´¢å¼•è¾¹ç•Œæ£€æŸ¥
    if (index < 0 || index >= this._items.length) {
        return this._new(this._items.slice());  // ç´¢å¼•æ— æ•ˆï¼Œè¿”å›å‰¯æœ¬
    }
    var result = this._items.slice();
    result.splice(index, 1);
    return this._new(result);
};
Array2D.prototype.deleteRow = Array2D.prototype.zåˆ é™¤è¡Œ;

/**
 * åˆ é™¤åˆ—
 * @param {Number} index - åˆ—å·
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[1,2,3],[4,5,6]]).zåˆ é™¤åˆ—(1)  // [[1,3],[4,6]]
 */
Array2D.prototype.zåˆ é™¤åˆ— = function(index) {
    // ç´¢å¼•è¾¹ç•Œæ£€æŸ¥
    if (index < 0 || index >= this.zåˆ—æ•°()) {
        return this._new(this._items.slice());  // ç´¢å¼•æ— æ•ˆï¼Œè¿”å›å‰¯æœ¬
    }
    var result = [];
    for (var i = 0; i < this._items.length; i++) {
        var newRow = this._items[i].slice();
        newRow.splice(index, 1);
        result.push(newRow);
    }
    return this._new(result);
};
Array2D.prototype.deleteCol = Array2D.prototype.zåˆ é™¤åˆ—;

/**
 * å°¾éƒ¨å¼¹å‡ºä¸€é¡¹ï¼ˆpopï¼‰- åˆ é™¤å¹¶è¿”å›æœ€åä¸€è¡Œ
 * @returns {Array} è¢«åˆ é™¤çš„è¡Œ
 * @example
 * Array2D([[1,2],[3,4],[5,6]]).zå°¾éƒ¨å¼¹å‡ºä¸€é¡¹()  // [5,6]
 */
Array2D.prototype.zå°¾éƒ¨å¼¹å‡ºä¸€é¡¹ = function() {
    if (this._items.length === 0) return undefined;
    return this._items.pop();
};
Array2D.prototype.pop = Array2D.prototype.zå°¾éƒ¨å¼¹å‡ºä¸€é¡¹;

/**
 * è¿½åŠ ä¸€é¡¹ï¼ˆpushï¼‰- å‘æ•°ç»„æœ«å°¾æ·»åŠ è¡Œ
 * @param {...Array} rows - è¦æ·»åŠ çš„è¡Œ
 * @returns {Number} æ·»åŠ åçš„è¡Œæ•°
 * @example
 * Array2D([[1,2],[3,4]]).zè¿½åŠ ä¸€é¡¹([5,6], [7,8])  // 4
 */
Array2D.prototype.zè¿½åŠ ä¸€é¡¹ = function() {
    for (var i = 0; i < arguments.length; i++) {
        this._items.push(arguments[i]);
    }
    return this._items.length;
};
Array2D.prototype.push = Array2D.prototype.zè¿½åŠ ä¸€é¡¹;

/**
 * åˆ é™¤ç¬¬ä¸€ä¸ªï¼ˆshiftï¼‰- åˆ é™¤å¹¶è¿”å›ç¬¬ä¸€è¡Œ
 * @returns {Array} è¢«åˆ é™¤çš„è¡Œ
 * @example
 * Array2D([[1,2],[3,4],[5,6]]).zåˆ é™¤ç¬¬ä¸€ä¸ª()  // [1,2]
 */
Array2D.prototype.zåˆ é™¤ç¬¬ä¸€ä¸ª = function() {
    if (this._items.length === 0) return undefined;
    return this._items.shift();
};
Array2D.prototype.shift = Array2D.prototype.zåˆ é™¤ç¬¬ä¸€ä¸ª;

// ==================== æ’åºå»é‡ ====================

/**
 * sort - åŸç”Ÿæ•°ç»„ sort æ–¹æ³•çš„ä»£ç†ï¼ˆæ”¯æŒé“¾å¼è°ƒç”¨ï¼‰
 * @param {Function} compareFn - æ¯”è¾ƒå‡½æ•°
 * @returns {Array2D} è¿”å›å½“å‰å®ä¾‹ï¼ˆæ”¯æŒé“¾å¼è°ƒç”¨ï¼‰
 * @example
 * Array2D([[3,1],[2,2],[1,3]]).sort((a,b)=>a[0]-b[0]).val()  // [[1,3],[2,2],[3,1]]
 */
Array2D.prototype.sort = function(compareFn) {
    if (compareFn) {
        this._items.sort(compareFn);
    } else {
        this._items.sort();
    }
    return this;  // è¿”å› this æ”¯æŒé“¾å¼è°ƒç”¨
};

/**
 * æŒ‰è§„åˆ™å‡åºï¼ˆsortByï¼‰- ä½¿ç”¨Lambdaè¡¨è¾¾å¼æŒ‡å®šæ’åºé”®è¿›è¡Œå‡åºæ’åº
 * @param {string|Function} keySelector - é”®é€‰æ‹©å™¨
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[3,'C'],[1,'A'],[2,'B']]).zæŒ‰è§„åˆ™å‡åº('x=>x[0]')  // [[1,'A'],[2,'B'],[3,'C']]
 */
Array2D.prototype.zæŒ‰è§„åˆ™å‡åº = function(keySelector) {
    var fn = typeof keySelector === 'function' ? keySelector : parseLambda(keySelector);
    if (!fn) return this._new(this._items.slice());
    var result = this._items.slice();
    result.sort(function(a, b) {
        var valA = fn(a);
        var valB = fn(b);
        if (valA < valB) return -1;
        if (valA > valB) return 1;
        return 0;
    });
    return this._new(result);
};
Array2D.prototype.sortBy = Array2D.prototype.zæŒ‰è§„åˆ™å‡åº;

/**
 * æŒ‰è§„åˆ™é™åºï¼ˆsortByDescï¼‰- ä½¿ç”¨Lambdaè¡¨è¾¾å¼æŒ‡å®šæ’åºé”®è¿›è¡Œé™åºæ’åº
 * @param {string|Function} keySelector - é”®é€‰æ‹©å™¨
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[3,'C'],[1,'A'],[2,'B']]).zæŒ‰è§„åˆ™é™åº('x=>x[0]')  // [[3,'C'],[2,'B'],[1,'A']]
 */
Array2D.prototype.zæŒ‰è§„åˆ™é™åº = function(keySelector) {
    var fn = typeof keySelector === 'function' ? keySelector : parseLambda(keySelector);
    if (!fn) return this._new(this._items.slice());
    var result = this._items.slice();
    result.sort(function(a, b) {
        var valA = fn(a);
        var valB = fn(b);
        if (valA > valB) return -1;
        if (valA < valB) return 1;
        return 0;
    });
    return this._new(result);
};
Array2D.prototype.sortByDesc = Array2D.prototype.zæŒ‰è§„åˆ™é™åº;

/**
 * é™åºæ’åºï¼ˆsortDescï¼‰- æŒ‰é¦–åˆ—é™åºæ’åº
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[3,'C'],[1,'A'],[2,'B']]).zé™åºæ’åº()  // [[3,'C'],[2,'B'],[1,'A']]
 */
Array2D.prototype.zé™åºæ’åº = function() {
    var result = this._items.slice();
    result.sort(function(a, b) {
        var valA = a[0];
        var valB = b[0];
        if (valA > valB) return -1;
        if (valA < valB) return 1;
        return 0;
    });
    return this._new(result);
};
Array2D.prototype.sortDesc = Array2D.prototype.zé™åºæ’åº;

/**
 * å‡åºæ’åº - æŒ‰é¦–åˆ—å‡åºæ’åº
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[3,'C'],[1,'A'],[2,'B']]).zå‡åºæ’åº()  // [[1,'A'],[2,'B'],[3,'C']]
 */
Array2D.prototype.zå‡åºæ’åº = function() {
    var result = this._items.slice();
    result.sort(function(a, b) {
        var valA = a[0];
        var valB = b[0];
        if (valA < valB) return -1;
        if (valA > valB) return 1;
        return 0;
    });
    return this._new(result);
};
Array2D.prototype.sortAsc = Array2D.prototype.zå‡åºæ’åº;

/**
 * è¡Œæ’åº
 * @param {Number} colIndex - æ’åºä¾æ®çš„åˆ—
 * @param {Boolean} ascending - æ˜¯å¦å‡åº
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[1,3],[2,2],[3,1]]).zè¡Œæ’åº(1)       // [[3,1],[2,2],[1,3]]
 * Array2D([[1,3],[2,2],[3,1]]).zè¡Œæ’åº(1, false)  // [[1,3],[2,2],[3,1]] é™åº
 */
Array2D.prototype.zè¡Œæ’åº = function(colIndex, ascending) {
    ascending = ascending !== undefined ? ascending : true;
    // åˆ—è¾¹ç•Œæ£€æŸ¥
    if (colIndex < 0 || colIndex >= this.zåˆ—æ•°()) {
        return this._new(this._items.slice());  // åˆ—ç´¢å¼•æ— æ•ˆï¼Œè¿”å›å‰¯æœ¬
    }
    var result = this._items.slice();
    result.sort(function(a, b) {
        var valA = a[colIndex];
        var valB = b[colIndex];
        if (valA < valB) return ascending ? -1 : 1;
        if (valA > valB) return ascending ? 1 : -1;
        return 0;
    });
    return this._new(result);
};
Array2D.prototype.sortRow = Array2D.prototype.zè¡Œæ’åº;

/**
 * åˆ—æ’åº
 * @param {Number} rowIndex - æ’åºä¾æ®çš„è¡Œ
 * @param {Boolean} ascending - æ˜¯å¦å‡åº
 * @returns {Array2D} æ–°å®ä¾‹
 */
Array2D.prototype.zåˆ—æ’åº = function(rowIndex, ascending) {
    ascending = ascending !== undefined ? ascending : true;
    if (!this._items[rowIndex]) return this._new([]);
    var colCount = this._items[rowIndex].length;
    var indices = [];
    for (var i = 0; i < colCount; i++) indices.push(i);
    indices.sort(function(a, b) {
        var valA = this._items[rowIndex][a];
        var valB = this._items[rowIndex][b];
        if (valA < valB) return ascending ? -1 : 1;
        if (valA > valB) return ascending ? 1 : -1;
        return 0;
    }.bind(this));
    var result = [];
    for (var r = 0; r < this._items.length; r++) {
        var newRow = [];
        for (var i = 0; i < indices.length; i++) {
            newRow.push(this._items[r][indices[i]]);
        }
        result.push(newRow);
    }
    return this._new(result);
};
Array2D.prototype.sortCol = Array2D.prototype.zåˆ—æ’åº;

/**
 * å¤šåˆ—æ’åº - æŒ‰å¤šåˆ—æ’åºï¼Œæ”¯æŒæŒ‡å®šæ¯åˆ—çš„å‡é™åº
 * @param {string} sortParams - æ’åºå‚æ•° 'f3+,f4-' è¡¨ç¤ºç¬¬3åˆ—å‡åºç¬¬4åˆ—é™åº
 * @param {number} [headerRows=0] - è¡¨å¤´çš„è¡Œæ•°ï¼ˆä¸å‚ä¸æ’åºï¼‰
 * @param {string} [customOrder] - è‡ªå®šä¹‰åºåˆ—ï¼Œé€—å·åˆ†éš”
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D(arr).zå¤šåˆ—æ’åº('f3+,f4-', 1)  // ç¬¬3åˆ—å‡åºï¼Œç¬¬4åˆ—é™åºï¼Œç¬¬1è¡Œä¸ºè¡¨å¤´
 */
Array2D.prototype.zå¤šåˆ—æ’åº = function(sortParams, headerRows, customOrder) {
    // ğŸ”§ v3.7.9 ä¿®å¤: å¦‚æœæ²¡æœ‰æŒ‡å®š headerRows ä½†å¯¹è±¡æœ‰ _header å±æ€§ï¼Œè‡ªåŠ¨è®¾ä¸º 1
    if (headerRows === undefined && '_header' in this && this._header !== undefined) {
        headerRows = 1;
        // Console.log('[zå¤šåˆ—æ’åº DEBUG] Auto-detected headerRows=1 from _header');
    }
    headerRows = headerRows || 0;

    // è§£ææ’åºå‚æ•°
    var sorts = [];
    var parts = sortParams.split(',');
    for (var i = 0; i < parts.length; i++) {
        var part = parts[i].trim();
        var match = part.match(/f?(\d+)([+-])/);
        if (match) {
            sorts.push({
                col: parseInt(match[1]),
                order: match[2] === '+' ? 1 : 2 // 1å‡åº 2é™åº
            });
        }
    }

    if (this._items.length <= headerRows) return this._new(this._items.slice());

    // åˆ†ç¦»è¡¨å¤´å’Œæ•°æ®
    var header = this._items.slice(0, headerRows);
    var data = this._items.slice(headerRows);

    // æ’åº
    data.sort(function(a, b) {
        for (var s = 0; s < sorts.length; s++) {
            var sort = sorts[s];
            var colIdx = sort.col - 1;
            var valA = a[colIdx];
            var valB = b[colIdx];

            // è‡ªå®šä¹‰åºåˆ—å¤„ç†
            if (customOrder) {
                var orderArr = customOrder.split(',');
                var idxA = orderArr.indexOf(String(valA));
                var idxB = orderArr.indexOf(String(valB));
                if (idxA >= 0 && idxB >= 0) {
                    valA = idxA;
                    valB = idxB;
                }
            }

            if (valA < valB) return sort.order === 1 ? -1 : 1;
            if (valA > valB) return sort.order === 1 ? 1 : -1;
        }
        return 0;
    });

    return this._new(header.concat(data));
};
Array2D.prototype.sortByCols = Array2D.prototype.zå¤šåˆ—æ’åº;

/**
 * è‡ªå®šä¹‰æ’åº - æŒ‰æŒ‡å®šåˆ—è¡¨çš„é¡ºåºæ’åº
 * @param {number|string} colIndex - åˆ—ç´¢å¼•ï¼ˆæ”¯æŒæ•°å­—0ç´¢å¼•æˆ– "f3" æ ¼å¼1ç´¢å¼•ï¼‰
 * @param {Array|string} orderList - æ’åºåˆ—è¡¨ï¼ˆæ•°ç»„æˆ–é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²ï¼‰
 * @param {number} [headerRows=0] - è¡¨å¤´çš„è¡Œæ•°ï¼ˆä¸å‚ä¸æ’åºï¼‰
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D(arr).zè‡ªå®šä¹‰æ’åº("f3", "ä¸­å›½,è‹±å›½,ç¾å›½,å¾·å›½")
 * Array2D(arr).sortByList(2, ["ä¸­å›½", "è‹±å›½", "ç¾å›½", "å¾·å›½"], 1)
 */
Array2D.prototype.zè‡ªå®šä¹‰æ’åº = function(colIndex, orderList, headerRows) {
    headerRows = headerRows || 0;

    // å¤„ç†åˆ—ç´¢å¼•ï¼šæ”¯æŒ f3 æ ¼å¼ï¼ˆä»1å¼€å§‹çš„åˆ—å·ï¼‰æˆ–æ•°å­—ç´¢å¼•
    var actualColIndex = colIndex;
    if (typeof colIndex === 'string' && colIndex.toLowerCase().startsWith('f')) {
        actualColIndex = parseInt(colIndex.substring(1)) - 1;
    }

    // å¤„ç†æ’åºåˆ—è¡¨ï¼šæ”¯æŒé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²æˆ–æ•°ç»„
    var actualOrderList = orderList;
    if (typeof orderList === 'string') {
        actualOrderList = orderList.split(',').map(function(s) { return s.trim(); });
    }

    if (this._items.length <= headerRows) return this._new(this._items.slice());

    // åˆ†ç¦»è¡¨å¤´å’Œæ•°æ®
    var header = this._items.slice(0, headerRows);
    var data = this._items.slice(headerRows);

    data.sort(function(a, b) {
        var valA = a[actualColIndex];
        var valB = b[actualColIndex];
        var indexA = actualOrderList.indexOf(valA);
        var indexB = actualOrderList.indexOf(valB);

        // ä¸åœ¨åˆ—è¡¨ä¸­çš„å€¼æ”¾åˆ°æœ€å
        var posA = indexA === -1 ? 999 : indexA;
        var posB = indexB === -1 ? 999 : indexB;

        return posA - posB;
    });

    return this._new(header.concat(data));
};
Array2D.prototype.sortByList = Array2D.prototype.zè‡ªå®šä¹‰æ’åº;

/**
 * å»é‡
 * @param {Number|String|Array|Function} [colSelector] - ä¾æ®å“ªä¸€åˆ—æˆ–å¤šåˆ—å»é‡ï¼ˆå¯é€‰ï¼‰
 *   - Number: åˆ—ç´¢å¼•ï¼ˆ0-basedï¼‰
 *   - String: åˆ—é€‰æ‹©å™¨ï¼Œå¦‚ 'f1'ï¼ˆç¬¬1åˆ—ï¼‰ã€'f1,f2'ï¼ˆç¬¬1,2åˆ—ç»„åˆå»é‡ï¼‰
 *   - Array: åˆ—ç´¢å¼•æ•°ç»„ï¼Œå¦‚ [0, 1]
 *   - Function: è‡ªå®šä¹‰é”®ç”Ÿæˆå‡½æ•°ï¼Œå¦‚ x=>[x.f1,x.f2]
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * // å•è¡Œå»é‡ï¼ˆæŒ‰ç¬¬1åˆ—ï¼‰
 * Array2D([[1,2],[1,3],[2,4]]).zå»é‡(0)  // [[1,2],[2,4]]
 * // fæ¨¡å¼å•åˆ—å»é‡
 * Array2D([[1,2],[1,3],[2,4]]).zå»é‡('f1')  // [[1,2],[2,4]]
 * // å¤šåˆ—ç»„åˆå»é‡
 * Array2D([[1,2],[1,3],[1,2]]).zå»é‡('f1,f2')  // [[1,2],[1,3]]
 * // Lambdaå‡½æ•°å»é‡
 * Array2D([[1,2],[1,3],[2,4]]).zå»é‡(x=>x.f1)  // [[1,2],[2,4]]
 * Array2D([[1,2],[1,3],[1,2]]).zå»é‡(x=>[x.f1,x.f2])  // [[1,2],[1,3]]
 * // æ•´è¡Œå»é‡ï¼ˆä¸ä¼ å‚æ•°ï¼‰
 * Array2D([[1,2],[1,2],[2,4]]).zå»é‡()  // [[1,2],[2,4]]
 */
Array2D.prototype.zå»é‡ = function(colSelector) {
    var seen = Object.create(null);
    var result = [];
    
    // å¤„ç†ä¸åŒçš„å‚æ•°ç±»å‹
    var keyFn;
    if (colSelector === undefined) {
        // æ•´è¡Œå»é‡
        keyFn = function(row) { return JSON.stringify(row); };
    } else if (typeof colSelector === 'function') {
        // å‡½æ•°å›è°ƒæ¨¡å¼
        keyFn = colSelector;
    } else if (typeof colSelector === 'number') {
        // æ•°å­—ç´¢å¼•
        keyFn = function(row) { return row[colSelector]; };
    } else if (typeof colSelector === 'string') {
        // å­—ç¬¦ä¸²æ¨¡å¼ï¼šæ”¯æŒ 'f1' æˆ– 'f1,f2' æˆ– 'f1,f3-f5'
        if (colSelector.includes(',')) {
            // å¤šåˆ—ç»„åˆ
            var colIndexes = [];
            var parts = colSelector.split(',');
            for (var p = 0; p < parts.length; p++) {
                var part = parts[p].trim();
                if (part.toLowerCase().startsWith('f')) {
                    colIndexes.push(parseInt(part.substring(1)) - 1);
                } else if (part.includes('-')) {
                    // å¤„ç†èŒƒå›´ f3-f5
                    var range = part.split('-');
                    var start = parseInt(range[0].toLowerCase().replace('f', ''));
                    var end = parseInt(range[1].toLowerCase().replace('f', ''));
                    for (var r = start; r <= end; r++) {
                        colIndexes.push(r - 1);
                    }
                } else {
                    colIndexes.push(parseInt(part) - 1);
                }
            }
            keyFn = function(row) {
                var keyParts = [];
                for (var i = 0; i < colIndexes.length; i++) {
                    keyParts.push(row[colIndexes[i]]);
                }
                return JSON.stringify(keyParts);
            };
        } else if (colSelector.toLowerCase().startsWith('f')) {
            // å•åˆ— fæ¨¡å¼
            var colIdx = parseInt(colSelector.substring(1)) - 1;
            keyFn = function(row) { return row[colIdx]; };
        } else {
            // æ™®é€šå­—ç¬¦ä¸²ï¼Œå½“ä½œæ•´è¡Œå»é‡
            keyFn = function(row) { return JSON.stringify(row); };
        }
    } else if (Array.isArray(colSelector)) {
        // æ•°ç»„æ¨¡å¼ [0, 1, 2]
        keyFn = function(row) {
            var keyParts = [];
            for (var i = 0; i < colSelector.length; i++) {
                keyParts.push(row[colSelector[i]]);
            }
            return JSON.stringify(keyParts);
        };
    } else {
        // é»˜è®¤æ•´è¡Œå»é‡
        keyFn = function(row) { return JSON.stringify(row); };
    }
    
    for (var i = 0; i < this._items.length; i++) {
        var row = this._items[i];
        var key = keyFn(row);
        var keyStr = typeof key === 'string' ? key : JSON.stringify(key);
        if (!seen[keyStr]) {
            seen[keyStr] = true;
            result.push(row);
        }
    }
    return this._new(result);
};
Array2D.prototype.distinct = Array2D.prototype.zå»é‡;
Array2D.prototype.zDistinct = Array2D.prototype.zå»é‡;

/**
 * è½¬çŸ©é˜µï¼ˆtoMatrixï¼‰- è½¬æ¢ä¸ºæ ‡å‡†çŸ©é˜µæ ¼å¼ï¼Œè¡¥é½ç¼ºå¤±åˆ—
 * @param {any} fillValue - å¡«å……å€¼ï¼Œé»˜è®¤ä¸ºnull
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[1,2],[3,4,5],[6]]).zè½¬çŸ©é˜µ()  // [[1,2,null],[3,4,5],[6,null,null]]
 */
Array2D.prototype.zè½¬çŸ©é˜µ = function(fillValue) {
    fillValue = fillValue !== undefined ? fillValue : null;
    if (this._items.length === 0) return this._new([]);

    // æ‰¾å‡ºæœ€å¤§åˆ—æ•°
    var maxCols = 0;
    for (var i = 0; i < this._items.length; i++) {
        var row = this._items[i];
        var rowLen = Array.isArray(row) ? row.length : 1;
        if (rowLen > maxCols) maxCols = rowLen;
    }

    var result = [];
    for (var i = 0; i < this._items.length; i++) {
        var row = this._items[i];
        if (Array.isArray(row)) {
            var newRow = row.slice();
            while (newRow.length < maxCols) {
                newRow.push(fillValue);
            }
            result.push(newRow);
        } else {
            var newRow = [row];
            while (newRow.length < maxCols) {
                newRow.push(fillValue);
            }
            result.push(newRow);
        }
    }
    return this._new(result);
};
Array2D.prototype.toMatrix = Array2D.prototype.zè½¬çŸ©é˜µ;

// ==================== åˆ†ç»„é€è§† ====================

/**
 * åˆ†ç»„
 * @param {string|Function} keySelector - åˆ†ç»„é”®é€‰æ‹©å™¨
 * @param {string|Function} valSelector - å€¼é€‰æ‹©å™¨
 * @returns {Object} åˆ†ç»„ç»“æœ
 */
Array2D.prototype.zåˆ†ç»„ = function(keySelector, valSelector) {
    var keyFn = typeof keySelector === 'function' ? keySelector : parseLambda(keySelector);
    var valFn = valSelector ? (typeof valSelector === 'function' ? valSelector : parseLambda(valSelector)) : null;

    var groups = Object.create(null);
    for (var i = 0; i < this._items.length; i++) {
        var row = this._items[i];
        var key = keyFn ? keyFn(row, i) : row[0];
        var val = valFn ? valFn(row, i) : row;
        if (!groups[key]) groups[key] = [];
        groups[key].push(val);
    }
    return groups;
};
Array2D.prototype.groupBy = Array2D.prototype.zåˆ†ç»„;

/**
 * æ•°æ®é€è§†ï¼ˆpivotByï¼‰- åˆ›å»ºæ•°æ®é€è§†è¡¨
 * @param {Number|Function} rowField - è¡Œå­—æ®µç´¢å¼•æˆ–é€‰æ‹©å™¨
 * @param {Number|Function} colField - åˆ—å­—æ®µç´¢å¼•æˆ–é€‰æ‹©å™¨
 * @param {Number|Function} valueField - å€¼å­—æ®µç´¢å¼•æˆ–é€‰æ‹©å™¨
 * @param {Function} aggregator - èšåˆå‡½æ•°ï¼Œé»˜è®¤ä¸ºæ±‚å’Œ
 * @returns {Array2D} æ–°å®ä¾‹ï¼ˆé€è§†è¡¨ï¼‰
 * @example
 * // æ•°æ®: [[äº§å“, åœ°åŒº, é”€é‡], ['A', 'åŒ—äº¬', 100], ['A', 'ä¸Šæµ·', 200]]
 * Array2D(data).zé€è§†(0, 1, 2)  // æŒ‰äº§å“(è¡Œ)ã€åœ°åŒº(åˆ—)é€è§†é”€é‡
 */
Array2D.prototype.zé€è§† = function(rowField, colField, valueField, aggregator) {
    if (this._items.length === 0) return this._new([]);

    // é»˜è®¤èšåˆå‡½æ•°ä¸ºæ±‚å’Œ
    var agg = aggregator || function(acc, val) {
        var num1 = typeof acc === 'number' ? acc : parseFloat(String(acc).replace(/,/g, ''));
        var num2 = typeof val === 'number' ? val : parseFloat(String(val).replace(/,/g, ''));
        return (isNaN(num1) ? 0 : num1) + (isNaN(num2) ? 0 : num2);
    };

    var rowValues = [];
    var colValues = [];
    var pivotData = Object.create(null);

    // è¾…åŠ©å‡½æ•°ï¼šè·å–å­—æ®µå€¼
    var getFieldValue = function(row, field, index) {
        if (typeof field === 'function') return field(row, index);
        if (Array.isArray(row)) return row[field];
        return row;
    };

    // ç¬¬ä¸€éï¼šæ”¶é›†æ‰€æœ‰è¡Œå’Œåˆ—çš„å€¼
    for (var i = 0; i < this._items.length; i++) {
        var row = this._items[i];
        var rowKey = String(getFieldValue(row, rowField, i));
        var colKey = String(getFieldValue(row, colField, i));
        var value = getFieldValue(row, valueField, i);

        // æ”¶é›†è¡Œå€¼
        if (rowValues.indexOf(rowKey) === -1) rowValues.push(rowKey);
        // æ”¶é›†åˆ—å€¼
        if (colValues.indexOf(colKey) === -1) colValues.push(colKey);

        // åˆå§‹åŒ–æ•°æ®ç»“æ„
        if (!pivotData[rowKey]) pivotData[rowKey] = Object.create(null);

        // èšåˆå€¼
        if (pivotData[rowKey][colKey] === undefined) {
            pivotData[rowKey][colKey] = value;
        } else {
            pivotData[rowKey][colKey] = agg(pivotData[rowKey][colKey], value);
        }
    }

    // æ’åº
    rowValues.sort();
    colValues.sort();

    // æ„å»ºç»“æœè¡¨
    var result = [];

    // è¡¨å¤´
    var header = ['è¡Œ\\åˆ—'].concat(colValues);
    result.push(header);

    // æ•°æ®è¡Œ
    for (var r = 0; r < rowValues.length; r++) {
        var rowKey = rowValues[r];
        var rowData = [rowKey];
        for (var c = 0; c < colValues.length; c++) {
            var colKey = colValues[c];
            var value = pivotData[rowKey] && pivotData[rowKey][colKey] !== undefined
                ? pivotData[rowKey][colKey]
                : 0;
            rowData.push(value);
        }
        result.push(rowData);
    }

    return this._new(result);
};
Array2D.prototype.pivotBy = Array2D.prototype.zé€è§†;

// ==================== è¿æ¥ç›¸å…³æ–¹æ³• ====================

/**
 * ä¸Šä¸‹è¿æ¥ï¼ˆconcatï¼‰- å°†ä¸¤ä¸ªæˆ–å¤šä¸ªæ•°ç»„æŒ‰è¡Œè¿æ¥
 * @param {Array} brr - ç¬¬äºŒä¸ªæ•°ç»„æˆ–å¤šä¸ªæ•°ç»„
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[1,2],[3,4]]).zä¸Šä¸‹è¿æ¥([[5,6]])  // [[1,2],[3,4],[5,6]]
 */
Array2D.prototype.zä¸Šä¸‹è¿æ¥ = function() {
    var result = this._items.slice();
    for (var i = 0; i < arguments.length; i++) {
        var arr = arguments[i];
        if (Array.isArray(arr)) {
            if (arr.length > 0 && Array.isArray(arr[0])) {
                result = result.concat(arr);
            } else {
                result.push(arr);
            }
        }
    }
    return this._new(result);
};
Array2D.prototype.concat = Array2D.prototype.zä¸Šä¸‹è¿æ¥;

/**
 * å·¦è¿æ¥ï¼ˆleftjoinï¼‰- ä»¥å·¦è¡¨ä¸ºå‡†çš„å·¦å¤–è¿æ¥
 * @param {Array} brr - å³è¡¨æ•°ç»„
 * @param {string|Function} leftKeySelector - å·¦è¡¨é”®é€‰æ‹©å™¨
 * @param {string|Function} rightKeySelector - å³è¡¨é”®é€‰æ‹©å™¨
 * @param {Function} resultSelector - ç»“æœé€‰æ‹©å™¨
 * @returns {Array2D} æ–°å®ä¾‹
 */
Array2D.prototype.zå·¦è¿æ¥ = function(brr, leftKeySelector, rightKeySelector, resultSelector) {
    var leftFn = leftKeySelector ? parseLambda(leftKeySelector) : function(row) { return JSON.stringify(row); };
    var rightFn = rightKeySelector ? parseLambda(rightKeySelector) : function(row) { return JSON.stringify(row); };
    var resFn = resultSelector || function(a, b) { return a.concat(b || []); };

    var result = [];
    for (var i = 0; i < this._items.length; i++) {
        var leftRow = this._items[i];
        var leftKey = leftFn(leftRow, i);
        var matched = null;
        for (var j = 0; j < brr.length; j++) {
            if (leftKey === rightFn(brr[j], j)) {
                matched = brr[j];
                break;
            }
        }
        result.push(resFn(leftRow.slice(), matched ? matched.slice() : []));
    }
    return this._new(result);
};
Array2D.prototype.leftjoin = Array2D.prototype.zå·¦è¿æ¥;

/**
 * å·¦å³å…¨è¿æ¥ï¼ˆfulljoinï¼‰- å…¨å¤–è¿æ¥
 * @param {Array} brr - å³è¡¨æ•°ç»„
 * @param {string|Function} leftKeySelector - å·¦è¡¨é”®é€‰æ‹©å™¨
 * @param {string|Function} rightKeySelector - å³è¡¨é”®é€‰æ‹©å™¨
 * @param {Function} resultSelector - ç»“æœé€‰æ‹©å™¨
 * @returns {Array2D} æ–°å®ä¾‹
 */
Array2D.prototype.zå·¦å³å…¨è¿æ¥ = function(brr, leftKeySelector, rightKeySelector, resultSelector) {
    var leftFn = leftKeySelector ? parseLambda(leftKeySelector) : function(row) { return JSON.stringify(row); };
    var rightFn = rightKeySelector ? parseLambda(rightKeySelector) : function(row) { return JSON.stringify(row); };
    var resFn = resultSelector || function(a, b) { return a.concat(b || []); };

    var leftKeys = [];
    var rightKeys = [];
    var rightMap = Object.create(null);

    for (var i = 0; i < this._items.length; i++) {
        var key = leftFn(this._items[i], i);
        if (leftKeys.indexOf(key) === -1) leftKeys.push(key);
    }

    for (var j = 0; j < brr.length; j++) {
        var key = rightFn(brr[j], j);
        if (rightKeys.indexOf(key) === -1) rightKeys.push(key);
        if (!rightMap[key]) rightMap[key] = [];
        rightMap[key].push(brr[j]);
    }

    var allKeys = [];
    for (var k = 0; k < leftKeys.length; k++) {
        if (allKeys.indexOf(leftKeys[k]) === -1) allKeys.push(leftKeys[k]);
    }
    for (var k = 0; k < rightKeys.length; k++) {
        if (allKeys.indexOf(rightKeys[k]) === -1) allKeys.push(rightKeys[k]);
    }

    var result = [];
    for (var i = 0; i < allKeys.length; i++) {
        var key = allKeys[i];
        var leftRows = this._items.filter(function(row, idx) { return leftFn(row, idx) === key; });
        var rightRows = rightMap[key] || [];

        if (leftRows.length > 0 && rightRows.length > 0) {
            for (var lr = 0; lr < leftRows.length; lr++) {
                for (var rr = 0; rr < rightRows.length; rr++) {
                    result.push(resFn(leftRows[lr].slice(), rightRows[rr].slice()));
                }
            }
        } else if (leftRows.length > 0) {
            for (var lr = 0; lr < leftRows.length; lr++) {
                result.push(resFn(leftRows[lr].slice(), []));
            }
        } else {
            for (var rr = 0; rr < rightRows.length; rr++) {
                result.push(resFn([], rightRows[rr].slice()));
            }
        }
    }

    return this._new(result);
};
Array2D.prototype.fulljoin = Array2D.prototype.zå·¦å³å…¨è¿æ¥;

/**
 * ä¸€å¯¹å¤šè¿æ¥ï¼ˆleftFulljoinï¼‰- å·¦è¡¨æ‰€æœ‰è¡Œä¸å³è¡¨åŒ¹é…çš„æ‰€æœ‰è¡Œè¿æ¥
 * @param {Array} brr - å³è¡¨æ•°ç»„
 * @param {string|Function} leftKeySelector - å·¦è¡¨é”®é€‰æ‹©å™¨
 * @param {string|Function} rightKeySelector - å³è¡¨é”®é€‰æ‹©å™¨
 * @param {Function} resultSelector - ç»“æœé€‰æ‹©å™¨
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * arr.leftFulljoin(brr, 'f1', 'f1')
 */
Array2D.prototype.zä¸€å¯¹å¤šè¿æ¥ = function(brr, leftKeySelector, rightKeySelector, resultSelector) {
    var leftFn = leftKeySelector ? parseLambda(leftKeySelector) : function(row) { return row[0]; };
    var rightFn = rightKeySelector ? parseLambda(rightKeySelector) : function(row) { return row[0]; };
    var resFn = resultSelector || function(a, b) { return a.concat(b || []); };

    var rightMap = Object.create(null);
    for (var j = 0; j < brr.length; j++) {
        var key = rightFn(brr[j], j);
        if (!rightMap[key]) rightMap[key] = [];
        rightMap[key].push(brr[j]);
    }

    var result = [];
    for (var i = 0; i < this._items.length; i++) {
        var leftRow = this._items[i];
        var key = leftFn(leftRow, i);
        var rightRows = rightMap[key] || [];
        if (rightRows.length === 0) {
            result.push(resFn(leftRow.slice(), []));
        } else {
            for (var r = 0; r < rightRows.length; r++) {
                result.push(resFn(leftRow.slice(), rightRows[r].slice()));
            }
        }
    }
    return this._new(result);
};
Array2D.prototype.leftFulljoin = Array2D.prototype.zä¸€å¯¹å¤šè¿æ¥;

/**
 * å·¦å³è¿æ¥ï¼ˆzipï¼‰- æŒ‰è¡Œå·¦å³æ‹¼æ¥
 * @param {...Array} arrays - è¦æ‹¼æ¥çš„æ•°ç»„
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * Array2D([[1,2],[3,4]]).zå·¦å³è¿æ¥([[5],[6]])  // [[1,2,5],[3,4,6]]
 */
Array2D.prototype.zå·¦å³è¿æ¥ = function() {
    var arrays = [this._items];
    for (var i = 0; i < arguments.length; i++) {
        arrays.push(arguments[i]);
    }

    var maxRows = 0;
    for (var a = 0; a < arrays.length; a++) {
        if (arrays[a].length > maxRows) maxRows = arrays[a].length;
    }

    var result = [];
    for (var r = 0; r < maxRows; r++) {
        var row = [];
        for (var a = 0; a < arrays.length; a++) {
            var arr = arrays[a];
            if (r < arr.length) {
                var rowData = arr[r];
                if (Array.isArray(rowData)) {
                    row = row.concat(rowData);
                } else {
                    row.push(rowData);
                }
            }
        }
        result.push(row);
    }

    return this._new(result);
};
Array2D.prototype.zip = Array2D.prototype.zå·¦å³è¿æ¥;

/**
 * æ’é™¤ï¼ˆexceptï¼‰- ä»å·¦è¡¨æ’é™¤ä¸å³è¡¨ç›¸åŒçš„å…ƒç´ 
 * @param {Array} brr - å³è¡¨æ•°ç»„
 * @param {string|Function} leftSelector - å·¦è¡¨é€‰æ‹©å™¨
 * @param {string|Function} rightSelector - å³è¡¨é€‰æ‹©å™¨
 * @returns {Array2D} æ–°å®ä¾‹
 */
Array2D.prototype.zæ’é™¤ = function(brr, leftSelector, rightSelector) {
    var leftFn = leftSelector ? parseLambda(leftSelector) : function(row) { return JSON.stringify(row); };
    var rightFn = rightSelector ? parseLambda(rightSelector) : function(row) { return JSON.stringify(row); };

    var rightKeys = [];
    for (var j = 0; j < brr.length; j++) {
        rightKeys.push(rightFn(brr[j], j));
    }

    var result = [];
    for (var i = 0; i < this._items.length; i++) {
        var key = leftFn(this._items[i], i);
        if (rightKeys.indexOf(key) === -1) {
            result.push(this._items[i]);
        }
    }

    return this._new(result);
};
Array2D.prototype.except = Array2D.prototype.zæ’é™¤;

/**
 * å–äº¤é›†ï¼ˆintersectï¼‰- è·å–ä¸¤ä¸ªæ•°ç»„çš„äº¤é›†
 * @param {Array} brr - å³è¡¨æ•°ç»„
 * @param {string|Function} leftSelector - å·¦è¡¨é€‰æ‹©å™¨
 * @param {string|Function} rightSelector - å³è¡¨é€‰æ‹©å™¨
 * @returns {Array2D} æ–°å®ä¾‹
 */
Array2D.prototype.zå–äº¤é›† = function(brr, leftSelector, rightSelector) {
    var leftFn = leftSelector ? parseLambda(leftSelector) : function(row) { return JSON.stringify(row); };
    var rightFn = rightSelector ? parseLambda(rightSelector) : function(row) { return JSON.stringify(row); };

    var rightKeys = [];
    var rightMap = Object.create(null);
    for (var j = 0; j < brr.length; j++) {
        var key = rightFn(brr[j], j);
        rightKeys.push(key);
        if (!rightMap[key]) rightMap[key] = [];
        rightMap[key].push(brr[j]);
    }

    var result = [];
    for (var i = 0; i < this._items.length; i++) {
        var key = leftFn(this._items[i], i);
        if (rightKeys.indexOf(key) !== -1) {
            result.push(this._items[i]);
        }
    }

    return this._new(result);
};
Array2D.prototype.intersect = Array2D.prototype.zå–äº¤é›†;

/**
 * å»é‡å¹¶é›†ï¼ˆunionï¼‰- åˆå¹¶ä¸¤ä¸ªæ•°ç»„å¹¶å»é‡
 * @param {Array} brr - å³è¡¨æ•°ç»„
 * @param {string|Function} keySelector - é”®é€‰æ‹©å™¨
 * @returns {Array2D} æ–°å®ä¾‹
 */
Array2D.prototype.zå»é‡å¹¶é›† = function(brr, keySelector) {
    var keyFn = keySelector ? parseLambda(keySelector) : function(row) { return JSON.stringify(row); };

    var combined = this._items.slice();
    for (var i = 0; i < brr.length; i++) {
        combined.push(brr[i]);
    }

    var seen = Object.create(null);
    var result = [];
    for (var j = 0; j < combined.length; j++) {
        var key = keyFn(combined[j], j);
        if (!seen[key]) {
            seen[key] = true;
            result.push(combined[j]);
        }
    }

    return this._new(result);
};
Array2D.prototype.union = Array2D.prototype.zå»é‡å¹¶é›†;

/**
 * è¶…çº§æŸ¥æ‰¾ï¼ˆsuperLookupï¼‰- ç±»ä¼¼VLOOKUPçš„å¤šæ¡ä»¶æŸ¥æ‰¾
 * @param {Array} brr - æŸ¥æ‰¾è¡¨æ•°ç»„
 * @param {string|Function} leftKeySelector - å·¦è¡¨é”®é€‰æ‹©å™¨
 * @param {string|Function} rightKeySelector - å³è¡¨é”®é€‰æ‹©å™¨
 * @param {Function} resultSelector - ç»“æœé€‰æ‹©å™¨
 * @returns {Array2D} æ–°å®ä¾‹
 */
Array2D.prototype.zè¶…çº§æŸ¥æ‰¾ = function(brr, leftKeySelector, rightKeySelector, resultSelector) {
    var leftFn = leftKeySelector ? parseLambda(leftKeySelector) : function(row) { return row[0]; };
    var rightFn = rightKeySelector ? parseLambda(rightKeySelector) : function(row) { return row[0]; };
    var resFn = resultSelector || function(a, b) { return a.concat(b || []); };

    // æ„å»ºå³è¡¨æŸ¥æ‰¾å­—å…¸
    var rightMap = Object.create(null);
    for (var j = 0; j < brr.length; j++) {
        var key = rightFn(brr[j], j);
        if (!rightMap[key]) {
            rightMap[key] = brr[j];
        }
    }

    var result = [];
    for (var i = 0; i < this._items.length; i++) {
        var leftRow = this._items[i];
        var key = leftFn(leftRow, i);
        var matched = rightMap[key];
        result.push(resFn(leftRow.slice(), matched ? matched.slice() : []));
    }

    return this._new(result);
};
Array2D.prototype.superLookup = Array2D.prototype.zè¶…çº§æŸ¥æ‰¾;

// ==================== æŸ¥æ‰¾ç›¸å…³æ–¹æ³• ====================

/**
 * æŸ¥æ‰¾å•ä¸ªå…ƒç´ ï¼ˆfindï¼‰
 * @param {string|Function} predicate - æŸ¥æ‰¾æ¡ä»¶
 * @returns {any} æ‰¾åˆ°çš„å…ƒç´ 
 */
Array2D.prototype.zæŸ¥æ‰¾å•ä¸ª = function(predicate) {
    var fn = typeof predicate === 'function' ? predicate : parseLambda(predicate);
    if (!fn) return undefined;

    for (var i = 0; i < this._items.length; i++) {
        if (fn(this._items[i], i)) {
            return this._items[i];
        }
    }
    return undefined;
};
Array2D.prototype.find = Array2D.prototype.zæŸ¥æ‰¾å•ä¸ª;

/**
 * æŸ¥æ‰¾æ‰€æœ‰ä¸‹æ ‡ï¼ˆfindAllIndexï¼‰- æŸ¥æ‰¾æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„å…ƒç´ ä½ç½®
 * @param {string|Function} predicate - æŸ¥æ‰¾æ¡ä»¶
 * @returns {Array} ä½ç½®æ•°ç»„ [[è¡Œ,åˆ—],...]
 */
Array2D.prototype.zæŸ¥æ‰¾æ‰€æœ‰ä¸‹æ ‡ = function(predicate) {
    var fn = typeof predicate === 'function' ? predicate : parseLambda(predicate);
    if (!fn) return [];

    var result = [];
    for (var i = 0; i < this._items.length; i++) {
        var row = this._items[i];
        if (Array.isArray(row)) {
            for (var j = 0; j < row.length; j++) {
                if (fn(row[j], i, j)) {
                    result.push([i, j]);
                }
            }
        } else {
            if (fn(row, i, 0)) {
                result.push([i, 0]);
            }
        }
    }
    return result;
};
Array2D.prototype.findAllIndex = Array2D.prototype.zæŸ¥æ‰¾æ‰€æœ‰ä¸‹æ ‡;

/**
 * æŸ¥æ‰¾æ‰€æœ‰è¡Œä¸‹æ ‡ï¼ˆfindRowsIndexï¼‰
 * @param {string|Function} predicate - æŸ¥æ‰¾æ¡ä»¶
 * @returns {Array} è¡Œä¸‹æ ‡æ•°ç»„
 */
Array2D.prototype.zæŸ¥æ‰¾æ‰€æœ‰è¡Œä¸‹æ ‡ = function(predicate) {
    var fn = typeof predicate === 'function' ? predicate : parseLambda(predicate);
    if (!fn) return [];

    var result = [];
    for (var i = 0; i < this._items.length; i++) {
        if (fn(this._items[i], i)) {
            result.push(i);
        }
    }
    return result;
};
Array2D.prototype.findRowsIndex = Array2D.prototype.zæŸ¥æ‰¾æ‰€æœ‰è¡Œä¸‹æ ‡;

/**
 * æŸ¥æ‰¾æ‰€æœ‰åˆ—ä¸‹æ ‡ï¼ˆfindColsIndexï¼‰
 * @param {Number} rowIndex - è¡Œå·
 * @param {string|Function} predicate - æŸ¥æ‰¾æ¡ä»¶
 * @returns {Array} åˆ—ä¸‹æ ‡æ•°ç»„
 */
Array2D.prototype.zæŸ¥æ‰¾æ‰€æœ‰åˆ—ä¸‹æ ‡ = function(rowIndex, predicate) {
    if (!this._items[rowIndex]) return [];

    var fn = typeof predicate === 'function' ? predicate : parseLambda(predicate);
    if (!fn) return [];

    var row = this._items[rowIndex];
    var result = [];
    for (var j = 0; j < row.length; j++) {
        if (fn(row[j], rowIndex, j)) {
            result.push(j);
        }
    }
    return result;
};
Array2D.prototype.findColsIndex = Array2D.prototype.zæŸ¥æ‰¾æ‰€æœ‰åˆ—ä¸‹æ ‡;

/**
 * æŸ¥æ‰¾å…ƒç´ ä¸‹æ ‡ï¼ˆfindIndexByPredicateï¼‰
 * @param {string|Function} predicate - æŸ¥æ‰¾æ¡ä»¶
 * @returns {Number} ä¸‹æ ‡ï¼Œæœªæ‰¾åˆ°è¿”å›-1
 */
Array2D.prototype.zæŸ¥æ‰¾å…ƒç´ ä¸‹æ ‡ = function(predicate) {
    var fn = typeof predicate === 'function' ? predicate : parseLambda(predicate);
    if (!fn) return -1;

    for (var i = 0; i < this._items.length; i++) {
        if (fn(this._items[i], i)) {
            return i;
        }
    }
    return -1;
};
Array2D.prototype.findIndexByPredicate = Array2D.prototype.zæŸ¥æ‰¾å…ƒç´ ä¸‹æ ‡;

/**
 * å€¼ä½ç½®ï¼ˆindexOfï¼‰- æŸ¥æ‰¾å…ƒç´ é¦–æ¬¡å‡ºç°çš„ä½ç½®
 * @param {any} value - è¦æŸ¥æ‰¾çš„å€¼
 * @param {Number} [fromIndex=0] - å¼€å§‹æŸ¥æ‰¾çš„ä½ç½®
 * @returns {Number} ä¸‹æ ‡ï¼Œæœªæ‰¾åˆ°è¿”å›-1
 * @example
 * Array2D([[1,2],[3,4],[1,2]]).zå€¼ä½ç½®([1,2])  // 0
 */
Array2D.prototype.zå€¼ä½ç½® = function(value, fromIndex) {
    fromIndex = fromIndex || 0;
    for (var i = fromIndex; i < this._items.length; i++) {
        if (JSON.stringify(this._items[i]) === JSON.stringify(value)) {
            return i;
        }
    }
    return -1;
};
Array2D.prototype.indexOf = Array2D.prototype.zå€¼ä½ç½®;

/**
 * ä»åå¾€å‰å€¼ä½ç½®ï¼ˆlastIndexOfï¼‰- æŸ¥æ‰¾å…ƒç´ æœ€åå‡ºç°çš„ä½ç½®
 * @param {any} value - è¦æŸ¥æ‰¾çš„å€¼
 * @param {Number} [fromIndex] - å¼€å§‹æŸ¥æ‰¾çš„ä½ç½®ï¼ˆä»åå¾€å‰ï¼‰
 * @returns {Number} ä¸‹æ ‡ï¼Œæœªæ‰¾åˆ°è¿”å›-1
 * @example
 * Array2D([[1,2],[3,4],[1,2]]).zä»åå¾€å‰å€¼ä½ç½®([1,2])  // 2
 */
Array2D.prototype.zä»åå¾€å‰å€¼ä½ç½® = function(value, fromIndex) {
    fromIndex = fromIndex !== undefined ? fromIndex : this._items.length - 1;
    for (var i = fromIndex; i >= 0; i--) {
        if (JSON.stringify(this._items[i]) === JSON.stringify(value)) {
            return i;
        }
    }
    return -1;
};
Array2D.prototype.lastIndexOf = Array2D.prototype.zä»åå¾€å‰å€¼ä½ç½®;

// ==================== æ‰¹é‡æ“ä½œæ–¹æ³• ====================

/**
 * æ‰¹é‡åˆ é™¤åˆ—ï¼ˆdeleteColsï¼‰
 * @param {Array|String} cols - åˆ—å·æ•°ç»„æˆ–fæ¨¡å¼å­—ç¬¦ä¸²
 * @returns {Array2D} æ–°å®ä¾‹
 */
Array2D.prototype.zæ‰¹é‡åˆ é™¤åˆ— = function(cols) {
    var colIndexes = [];

    // è§£æåˆ—ç´¢å¼•
    if (typeof cols === 'string') {
        // fæ¨¡å¼: f1,f2 æˆ– f3
        if (cols.startsWith('f') && !cols.includes(',')) {
            var idx = parseInt(cols.substring(1)) - 1;
            colIndexes = [idx];
        } else {
            var parts = cols.split(',');
            for (var p = 0; p < parts.length; p++) {
                if (parts[p].trim().startsWith('f')) {
                    colIndexes.push(parseInt(parts[p].trim().substring(1)) - 1);
                }
            }
        }
    } else if (Array.isArray(cols)) {
        colIndexes = cols;
    }

    // ä»å¤§åˆ°å°æ’åºåˆ é™¤
    colIndexes.sort(function(a, b) { return b - a; });

    var result = [];
    for (var i = 0; i < this._items.length; i++) {
        var newRow = this._items[i].slice();
        for (var c = 0; c < colIndexes.length; c++) {
            if (colIndexes[c] >= 0 && colIndexes[c] < newRow.length) {
                newRow.splice(colIndexes[c], 1);
            }
        }
        result.push(newRow);
    }

    return this._new(result);
};
Array2D.prototype.deleteCols = Array2D.prototype.zæ‰¹é‡åˆ é™¤åˆ—;
Array2D.prototype.delcols = Array2D.prototype.zæ‰¹é‡åˆ é™¤åˆ—;  // æ–‡æ¡£ä¸­çš„åˆ«å
Array2D.prototype.zæ‰¹é‡åˆ é™¤åˆ—2 = Array2D.prototype.zæ‰¹é‡åˆ é™¤åˆ—;  // åˆ«å

/**
 * æ‰¹é‡åˆ é™¤è¡Œï¼ˆdeleteRowsï¼‰
 * @param {Array|String} rows - è¡Œå·æ•°ç»„æˆ–fæ¨¡å¼
 * @returns {Array2D} æ–°å®ä¾‹
 */
Array2D.prototype.zæ‰¹é‡åˆ é™¤è¡Œ = function(rows) {
    var rowIndexes = [];

    if (typeof rows === 'string') {
        // fæ¨¡å¼: f2-f4
        if (rows.includes('-')) {
            var match = rows.match(/f(\d+)\-f(\d+)/);
            if (match) {
                var start = parseInt(match[1]) - 1;
                var end = parseInt(match[2]) - 1;
                for (var i = start; i <= end; i++) {
                    rowIndexes.push(i);
                }
            }
        } else if (rows.startsWith('f')) {
            rowIndexes = [parseInt(rows.substring(1)) - 1];
        }
    } else if (Array.isArray(rows)) {
        rowIndexes = rows;
    }

    // ä»å¤§åˆ°å°æ’åºåˆ é™¤
    rowIndexes.sort(function(a, b) { return b - a; });

    var result = this._items.slice();
    for (var r = 0; r < rowIndexes.length; r++) {
        if (rowIndexes[r] >= 0 && rowIndexes[r] < result.length) {
            result.splice(rowIndexes[r], 1);
        }
    }

    return this._new(result);
};
Array2D.prototype.deleteRows = Array2D.prototype.zæ‰¹é‡åˆ é™¤è¡Œ;

/**
 * æ‰¹é‡æ’å…¥åˆ—ï¼ˆinsertColsï¼‰
 * @param {Number|Function} colSelector - åˆ—å·æˆ–æ¡ä»¶å›è°ƒ
 * @param {any|Function} value - å¡«å……å€¼æˆ–å›è°ƒ
 * @param {Number} count - æ’å…¥æ•°é‡
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * // åœ¨ç¬¬2åˆ—ä½ç½®æ’å…¥2åˆ—
 * Array2D(arr).zæ‰¹é‡æ’å…¥åˆ—(1, "x", 2)
 * // åœ¨åŒ…å«"äº§å“"å€¼çš„åˆ—ä½ç½®å‰æ’å…¥2åˆ—ï¼ˆé»˜è®¤åœ¨æœ€åä¸€è¡ŒæŸ¥æ‰¾ï¼‰
 * Array2D(arr).zæ‰¹é‡æ’å…¥åˆ—(x=>x.includes("äº§å“"), " ", 2)
 */
Array2D.prototype.zæ‰¹é‡æ’å…¥åˆ— = function(colSelector, value, count) {
    count = count || 1;
    var fillVal = value;

    var insertIndex = 0;
    if (typeof colSelector === 'function') {
        // ä»æ¡ä»¶å‡½æ•°è§£æç›®æ ‡å€¼
        var funcStr = colSelector.toString();
        var valueMatch = funcStr.match(/['"]([^'"]+)['"]/);

        if (valueMatch) {
            var targetValue = valueMatch[1];
            // é»˜è®¤åœ¨æœ€åä¸€è¡ŒæŸ¥æ‰¾ç›®æ ‡å€¼çš„ä½ç½®
            var lastRow = this._items[this._items.length - 1];
            if (Array.isArray(lastRow)) {
                for (var j = 0; j < lastRow.length; j++) {
                    if (String(lastRow[j]) == targetValue) {
                        insertIndex = j;
                        break;
                    }
                }
            }
        } else {
            // å°è¯•ä» x[N] è§£æåˆ—ç´¢å¼•
            var indexMatch = funcStr.match(/x\[(\d+)\]/);
            if (indexMatch) {
                insertIndex = parseInt(indexMatch[1]);
            }
        }
    } else if (typeof colSelector === 'number') {
        insertIndex = colSelector;
    }

    var result = [];
    for (var i = 0; i < this._items.length; i++) {
        var row = this._items[i];
        if (!Array.isArray(row)) row = [row];

        var newRow = row.slice();
        // å‡†å¤‡å¡«å……å€¼
        var fillVals = [];
        for (var c = 0; c < count; c++) {
            if (typeof fillVal === 'function') {
                fillVals.push(fillVal(row, i, insertIndex + c));
            } else {
                fillVals.push(fillVal !== undefined ? fillVal : '');
            }
        }
        // åœ¨æŒ‡å®šä½ç½®æ’å…¥
        newRow.splice.apply(newRow, [insertIndex, 0].concat(fillVals));
        result.push(newRow);
    }

    return this._new(result);
};
Array2D.prototype.insertCols = Array2D.prototype.zæ‰¹é‡æ’å…¥åˆ—;

/**
 * æ‰¹é‡æ’å…¥è¡Œï¼ˆinsertRowsï¼‰
 * @param {Array|Function} rowSelector - è¡Œå·æ•°ç»„æˆ–æ¡ä»¶å›è°ƒ
 * @param {any} value - å¡«å……å€¼
 * @param {Number} count - æ’å…¥æ•°é‡
 * @returns {Array2D} æ–°å®ä¾‹
 */
Array2D.prototype.zæ‰¹é‡æ’å…¥è¡Œ = function(rowSelector, value, count) {
    count = count || 1;
    var fillVal = value !== undefined ? value : '';

    var insertIndexes = [];
    if (typeof rowSelector === 'function') {
        for (var i = 0; i < this._items.length; i++) {
            if (rowSelector(this._items[i], i)) {
                insertIndexes.push(i);
            }
        }
    } else if (typeof rowSelector === 'string' && rowSelector.startsWith('f')) {
        insertIndexes = [parseInt(rowSelector.substring(1)) - 1];
    } else if (Array.isArray(rowSelector)) {
        insertIndexes = rowSelector;
    }

    var result = this._items.slice();
    // ä»åå¾€å‰æ’å…¥
    for (var i = insertIndexes.length - 1; i >= 0; i--) {
        var idx = insertIndexes[i];
        var newRow = [];
        var maxCols = 0;
        for (var r = 0; r < result.length; r++) {
            if (Array.isArray(result[r]) && result[r].length > maxCols) {
                maxCols = result[r].length;
            }
        }
        for (var c = 0; c < maxCols; c++) {
            newRow.push(fillVal);
        }
        for (var c = 0; c < count; c++) {
            result.splice(idx, 0, newRow.slice());
        }
    }

    return this._new(result);
};
Array2D.prototype.insertRows = Array2D.prototype.zæ‰¹é‡æ’å…¥è¡Œ;

/**
 * æ’å…¥è¡Œå·ï¼ˆinsertRowNumï¼‰
 * @param {Number} startNum - èµ·å§‹è¡Œå·
 * @returns {Array2D} æ–°å®ä¾‹
 */
Array2D.prototype.zæ’å…¥è¡Œå· = function(startNum) {
    startNum = startNum || 0;
    var result = [];
    for (var i = 0; i < this._items.length; i++) {
        var newRow = [startNum + i].concat(this._items[i]);
        result.push(newRow);
    }
    return this._new(result);
};
Array2D.prototype.insertRowNum = Array2D.prototype.zæ’å…¥è¡Œå·;

// ==================== åˆ†é¡µæ–¹æ³• ====================

/**
 * æŒ‰é¡µæ•°åˆ†é¡µï¼ˆpageByCountï¼‰
 * @param {Number} pageCount - æ€»é¡µæ•°
 * @returns {Array} åˆ†é¡µåçš„å¤šç»´æ•°ç»„
 */
Array2D.prototype.zæŒ‰é¡µæ•°åˆ†é¡µ = function(pageCount) {
    if (pageCount < 1) pageCount = 1;
    var totalRows = this._items.length;
    var rowsPerPage = Math.ceil(totalRows / pageCount);

    var result = [];
    for (var page = 0; page < pageCount; page++) {
        var start = page * rowsPerPage;
        var end = Math.min(start + rowsPerPage, totalRows);
        if (start < totalRows) {
            result.push(this._items.slice(start, end));
        }
    }

    return result;
};
Array2D.prototype.pageByCount = Array2D.prototype.zæŒ‰é¡µæ•°åˆ†é¡µ;

/**
 * æŒ‰è¡Œæ•°åˆ†é¡µï¼ˆpageByRowsï¼‰
 * @param {Number} pageSize - æ¯é¡µè¡Œæ•°
 * @returns {Array} åˆ†é¡µåçš„å¤šç»´æ•°ç»„
 */
Array2D.prototype.zæŒ‰è¡Œæ•°åˆ†é¡µ = function(pageSize) {
    if (pageSize < 1) pageSize = 1;

    var result = [];
    for (var i = 0; i < this._items.length; i += pageSize) {
        result.push(this._items.slice(i, i + pageSize));
    }

    return result;
};
Array2D.prototype.pageByRows = Array2D.prototype.zæŒ‰è¡Œæ•°åˆ†é¡µ;

/**
 * æŒ‰ä¸‹æ ‡åˆ†é¡µï¼ˆpageByIndexsï¼‰
 * @param {Array|String} indexes - ä¸‹æ ‡æ•°ç»„æˆ–æ¡ä»¶
 * @returns {Array} åˆ†é¡µåçš„å¤šç»´æ•°ç»„
 */
Array2D.prototype.zæŒ‰ä¸‹æ ‡åˆ†é¡µ = function(indexes) {
    var splitIndexes = [];

    if (typeof indexes === 'string') {
        // fæ¨¡å¼æ¡ä»¶
        var fn = parseLambda(indexes);
        if (fn) {
            for (var i = 0; i < this._items.length; i++) {
                if (fn(this._items[i], i)) {
                    splitIndexes.push(i);
                }
            }
        }
    } else if (Array.isArray(indexes)) {
        splitIndexes = indexes;
    }

    if (splitIndexes.length === 0) return [this._items.slice()];

    var result = [];
    var start = 0;
    for (var i = 0; i < splitIndexes.length; i++) {
        var idx = splitIndexes[i];
        if (idx > start) {
            result.push(this._items.slice(start, idx));
        }
        start = idx;
    }
    result.push(this._items.slice(start));

    return result;
};
Array2D.prototype.pageByIndexs = Array2D.prototype.zæŒ‰ä¸‹æ ‡åˆ†é¡µ;

// ==================== å…¶ä»–é«˜çº§æ–¹æ³• ====================

/**
 * é—´éš”å–æ•°ï¼ˆnthï¼‰
 * @param {Number} interval - é—´éš”
 * @param {Number} offset - åç§»
 * @returns {Array2D} æ–°å®ä¾‹
 */
Array2D.prototype.zé—´éš”å–æ•° = function(interval, offset) {
    interval = interval || 1;
    offset = offset || 0;

    // ä¿ç•™ç¬¬ä¸€è¡Œï¼ˆè¡¨å¤´ï¼‰
    var result = [this._items[0].slice()];

    for (var i = 1; i < this._items.length; i++) {
        if ((i - 1 + offset) % interval === 0) {
            result.push(this._items[i]);
        }
    }

    return this._new(result);
};
Array2D.prototype.nth = Array2D.prototype.zé—´éš”å–æ•°;

/**
 * è¡¥é½æ•°ç»„ï¼ˆpadï¼‰
 * @param {Number} cols - åˆ—æ•°
 * @param {Number} rows - è¡Œæ•°
 * @param {any} fillValue - å¡«å……å€¼
 * @returns {Array2D} æ–°å®ä¾‹
 */
Array2D.prototype.zè¡¥é½æ•°ç»„ = function(cols, rows, fillValue) {
    cols = cols || (this._items[0] ? this._items[0].length : 1);
    rows = rows || this._items.length;
    fillValue = fillValue !== undefined ? fillValue : '';

    var result = [];
    for (var i = 0; i < rows; i++) {
        var row = i < this._items.length ? this._items[i].slice() : [];
        while (row.length < cols) {
            row.push(fillValue);
        }
        result.push(row);
    }

    return this._new(result);
};
Array2D.prototype.pad = Array2D.prototype.zè¡¥é½æ•°ç»„;

/**
 * é‡è®¾å¤§å°ï¼ˆresizeï¼‰
 * @param {Number} rows - è¡Œæ•°
 * @param {Number} cols - åˆ—æ•°
 * @returns {Array2D} æ–°å®ä¾‹
 */
Array2D.prototype.zé‡è®¾å¤§å° = function(rows, cols) {
    return this.zè¡¥é½æ•°ç»„(cols, rows);
};
Array2D.prototype.resize = Array2D.prototype.zé‡è®¾å¤§å°;

/**
 * å¤„ç†ç©ºå€¼ï¼ˆnoNullï¼‰- å°†nullå’Œundefinedæ›¿æ¢ä¸ºç©ºå­—ç¬¦ä¸²
 * @returns {Array2D} æ–°å®ä¾‹
 */
Array2D.prototype.zå¤„ç†ç©ºå€¼ = function() {
    var result = [];
    for (var i = 0; i < this._items.length; i++) {
        var row = [];
        if (Array.isArray(this._items[i])) {
            for (var j = 0; j < this._items[i].length; j++) {
                var val = this._items[i][j];
                row.push((val === null || val === undefined) ? '' : val);
            }
        } else {
            var val = this._items[i];
            row.push((val === null || val === undefined) ? '' : val);
        }
        result.push(row);
    }
    return this._new(result);
};
Array2D.prototype.noNull = Array2D.prototype.zå¤„ç†ç©ºå€¼;

/**
 * é€‰æ‹©åˆ—ï¼ˆselectColsï¼‰- é€‰æ‹©äºŒç»´æ•°ç»„ä¸­æŒ‡å®šçš„åˆ—
 * @param {Array|String} cols - åˆ—é€‰æ‹©æ–¹å¼ï¼Œæ”¯æŒå¤šç§æ ¼å¼ï¼š
 *   - æ•°å­—æ•°ç»„: [0, 2, 4] é€‰æ‹©ç¬¬1ã€3ã€5åˆ—ï¼ˆ0-basedç´¢å¼•ï¼‰
 *   - fæ¨¡å¼å­—ç¬¦ä¸²: "f1,f3,f5" é€‰æ‹©ç¬¬1ã€3ã€5åˆ—ï¼ˆ1-basedç´¢å¼•ï¼‰
 *   - fæ¨¡å¼æ•°ç»„: ["f1", "f3", "f5"]
 *   - è¡¨å¤´åç§°æ•°ç»„: ["äº§å“", "æ•°é‡", "ä»·æ ¼"] æŒ‰é¦–è¡Œè¡¨å¤´åŒ¹é…
 *   - å•ä¸ªè¡¨å¤´å: "äº§å“" é€‰æ‹©å•åˆ—
 * @param {Array} [newHeaders] - å¯é€‰ï¼Œä¸ºé€‰æ‹©åçš„åˆ—æŒ‡å®šæ–°è¡¨å¤´
 * @returns {Array2D} æ–°å®ä¾‹
 * @example
 * // ç¤ºä¾‹1ï¼šæŒ‰åˆ—å·é€‰æ‹©
 * var arr = [[1, 2, 3], [4, 5, 6], [7, 8, 9]];
 * Array2D.selectCols(arr, [0, 2]);  // é€‰æ‹©ç¬¬1åˆ—å’Œç¬¬3åˆ—
 * // ç»“æœ: [[1, 3], [4, 6], [7, 9]]
 *
 * // ç¤ºä¾‹2ï¼šæŒ‰fæ¨¡å¼å­—ç¬¦ä¸²é€‰æ‹©ï¼ˆæ¨èï¼‰
 * Array2D.selectCols(arr, "f1,f3");  // é€‰æ‹©ç¬¬1åˆ—å’Œç¬¬3åˆ—
 *
 * // ç¤ºä¾‹3ï¼šæŒ‰è¡¨å¤´é€‰æ‹©
 * var arr2 = [['a','b','c'], [1,2,3], [4,5,6]];
 * Array2D.selectCols(arr2, ['c','b','a']);  // æŒ‰é¦–è¡Œè¡¨å¤´é”™ä½é€‰æ‹©
 * // ç»“æœ: [["c","b","a"], [3,2,1], [6,5,4]]
 *
 * // ç¤ºä¾‹4ï¼šæŒ‡å®šæ–°è¡¨å¤´
 * Array2D.selectCols(arr2, ['a','c'], ['x','z']);
 * // ç»“æœ: [["x","z"], [1,3], [4,6]]
 */
Array2D.prototype.zé€‰æ‹©åˆ— = function(cols, newHeaders) {
    if (!this._items.length) return this._new([]);

    var indexes = [];
    var useHeader = false;

    // å¤„ç†å­—ç¬¦ä¸²å‚æ•°ï¼šæ”¯æŒ "f2,f3,f6" æˆ– "f2,f3-f7" èŒƒå›´æ ¼å¼
    if (typeof cols === 'string') {
        // æ£€æŸ¥æ˜¯å¦æ˜¯ f æ¨¡å¼ï¼ˆåˆ—å·æ ¼å¼ï¼‰
        if ((cols.includes(',') || cols.includes('-')) && (cols.toLowerCase().includes('f'))) {
            // f æ¨¡å¼ï¼šå…ˆæŒ‰é€—å·åˆ†å‰²ï¼Œå†å¤„ç†èŒƒå›´
            var parts = cols.split(',');
            indexes = [];
            for (var i = 0; i < parts.length; i++) {
                var part = parts[i].trim();
                if (part.includes('-')) {
                    // å¤„ç†èŒƒå›´ f3-f7
                    var range = part.split('-');
                    var start = parseInt(range[0].toLowerCase().replace('f', ''));
                    var end = parseInt(range[1].toLowerCase().replace('f', ''));
                    for (var j = start; j <= end; j++) {
                        indexes.push(j - 1);
                    }
                } else if (part.toLowerCase().startsWith('f')) {
                    indexes.push(parseInt(part.substring(1)) - 1);  // f2 â†’ ç´¢å¼•1
                } else {
                    indexes.push(parseInt(part) - 1);
                }
            }
            useHeader = false;
        } else {
            // å•ä¸ªå­—ç¬¦ä¸²ï¼Œå½“ä½œè¡¨å¤´åç§°
            cols = [cols];
            useHeader = true;
        }
    } else if (cols.length > 0 && typeof cols[0] === 'string') {
        // æ£€æŸ¥æ˜¯å¦æ˜¯ f æ¨¡å¼æ•°ç»„
        var allFMode = true;
        for (var i = 0; i < cols.length; i++) {
            if (typeof cols[i] === 'string' && !cols[i].toLowerCase().startsWith('f')) {
                allFMode = false;
                break;
            }
        }
        if (allFMode) {
            // f æ¨¡å¼æ•°ç»„ï¼šè½¬æ¢ä¸ºåˆ—ç´¢å¼•ï¼ˆæ”¯æŒèŒƒå›´ï¼‰
            indexes = [];
            for (var i = 0; i < cols.length; i++) {
                var c = cols[i];
                if (c.includes('-')) {
                    // å¤„ç†èŒƒå›´
                    var range = c.split('-');
                    var start = parseInt(range[0].substring(1));
                    var end = parseInt(range[1].substring(1));
                    for (var j = start; j <= end; j++) {
                        indexes.push(j - 1);
                    }
                } else {
                    indexes.push(parseInt(c.substring(1)) - 1);
                }
            }
            useHeader = false;
        } else {
            useHeader = true;
        }
    }

    if (!useHeader && indexes.length > 0) {
        // æŒ‰åˆ—å·é€‰æ‹©ï¼ˆå·²è§£æçš„ç´¢å¼•ï¼‰
        var result = [];
        for (var i = 0; i < this._items.length; i++) {
            var row = [];
            for (var k = 0; k < indexes.length; k++) {
                row.push(this._items[i][indexes[k]]);
            }
            result.push(row);
        }
        return this._new(result);
    }

    if (useHeader) {
        // æŒ‰è¡¨å¤´é€‰æ‹©
        var headers = this._items[0];
        var headerMap = {};
        for (var i = 0; i < headers.length; i++) {
            headerMap[String(headers[i])] = i;
        }

        for (var j = 0; j < cols.length; j++) {
            var col = cols[j];
            if (headerMap.hasOwnProperty(col)) {
                indexes.push(headerMap[col]);
            }
        }

        var result = [];
        if (newHeaders && newHeaders.length > 0) {
            result.push(newHeaders);
        } else {
            var headerRow = [];
            for (var k = 0; k < cols.length; k++) {
                var idx = indexes[k];
                headerRow.push(idx !== undefined ? headers[idx] : cols[k]);
            }
            result.push(headerRow);
        }

        for (var i = 1; i < this._items.length; i++) {
            var row = this._items[i];
            var newRow = [];
            for (var k = 0; k < indexes.length; k++) {
                newRow.push(row[indexes[k]]);
            }
            result.push(newRow);
        }

        return this._new(result);
    }
};
Array2D.prototype.selectCols = Array2D.prototype.zé€‰æ‹©åˆ—;
Array2D.prototype.SelectCols = Array2D.prototype.zé€‰æ‹©åˆ—;  // æ–‡æ¡£ä¸­çš„å¤§å†™åˆ«å

/**
 * é€‰æ‹©è¡Œï¼ˆselectRowsï¼‰
 * @param {Array} rowIndexes - è¡Œå·æ•°ç»„
 * @returns {Array2D} æ–°å®ä¾‹
 */
Array2D.prototype.zé€‰æ‹©è¡Œ = function(rowIndexes) {
    var result = [];
    for (var i = 0; i < rowIndexes.length; i++) {
        var idx = rowIndexes[i];
        if (idx >= 0 && idx < this._items.length) {
            result.push(this._items[idx]);
        }
    }
    return this._new(result);
};
Array2D.prototype.selectRows = Array2D.prototype.zé€‰æ‹©è¡Œ;

/**
 * è·å–ç»“æœï¼ˆresï¼‰- è·å–å½“å‰æ•°ç»„çš„å€¼ï¼ˆvalçš„åˆ«åï¼‰
 * @returns {Array} å½“å‰æ•°ç»„
 * @example
 * Array2D([[1,2],[3,4]]).zç»“æœ()  // [[1,2],[3,4]]
 */
Array2D.prototype.zç»“æœ = function() {
    return this._items;
};
Array2D.prototype.res = Array2D.prototype.zç»“æœ;

/**
 * çŸ©é˜µåˆ†å¸ƒï¼ˆgetMatrixï¼‰- ç”Ÿæˆæ•°å­—åºåˆ—çš„çŸ©é˜µåˆ†å¸ƒ
 * @param {Number} totalRows - æ€»è¡Œæ•°
 * @param {Number} cols - åˆ—æ•°
 * @param {String} direction - æ–¹å‘ 'r'æˆ–'c'
 * @returns {Array} åˆ†å¸ƒåçš„æ•°ç»„
 */
Array2D.getMatrix = function(totalRows, cols, direction) {
    if (totalRows === undefined || totalRows <= 0) return [];
    if (cols === undefined || cols <= 0) return [];
    direction = direction || 'r';
    var result = [];
    var numbers = [];
    for (var i = 0; i < totalRows; i++) {
        numbers.push(i);
    }

    if (direction === 'r') {
        var rows = Math.ceil(totalRows / cols);
        for (var i = 0; i < rows; i++) {
            var row = [];
            for (var j = 0; j < cols; j++) {
                var index = i * cols + j;
                if (index < totalRows) row.push(numbers[index]);
            }
            if (row.length > 0) result.push(row);
        }
    } else {
        var rows = Math.ceil(totalRows / cols);
        for (var i = 0; i < rows; i++) {
            var row = [];
            for (var j = 0; j < cols; j++) {
                var index = j * rows + i;
                if (index < totalRows) row.push(numbers[index]);
            }
            if (row.length > 0) result.push(row);
        }
    }

    return result;
};
Array2D.zçŸ©é˜µåˆ†å¸ƒ = Array2D.getMatrix;

/**
 * rangeMatrix - åŒºåŸŸçŸ©é˜µæ“ä½œï¼ˆæŒ‰æŒ‡å®šåŒºåŸŸåˆ†ç»„èšåˆï¼‰
 * @param {Array} arr - æºæ•°æ®æ•°ç»„
 * @param {string|Function} keySelector - åˆ†ç»„é”®é€‰æ‹©å™¨ï¼Œå¦‚ 'f1' æˆ– 'A:A'
 * @param {Array} dataArrays - æ•°æ®æ•°ç»„æˆ–èŒƒå›´æ•°ç»„ï¼Œå¦‚ [brr, 'B:B']
 * @param {Function} [aggregator] - èšåˆå‡½æ•°ï¼Œé»˜è®¤æ±‚å’Œ
 * @returns {Array} èšåˆåçš„ç»“æœæ•°ç»„
 * @example
 * // æŒ‰Aåˆ—åˆ†ç»„ï¼Œå¯¹Båˆ—æ±‚å’Œ
 * Array2D.rangeMatrix(arr, 'A:A', [brr, 'B:B'], (a,b)=>a+b)
 * // æŒ‰ç¬¬1åˆ—åˆ†ç»„ï¼Œèšåˆå¤šä¸ªæ•°æ®åˆ—
 * Array2D.rangeMatrix(arr, 'f1', [brr], (a,b)=>a+b)
 */
Array2D.rangeMatrix = function(arr, keySelector, dataArrays, aggregator) {
    if (!arr || !Array.isArray(arr)) return [];
    
    // è§£æé”®é€‰æ‹©å™¨
    var keyFn = typeof keySelector === 'function' ? keySelector : parseLambda(keySelector);
    if (!keyFn) {
        // å°è¯•è§£æ A:A æ ¼å¼
        if (typeof keySelector === 'string' && keySelector.match(/^[A-Z]:[A-Z]$/i)) {
            var colIdx = keySelector.charCodeAt(0) - 65; // A=0, B=1, etc.
            keyFn = function(row) { return row[colIdx]; };
        } else {
            keyFn = function(row) { return row[0]; };
        }
    }
    
    // é»˜è®¤èšåˆå‡½æ•°ï¼šæ±‚å’Œ
    var aggFn = aggregator || function(acc, val) {
        var num1 = typeof acc === 'number' ? acc : parseFloat(String(acc).replace(/,/g, '')) || 0;
        var num2 = typeof val === 'number' ? val : parseFloat(String(val).replace(/,/g, '')) || 0;
        return num1 + num2;
    };
    
    // æ ‡å‡†åŒ–æ•°æ®æ•°ç»„
    var dataList = [];
    if (Array.isArray(dataArrays)) {
        if (dataArrays.length === 2 && typeof dataArrays[1] === 'string' && dataArrays[1].match(/^[A-Z]:[A-Z]$/i)) {
            // [brr, 'B:B'] æ ¼å¼
            dataList.push({
                data: dataArrays[0],
                colSelector: dataArrays[1]
            });
        } else {
            dataList.push({ data: dataArrays, colSelector: null });
        }
    } else {
        dataList.push({ data: dataArrays, colSelector: null });
    }
    
    // æ„å»ºåˆ†ç»„
    var groups = Object.create(null);
    for (var i = 0; i < arr.length; i++) {
        var key = keyFn(arr[i], i);
        if (!groups[key]) {
            groups[key] = { key: key, indices: [] };
        }
        groups[key].indices.push(i);
    }
    
    // æ‰§è¡Œèšåˆ
    var result = [];
    for (var key in groups) {
        var group = groups[key];
        var row = [key];
        
        for (var d = 0; d < dataList.length; d++) {
            var dataInfo = dataList[d];
            var dataArr = dataInfo.data;
            
            // èšåˆè¯¥ç»„çš„æ‰€æœ‰å€¼
            var aggValue = null;
            for (var i = 0; i < group.indices.length; i++) {
                var idx = group.indices[i];
                if (idx < dataArr.length) {
                    var val = dataArr[idx];
                    if (aggValue === null) {
                        aggValue = val;
                    } else {
                        aggValue = aggFn(aggValue, val);
                    }
                }
            }
            row.push(aggValue !== null ? aggValue : 0);
        }
        result.push(row);
    }
    
    return result;
};
Array2D.zåŒºåŸŸçŸ©é˜µ = Array2D.rangeMatrix;
// å…¼å®¹æ–‡æ¡£ä¸­çš„æ‹¼å†™
Array2D.rangeMatric = Array2D.rangeMatrix;

/**
 * ç”Ÿæˆä¸‹æ ‡æ•°ç»„ï¼ˆgetIndexsï¼‰
 * @param {Number} start - èµ·å§‹
 * @param {Number} end - ç»“æŸ
 * @param {Number} step - æ­¥é•¿
 * @returns {Array} åºåˆ—
 */
Array2D.getIndexs = function(start, end, step) {
    step = step || 1;
    var result = [];
    for (var i = start; i <= end; i += step) {
        result.push(i);
    }
    return result;
};
Array2D.zç”Ÿæˆä¸‹æ ‡æ•°ç»„ = Array2D.getIndexs;

/**
 * ä¸‹æ ‡æ•°ç»„ï¼ˆindexArrayï¼‰- æ ¹æ®æ¡ä»¶è·å–å…ƒç´ çš„ä¸‹æ ‡æ•°ç»„
 * @param {Array} arr - æ•°ç»„
 * @param {string|Function} predicate - ç­›é€‰æ¡ä»¶
 * @returns {Array} ä¸‹æ ‡æ•°ç»„
 * @example
 * Array2D.indexArray([[1,2],[3,4],[5,6]], 'x=>x[0]>1')  // [1, 2]
 */
Array2D.indexArray = function(arr, predicate) {
    var fn = typeof predicate === 'function' ? predicate : parseLambda(predicate);
    if (!fn) return [];
    var result = [];
    for (var i = 0; i < arr.length; i++) {
        if (fn(arr[i], i)) {
            result.push(i);
        }
    }
    return result;
};
Array2D.zä¸‹æ ‡æ•°ç»„ = Array2D.indexArray;

/**
 * æŒ‰èŒƒå›´éå†ï¼ˆrangeForEachï¼‰- å¯¹æŒ‡å®šç´¢å¼•èŒƒå›´çš„å…ƒç´ æ‰§è¡Œå›è°ƒ
 * @param {Array} arr - æ•°ç»„
 * @param {Number} start - èµ·å§‹ç´¢å¼•
 * @param {Number} end - ç»“æŸç´¢å¼•
 * @param {Function} callback - å›è°ƒå‡½æ•° (item, index)
 * @returns {void}
 * @example
 * Array2D.rangeForEach([[1,2],[3,4],[5,6]], 0, 1, (row, i) => Console.log(row))
 */
Array2D.rangeForEach = function(arr, start, end, callback) {
    if (!arr || !Array.isArray(arr)) return;
    start = start || 0;
    end = end !== undefined ? end : arr.length - 1;
    for (var i = start; i <= end && i < arr.length; i++) {
        callback(arr[i], i);
    }
};
Array2D.zæŒ‰èŒƒå›´éå† = Array2D.rangeForEach;

/**
 * å±€éƒ¨æ˜ å°„ï¼ˆrangeMapï¼‰- å¯¹æŒ‡å®šç´¢å¼•èŒƒå›´çš„å…ƒç´ è¿›è¡Œæ˜ å°„
 * @param {Array} arr - æ•°ç»„
 * @param {Number} start - èµ·å§‹ç´¢å¼•
 * @param {Number} end - ç»“æŸç´¢å¼•
 * @param {string|Function} mapper - è½¬æ¢å‡½æ•°
 * @returns {Array} æ˜ å°„åçš„æ•°ç»„
 * @example
 * Array2D.rangeMap([[1,2],[3,4],[5,6]], 0, 1, 'x=>x[0]*2')  // [[2], [6]]
 */
Array2D.rangeMap = function(arr, start, end, mapper) {
    if (!arr || !Array.isArray(arr)) return [];
    var fn = typeof mapper === 'function' ? mapper : parseLambda(mapper);
    if (!fn) return [];
    start = start || 0;
    end = end !== undefined ? end : arr.length - 1;
    var result = [];
    for (var i = start; i <= end && i < arr.length; i++) {
        result.push(fn(arr[i], i));
    }
    return result;
};
Array2D.zå±€éƒ¨æ˜ å°„ = Array2D.rangeMap;

/**
 * æ’åï¼ˆrankï¼‰- å¯¹æ•°ç»„è¿›è¡Œæ’å
 * @param {Array} arr - æ•°ç»„
 * @param {string|Function} colSelector - åˆ—é€‰æ‹©å™¨ï¼Œæ”¯æŒ f2, f2-ï¼ˆé™åºï¼‰
 * @param {string} [type='cn'] - æ’åç±»å‹ï¼š'cn'ä¸­å¼æ’åï¼ˆå¹¶åˆ—è·³è¿‡ï¼‰ï¼Œ'usa'ç¾å¼æ’åï¼ˆå¹¶åˆ—ä¸è·³è¿‡ï¼‰ï¼Œ'+'é¡ºåºç¼–å·
 * @returns {Array} æ’åç»“æœï¼ˆäºŒç»´æ•°ç»„ï¼Œæ¯è¡Œä¸€ä¸ªæ’åå€¼ï¼‰
 * @example
 * Array2D.rank([[1,90],[2,80],[3,90]], 'f2-')  // [[1],[3],[1]]ï¼ˆä¸­å¼ï¼‰
 * Array2D.rank([[1,90],[2,80],[3,90]], 'f2-', 'usa')  // [[1],[3],[1]]ï¼ˆç¾å¼ï¼‰
 * Array2D.rank([[1,90],[2,80],[3,90]], 'f2-', '+')  // [[1],[3],[2]]ï¼ˆé¡ºåºï¼‰
 */
Array2D.rank = function(arr, colSelector, type) {
    if (!arr || !Array.isArray(arr)) return [];
    type = type || 'cn';
    var selectorStr = typeof colSelector === 'string' ? colSelector : '';
    var isDesc = selectorStr.endsWith('-');
    var fn = typeof colSelector === 'function' ? colSelector : parseLambda(colSelector);
    if (!fn) return [];

    var values = arr.map(function(row, i) { return {value: fn(row, i), index: i}; });
    values.sort(function(a, b) {
        var cmp = 0;
        if (typeof a.value === 'number' && typeof b.value === 'number') {
            cmp = a.value - b.value;
        } else {
            cmp = String(a.value).localeCompare(String(b.value));
        }
        return isDesc ? -cmp : cmp;
    });

    var ranks = [];
    for (var i = 0; i < values.length; i++) {
        var rank;
        if (type === '+') {
            rank = i + 1;
        } else if (type === 'usa') {
            rank = i + 1;
        } else { // cn ä¸­å¼æ’å
            rank = i + 1;
            for (var j = i - 1; j >= 0; j--) {
                if (values[j].value === values[i].value) {
                    rank = j + 1;
                    break;
                }
            }
        }
        ranks[values[i].index] = [rank];
    }
    return ranks;
};
Array2D.zæ’å = Array2D.rank;

/**
 * åˆ†ç»„æ’åï¼ˆrankGroupï¼‰- æŒ‰åˆ†ç»„è¿›è¡Œæ’å
 * @param {Array} arr - æ•°ç»„
 * @param {string|Function} colSelector - åˆ—é€‰æ‹©å™¨ï¼Œæ”¯æŒ f2, f2-ï¼ˆé™åºï¼‰
 * @param {string|Function} groupCol - åˆ†ç»„åˆ—é€‰æ‹©å™¨
 * @param {string} [type='cn'] - æ’åç±»å‹
 * @param {Number} [skipHeader=0] - è·³è¿‡æ ‡é¢˜è¡Œæ•°
 * @returns {Array} æ’åç»“æœï¼ˆäºŒç»´æ•°ç»„ï¼‰
 * @example
 * Array2D.rankGroup([[1,'A',90],[2,'A',80],[3,'B',90]], 'f3-', 'f2')
 */
Array2D.rankGroup = function(arr, colSelector, groupCol, type, skipHeader) {
    if (!arr || !Array.isArray(arr)) return [];
    type = type || 'cn';
    skipHeader = skipHeader || 0;
    var selectorStr = typeof colSelector === 'string' ? colSelector : '';
    var isDesc = selectorStr.endsWith('-');
    var fn = typeof colSelector === 'function' ? colSelector : parseLambda(colSelector);
    var groupFn = typeof groupCol === 'function' ? groupCol : parseLambda(groupCol);
    if (!fn || !groupFn) return [];

    var data = arr.slice(skipHeader);
    var groups = Object.create(null);
    for (var i = 0; i < data.length; i++) {
        var key = JSON.stringify(groupFn(data[i], i));
        if (!groups[key]) groups[key] = [];
        groups[key].push({row: data[i], index: i + skipHeader});
    }

    var ranks = [];
    for (var h = 0; h < skipHeader; h++) {
        ranks.push(['']);
    }

    for (var key in groups) {
        var group = groups[key];
        var values = group.map(function(item) {
            return {value: fn(item.row, item.index), index: item.index};
        });
        values.sort(function(a, b) {
            var cmp = 0;
            if (typeof a.value === 'number' && typeof b.value === 'number') {
                cmp = a.value - b.value;
            } else {
                cmp = String(a.value).localeCompare(String(b.value));
            }
            return isDesc ? -cmp : cmp;
        });

        for (var j = 0; j < values.length; j++) {
            var rank;
            if (type === '+') {
                rank = j + 1;
            } else if (type === 'usa') {
                rank = j + 1;
            } else { // cn ä¸­å¼æ’å
                rank = j + 1;
                for (var k = j - 1; k >= 0; k--) {
                    if (values[k].value === values[j].value) {
                        rank = k + 1;
                        break;
                    }
                }
            }
            ranks[values[j].index] = [rank];
        }
    }
    return ranks;
};
Array2D.zåˆ†ç»„æ’å = Array2D.rankGroup;

/**
 * ç¬›å¡å°”ç§¯ï¼ˆcrossjoinï¼‰- ä¸¤ä¸ªæ•°ç»„çš„ç¬›å¡å°”ç§¯
 * @param {Array} arr - ç¬¬ä¸€ä¸ªæ•°ç»„
 * @param {Array} brr - ç¬¬äºŒä¸ªæ•°ç»„
 * @returns {Array} ç¬›å¡å°”ç§¯ç»“æœ
 * @example
 * Array2D.crossjoin([[1,2],[3,4]], [[5,6],[7,8]])  // [[1,2,5,6],[1,2,7,8],[3,4,5,6],[3,4,7,8]]
 */
Array2D.crossjoin = function(arr, brr) {
    if (!arr || !brr) return [];
    var result = [];
    for (var i = 0; i < arr.length; i++) {
        var aRow = Array.isArray(arr[i]) ? arr[i] : [arr[i]];
        for (var j = 0; j < brr.length; j++) {
            var bRow = Array.isArray(brr[j]) ? brr[j] : [brr[j]];
            result.push(aRow.concat(bRow));
        }
    }
    return result;
};
Array2D.zç¬›å¡å°”ç§¯ = Array2D.crossjoin;

/**
 * åˆ†ç»„æ±‡æ€»ï¼ˆgroupIntoï¼‰- æŒ‰é”®åˆ†ç»„å¹¶è¿›è¡Œæ±‡æ€»è®¡ç®—
 * @param {Array} arr - æ•°ç»„
 * @param {string|Function} keySelector - åˆ†ç»„é”®é€‰æ‹©å™¨
 * @param {string|Function} valueSelector - å€¼èšåˆé€‰æ‹©å™¨ï¼ˆæ”¯æŒ g.sum(), g.count(), g.average() ç­‰ï¼‰
 * @param {string} [separator='@^@'] - å¤šåˆ—åˆ†ç»„æ—¶çš„åˆ†éš”ç¬¦
 * @returns {Array} åˆ†ç»„æ±‡æ€»ç»“æœï¼ˆäºŒç»´æ•°ç»„ï¼‰
 * @example
 * Array2D.groupInto([[1,'A',10],[2,'B',20],[3,'A',30]], 'f2', 'g=>g.sum("f3")')
 */
Array2D.groupInto = function(arr, keySelector, valueSelector, separator) {
    if (!arr || !Array.isArray(arr)) return [];
    separator = separator || '@^@';
    var keyFn = typeof keySelector === 'function' ? keySelector : parseLambda(keySelector);
    if (!keyFn) return [];

    // è§£æå€¼é€‰æ‹©å™¨
    var valueFn;
    if (typeof valueSelector === 'string') {
        // æ£€æŸ¥æ˜¯å¦æ˜¯èšåˆå‡½æ•°æ ¼å¼
        var aggMatch = valueSelector.match(/g\.(sum|count|average|max|min)\s*\(\s*["']?f?(\d+)["']?\s*\)/i);
        if (aggMatch) {
            var aggFunc = aggMatch[1].toLowerCase();
            var colIdx = parseInt(aggMatch[2]) - 1;
            valueFn = function(group) {
                var arr2d = new Array2D(group);
                switch (aggFunc) {
                    case 'sum': return arr2d.zæ±‚å’Œ(function(r) { return r[colIdx]; });
                    case 'count': return arr2d.zæ•°é‡();
                    case 'average': return arr2d.zå¹³å‡å€¼(function(r) { return r[colIdx]; });
                    case 'max': return arr2d.zæœ€å¤§å€¼(function(r) { return r[colIdx]; });
                    case 'min': return arr2d.zæœ€å°å€¼(function(r) { return r[colIdx]; });
                    default: return null;
                }
            };
        } else {
            valueFn = typeof valueSelector === 'function' ? valueSelector : parseLambda(valueSelector);
        }
    } else {
        valueFn = valueSelector;
    }

    if (!valueFn) return [];

    var groups = Object.create(null);
    for (var i = 0; i < arr.length; i++) {
        var key = keyFn(arr[i], i);
        var keyStr = Array.isArray(key) ? key.join(separator) : String(key);
        if (!groups[keyStr]) {
            groups[keyStr] = { key: key, rows: [] };
        }
        groups[keyStr].rows.push(arr[i]);
    }

    var result = [];
    for (var key in groups) {
        var group = groups[key];
        var agg = valueFn(group.rows);
        var row = Array.isArray(group.key) ? group.key.concat([agg]) : [group.key, agg];
        result.push(row);
    }
    return result;
};
Array2D.zåˆ†ç»„æ±‡æ€» = Array2D.groupInto;

/**
 * agg - å¯¹æ•°ç»„æ‰§è¡Œèšåˆè®¡ç®—
 * @param {Array} arr - æ•°ç»„
 * @param {string|Function} colSelector - åˆ—é€‰æ‹©å™¨ï¼Œå¦‚ 'f3' æˆ– 'f3-'ï¼ˆé™åºç›¸å…³ï¼‰
 * @param {string} [aggType='sum'] - èšåˆç±»å‹ï¼š'sum', 'count', 'average', 'max', 'min'
 * @returns {Number} èšåˆç»“æœ
 * @example
 * Array2D.agg([[1,2,10],[3,4,20]], 'f3', 'sum')      // 30
 * Array2D.agg([[1,2,10],[3,4,20]], 'f3', 'count')   // 2
 * Array2D.agg([[1,2,10],[3,4,20]], 'f3', 'average') // 15
 * Array2D.agg([[1,2,10],[3,4,20]], 'f3', 'max')     // 20
 * Array2D.agg([[1,2,10],[3,4,20]], 'f3', 'min')     // 10
 */
Array2D.agg = function(arr, colSelector, aggType) {
    if (!arr || !Array.isArray(arr) || arr.length === 0) return 0;
    aggType = (aggType || 'sum').toLowerCase();
    
    // è§£æåˆ—é€‰æ‹©å™¨
    var fn = typeof colSelector === 'function' ? colSelector : parseLambda(colSelector);
    if (!fn) {
        // é»˜è®¤å–ç¬¬ä¸€åˆ—
        fn = function(row) { return row[0]; };
    }
    
    // æå–å€¼
    var values = [];
    for (var i = 0; i < arr.length; i++) {
        var val = fn(arr[i], i);
        if (val !== null && val !== undefined && val !== '') {
            var num = typeof val === 'number' ? val : parseFloat(String(val).replace(/,/g, ''));
            if (!isNaN(num)) {
                values.push(num);
            }
        }
    }
    
    if (values.length === 0) return 0;
    
    switch (aggType) {
        case 'sum':
            var sum = 0;
            for (var i = 0; i < values.length; i++) sum += values[i];
            return sum;
        case 'count':
            return values.length;
        case 'average':
        case 'avg':
            var sum = 0;
            for (var i = 0; i < values.length; i++) sum += values[i];
            return sum / values.length;
        case 'max':
            var max = values[0];
            for (var i = 1; i < values.length; i++) {
                if (values[i] > max) max = values[i];
            }
            return max;
        case 'min':
            var min = values[0];
            for (var i = 1; i < values.length; i++) {
                if (values[i] < min) min = values[i];
            }
            return min;
        default:
            return 0;
    }
};
Array2D.zèšåˆ = Array2D.agg;

/**
 * åˆ†ç»„æ±‡æ€»åˆ°å­—å…¸ï¼ˆgroupIntoMapï¼‰- æŒ‰é”®åˆ†ç»„å¹¶æ±‡æ€»åˆ°Mapå¯¹è±¡
 * @param {Array} arr - æ•°ç»„
 * @param {string|Function} keySelector - åˆ†ç»„é”®é€‰æ‹©å™¨
 * @param {string|Function} [valueSelector] - å€¼é€‰æ‹©å™¨
 * @returns {Map} Mapå¯¹è±¡ï¼Œé”®ä¸ºåˆ†ç»„é”®ï¼Œå€¼ä¸º {group: æ•°ç»„, agg: èšåˆç»“æœ}
 * @example
 * var map = Array2D.groupIntoMap([[1,'A',10],[2,'B',20]], 'f2')
 */
Array2D.groupIntoMap = function(arr, keySelector, valueSelector) {
    if (!arr || !Array.isArray(arr)) return new Map();
    var keyFn = typeof keySelector === 'function' ? keySelector : parseLambda(keySelector);
    var valueFn = valueSelector ? (typeof valueSelector === 'function' ? valueSelector : parseLambda(valueSelector)) : null;
    if (!keyFn) return new Map();

    var map = new Map();
    for (var i = 0; i < arr.length; i++) {
        var key = keyFn(arr[i], i);
        if (!map.has(key)) {
            map.set(key, { group: [], agg: [] });
        }
        var entry = map.get(key);
        entry.group.push(arr[i]);
        if (valueFn) {
            entry.agg.push(valueFn(arr[i], i));
        }
    }
    return map;
};
Array2D.zåˆ†ç»„æ±‡æ€»åˆ°å­—å…¸ = Array2D.groupIntoMap;

/**
 * åˆ†ç»„è¿æ¥ï¼ˆgroupIntoJoinï¼‰- ä¼˜åŒ–sumifså’ŒCountifsæ‰¹é‡æ¡ä»¶ç»Ÿè®¡
 * @param {Array} targetData - ç»Ÿè®¡ç›®æ ‡æ•°æ®ï¼ˆå·¦è¡¨ï¼‰
 * @param {Array} sourceData - æ•°æ®æºï¼ˆå³è¡¨ï¼‰
 * @param {string|Function} keySelector - åˆ†ç»„é”®é€‰æ‹©å™¨
 * @param {string|Function} valueSelector - æ±‡æ€»å‡½æ•°æˆ–é€‰æ‹©å™¨
 * @param {string} [separator='@^@'] - å¤šåˆ—åˆ†ç»„æ—¶çš„åˆ†éš”ç¬¦
 * @returns {Array} è¿æ¥æ±‡æ€»åçš„ç»“æœ
 * @example
 * // å¯¹æºæ•°æ®æŒ‰æ¡ä»¶åˆ†ç±»æ±‡æ€»ï¼Œç„¶åå·¦è¿æ¥åˆ°ç›®æ ‡æ•°æ®
 * Array2D.groupIntoJoin(ç›®æ ‡è¡¨, æºæ•°æ®è¡¨, 'f2', 'sum("f4")');
 * Array2D.groupIntoJoin(ç›®æ ‡è¡¨, æºæ•°æ®è¡¨, 'f2,f3', 'count(),sum("f4")', '@^@');
 * // å®Œæ•´å›è°ƒæ¨¡å¼ç”¨æ³•
 * Array2D.groupIntoJoin(ç›®æ ‡è¡¨, æºæ•°æ®è¡¨, 'f2', g => g.count());
 */
Array2D.groupIntoJoin = function(targetData, sourceData, keySelector, valueSelector, separator) {
    separator = separator || '@^@';
    
    // 1. å…ˆå¯¹æºæ•°æ®åšåˆ†ç±»æ±‡æ€»
    var grouped = Array2D.groupInto(sourceData, keySelector, valueSelector, separator);
    
    // 2. å°†æ±‡æ€»ç»“æœä½œä¸ºå³è¡¨ï¼Œä¸ç›®æ ‡è¡¨åšå·¦è¿æ¥
    return new Array2D(targetData).zå·¦è¿æ¥(
        grouped,
        keySelector,
        keySelector,
        function(leftRow, rightRow) {
            return leftRow.concat(rightRow || []);
        }
    ).val();
};
Array2D.zåˆ†ç»„æ±‡æ€»è¿æ¥ = Array2D.groupIntoJoin;

/**
 * å¤åˆ¶åˆ°æŒ‡å®šä½ç½®ï¼ˆcopyWithinï¼‰- æ•°ç»„å†…éƒ¨å¤åˆ¶
 * @param {Array} arr - æ•°ç»„
 * @param {Number} target - ç›®æ ‡ä½ç½®
 * @param {Number} [start=0] - æºèµ·å§‹ä½ç½®
 * @param {Number} [end] - æºç»“æŸä½ç½®
 * @returns {Array} å¤åˆ¶åçš„æ•°ç»„
 * @example
 * Array2D.copyWithin([[1,2],[3,4],[5,6]], 0, 2)  // [[5,6],[3,4],[5,6]]
 */
Array2D.copyWithin = function(arr, target, start, end) {
    if (!arr || !Array.isArray(arr)) return [];
    var result = JSON.parse(JSON.stringify(arr));
    var copyArr = result.slice(start || 0, end !== undefined ? end : result.length);
    for (var i = 0; i < copyArr.length; i++) {
        if (target + i < result.length) {
            result[target + i] = JSON.parse(JSON.stringify(copyArr[i]));
        }
    }
    return result;
};
Array2D.zå¤åˆ¶åˆ°æŒ‡å®šä½ç½® = Array2D.copyWithin;

/**
 * éšæœºä¸€é¡¹ï¼ˆrandomï¼‰- éšæœºé€‰æ‹©ä¸€è¡Œ
 * @param {Array} arr - æ•°ç»„
 * @returns {Array} éšæœºé€‰æ‹©çš„è¡Œ
 * @example
 * Array2D.random([[1,2],[3,4],[5,6]])  // éšæœºè¿”å›ä¸€è¡Œ
 */
Array2D.random = function(arr) {
    if (!arr || !Array.isArray(arr) || arr.length === 0) return undefined;
    var idx = Math.floor(Math.random() * arr.length);
    return arr[idx];
};
Array2D.zéšæœºä¸€é¡¹ = Array2D.random;

/**
 * éšæœºæ‰“ä¹±ï¼ˆshuffleï¼‰- Fisher-Yates æ´—ç‰Œç®—æ³•
 * @param {Array} arr - æ•°ç»„
 * @returns {Array} æ‰“ä¹±åçš„æ•°ç»„
 * @example
 * Array2D.shuffle([[1,2],[3,4],[5,6]])
 */
Array2D.shuffle = function(arr) {
    if (!arr || !Array.isArray(arr)) return [];
    var result = JSON.parse(JSON.stringify(arr));
    for (var i = result.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = result[i];
        result[i] = result[j];
        result[j] = temp;
    }
    return result;
};
Array2D.zéšæœºæ‰“ä¹± = Array2D.shuffle;

/**
 * é‡å¤Næ¬¡ï¼ˆrepeatï¼‰- å°†æ•°ç»„é‡å¤Næ¬¡
 * @param {Array} arr - æ•°ç»„
 * @param {Number} count - é‡å¤æ¬¡æ•°
 * @returns {Array} é‡å¤åçš„æ•°ç»„
 * @example
 * Array2D.repeat([[1,2]], 3)  // [[1,2],[1,2],[1,2]]
 */
Array2D.repeat = function(arr, count) {
    if (!arr || !Array.isArray(arr)) return [];
    if (count <= 0) return [];
    var result = [];
    for (var i = 0; i < count; i++) {
        for (var j = 0; j < arr.length; j++) {
            result.push(JSON.parse(JSON.stringify(arr[j])));
        }
    }
    return result;
};
Array2D.zé‡å¤Næ¬¡ = Array2D.repeat;

/**
 * é™æ€æ–¹æ³•ï¼šé€‰æ‹©åˆ—ï¼ˆè¿”å› Array2D å¯¹è±¡ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ï¼‰
 * @param {Array|Array2D} arr - äºŒç»´æ•°ç»„æˆ– Array2D å¯¹è±¡
 */
Array2D.zé€‰æ‹©åˆ— = function(arr, cols, newHeaders) {
    // æ™ºèƒ½åˆ¤æ–­ï¼šå¦‚æœæ˜¯ Array2D å¯¹è±¡ï¼Œç›´æ¥è°ƒç”¨å®ä¾‹æ–¹æ³•
    if (arr && arr instanceof Array2D) {
        return arr.zé€‰æ‹©åˆ—(cols, newHeaders);
    }
    return new Array2D(arr).zé€‰æ‹©åˆ—(cols, newHeaders);
};
Array2D.selectCols = Array2D.zé€‰æ‹©åˆ—;

/**
 * ç‰ˆæœ¬å·ï¼ˆversionï¼‰- è¿”å›Array2Då‡½æ•°åº“ç‰ˆæœ¬å·
 * @returns {String} ç‰ˆæœ¬å·
 * @example
 * Array2D.version()  // "3.2.0"
 */
Array2D.version = function() {
    return '3.7.9';
};

/**
 * é™æ€æ–¹æ³•ï¼šæ•°é‡ï¼ˆcountï¼‰- è®¡ç®—æ•°ç»„çš„å…ƒç´ æ•°é‡
 * @param {Array} arr - æ•°ç»„
 * @returns {Number} å…ƒç´ æ•°é‡
 * @example
 * Array2D.count([[1,2],[3,4]])  // 4
 */
Array2D.count = function(arr) {
    if (!arr || !Array.isArray(arr)) return 0;
    var count = 0;
    for (var i = 0; i < arr.length; i++) {
        if (Array.isArray(arr[i])) {
            count += arr[i].length;
        } else {
            count++;
        }
    }
    return count;
};
Array2D.zæ•°é‡ = Array2D.count;

/**
 * é™æ€æ–¹æ³•ï¼šæ‰¹é‡å¡«å……
 */
Array2D.zæ‰¹é‡å¡«å…… = function(arr, value, rows, cols) {
    return new Array2D(arr).zå¡«å……(value, rows, cols).val();
};
Array2D.fill = Array2D.zæ‰¹é‡å¡«å……;

/**
 * é™æ€æ–¹æ³•ï¼šå†™å…¥å•å…ƒæ ¼ï¼ˆæ ¹æ®æ•°ç»„å¤§å°è‡ªåŠ¨æ‰©å±•åŒºåŸŸï¼Œè¿”å› Range å¯¹è±¡ï¼‰
 * @param {Array} arr - äºŒç»´æ•°ç»„
 * @param {Range|string} rng - ç›®æ ‡å•å…ƒæ ¼åŒºåŸŸï¼ˆå·¦ä¸Šè§’å•å…ƒæ ¼ï¼‰
 * @returns {Range} å†™å…¥çš„ Range å¯¹è±¡
 * @example
 * var arr = [[1, 'A'], [2, 'B'], [3, 'C']];
 * Array2D.toRange(arr, "Sheet1!a1");
 * Array2D.toRange(arr, "e1");
 * var rs = Array2D.toRange(arr, Range("i1"));
 * console.log(rs.Address());  // $I$1:$J$3
 */
Array2D.toRange = function(arr, rng) {
    if (!isWPS) return null;
    var targetRng = typeof rng === 'string' ? Range(rng) : rng;
    var rows = arr.length;
    var cols = rows > 0 ? (Array.isArray(arr[0]) ? arr[0].length : 1) : 0;

    // ğŸ”§ é˜²å¾¡æ€§æ£€æŸ¥ï¼šç¡®ä¿ç»´åº¦æœ‰æ•ˆ
    if (rows === 0 || cols === 0) {
        console.log("âš ï¸ è­¦å‘Š: toRange æ”¶åˆ°ç©ºæ•°ç»„ (rows=" + rows + ", cols=" + cols + ")");
        return targetRng;  // è¿”å›åŸrangeï¼Œä¸åšæ“ä½œ
    }

    // ğŸ”§ é˜²å¾¡æ€§æ£€æŸ¥ï¼šé˜²æ­¢è¶…å¤§èŒƒå›´å¯¼è‡´WPSå´©æºƒ
    if (rows > 100000 || cols > 16000) {
        console.log("âš ï¸ è­¦å‘Š: toRange ç»´åº¦è¶…é™ (rows=" + rows + ", cols=" + cols + ")");
        return targetRng;
    }

    // æ ¹æ®æ•°ç»„å¤§å°è°ƒæ•´ç›®æ ‡åŒºåŸŸ
    try {
        var endRng = targetRng.Item(rows, cols);
    } catch (e) {
        console.log("âŒ åˆ›å»º endRng å¤±è´¥: rows=" + rows + ", cols=" + cols + ", é”™è¯¯: " + e.message);
        // å°è¯•ä½¿ç”¨ Offset æ–¹æ³•
        try {
            var endRng = targetRng.Offset(rows - 1, cols - 1);
        } catch (e2) {
            console.log("âŒ Offset æ–¹æ³•ä¹Ÿå¤±è´¥: " + e2.message);
            return targetRng;
        }
    }

    var sheet = targetRng.Worksheet || Application.ActiveSheet;
    var writeRng = sheet.Range(targetRng, endRng);

    // ğŸ”§ æ€§èƒ½ä¼˜åŒ–ï¼šä¸€æ¬¡æ€§è§£é™¤æ•´ä¸ªåŒºåŸŸçš„åˆå¹¶ï¼Œè€Œä¸æ˜¯é€ä¸ªå•å…ƒæ ¼æ£€æŸ¥
    // æ–¹æ³•ï¼šç›´æ¥è®¾ç½® MergeCells = false
    try {
        writeRng.MergeCells = false;
    } catch (e) {
        // å¦‚æœä¸€æ¬¡æ€§è§£é™¤å¤±è´¥ï¼Œå›é€€åˆ°åŸæ–¹æ³•ï¼ˆä¿ç•™å‘åå…¼å®¹ï¼‰
        for (var i = 1; i <= writeRng.Rows.Count; i++) {
            for (var j = 1; j <= writeRng.Columns.Count; j++) {
                var cell = writeRng.Cells(i, j);
                if (cell.MergeCells) {
                    cell.MergeArea.UnMerge();
                }
            }
        }
    }

    // æ‰¹é‡å†™å…¥æ•°æ®
    writeRng.Value2 = arr;
    return writeRng;
};

/**
 * é™æ€æ–¹æ³•ï¼šå†™å…¥å•å…ƒæ ¼ï¼ˆä¸­æ–‡åˆ«åï¼Œè¿”å› Range å¯¹è±¡ï¼‰
 */
Array2D.zå†™å…¥å•å…ƒæ ¼ = Array2D.toRange;

// ==================== é™æ€æ–¹æ³•å°è£…ï¼ˆæ”¯æŒç›´æ¥è°ƒç”¨ï¼‰====================

/**
 * é™æ€æ–¹æ³•ï¼šç­›é€‰ï¼ˆfilterï¼‰- æ ¹æ®æ¡ä»¶ç­›é€‰æ•°ç»„è¡Œ
 * @param {Array} arr - äºŒç»´æ•°ç»„
 * @param {String|Function} predicate - ç­›é€‰æ¡ä»¶
 * @param {Number} skipHeader - è·³è¿‡è¡¨å¤´è¡Œæ•°
 * @returns {Array} ç­›é€‰åçš„äºŒç»´æ•°ç»„
 * @example
 * Array2D.filter(arr, 'f1>1')
 * Array2D.filter(arr, x=>x.f1>5 && x.f2=="A")
 * Array2D.filter(arr, "[f1,f3,f4]")
 */
Array2D.filter = function(arr, predicate, skipHeader) {
    // å¤„ç†å¯¹è±¡å‚æ•°å½¢å¼
    if (predicate && typeof predicate === 'object' && !Array.isArray(predicate)) {
        var data = skipHeader ? arr.slice(skipHeader) : arr;
        return Array2D._filterByObject(data, predicate);
    }
    // ğŸ”§ v3.7.6 ä¿®å¤: ä¿ç•™ Array2D å¯¹è±¡è€Œéè¿”å› .val()
    // è¿™æ ·å¯ä»¥ä¿ç•™ _header å±æ€§ç”¨äºåç»­æ“ä½œ
    var result = new Array2D(arr).zç­›é€‰(predicate, skipHeader);
    // å¦‚æœåŸå§‹è¾“å…¥æœ‰ _header å±æ€§ï¼Œç¡®ä¿ç»“æœå¯¹è±¡ä¹Ÿæœ‰ï¼ˆè™½ç„¶ zç­›é€‰é€šè¿‡ _new å·²ç»ä¿ç•™ï¼‰
    return result;
};
Array2D.zç­›é€‰ = Array2D.filter;

/**
 * é™æ€æ–¹æ³•ï¼šæ˜ å°„ï¼ˆmapï¼‰- å¯¹æ•°ç»„çš„æ¯è¡Œè¿›è¡Œè½¬æ¢
 * @param {Array} arr - äºŒç»´æ•°ç»„
 * @param {String|Function} mapper - è½¬æ¢å‡½æ•°
 * @returns {Array} è½¬æ¢åçš„äºŒç»´æ•°ç»„
 * @example
 * Array2D.map(arr, 'f1*2')
 * Array2D.map(arr, x=>[x.f1, x.f3])
 * Array2D.map(arr, "[f1,f3]")
 */
Array2D.map = function(arr, mapper) {
    return new Array2D(arr).zæ˜ å°„(mapper).val();
};
Array2D.zæ˜ å°„ = Array2D.map;

/**
 * é™æ€æ–¹æ³•ï¼šå»é‡ï¼ˆdistinctï¼‰- æ ¹æ®æŒ‡å®šåˆ—å»é‡
 * @param {Array} arr - äºŒç»´æ•°ç»„
 * @param {String|Function} keySelector - å»é‡ä¾æ®çš„åˆ—
 * @param {String} resultSelector - ç»“æœé€‰æ‹©å™¨
 * @returns {Array} å»é‡åçš„äºŒç»´æ•°ç»„
 * @example
 * Array2D.distinct(arr, 'f1,f2')
 * Array2D.distinct(arr, x=>x.f1)
 * Array2D.distinct(arr)
 */
Array2D.distinct = function(arr, keySelector, resultSelector) {
    return new Array2D(arr).zå»é‡(keySelector, resultSelector).val();
};
Array2D.zå»é‡ = Array2D.distinct;

/**
 * é™æ€æ–¹æ³•ï¼šå¤šåˆ—æ’åºï¼ˆsortByColsï¼‰- æŒ‰å¤šåˆ—æ’åº
 * @param {Array} arr - äºŒç»´æ•°ç»„
 * @param {String} colsConfig - åˆ—é…ç½®ï¼Œå¦‚ 'f1+,f2-,f3+'
 * @param {Number} skipHeader - è¡¨å¤´è¡Œæ•°
 * @returns {Array} æ’åºåçš„äºŒç»´æ•°ç»„
 * @example
 * Array2D.sortByCols(arr, 'f1+,f2-', 1)
 */
Array2D.sortByCols = function(arr, colsConfig, skipHeader) {
    // ğŸ”§ v3.7.6 ä¿®å¤: ä¿ç•™ Array2D å¯¹è±¡è€Œéè¿”å› .val()
    // è¿™æ ·å¯ä»¥ä¿ç•™ _header å±æ€§ç”¨äºåç»­æ“ä½œ
    var result = new Array2D(arr).zå¤šåˆ—æ’åº(colsConfig, skipHeader);
    return result;
};
Array2D.zå¤šåˆ—æ’åº = Array2D.sortByCols;

/**
 * é™æ€æ–¹æ³•ï¼šè‡ªå®šä¹‰æ’åºï¼ˆsortByListï¼‰- æŒ‰è‡ªå®šä¹‰åˆ—è¡¨æ’åº
 * @param {Array} arr - äºŒç»´æ•°ç»„
 * @param {String|Number} col - åˆ—å·æˆ–åˆ—å
 * @param {String} orderList - æ’åºé¡ºåºï¼Œå¦‚ "A,B,C"
 * @param {Number} skipHeader - è¡¨å¤´è¡Œæ•°
 * @returns {Array} æ’åºåçš„äºŒç»´æ•°ç»„
 * @example
 * Array2D.sortByList(arr, 'f3', 'ç¾å›½,å¾·å›½,ä¸­å›½')
 */
Array2D.sortByList = function(arr, col, orderList, skipHeader) {
    return new Array2D(arr).zè‡ªå®šä¹‰æ’åº(col, orderList, skipHeader).val();
};
Array2D.zè‡ªå®šä¹‰æ’åº = Array2D.sortByList;

// ==================== æ™ºèƒ½ç±»å‹è¯†åˆ«ä¸æ™ºèƒ½æ’åº/åˆ†ç»„ ====================

/**
 * æ™ºèƒ½ç±»å‹æ£€æµ‹ - è‡ªåŠ¨è¯†åˆ«åˆ—çš„æ•°æ®ç±»å‹
 * @param {Array} data - äºŒç»´æ•°ç»„æ•°æ®
 * @param {number} colIndex - åˆ—ç´¢å¼•
 * @returns {Object} ç±»å‹ä¿¡æ¯ {type: 'number'|'date'|'string'|'boolean', format: string}
 */
Array2D.detectType = function(data, colIndex) {
    var samples = [];
    var maxSamples = Math.min(data.length, 100); // æœ€å¤šå–æ ·100è¡Œ
    
    for (var i = 0; i < maxSamples; i++) {
        if (data[i] && data[i][colIndex] !== undefined && data[i][colIndex] !== null && data[i][colIndex] !== '') {
            samples.push(data[i][colIndex]);
        }
    }
    
    if (samples.length === 0) {
        return { type: 'string', format: 'text' };
    }
    
    // æ£€æµ‹å¸ƒå°”å€¼
    var boolCount = 0;
    for (var i = 0; i < samples.length; i++) {
        var v = samples[i];
        if (v === true || v === false || v === 'true' || v === 'false' || v === 'æ˜¯' || v === 'å¦' || v === 'YES' || v === 'NO') {
            boolCount++;
        }
    }
    if (boolCount / samples.length > 0.8) {
        return { type: 'boolean', format: 'boolean' };
    }
    
    // æ£€æµ‹æ—¥æœŸ
    var dateCount = 0;
    var datePatterns = [
        /^\d{4}[-/\.]\d{1,2}[-/\.]\d{1,2}$/,           // 2024-01-15, 2024/01/15
        /^\d{1,2}[-/\.]\d{1,2}[-/\.]\d{4}$/,           // 15-01-2024, 01/15/2024
        /^\d{4}å¹´\d{1,2}æœˆ\d{1,2}[æ—¥]?$/,               // 2024å¹´01æœˆ15æ—¥
        /^\d{1,2}æœˆ\d{1,2}[æ—¥]?$/,                      // 01æœˆ15æ—¥
        /^\d{8}$/                                        // 20240115
    ];
    
    for (var i = 0; i < samples.length; i++) {
        var s = String(samples[i]);
        for (var j = 0; j < datePatterns.length; j++) {
            if (datePatterns[j].test(s)) {
                dateCount++;
                break;
            }
        }
    }
    if (dateCount / samples.length > 0.8) {
        // åˆ¤æ–­æ—¥æœŸæ ¼å¼
        var sample = String(samples[0]);
        var format = 'date';
        if (sample.indexOf('-') > 0) format = 'yyyy-MM-dd';
        else if (sample.indexOf('/') > 0) format = 'yyyy/MM/dd';
        else if (sample.indexOf('.') > 0) format = 'yyyy.MM.dd';
        else if (sample.indexOf('å¹´') > 0) format = 'yyyyå¹´MMæœˆddæ—¥';
        else if (/^\d{8}$/.test(sample)) format = 'yyyyMMdd';
        return { type: 'date', format: format };
    }
    
    // æ£€æµ‹æ•°å­—
    var numCount = 0;
    for (var i = 0; i < samples.length; i++) {
        var v = samples[i];
        if (typeof v === 'number') {
            numCount++;
        } else if (typeof v === 'string') {
            // å»æ‰åƒåˆ†ä½ç¬¦åæ£€æµ‹
            var clean = v.replace(/,/g, '').replace(/\s/g, '');
            if (!isNaN(parseFloat(clean)) && isFinite(clean)) {
                numCount++;
            }
        }
    }
    if (numCount / samples.length > 0.8) {
        return { type: 'number', format: 'number' };
    }
    
    // é»˜è®¤ä¸ºå­—ç¬¦ä¸²
    return { type: 'string', format: 'text' };
};
Array2D.zæ£€æµ‹ç±»å‹ = Array2D.detectType;

/**
 * æ™ºèƒ½æ’åº - è‡ªåŠ¨è¯†åˆ«æ•°æ®ç±»å‹å¹¶è¿›è¡Œé€‚å½“æ’åº
 * @param {Array} arr - äºŒç»´æ•°ç»„
 * @param {string|number} col - åˆ—å·æˆ–åˆ—å
 * @param {string} direction - æ’åºæ–¹å‘ '+' æˆ– '-'ï¼Œå¯é€‰ï¼Œä¸æŒ‡å®šåˆ™è‡ªåŠ¨åˆ¤æ–­
 * @param {number} skipHeader - è·³è¿‡è¡¨å¤´è¡Œæ•°
 * @returns {Array} æ’åºåçš„æ•°ç»„
 */
Array2D.smartSort = function(arr, col, direction, skipHeader) {
    var data = arr;
    var header = [];
    skipHeader = skipHeader || 0;
    
    if (skipHeader > 0) {
        header = data.slice(0, skipHeader);
        data = data.slice(skipHeader);
    }
    
    // è§£æåˆ—ç´¢å¼•
    var colIndex = -1;
    if (typeof col === 'string' && col.match(/^f\d+$/i)) {
        colIndex = parseInt(col.substring(1)) - 1;
    } else if (typeof col === 'number') {
        colIndex = col;
    }
    
    if (colIndex < 0) {
        return arr;
    }
    
    // æ£€æµ‹ç±»å‹
    var typeInfo = Array2D.detectType(data, colIndex);
    
    // å¦‚æœæœªæŒ‡å®šæ–¹å‘ï¼Œæ•°å­—å’Œæ—¥æœŸé»˜è®¤å‡åºï¼Œå­—ç¬¦ä¸²é»˜è®¤æŒ‰æ‹¼éŸ³å‡åº
    if (!direction) {
        direction = '+';
    }
    
    var isDesc = direction === '-';
    
    // æ ¹æ®ç±»å‹æ’åº
    data.sort(function(a, b) {
        var valA = a[colIndex];
        var valB = b[colIndex];
        
        // å¤„ç†ç©ºå€¼
        if (valA === null || valA === undefined || valA === '') {
            return isDesc ? 1 : -1;
        }
        if (valB === null || valB === undefined || valB === '') {
            return isDesc ? -1 : 1;
        }
        
        var result = 0;
        
        switch (typeInfo.type) {
            case 'number':
                // æ•°å­—æ’åº
                var numA = typeof valA === 'number' ? valA : parseFloat(String(valA).replace(/,/g, ''));
                var numB = typeof valB === 'number' ? valB : parseFloat(String(valB).replace(/,/g, ''));
                result = numA - numB;
                break;
                
            case 'date':
                // æ—¥æœŸæ’åº - ç»Ÿä¸€è½¬æ¢ä¸ºå¯æ¯”è¾ƒæ ¼å¼
                var dateA = Array2D._parseDateForSort(valA);
                var dateB = Array2D._parseDateForSort(valB);
                result = dateA - dateB;
                break;
                
            case 'boolean':
                // å¸ƒå°”æ’åº
                var boolA = valA === true || valA === 'true' || valA === 'æ˜¯' || valA === 'YES' ? 1 : 0;
                var boolB = valB === true || valB === 'true' || valB === 'æ˜¯' || valB === 'YES' ? 1 : 0;
                result = boolA - boolB;
                break;
                
            default:
                // å­—ç¬¦ä¸²æ’åºï¼ˆå°è¯•æŒ‰æ‹¼éŸ³ï¼‰
                var strA = String(valA);
                var strB = String(valB);
                
                // å¦‚æœæœ‰ä¸­æ–‡ï¼Œå°è¯•æŒ‰æ‹¼éŸ³æ’åº
                if (/[\u4e00-\u9fa5]/.test(strA) || /[\u4e00-\u9fa5]/.test(strB)) {
                    // åœ¨WPSç¯å¢ƒä¸­å¯èƒ½æ²¡æœ‰localeCompareï¼Œä½¿ç”¨ç®€å•æ¯”è¾ƒ
                    result = strA.localeCompare ? strA.localeCompare(strB, 'zh-CN') : (strA > strB ? 1 : -1);
                } else {
                    result = strA.toLowerCase() > strB.toLowerCase() ? 1 : -1;
                }
        }
        
        return isDesc ? -result : result;
    });
    
    return header.concat(data);
};
Array2D.zæ™ºèƒ½æ’åº = Array2D.smartSort;

/**
 * å†…éƒ¨æ–¹æ³•ï¼šè§£ææ—¥æœŸç”¨äºæ’åº
 * @private
 */
Array2D._parseDateForSort = function(dateVal) {
    if (dateVal instanceof Date) {
        return dateVal.getTime();
    }
    
    var s = String(dateVal);
    
    // å°è¯•è§£æå„ç§æ—¥æœŸæ ¼å¼
    // yyyy-MM-dd
    var match = s.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})$/);
    if (match) {
        return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3])).getTime();
    }
    
    // yyyyå¹´MMæœˆddæ—¥
    match = s.match(/^(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})/);
    if (match) {
        return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3])).getTime();
    }
    
    // yyyyMMdd
    match = s.match(/^(\d{4})(\d{2})(\d{2})$/);
    if (match) {
        return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3])).getTime();
    }
    
    // å…¶ä»–æ ¼å¼å°è¯•ç›´æ¥è§£æ
    var d = new Date(s);
    if (!isNaN(d.getTime())) {
        return d.getTime();
    }
    
    return 0;
};

/**
 * æ™ºèƒ½åˆ†ç»„ - è‡ªåŠ¨è¯†åˆ«æ•°æ®ç±»å‹å¹¶è¿›è¡Œé€‚å½“åˆ†ç»„
 * @param {Array} arr - äºŒç»´æ•°ç»„
 * @param {string|number} col - åˆ—å·æˆ–åˆ—å
 * @param {string} groupBy - åˆ†ç»„æ–¹å¼ï¼ˆæ—¥æœŸæœ‰æ•ˆï¼‰ï¼š'year'|'month'|'day'|'week'
 * @returns {Map} åˆ†ç»„ç»“æœ
 */
Array2D.smartGroup = function(arr, col, groupBy) {
    var data = arr;
    
    // è§£æåˆ—ç´¢å¼•
    var colIndex = -1;
    if (typeof col === 'string' && col.match(/^f\d+$/i)) {
        colIndex = parseInt(col.substring(1)) - 1;
    } else if (typeof col === 'number') {
        colIndex = col;
    }
    
    if (colIndex < 0) {
        return new Map();
    }
    
    // æ£€æµ‹ç±»å‹
    var typeInfo = Array2D.detectType(data, colIndex);
    
    var groups = new Map();
    
    for (var i = 0; i < data.length; i++) {
        var row = data[i];
        var val = row[colIndex];
        var key;
        
        if (typeInfo.type === 'date' && groupBy) {
            // æŒ‰æ—¥æœŸç»´åº¦åˆ†ç»„
            var date = Array2D._parseDateForSort(val);
            var d = new Date(date);
            
            switch (groupBy) {
                case 'year':
                case 'å¹´':
                    key = d.getFullYear() + 'å¹´';
                    break;
                case 'month':
                case 'æœˆ':
                    key = d.getFullYear() + 'å¹´' + (d.getMonth() + 1) + 'æœˆ';
                    break;
                case 'day':
                case 'æ—¥':
                    key = d.getFullYear() + '-' + (d.getMonth() + 1) + '-' + d.getDate();
                    break;
                case 'week':
                case 'å‘¨':
                    // è®¡ç®—å‘¨æ•°
                    var weekStart = new Date(d.getFullYear(), 0, 1);
                    var weekNum = Math.ceil(((d - weekStart) / 86400000 + weekStart.getDay() + 1) / 7);
                    key = d.getFullYear() + 'å¹´ç¬¬' + weekNum + 'å‘¨';
                    break;
                case 'quarter':
                case 'å­£åº¦':
                    var quarter = Math.floor(d.getMonth() / 3) + 1;
                    key = d.getFullYear() + 'å¹´Q' + quarter;
                    break;
                default:
                    key = String(val);
            }
        } else if (typeInfo.type === 'number' && groupBy) {
            // æŒ‰æ•°å­—èŒƒå›´åˆ†ç»„
            var num = typeof val === 'number' ? val : parseFloat(String(val).replace(/,/g, ''));
            if (groupBy === 'decade' || groupBy === 'åä½æ•°') {
                var decade = Math.floor(num / 10) * 10;
                key = decade + '-' + (decade + 9);
            } else if (groupBy === 'hundred' || groupBy === 'ç™¾ä½æ•°') {
                var hundred = Math.floor(num / 100) * 100;
                key = hundred + '-' + (hundred + 99);
            } else if (groupBy === 'thousand' || groupBy === 'åƒä½æ•°') {
                var thousand = Math.floor(num / 1000) * 1000;
                key = thousand + '-' + (thousand + 999);
            } else {
                key = String(val);
            }
        } else {
            key = String(val);
        }
        
        if (!groups.has(key)) {
            groups.set(key, []);
        }
        groups.get(key).push(row);
    }
    
    return groups;
};
Array2D.zæ™ºèƒ½åˆ†ç»„ = Array2D.smartGroup;

// å®ä¾‹æ–¹æ³•ç‰ˆæœ¬
Array2D.prototype.zæ™ºèƒ½æ’åº = function(col, direction, skipHeader) {
    return this._new(Array2D.smartSort(this._items, col, direction, skipHeader));
};

Array2D.prototype.zæ™ºèƒ½åˆ†ç»„ = function(col, groupBy) {
    return Array2D.smartGroup(this._items, col, groupBy);
};

Array2D.prototype.zæ£€æµ‹ç±»å‹ = function(col) {
    var colIndex = -1;
    if (typeof col === 'string' && col.match(/^f\d+$/i)) {
        colIndex = parseInt(col.substring(1)) - 1;
    } else if (typeof col === 'number') {
        colIndex = col;
    }
    return Array2D.detectType(this._items, colIndex);
};

/**
 * é™æ€æ–¹æ³•ï¼šæ‰¹é‡æ’å…¥åˆ—ï¼ˆinsertColsï¼‰- åœ¨æŒ‡å®šä½ç½®æ’å…¥åˆ—
 * @param {Array} arr - äºŒç»´æ•°ç»„
 * @param {Number|Array} colPos - æ’å…¥ä½ç½®æˆ–å¤šä¸ªä½ç½®
 * @param {Array|String} values - æ’å…¥çš„å€¼
 * @param {Number} totalCols - æ€»åˆ—æ•°
 * @returns {Array} æ’å…¥åˆ—åçš„äºŒç»´æ•°ç»„
 * @example
 * Array2D.insertCols(arr, 2, ['æ–°åˆ—1','æ–°åˆ—2'])
 */
Array2D.insertCols = function(arr, colPos, values, totalCols) {
    return new Array2D(arr).zæ‰¹é‡æ’å…¥åˆ—(colPos, values, totalCols).val();
};
Array2D.zæ‰¹é‡æ’å…¥åˆ— = Array2D.insertCols;

/**
 * é™æ€æ–¹æ³•ï¼šæ‰¹é‡åˆ é™¤åˆ—ï¼ˆdeleteCols/delColsï¼‰- åˆ é™¤æŒ‡å®šåˆ—
 * @param {Array} arr - äºŒç»´æ•°ç»„
 * @param {String|Number|Array} cols - åˆ—é…ç½®
 * @returns {Array} åˆ é™¤åˆ—åçš„äºŒç»´æ•°ç»„
 * @example
 * Array2D.deleteCols(arr, '1,3,5')
 * Array2D.delCols(arr, [0, 2, 4])
 */
Array2D.deleteCols = function(arr, cols) {
    return new Array2D(arr).zæ‰¹é‡åˆ é™¤åˆ—(cols).val();
};
Array2D.zæ‰¹é‡åˆ é™¤åˆ— = Array2D.deleteCols;
Array2D.delCols = Array2D.deleteCols;

/**
 * é™æ€æ–¹æ³•ï¼šå·¦è¿æ¥ï¼ˆleftjoinï¼‰- ç±»ä¼¼SQLçš„LEFT JOIN
 * @param {Array} arr - å·¦è¡¨
 * @param {Array} brr - å³è¡¨
 * @param {String|Function} leftKey - å·¦è¡¨å…³é”®å­—
 * @param {String|Function} rightKey - å³è¡¨å…³é”®å­—
 * @param {String|Function} resultSelector - ç»“æœé€‰æ‹©å™¨
 * @returns {Array} è¿æ¥åçš„äºŒç»´æ•°ç»„
 * @example
 * Array2D.leftjoin(arr, brr, 'f1', 'f1', 'f1,f2,f4')
 */
Array2D.leftjoin = function(arr, brr, leftKey, rightKey, resultSelector) {
    return new Array2D(arr).zå·¦è¿æ¥(brr, leftKey, rightKey, resultSelector).val();
};
Array2D.zå·¦è¿æ¥ = Array2D.leftjoin;

/**
 * é™æ€æ–¹æ³•ï¼šæ’é™¤ï¼ˆexceptï¼‰- è·å–åœ¨arrä¸­ä½†ä¸åœ¨brrä¸­çš„å…ƒç´ 
 * @param {Array} arr - æ•°ç»„1
 * @param {Array} brr - æ•°ç»„2
 * @returns {Array} å·®å¼‚æ•°ç»„
 * @example
 * Array2D.except(arr, brr)
 */
Array2D.except = function(arr, brr) {
    return new Array2D(arr).zæ’é™¤(brr).val();
};
Array2D.zæ’é™¤ = Array2D.except;

/**
 * é™æ€æ–¹æ³•ï¼šäº¤é›†ï¼ˆintersectï¼‰- è·å–arrå’Œbrrçš„äº¤é›†
 * @param {Array} arr - æ•°ç»„1
 * @param {Array} brr - æ•°ç»„2
 * @returns {Array} äº¤é›†æ•°ç»„
 * @example
 * Array2D.intersect(arr, brr)
 */
Array2D.intersect = function(arr, brr) {
    return new Array2D(arr).zå–äº¤é›†(brr).val();
};
Array2D.zå–äº¤é›† = Array2D.intersect;

/**
 * é™æ€æ–¹æ³•ï¼šå¹¶é›†ï¼ˆunionï¼‰- è·å–arrå’Œbrrçš„å¹¶é›†å¹¶å»é‡
 * @param {Array} arr - æ•°ç»„1
 * @param {Array} brr - æ•°ç»„2
 * @returns {Array} å¹¶é›†æ•°ç»„
 * @example
 * Array2D.union(arr, brr)
 */
Array2D.union = function(arr, brr) {
    return new Array2D(arr).zå»é‡å¹¶é›†(brr).val();
};
Array2D.zå»é‡å¹¶é›† = Array2D.union;

/**
 * é™æ€æ–¹æ³•ï¼šæœ€å¤§å€¼ï¼ˆmaxï¼‰- è·å–æ•°ç»„æœ€å¤§å€¼
 * @param {Array} arr - æ•°ç»„
 * @param {String|Function} selector - é€‰æ‹©å™¨
 * @returns {Number} æœ€å¤§å€¼
 * @example
 * Array2D.max(arr)
 * Array2D.max(arr, 'f1')
 */
Array2D.max = function(arr, selector) {
    var result = new Array2D(arr).zæœ€å¤§å€¼(selector);
    return typeof result === 'object' && result.val ? result.val() : result;
};
Array2D.zæœ€å¤§å€¼ = Array2D.max;

/**
 * é™æ€æ–¹æ³•ï¼šæœ€å°å€¼ï¼ˆminï¼‰- è·å–æ•°ç»„æœ€å°å€¼
 * @param {Array} arr - æ•°ç»„
 * @param {String|Function} selector - é€‰æ‹©å™¨
 * @returns {Number} æœ€å°å€¼
 * @example
 * Array2D.min(arr)
 * Array2D.min(arr, 'f1')
 */
Array2D.min = function(arr, selector) {
    var result = new Array2D(arr).zæœ€å°å€¼(selector);
    return typeof result === 'object' && result.val ? result.val() : result;
};
Array2D.zæœ€å°å€¼ = Array2D.min;

/**
 * é™æ€æ–¹æ³•ï¼šæ–‡æœ¬è¿æ¥ï¼ˆtextjoinï¼‰- é€‰æ‹©æŒ‡å®šåˆ—çš„å€¼ï¼Œç”¨åˆ†éš”ç¬¦è¿æ¥
 * @param {Array} arr - äºŒç»´æ•°ç»„
 * @param {String|Number|Function} selector - åˆ—é€‰æ‹©å™¨ï¼Œå¦‚ 'f1' æˆ– 0 æˆ– row=>row.col
 * @param {String} [separator=','] - åˆ†éš”ç¬¦
 * @returns {String} è¿æ¥åçš„å­—ç¬¦ä¸²
 * @example
 * Array2D.textjoin([['a','b'],['c','d']], 1, '+')  // "b+d"
 * Array2D.textjoin([['a','b'],['c','d']], 'f2', '+')  // "b+d"
 */
Array2D.textjoin = function(arr, selector, separator = ',') {
    return new Array2D(arr).zæ–‡æœ¬è¿æ¥(selector, separator);
};
Array2D.zæ–‡æœ¬è¿æ¥ = Array2D.textjoin;

/**
 * Array åŸå‹æ–¹æ³•ï¼štextjoin - ä¸ºæ™®é€šæ•°ç»„æ·»åŠ  textjoin æ–¹æ³•
 * è¿™æ · .res() è¿”å›çš„æ•°ç»„ä¹Ÿå¯ä»¥ä½¿ç”¨ .textjoin()
 */
if (!Array.prototype.textjoin) {
    Array.prototype.textjoin = function(selector, separator = ',') {
        return Array2D.textjoin(this, selector, separator);
    };
}

/**
 * Array åŸå‹æ–¹æ³•ï¼štoRange - ä¸ºæ™®é€šæ•°ç»„æ·»åŠ  toRange æ–¹æ³•
 * è¿™æ · .res() è¿”å›çš„æ•°ç»„ä¹Ÿå¯ä»¥ä½¿ç”¨ .toRange()
 */
if (!Array.prototype.toRange) {
    Array.prototype.toRange = function(rng) {
        return Array2D.toRange(this, rng);
    };
}

/**
 * Array åŸå‹æ–¹æ³•ï¼šgetRange - ä¸ºæ™®é€šæ•°ç»„æ·»åŠ  getRange æ–¹æ³•
 * è¿™æ · .res() è¿”å›çš„æ•°ç»„ä¹Ÿå¯ä»¥ä½¿ç”¨ .getRange()
 */
if (!Array.prototype.getRange) {
    Array.prototype.getRange = function(rng) {
        return Array2D.toRange(this, rng);
    };
}

/**
 * é™æ€æ–¹æ³•ï¼šå¹³å‡å€¼ï¼ˆaverageï¼‰- è·å–æ•°ç»„å¹³å‡å€¼
 * @param {Array} arr - æ•°ç»„
 * @param {String|Function} selector - é€‰æ‹©å™¨
 * @returns {Number} å¹³å‡å€¼
 * @example
 * Array2D.average(arr)
 * Array2D.average(arr, 'f1')
 */
Array2D.average = function(arr, selector) {
    var result = new Array2D(arr).zå¹³å‡å€¼(selector);
    return typeof result === 'object' && result.val ? result.val() : result;
};
Array2D.zå¹³å‡å€¼ = Array2D.average;

/**
 * é™æ€æ–¹æ³•ï¼šç¬¬ä¸€ä¸ªï¼ˆfirstï¼‰- è·å–ç¬¬ä¸€ä¸ªå…ƒç´ 
 * @param {Array} arr - æ•°ç»„
 * @param {String|Function} predicate - ç­›é€‰æ¡ä»¶
 * @returns {Array} ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆè¡Œï¼‰
 * @example
 * Array2D.first(arr)
 * Array2D.first(arr, 'f1>5')
 */
Array2D.first = function(arr, predicate) {
    var result = predicate ? new Array2D(arr).zç¬¬ä¸€ä¸ª(predicate) : new Array2D(arr).zç¬¬ä¸€ä¸ª();
    return typeof result === 'object' && result.val ? result.val() : result;
};
Array2D.zç¬¬ä¸€ä¸ª = Array2D.first;

/**
 * é™æ€æ–¹æ³•ï¼šæœ€åä¸€ä¸ªï¼ˆlastï¼‰- è·å–æœ€åä¸€ä¸ªå…ƒç´ 
 * @param {Array} arr - æ•°ç»„
 * @param {String|Function} predicate - ç­›é€‰æ¡ä»¶
 * @returns {Array} æœ€åä¸€ä¸ªå…ƒç´ ï¼ˆè¡Œï¼‰
 * @example
 * Array2D.last(arr)
 * Array2D.last(arr, 'f1>5')
 */
Array2D.last = function(arr, predicate) {
    var result = predicate ? new Array2D(arr).zæœ€åä¸€ä¸ª(predicate) : new Array2D(arr).zæœ€åä¸€ä¸ª();
    return typeof result === 'object' && result.val ? result.val() : result;
};
Array2D.zæœ€åä¸€ä¸ª = Array2D.last;

/**
 * é™æ€æ–¹æ³•ï¼šè·³è¿‡ï¼ˆskipï¼‰- è·³è¿‡å‰Nä¸ªå…ƒç´ 
 * @param {Array} arr - æ•°ç»„
 * @param {Number} count - è·³è¿‡çš„æ•°é‡
 * @returns {Array} å‰©ä½™æ•°ç»„
 * @example
 * Array2D.skip(arr, 5)
 */
Array2D.skip = function(arr, count) {
    return new Array2D(arr).zè·³è¿‡(count).val();
};
Array2D.zè·³è¿‡ = Array2D.skip;

/**
 * é™æ€æ–¹æ³•ï¼šå–å‰Nä¸ªï¼ˆtakeï¼‰- è·å–å‰Nä¸ªå…ƒç´ 
 * @param {Array} arr - æ•°ç»„
 * @param {Number} count - è·å–çš„æ•°é‡
 * @returns {Array} å–å‡ºçš„æ•°ç»„
 * @example
 * Array2D.take(arr, 10)
 */
Array2D.take = function(arr, count) {
    return new Array2D(arr).zå–å‰Nä¸ª(count).val();
};
Array2D.zå–å‰Nä¸ª = Array2D.take;

// è¡¥å……é™æ€æ–¹æ³•åˆ«å
Array2D.zè·³è¿‡å‰Nä¸ª = Array2D.skip;
Array2D.zè·³è¿‡å‰å‡ ä¸ª = Array2D.skip;
Array2D.zå–å‰å‡ ä¸ª = Array2D.take;

/**
 * é™æ€æ–¹æ³•ï¼šè¡¥é½æ•°ç»„ï¼ˆpadï¼‰- è¡¥é½æ•°ç»„ä½¿æ‰€æœ‰è¡Œåˆ—æ•°ä¸€è‡´
 * @param {Array} arr - æ•°ç»„
 * @param {Number} cols - ç›®æ ‡åˆ—æ•°
 * @param {Number} rows - ç›®æ ‡è¡Œæ•°
 * @param {*} fillValue - å¡«å……å€¼
 * @returns {Array} è¡¥é½åçš„æ•°ç»„
 * @example
 * Array2D.pad(arr, 5, 10)
 * Array2D.pad(arr)  // è‡ªåŠ¨æŒ‰æœ€å¤§åˆ—è¡¥é½
 */
Array2D.pad = function(arr, cols, rows, fillValue) {
    return new Array2D(arr).zè¡¥é½æ•°ç»„(cols, rows, fillValue).val();
};
Array2D.zè¡¥é½æ•°ç»„ = Array2D.pad;

/**
 * é™æ€æ–¹æ³•ï¼šæŸ¥æ‰¾ï¼ˆfindï¼‰- æŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
 * @param {Array} arr - æ•°ç»„
 * @param {String|Function} predicate - æŸ¥æ‰¾æ¡ä»¶
 * @returns {Array} æ‰¾åˆ°çš„å…ƒç´ 
 * @example
 * Array2D.find(arr, 'f1==5')
 * Array2D.find(arr, x=>x.f1>10)
 */
Array2D.find = function(arr, predicate) {
    var result = new Array2D(arr).zæŸ¥æ‰¾å•ä¸ª(predicate);
    return typeof result === 'object' && result.val ? result.val() : result;
};
Array2D.zæŸ¥æ‰¾å•ä¸ª = Array2D.find;

/**
 * é™æ€æ–¹æ³•ï¼šæŸ¥æ‰¾ç´¢å¼•ï¼ˆfindIndexï¼‰- æŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„ç¬¬ä¸€ä¸ªå…ƒç´ ç´¢å¼•
 * @param {Array} arr - æ•°ç»„
 * @param {String|Function} predicate - æŸ¥æ‰¾æ¡ä»¶
 * @returns {Number} å…ƒç´ ç´¢å¼•
 * @example
 * Array2D.findIndex(arr, 'f1==5')
 */
Array2D.findIndex = function(arr, predicate) {
    return new Array2D(arr).zæŸ¥æ‰¾ç´¢å¼•(predicate);
};
Array2D.zæŸ¥æ‰¾ç´¢å¼• = Array2D.findIndex;

/**
 * é™æ€æ–¹æ³•ï¼šæŒ‰è¡Œæ•°åˆ†é¡µï¼ˆpageByRowsï¼‰- å°†æ•°ç»„æŒ‰æŒ‡å®šè¡Œæ•°åˆ†é¡µ
 * @param {Array} arr - æ•°ç»„
 * @param {Number} pageSize - æ¯é¡µè¡Œæ•°
 * @param {Number} pageNumber - é¡µç ï¼ˆä»1å¼€å§‹ï¼‰
 * @returns {Array} åˆ†é¡µåçš„æ•°ç»„
 * @example
 * Array2D.pageByRows(arr, 10, 2)
 */
Array2D.pageByRows = function(arr, pageSize, pageNumber) {
    return new Array2D(arr).zæŒ‰è¡Œæ•°åˆ†é¡µ(pageSize, pageNumber).val();
};
Array2D.zæŒ‰è¡Œæ•°åˆ†é¡µ = Array2D.pageByRows;

/**
 * é™æ€æ–¹æ³•ï¼šæŒ‰é¡µæ•°åˆ†é¡µï¼ˆpageByCountï¼‰- å°†æ•°ç»„å¹³å‡åˆ†æˆæŒ‡å®šé¡µæ•°
 * @param {Array} arr - æ•°ç»„
 * @param {Number} pageCount - æ€»é¡µæ•°
 * @param {Number} pageNumber - é¡µç ï¼ˆä»1å¼€å§‹ï¼‰
 * @returns {Array} åˆ†é¡µåçš„æ•°ç»„
 * @example
 * Array2D.pageByCount(arr, 5, 2)
 */
Array2D.pageByCount = function(arr, pageCount, pageNumber) {
    return new Array2D(arr).zæŒ‰é¡µæ•°åˆ†é¡µ(pageCount, pageNumber).val();
};
Array2D.zæŒ‰é¡µæ•°åˆ†é¡µ = Array2D.pageByCount;

/**
 * é™æ€æ–¹æ³•ï¼šå¡«å……ç©ºç™½ï¼ˆfillBlankï¼‰- å¡«å……åˆå¹¶å•å…ƒæ ¼çš„ç©ºç™½åŒºåŸŸ
 * @param {Array} arr - æ•°ç»„
 * @param {String} direction - å¡«å……æ–¹å‘ 'up'/'down'/'left'/'right'
 * @param {String} rangeAddress - åŒºåŸŸåœ°å€
 * @returns {Array} å¡«å……åçš„æ•°ç»„
 * @example
 * Array2D.fillBlank(arr, 'up', 'A2:D2')
 */
Array2D.fillBlank = function(arr, direction, rangeAddress) {
    return new Array2D(arr).zè¡¥é½ç©ºä½(direction, rangeAddress).val();
};
Array2D.zè¡¥é½ç©ºä½ = Array2D.fillBlank;

/**
 * é™æ€æ–¹æ³•ï¼šè½¬çŸ©é˜µï¼ˆtoMatrixï¼‰- å°†æ•°ç»„è½¬æ¢ä¸ºçŸ©é˜µæ ¼å¼
 * @param {Array} arr - æ•°ç»„
 * @param {Number} rows - è¡Œæ•°
 * @param {Number} cols - åˆ—æ•°
 * @param {String} direction - æ–¹å‘ 'r'/'c'
 * @returns {Array} çŸ©é˜µæ•°ç»„
 * @example
 * Array2D.toMatrix(arr, 3, 4, 'r')
 */
Array2D.toMatrix = function(arr, rows, cols, direction) {
    return new Array2D(arr).zè½¬çŸ©é˜µ(rows, cols, direction).val();
};
Array2D.zè½¬çŸ©é˜µ = Array2D.toMatrix;

/**
 * é™æ€æ–¹æ³•ï¼šæŸ¥æ‰¾æ‰€æœ‰è¡Œä¸‹æ ‡ï¼ˆfindRowsIndexï¼‰- æŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰è¡Œç´¢å¼•
 * @param {Array} arr - æ•°ç»„
 * @param {String|Function} predicate - æŸ¥æ‰¾æ¡ä»¶
 * @returns {Array} è¡Œç´¢å¼•æ•°ç»„
 * @example
 * Array2D.findRowsIndex(arr, 'f1=="A"')
 */
Array2D.findRowsIndex = function(arr, predicate) {
    return new Array2D(arr).zæŸ¥æ‰¾æ‰€æœ‰è¡Œä¸‹æ ‡(predicate);
};
Array2D.zæŸ¥æ‰¾æ‰€æœ‰è¡Œä¸‹æ ‡ = Array2D.findRowsIndex;

/**
 * é™æ€æ–¹æ³•ï¼šæ’åºï¼ˆsortï¼‰- åŸºæœ¬æ’åº
 * @param {Array} arr - æ•°ç»„
 * @param {String|Function} comparer - æ¯”è¾ƒå‡½æ•°
 * @returns {Array} æ’åºåçš„æ•°ç»„
 * @example
 * Array2D.sort(arr)
 * Array2D.sort(arr, 'f1+')
 */
Array2D.sort = function(arr, comparer) {
    return new Array2D(arr).zå‡åºæ’åº(comparer).val();
};
Array2D.zå‡åºæ’åº = Array2D.sort;

/**
 * é™æ€æ–¹æ³•ï¼šé™åºæ’åºï¼ˆsortDescï¼‰
 * @param {Array} arr - æ•°ç»„
 * @param {String|Function} comparer - æ¯”è¾ƒå‡½æ•°
 * @returns {Array} æ’åºåçš„æ•°ç»„
 * @example
 * Array2D.sortDesc(arr, 'f1-')
 */
Array2D.sortDesc = function(arr, comparer) {
    return new Array2D(arr).zé™åºæ’åº(comparer).val();
};
Array2D.zé™åºæ’åº = Array2D.sortDesc;

/**
 * é™æ€æ–¹æ³•ï¼šæ±‚å’Œï¼ˆsumï¼‰- è®¡ç®—æ•°ç»„å…ƒç´ çš„å’Œ
 * @param {Array} arr - æ•°ç»„
 * @param {String|Function} selector - é€‰æ‹©å™¨
 * @returns {Number} å’Œ
 * @example
 * Array2D.sum([1,2,3,4])
 * Array2D.sum(arr, 'f1')
 */
Array2D.sum = function(arr, selector) {
    var result = new Array2D(arr).zæ±‚å’Œ(selector);
    return typeof result === 'object' && result.val ? result.val() : result;
};

/**
 * é™æ€æ–¹æ³•ï¼šå½’çº¦ï¼ˆreduceï¼‰- å¯¹æ•°ç»„è¿›è¡Œå½’çº¦æ“ä½œ
 * @param {Array} arr - æ•°ç»„
 * @param {Function} callback - å›è°ƒå‡½æ•°
 * @param {*} initialValue - åˆå§‹å€¼
 * @returns {*} å½’çº¦ç»“æœ
 * @example
 * Array2D.reduce(arr, (acc, row) => acc + row[0], 0)
 */
Array2D.reduce = function(arr, callback, initialValue) {
    return new Array2D(arr).zå½’çº¦(callback, initialValue);
};
Array2D.zå½’çº¦ = Array2D.reduce;

/**
 * é™æ€æ–¹æ³•ï¼šå€’åºå½’çº¦ï¼ˆreduceRightï¼‰- ä»å³å‘å·¦å½’çº¦
 * @param {Array} arr - æ•°ç»„
 * @param {Function} callback - å›è°ƒå‡½æ•°
 * @param {*} initialValue - åˆå§‹å€¼
 * @returns {*} å½’çº¦ç»“æœ
 * @example
 * Array2D.reduceRight(arr, (acc, row) => acc + row[0], 0)
 */
Array2D.reduceRight = function(arr, callback, initialValue) {
    return new Array2D(arr).zå€’åºå½’çº¦(callback, initialValue);
};
Array2D.zå€’åºå½’çº¦ = Array2D.reduceRight;

/**
 * é™æ€æ–¹æ³•ï¼šéå†ï¼ˆforEachï¼‰- éå†æ•°ç»„çš„æ¯ä¸€è¡Œ
 * @param {Array} arr - æ•°ç»„
 * @param {Function} callback - å›è°ƒå‡½æ•°
 * @returns {Array} åŸæ•°ç»„
 * @example
 * Array2D.forEach(arr, (row, i) => console.log(i, row))
 */
Array2D.forEach = function(arr, callback) {
    var instance = new Array2D(arr);
    instance.forEach(callback);
    return arr;
};

/**
 * é™æ€æ–¹æ³•ï¼šå€’åºéå†ï¼ˆforEachRevï¼‰- ä»åå‘å‰éå†
 * @param {Array} arr - æ•°ç»„
 * @param {Function} callback - å›è°ƒå‡½æ•°
 * @returns {Array} åŸæ•°ç»„
 * @example
 * Array2D.forEachRev(arr, (row, i) => console.log(i, row))
 */
Array2D.forEachRev = function(arr, callback) {
    new Array2D(arr).zå€’åºéå†æ‰§è¡Œ(callback);
    return arr;
};
Array2D.zå€’åºéå†æ‰§è¡Œ = Array2D.forEachRev;

/**
 * é™æ€æ–¹æ³•ï¼šæœ‰æ»¡è¶³ï¼ˆsomeï¼‰- æ£€æŸ¥æ˜¯å¦æœ‰å…ƒç´ æ»¡è¶³æ¡ä»¶
 * @param {Array} arr - æ•°ç»„
 * @param {String|Function} predicate - æ¡ä»¶
 * @returns {Boolean} æ˜¯å¦æœ‰æ»¡è¶³
 * @example
 * Array2D.some(arr, 'f1>5')
 */
Array2D.some = function(arr, predicate) {
    return new Array2D(arr).zæœ‰æ»¡è¶³(predicate);
};
Array2D.zæœ‰æ»¡è¶³ = Array2D.some;

/**
 * é™æ€æ–¹æ³•ï¼šå…¨éƒ¨æ»¡è¶³ï¼ˆeveryï¼‰- æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å…ƒç´ éƒ½æ»¡è¶³æ¡ä»¶
 * @param {Array} arr - æ•°ç»„
 * @param {String|Function} predicate - æ¡ä»¶
 * @returns {Boolean} æ˜¯å¦å…¨éƒ¨æ»¡è¶³
 * @example
 * Array2D.every(arr, 'f1>0')
 */
Array2D.every = function(arr, predicate) {
    return new Array2D(arr).zå…¨éƒ¨æ»¡è¶³(predicate);
};
Array2D.zå…¨éƒ¨æ»¡è¶³ = Array2D.every;

/**
 * é™æ€æ–¹æ³•ï¼šé™ç»´ï¼ˆflatï¼‰- å°†äºŒç»´æ•°ç»„é™ç»´ä¸ºä¸€ç»´
 * @param {Array} arr - äºŒç»´æ•°ç»„
 * @param {Function} mapper - å¯é€‰çš„æ˜ å°„å‡½æ•°
 * @returns {Array} ä¸€ç»´æ•°ç»„
 * @example
 * Array2D.flat(arr)
 * Array2D.flat(arr, x=>x.f1)
 */
Array2D.flat = function(arr, mapper) {
    var result = new Array2D(arr);
    return mapper ? result.zæ‰å¹³åŒ–(mapper) : result.zæ‰å¹³åŒ–();
};
Array2D.zæ‰å¹³åŒ– = Array2D.flat;

/**
 * é™æ€æ–¹æ³•ï¼šè¡Œåˆ‡ç‰‡åˆ é™¤ï¼ˆspliceï¼‰- åˆ é™¤/æ’å…¥å…ƒç´ 
 * @param {Array} arr - æ•°ç»„
 * @param {Number} start - èµ·å§‹ä½ç½®
 * @param {Number} deleteCount - åˆ é™¤æ•°é‡
 * @param {...*} items - è¦æ’å…¥çš„å…ƒç´ 
 * @returns {Array} è¢«åˆ é™¤çš„å…ƒç´ 
 * @example
 * Array2D.splice(arr, 2, 1, ['æ–°è¡Œ'])
 */
Array2D.splice = function(arr, start, deleteCount) {
    var items = Array.prototype.slice.call(arguments, 3);
    return new Array2D(arr).zè¡Œåˆ‡ç‰‡åˆ é™¤è¡Œ(start, deleteCount, items);
};
Array2D.zè¡Œåˆ‡ç‰‡åˆ é™¤è¡Œ = Array2D.splice;

/**
 * é™æ€æ–¹æ³•ï¼šè¿½åŠ ä¸€é¡¹ï¼ˆpushï¼‰- åœ¨æ•°ç»„æœ«å°¾æ·»åŠ å…ƒç´ 
 * @param {Array} arr - æ•°ç»„
 * @param {*} item - è¦æ·»åŠ çš„å…ƒç´ 
 * @returns {Number} æ–°é•¿åº¦
 * @example
 * Array2D.push(arr, [1,2,3])
 */
Array2D.push = function(arr, item) {
    new Array2D(arr).zè¿½åŠ ä¸€é¡¹(item);
    return arr.length;
};
Array2D.zè¿½åŠ ä¸€é¡¹ = Array2D.push;

/**
 * é™æ€æ–¹æ³•ï¼šå°¾éƒ¨å¼¹å‡ºä¸€é¡¹ï¼ˆpopï¼‰- åˆ é™¤å¹¶è¿”å›æœ€åä¸€ä¸ªå…ƒç´ 
 * @param {Array} arr - æ•°ç»„
 * @returns {Array} è¢«åˆ é™¤çš„å…ƒç´ 
 * @example
 * Array2D.pop(arr)
 */
Array2D.pop = function(arr) {
    return new Array2D(arr).zå°¾éƒ¨å¼¹å‡ºä¸€é¡¹();
};
Array2D.zå°¾éƒ¨å¼¹å‡ºä¸€é¡¹ = Array2D.pop;

/**
 * é™æ€æ–¹æ³•ï¼šåˆ é™¤ç¬¬ä¸€ä¸ªï¼ˆshiftï¼‰- åˆ é™¤å¹¶è¿”å›ç¬¬ä¸€ä¸ªå…ƒç´ 
 * @param {Array} arr - æ•°ç»„
 * @returns {Array} è¢«åˆ é™¤çš„å…ƒç´ 
 * @example
 * Array2D.shift(arr)
 */
Array2D.shift = function(arr) {
    return new Array2D(arr).zåˆ é™¤ç¬¬ä¸€ä¸ª();
};
Array2D.zåˆ é™¤ç¬¬ä¸€ä¸ª = Array2D.shift;

/**
 * é™æ€æ–¹æ³•ï¼šåè½¬ï¼ˆreverseï¼‰- åè½¬æ•°ç»„é¡ºåº
 * @param {Array} arr - æ•°ç»„
 * @returns {Array} åè½¬åçš„æ•°ç»„
 * @example
 * Array2D.reverse(arr)
 */
Array2D.reverse = function(arr) {
    return new Array2D(arr).zåè½¬().val();
};
Array2D.zåè½¬ = Array2D.reverse;

/**
 * é™æ€æ–¹æ³•ï¼šæ–‡æœ¬è¿æ¥ï¼ˆjoinï¼‰- ç”¨åˆ†éš”ç¬¦è¿æ¥æ‰€æœ‰å…ƒç´ 
 * @param {Array} arr - æ•°ç»„
 * @param {String} separator - åˆ†éš”ç¬¦
 * @returns {String} è¿æ¥åçš„å­—ç¬¦ä¸²
 * @example
 * Array2D.join(arr, ',')
 */
Array2D.join = function(arr, separator) {
    return new Array2D(arr).zè¿æ¥(separator);
};
Array2D.zè¿æ¥ = Array2D.join;

/**
 * é™æ€æ–¹æ³•ï¼šè½¬JSONå­—ç¬¦ä¸²ï¼ˆtoJsonï¼‰- å°†æ•°ç»„è½¬ä¸ºJSONå­—ç¬¦ä¸²
 * @param {Array} arr - æ•°ç»„
 * @param {Number|String} indent - ç¼©è¿›
 * @returns {String} JSONå­—ç¬¦ä¸²
 * @example
 * Array2D.toJson(arr, 2)
 */
Array2D.toJson = function(arr, indent) {
    return new Array2D(arr).zè½¬JSON(indent);
};
Array2D.zè½¬JSON = Array2D.toJson;

/**
 * é™æ€æ–¹æ³•ï¼šè½¬å­—ç¬¦ä¸²ï¼ˆtoStringï¼‰- å°†æ•°ç»„è½¬ä¸ºå­—ç¬¦ä¸²
 * @param {Array} arr - æ•°ç»„
 * @param {String} separator - åˆ†éš”ç¬¦
 * @returns {String} å­—ç¬¦ä¸²
 * @example
 * Array2D.toString(arr, ',')
 */
Array2D.toString = function(arr, separator) {
    return new Array2D(arr).zè½¬å­—ç¬¦ä¸²(separator);
};
Array2D.zè½¬å­—ç¬¦ä¸² = Array2D.toString;

/**
 * é™æ€æ–¹æ³•ï¼šæ˜¯å¦ä¸ºç©ºï¼ˆisEmptyï¼‰- æ£€æŸ¥æ•°ç»„æ˜¯å¦ä¸ºç©º
 * @param {Array} arr - æ•°ç»„
 * @returns {Boolean} æ˜¯å¦ä¸ºç©º
 * @example
 * Array2D.isEmpty(arr)
 */
Array2D.isEmpty = function(arr) {
    return new Array2D(arr).zæ˜¯å¦ä¸ºç©º();
};
Array2D.zæ˜¯å¦ä¸ºç©º = Array2D.isEmpty;

/**
 * é™æ€æ–¹æ³•ï¼šåˆ†ç»„ï¼ˆgroupByï¼‰- æŒ‰æŒ‡å®šæ¡ä»¶åˆ†ç»„
 * @param {Array} arr - æ•°ç»„
 * @param {String|Function} keySelector - åˆ†ç»„ä¾æ®
 * @returns {Map} åˆ†ç»„ç»“æœ
 * @example
 * Array2D.groupBy(arr, 'f1')
 */
Array2D.groupBy = function(arr, keySelector) {
    return new Array2D(arr).zåˆ†ç»„(keySelector);
};
Array2D.zåˆ†ç»„ = Array2D.groupBy;

/**
 * é™æ€æ–¹æ³•ï¼šå·¦å³å…¨è¿æ¥ï¼ˆfulljoinï¼‰- ç±»ä¼¼SQLçš„FULL OUTER JOIN
 * @param {Array} arr - æ•°ç»„1
 * @param {Array} brr - æ•°ç»„2
 * @param {String|Function} leftKey - å·¦è¡¨å…³é”®å­—
 * @param {String|Function} rightKey - å³è¡¨å…³é”®å­—
 * @param {String|Function} resultSelector - ç»“æœé€‰æ‹©å™¨
 * @returns {Array} è¿æ¥åçš„æ•°ç»„
 * @example
 * Array2D.fulljoin(arr, brr, 'f1', 'f1', 'f1,f2,f3')
 */
Array2D.fulljoin = function(arr, brr, leftKey, rightKey, resultSelector) {
    return new Array2D(arr).zå·¦å³å…¨è¿æ¥(brr, leftKey, rightKey, resultSelector).val();
};
Array2D.zå·¦å³å…¨è¿æ¥ = Array2D.fulljoin;

/**
 * é™æ€æ–¹æ³•ï¼šä¸€å¯¹å¤šè¿æ¥ï¼ˆleftFulljoinï¼‰- å·¦è¡¨ä¸€å¯¹å¤šè¿æ¥
 * @param {Array} arr - å·¦è¡¨
 * @param {Array} brr - å³è¡¨
 * @param {String|Function} leftKey - å·¦è¡¨å…³é”®å­—
 * @param {String|Function} rightKey - å³è¡¨å…³é”®å­—
 * @param {String|Function} resultSelector - ç»“æœé€‰æ‹©å™¨
 * @returns {Array} è¿æ¥åçš„æ•°ç»„
 * @example
 * Array2D.leftFulljoin(arr, brr, 'f1', 'f1', 'f1,f2,f3')
 */
Array2D.leftFulljoin = function(arr, brr, leftKey, rightKey, resultSelector) {
    return new Array2D(arr).zä¸€å¯¹å¤šè¿æ¥(brr, leftKey, rightKey, resultSelector).val();
};
Array2D.zä¸€å¯¹å¤šè¿æ¥ = Array2D.leftFulljoin;

/**
 * é™æ€æ–¹æ³•ï¼šè¶…çº§æŸ¥æ‰¾ï¼ˆsuperLookupï¼‰- å¢å¼ºç‰ˆVLOOKUP
 * @param {Array} arr - æŸ¥æ‰¾èŒƒå›´
 * @param {*} lookupValue - æŸ¥æ‰¾å€¼
 * @param {Number|String} colIndex - åˆ—å·
 * @param {Number|String} returnCol - è¿”å›åˆ—å·
 * @returns {Array} æŸ¥æ‰¾ç»“æœ
 * @example
 * Array2D.superLookup(arr, 'A', 1, 3)
 */
Array2D.superLookup = function(arr, lookupValue, colIndex, returnCol) {
    var result = new Array2D(arr).zè¶…çº§æŸ¥æ‰¾(lookupValue, colIndex, returnCol);
    return typeof result === 'object' && result.val ? result.val() : result;
};
Array2D.zè¶…çº§æŸ¥æ‰¾ = Array2D.superLookup;

/**
 * é™æ€æ–¹æ³•ï¼šå·¦å³è¿æ¥ï¼ˆzipï¼‰- å°†ä¸¤ä¸ªæ•°ç»„çš„å¯¹åº”ä½ç½®å…ƒç´ é…å¯¹
 * @param {Array} arr - æ•°ç»„1
 * @param {Array} brr - æ•°ç»„2
 * @returns {Array} é…å¯¹åçš„æ•°ç»„
 * @example
 * Array2D.zip(arr1, arr2)
 */
Array2D.zip = function(arr, brr) {
    return new Array2D(arr).zå·¦å³è¿æ¥(brr).val();
};
Array2D.zå·¦å³è¿æ¥ = Array2D.zip;

/**
 * é™æ€æ–¹æ³•ï¼šè½¬ç½®ï¼ˆtransposeï¼‰- è½¬ç½®äºŒç»´æ•°ç»„
 * @param {Array} arr - äºŒç»´æ•°ç»„
 * @returns {Array} è½¬ç½®åçš„æ•°ç»„
 * @example
 * Array2D.transpose([[1,2],[3,4]])  // [[1,3],[2,4]]
 */
Array2D.transpose = function(arr) {
    return new Array2D(arr).zè½¬ç½®().val();
};

/**
 * é™æ€æ–¹æ³•ï¼šå…‹éš†ï¼ˆcopyï¼‰- æ·±æ‹·è´æ•°ç»„
 * @param {Array} arr - æ•°ç»„
 * @returns {Array} æ‹·è´åçš„æ•°ç»„
 * @example
 * Array2D.copy(arr)
 */
Array2D.copy = function(arr) {
    return new Array2D(arr).zå…‹éš†().val();
};
Array2D.zå…‹éš† = Array2D.copy;

/**
 * é™æ€æ–¹æ³•ï¼šä¸Šä¸‹è¿æ¥ï¼ˆconcatï¼‰- è¿æ¥å¤šä¸ªæ•°ç»„
 * @param {Array} arr - æ•°ç»„1
 * @param {...Array} arrays - å…¶ä»–æ•°ç»„
 * @returns {Array} è¿æ¥åçš„æ•°ç»„
 * @example
 * Array2D.concat(arr1, arr2, arr3)
 */
Array2D.concat = function(arr) {
    var arrays = Array.prototype.slice.call(arguments, 1);
    return new Array2D(arr).zä¸Šä¸‹è¿æ¥.apply(new Array2D(arr), arrays).val();
};
Array2D.zä¸Šä¸‹è¿æ¥ = Array2D.concat;

/**
 * é™æ€æ–¹æ³•ï¼šé€‰æ‹©è¡Œï¼ˆselectRowsï¼‰- é€‰æ‹©æŒ‡å®šè¡Œ
 * @param {Array} arr - æ•°ç»„
 * @param {String|Array} rows - è¡Œé…ç½®
 * @returns {Array} é€‰æ‹©åçš„æ•°ç»„
 * @example
 * Array2D.selectRows(arr, '1,3,5')
 * Array2D.selectRows(arr, [0, 2, 4])
 */
Array2D.selectRows = function(arr, rows) {
    return new Array2D(arr).zé€‰æ‹©è¡Œ(rows).val();
};
Array2D.zé€‰æ‹©è¡Œ = Array2D.selectRows;

/**
 * é™æ€æ–¹æ³•ï¼šåˆ é™¤è¡Œï¼ˆdeleteRowsï¼‰- åˆ é™¤æŒ‡å®šè¡Œ
 * @param {Array} arr - æ•°ç»„
 * @param {String|Array} rows - è¡Œé…ç½®
 * @returns {Array} åˆ é™¤åçš„æ•°ç»„
 * @example
 * Array2D.deleteRows(arr, '1,3,5')
 */
Array2D.deleteRows = function(arr, rows) {
    return new Array2D(arr).zæ‰¹é‡åˆ é™¤è¡Œ(rows).val();
};
Array2D.zæ‰¹é‡åˆ é™¤è¡Œ = Array2D.deleteRows;

/**
 * é™æ€æ–¹æ³•ï¼šæ’å…¥è¡Œï¼ˆinsertRowsï¼‰- åœ¨æŒ‡å®šä½ç½®æ’å…¥è¡Œ
 * @param {Array} arr - æ•°ç»„
 * @param {Number|Array} rowPos - æ’å…¥ä½ç½®
 * @param {Array} values - æ’å…¥çš„å€¼
 * @returns {Array} æ’å…¥åçš„æ•°ç»„
 * @example
 * Array2D.insertRows(arr, 2, [[1,2,3]])
 */
Array2D.insertRows = function(arr, rowPos, values) {
    return new Array2D(arr).zæ‰¹é‡æ’å…¥è¡Œ(rowPos, values).val();
};
Array2D.zæ‰¹é‡æ’å…¥è¡Œ = Array2D.insertRows;

/**
 * é™æ€æ–¹æ³•ï¼šæ’å…¥è¡Œå·ï¼ˆinsertRowNumï¼‰- åœ¨æ•°ç»„å‰æ’å…¥è¡Œå·åˆ—
 * @param {Array} arr - æ•°ç»„
 * @param {Number} start - èµ·å§‹è¡Œå·
 * @param {String} title - åˆ—æ ‡é¢˜
 * @returns {Array} æ’å…¥è¡Œå·åçš„æ•°ç»„
 * @example
 * Array2D.insertRowNum(arr, 1, 'åºå·')
 */
Array2D.insertRowNum = function(arr, start, title) {
    return new Array2D(arr).zæ’å…¥è¡Œå·(start, title).val();
};
Array2D.zæ’å…¥è¡Œå· = Array2D.insertRowNum;

/**
 * é™æ€æ–¹æ³•ï¼šæ˜¯å¦åŒ…å«å€¼ï¼ˆincludesï¼‰- æ£€æŸ¥æ•°ç»„æ˜¯å¦åŒ…å«æŸå€¼
 * @param {Array} arr - æ•°ç»„
 * @param {*} value - è¦æ£€æŸ¥çš„å€¼
 * @returns {Boolean} æ˜¯å¦åŒ…å«
 * @example
 * Array2D.includes(arr, [1,2])
 */
Array2D.includes = function(arr, value) {
    return new Array2D(arr).zåŒ…å«(value);
};
Array2D.zåŒ…å« = Array2D.includes;

/**
 * é™æ€æ–¹æ³•ï¼šå€¼ä½ç½®ï¼ˆindexOfï¼‰- æŸ¥æ‰¾å…ƒç´ çš„ä½ç½®
 * @param {Array} arr - æ•°ç»„
 * @param {*} value - è¦æŸ¥æ‰¾çš„å€¼
 * @returns {Number} å…ƒç´ ç´¢å¼•
 * @example
 * Array2D.indexOf(arr, [1,2])
 */
Array2D.indexOf = function(arr, value) {
    return new Array2D(arr).zå€¼ä½ç½®(value);
};

/**
 * é™æ€æ–¹æ³•ï¼šä»åå¾€å‰å€¼ä½ç½®ï¼ˆlastIndexOfï¼‰- ä»åå‘å‰æŸ¥æ‰¾å…ƒç´ ä½ç½®
 * @param {Array} arr - æ•°ç»„
 * @param {*} value - è¦æŸ¥æ‰¾çš„å€¼
 * @returns {Number} å…ƒç´ ç´¢å¼•
 * @example
 * Array2D.lastIndexOf(arr, [1,2])
 */
Array2D.lastIndexOf = function(arr, value) {
    return new Array2D(arr).zä»åå¾€å‰å€¼ä½ç½®(value);
};

/**
 * é™æ€æ–¹æ³•ï¼šä¸­ä½æ•°ï¼ˆmedianï¼‰- è®¡ç®—ä¸­ä½æ•°
 * @param {Array} arr - æ•°ç»„
 * @param {String|Function} selector - é€‰æ‹©å™¨
 * @returns {Number} ä¸­ä½æ•°
 * @example
 * Array2D.median(arr)
 * Array2D.median(arr, 'f1')
 */
Array2D.median = function(arr, selector) {
    var result = new Array2D(arr).zä¸­ä½æ•°(selector);
    return typeof result === 'object' && result.val ? result.val() : result;
};
Array2D.zä¸­ä½æ•° = Array2D.median;

/**
 * é™æ€æ–¹æ³•ï¼šé—´éš”å–æ•°ï¼ˆnthï¼‰- æ¯éš”nä¸ªå–ä¸€ä¸ª
 * @param {Array} arr - æ•°ç»„
 * @param {Number} n - é—´éš”
 * @param {Number} offset - åç§»é‡
 * @returns {Array} å–å‡ºçš„æ•°ç»„
 * @example
 * Array2D.nth(arr, 3, 0)  // æ¯3ä¸ªå–1ä¸ª
 */
Array2D.nth = function(arr, n, offset) {
    return new Array2D(arr).zé—´éš”å–æ•°(n, offset).val();
};
Array2D.zé—´éš”å–æ•° = Array2D.nth;

/**
 * é™æ€æ–¹æ³•ï¼šè¡Œåˆ‡ç‰‡ï¼ˆsliceï¼‰- æå–æŒ‡å®šèŒƒå›´çš„è¡Œ
 * @param {Array} arr - æ•°ç»„
 * @param {Number} start - èµ·å§‹ä½ç½®
 * @param {Number} end - ç»“æŸä½ç½®
 * @returns {Array} åˆ‡ç‰‡åçš„æ•°ç»„
 * @example
 * Array2D.slice(arr, 1, 5)
 */
Array2D.slice = function(arr, start, end) {
    return new Array2D(arr).zè¡Œåˆ‡ç‰‡(start, end).val();
};

/**
 * é™æ€æ–¹æ³•ï¼šç»“æœï¼ˆresï¼‰- è·å–ç»“æœæ•°ç»„
 * @param {Array} arr - æ•°ç»„
 * @returns {Array} ç»“æœæ•°ç»„
 * @example
 * Array2D.res(arr)
 */
Array2D.res = function(arr) {
    return new Array2D(arr).zç»“æœ();
};
Array2D.zç»“æœ = Array2D.res;

// ==================== è¶…çº§é€è§†è¡¨ï¼ˆsuperPivotï¼‰====================
/**
 * è¶…çº§é€è§†ï¼ˆzè¶…çº§é€è§†ï¼‰- å°†äºŒç»´æ•°ç»„ä»¿é€è§†è¡¨ç”Ÿæˆè¡Œåˆ—å­—æ®µï¼Œå¹¶è¿›è¡Œå„ç§æ±‡æ€»ç»Ÿè®¡çš„äº¤å‰è¡¨
 * @param {Array} arr - äºŒç»´æ•°ç»„
 * @param {Array|string} rowFields - è¡Œå­—æ®µé…ç½®ï¼Œå¦‚ ['f1+,f2-'] æˆ– ['f1,f2', 'æ ‡é¢˜']
 * @param {Array|string} colFields - åˆ—å­—æ®µé…ç½®ï¼Œå¦‚ ['f5+,f6+'] æˆ– ['f2', 'æ ‡é¢˜']
 * @param {Array|string} dataFields - æ•°æ®å­—æ®µé…ç½®ï¼Œå¦‚ ['count(),sum("f3")'] æˆ– [[å›è°ƒæ•°ç»„], 'æ ‡é¢˜']
 * @param {Number} headerRows - æ ‡é¢˜è¡Œæ•°ï¼Œé»˜è®¤1
 * @param {string|Number} outputHeader - 1:è¾“å‡ºè¡¨å¤´, 0:ä¸è¾“å‡º, 'map':è¿”å›å­—å…¸ï¼Œé»˜è®¤1
 * @param {string} separator - åˆ†éš”ç¬¦ï¼Œé»˜è®¤"@^@"
 * @returns {Array|Map} è¿”å›äºŒç»´æ•°ç»„æˆ–Map
 * @example
 * // ç¤ºä¾‹1ï¼šåŸºæœ¬é€è§†ï¼ˆå¸¦æ’åºç¬¦å·ï¼‰
 * var rs = Array2D.zè¶…çº§é€è§†(arr, ['f1+,f2-'], ['f5+,f6+'], ['count(),sum("f3")']);
 *
 * // ç¤ºä¾‹2ï¼šå¸¦æ ‡é¢˜çš„é€è§†
 * var rs = Array2D.zè¶…çº§é€è§†(arr, ['f1,f5,f6','prod,year,month'], ['f2','country'], ['count(),sum("f3"),average("f4")','count,sum,avg']);
 *
 * // ç¤ºä¾‹3ï¼šå›è°ƒå‡½æ•°æ¨¡å¼ + Mapè¿”å›
 * var rs = Array2D.zè¶…çº§é€è§†(arr, ['f1,f5,f6','æœŸæ•°,å¹´,æœˆ'], ['f2','å›½å®¶'], [[g=>g.count(),g=>g.sum("f3")],'è®¡æ•°,æ±‚å’Œ'], 2, 'map');
 */
Array2D.zè¶…çº§é€è§† = function(arr, rowFields, colFields, dataFields, headerRows, outputHeader, separator, options) {
    separator = separator || '@^@';
    headerRows = headerRows !== undefined ? headerRows : 1;
    outputHeader = outputHeader !== undefined ? outputHeader : 1;
    options = options || {};
    
    // ğŸ”§ v3.9.0 æ–°å¢ï¼šè§£æoptionså‚æ•°
    var cornerTitle = options.cornerTitle || '';
    var rowFieldIndent = options.rowFieldIndent !== false;  // é»˜è®¤å¯ç”¨ç¼©è¿›
    var rowFieldIndentSize = options.rowFieldIndentSize || 4;  // é»˜è®¤4ç©ºæ ¼
    var layoutMode = options.layoutMode || 'outline';  // compact/outline/tabular
    
    // ğŸ”§ v3.9.0 æ–°å¢ï¼šå°è®¡å’Œæ€»è®¡é…ç½®
    options.subtotals = options.subtotals || { 
      enabled: false,
      row: false,
      col: false,
      label: 'å°è®¡' 
    };
    
    options.grandTotal = options.grandTotal || { 
      row: false,
      col: false,
      label: 'æ€»è®¡' 
    };
    
    // å…¼å®¹æ—§ç‰ˆé…ç½®åç§°
    if (options.rowSubtotals && options.rowSubtotals.enabled) {
      options.subtotals.row = true;
    }
    if (options.colSubtotals && options.colSubtotals.enabled) {
      options.subtotals.col = true;
    }
    if (options.grandTotals) {
      if (options.grandTotals.row) options.grandTotal.row = true;
      if (options.grandTotals.column) options.grandTotal.col = true;
    }
    
    // ä¿ç•™æ—§é…ç½®å˜é‡ä»¥å…¼å®¹ç°æœ‰ä»£ç 
    var rowSubtotals = { enabled: options.subtotals.row };
    var colSubtotals = { enabled: options.subtotals.col };
    var grandTotals = { row: options.grandTotal.row, column: options.grandTotal.col };
    
    // ç™¾åˆ†æ¯”æ˜¾ç¤ºé…ç½®
    var displayAs = options.displayAs || { mode: 'value', decimals: 2 };
    

    // ğŸ”§ v3.7.6 ä¿®å¤: åœ¨å¤„ç† Array2D å¯¹è±¡ä¹‹å‰ï¼Œå…ˆä¿å­˜ _header å’Œ _original å±æ€§
    var _savedHeader = null;
    var _savedOriginal = null;

    if (arr && typeof arr === 'object') {
        // ğŸ”§ v3.7.9 ä¿®å¤: ä½¿ç”¨æ›´å¯é çš„æ–¹å¼æ£€æŸ¥ _header å±æ€§
        // ä½¿ç”¨ in æ“ä½œç¬¦æ£€æŸ¥ï¼Œå› ä¸º _header å¯èƒ½æ˜¯ä¸å¯æšä¸¾çš„
        if ('_header' in arr && arr._header !== undefined && arr._header !== null) {
            _savedHeader = arr._header;
            // Console.log('[superPivot DEBUG] Found _header in arr: ' + JSON.stringify(_savedHeader));
        }
        // ä¿å­˜ _original å±æ€§ï¼ˆç”¨äºè·å–åŸå§‹è¡¨å¤´ï¼‰
        if ('_original' in arr && arr._original !== undefined && arr._original !== null && arr._original.length > 0) {
            _savedOriginal = arr._original;
            // Console.log('[superPivot DEBUG] Found _original in arr, length: ' + arr._original.length);
        }
    }

    // å¤„ç† Array2D å¯¹è±¡
    if (arr && typeof arr === 'object' && arr._items && Array.isArray(arr._items)) {
        arr = arr._items;
    }

    // ğŸ”§ v3.7.5 è‡ªåŠ¨ä¿å­˜åŸå§‹è¡¨å¤´ï¼ˆç”¨äºåˆ—å­—æ®µæ ‡é¢˜ï¼‰
    // æ™ºèƒ½æ£€æµ‹: å°è¯•ä»å¤šä¸ªæ¥æºè·å–è¡¨å¤´
    var _originalHeader = null;

    // æ¥æº1: ä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„ _header å±æ€§ï¼ˆæ¥è‡ª $.maxArray æˆ–é“¾å¼è°ƒç”¨ï¼‰
    if (_savedHeader !== null) {
        _originalHeader = _savedHeader;
        // Console.log('[superPivot DEBUG] _originalHeader from _savedHeader: ' + JSON.stringify(_originalHeader));
    }

    // æ¥æº2: æ£€æŸ¥ä¿å­˜çš„ _original å±æ€§
    if (!_originalHeader && _savedOriginal !== null) {
        _originalHeader = _savedOriginal[0];
        // Console.log('[superPivot DEBUG] _originalHeader from _savedOriginal: ' + JSON.stringify(_originalHeader));
    }

    // æ¥æº3: æ£€æŸ¥æ•°æ®çš„ç¬¬ä¸€è¡Œæ˜¯å¦å¯èƒ½æ˜¯è¡¨å¤´
    if (!_originalHeader && headerRows > 0 && arr && arr.length > 0) {
        // æ™ºèƒ½æ£€æµ‹: å¦‚æœç¬¬ä¸€è¡ŒåŒ…å«å­—ç¬¦ä¸²è€Œéæ•°å­—ï¼Œå¯èƒ½æ˜¯è¡¨å¤´
        var firstRow = arr[0];
        var isHeader = false;

        // æ£€æµ‹æ–¹æ³•1: å¦‚æœå¤§éƒ¨åˆ†åˆ—æ˜¯å­—ç¬¦ä¸²ï¼Œè®¤ä¸ºæ˜¯è¡¨å¤´
        var stringCount = 0;
        var totalCols = firstRow.length;
        for (var i = 0; i < Math.min(5, totalCols); i++) {  // åªæ£€æŸ¥å‰5åˆ—
            if (typeof firstRow[i] === 'string' && isNaN(parseFloat(firstRow[i]))) {
                stringCount++;
            }
        }

        if (stringCount >= 2) {  // è‡³å°‘2åˆ—æ˜¯å­—ç¬¦ä¸²
            isHeader = true;
        }
        
        // ğŸ”§ å¼ºåˆ¶ä¿¡ä»»: å¦‚æœç”¨æˆ·æŒ‡å®šäº† headerRows > 0ï¼Œä¸”æ²¡æœ‰æ›´å¥½çš„æ¥æºï¼Œä½¿ç”¨ arr[0]
        // ä½†è¦æ£€æŸ¥å®ƒçœ‹èµ·æ¥ä¸åƒçº¯æ•°æ®è¡Œï¼ˆæ¯”å¦‚ä¸åŒ…å« product1, product2 è¿™æ ·çš„å€¼ï¼‰
        if (!isHeader) {
            // æ£€æŸ¥æ˜¯å¦åŒ…å«å…¸å‹çš„æ•°æ®å€¼ï¼ˆå¦‚ product1, product2 ç­‰ï¼‰
            var looksLikeData = false;
            for (var i = 0; i < firstRow.length; i++) {
                var val = String(firstRow[i]).toLowerCase();
                if (val.indexOf('product') === 0 || val.indexOf('item') === 0) {
                    looksLikeData = true;
                    break;
                }
            }
            // å¦‚æœçœ‹èµ·æ¥åƒæ•°æ®ï¼Œåˆ™ä¸ä½¿ç”¨ arr[0] ä½œä¸ºè¡¨å¤´
            if (!looksLikeData) {
                isHeader = true;
            }
        }

        if (isHeader) {
            _originalHeader = firstRow;
            // Console.log('[superPivot DEBUG] _originalHeader detected from arr[0]: ' + JSON.stringify(_originalHeader));
        } else {
            // Console.log('[superPivot DEBUG] arr[0] not detected as header: ' + JSON.stringify(firstRow));
        }
    }
    
    // Console.log('[superPivot DEBUG] Final _originalHeader: ' + JSON.stringify(_originalHeader));

    // è¾…åŠ©å‡½æ•°ï¼šå°†è¡Œæ•°ç»„è½¬ä¸ºå¸¦f1,f2...å±æ€§çš„å¯¹è±¡
    function toRowObject(row) {
        var obj = Array(row.length);
        for (var i = 0; i < row.length; i++) {
            obj['f' + (i + 1)] = row[i];
            obj[i] = row[i];
        }
        return obj;
    }

    // è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºåˆ†ç»„å¯¹è±¡ï¼Œæ”¯æŒèšåˆæ“ä½œ
    function createGroupObject(group) {
        return {
            _items: group,
            count: function() { return group.length; },
            sum: function(col) {
                var total = 0;
                for (var i = 0; i < group.length; i++) {
                    var val = group[i][col];
                    if (typeof val === 'number') {
                        total += val;
                    } else if (typeof val === 'string') {
                        var num = parseFloat(val.replace(/,/g, ''));
                        if (!isNaN(num)) total += num;
                    }
                }
                return total;
            },
            average: function(col) {
                if (group.length === 0) return 0;
                var sum = this.sum(col);
                return sum / group.length;
            },
            max: function(col) {
                var max = null;
                for (var i = 0; i < group.length; i++) {
                    var val = group[i][col];
                    if (typeof val === 'string') {
                        val = parseFloat(val.replace(/,/g, ''));
                    }
                    if (typeof val === 'number' && !isNaN(val)) {
                        if (max === null || val > max) max = val;
                    }
                }
                return max;
            },
            min: function(col) {
                var min = null;
                for (var i = 0; i < group.length; i++) {
                    var val = group[i][col];
                    if (typeof val === 'string') {
                        val = parseFloat(val.replace(/,/g, ''));
                    }
                    if (typeof val === 'number' && !isNaN(val)) {
                        if (min === null || val < min) min = val;
                    }
                }
                return min;
            },
            textjoin: function(col, sep) {
                var values = [];
                for (var i = 0; i < group.length; i++) {
                    var val = group[i][col];
                    values.push(val);
                }
                return values.join(sep);
            }
        };
    }

    // è¾…åŠ©å‡½æ•°ï¼šè§£æç»“æœé€‰æ‹©å™¨å­—ç¬¦ä¸²
    function parseResultSelector(str) {
        var operations = [];
        var regex = /(\w+)\s*\(([^)]*)\)/g;
        var match;
        while ((match = regex.exec(str)) !== null) {
            var op = { name: match[1] };
            var argsStr = match[2].trim();
            if (argsStr) {
                // è§£æå‚æ•°ï¼Œæ”¯æŒå¸¦å¼•å·å’Œä¸å¸¦å¼•å·
                op.args = [];
                // ğŸ”§ ä¿®å¤ï¼šå…ˆæå–æ‰€æœ‰å¼•å·åŒ…è£¹çš„å‚æ•°ï¼Œå†å¤„ç†éå¼•å·å‚æ•°
                // ä½¿ç”¨æ›´ç²¾ç¡®çš„æ­£åˆ™è¡¨è¾¾å¼æ¥æ­£ç¡®å¤„ç†å¸¦é€—å·çš„å­—ç¬¦ä¸²å‚æ•°
                var argRegex = /["']([^"']*)["']|([^,]+)(?:,|$)/g;
                var argMatch;
                while ((argMatch = argRegex.exec(argsStr)) !== null) {
                    var argValue;
                    if (argMatch[1] !== undefined) {
                        // å¼•å·åŒ…è£¹çš„å‚æ•°
                        argValue = argMatch[1];
                    } else if (argMatch[2] !== undefined) {
                        // éå¼•å·å‚æ•°ï¼Œå»é™¤å‰åç©ºæ ¼
                        argValue = argMatch[2].trim();
                    }
                    if (argValue !== undefined && argValue !== '') {
                        op.args.push(argValue);
                    }
                }
            }
            operations.push(op);
        }
        return operations;
    }

    // è§£æå­—æ®µé…ç½®
    function parseFieldsConfig(fieldsConfig) {
        var fields = [];
        var titles = [];
        var hasTitles = false;

        if (Array.isArray(fieldsConfig)) {
            // ğŸ”§ v3.7.5 ä¿®å¤: æ£€æŸ¥ [['f1,f2', ['æ ‡é¢˜1','æ ‡é¢˜2']] æ ¼å¼
            if (fieldsConfig.length === 2 && Array.isArray(fieldsConfig[0])) {
                // ç¬¬ä¸€é¡¹æ˜¯æ•°ç»„ï¼ˆå¯èƒ½æ˜¯å­—æ®µæ•°ç»„æˆ–å›è°ƒæ•°ç»„ï¼‰
                var firstItem = fieldsConfig[0];
                var secondItem = fieldsConfig[1];

                // æ£€æŸ¥æ˜¯å¦æ˜¯å›è°ƒæ•°ç»„ï¼ˆåŒ…å«å‡½æ•°ï¼‰
                var isCallbackArray = firstItem.length > 0 && typeof firstItem[0] === 'function';

                // å¤„ç†æ ‡é¢˜ï¼šæ”¯æŒå­—ç¬¦ä¸²æˆ–æ•°ç»„
                var titleArray = [];
                if (typeof secondItem === 'string') {
                    titleArray = secondItem.split(',');
                } else if (Array.isArray(secondItem)) {
                    titleArray = secondItem;
                }

                if (isCallbackArray) {
                    // [[å›è°ƒæ•°ç»„], 'æ ‡é¢˜'] æ ¼å¼ - æ•°æ®å­—æ®µ
                    return {
                        fields: [{ callbacks: firstItem }],
                        titles: titleArray,
                        hasTitles: true,
                        isCallback: true
                    };
                } else {
                    // [['f1,f2'], ['æ ‡é¢˜1','æ ‡é¢˜2']] æ ¼å¼ - å¸¦è‡ªå®šä¹‰æ ‡é¢˜çš„å­—æ®µåˆ—è¡¨
                    var fieldStr = firstItem[0] || '';  // å‡è®¾æ˜¯ ['f1,f2,f3'] æ ¼å¼
                    var items = fieldStr.split(',');
                    for (var j = 0; j < items.length; j++) {
                        var item = items[j].trim();
                        var match = item.match(/^(f\d+)([+\-#]*)$/);
                        if (match) {
                            fields.push({
                                field: match[1],
                                sort: match[2] || '+'
                            });
                        }
                    }
                    return {
                        fields: fields,
                        titles: titleArray,
                        hasTitles: true
                    };
                }
            }
            // æ£€æŸ¥ ['f1,f2,f3', 'æ ‡é¢˜'] æ ¼å¼
            // ğŸ”§ v3.8.3 ä¿®å¤ï¼šæ”¯æŒåŒæ—¶ä½¿ç”¨æ’åºç¬¦å·å’Œè‡ªå®šä¹‰æ ‡é¢˜
            if (fieldsConfig.length === 2 && typeof fieldsConfig[0] === 'string' && typeof fieldsConfig[1] === 'string') {
                var fieldStr = fieldsConfig[0];
                var items = fieldStr.split(',');
                // å§‹ç»ˆè§£ææ ‡é¢˜ï¼ˆå³ä½¿æœ‰æ’åºç¬¦å·ï¼‰
                titles = fieldsConfig[1].split(',');
                for (var j = 0; j < items.length; j++) {
                    var item = items[j].trim();
                    var match = item.match(/^(f\d+)([+\-#]*)$/);
                    if (match) {
                        fields.push({
                            field: match[1],
                            sort: match[2] || '+'
                        });
                    } else {
                        // æ²¡æœ‰æ’åºç¬¦å·ï¼Œä½œä¸ºæ™®é€šå­—æ®µå¤„ç†
                        fields.push({
                            field: item,
                            sort: '+'
                        });
                    }
                }
                hasTitles = true;
                return { fields: fields, titles: titles, hasTitles: hasTitles };
            }
            // ['f1+,f2-'] æ ¼å¼ æˆ– å¸¦æ’åºç¬¦å·çš„æ ¼å¼
            if (typeof fieldsConfig[0] === 'string') {
                var fieldStr = fieldsConfig[0];
                var items = fieldStr.split(',');
                for (var k = 0; k < items.length; k++) {
                    var item = items[k].trim();
                    var match = item.match(/^(f\d+)([+\-#]*)$/);
                    if (match) {
                        fields.push({
                            field: match[1],
                            sort: match[2] || '+'
                        });
                    }
                }
            }
        } else if (typeof fieldsConfig === 'string') {
            var items = fieldsConfig.split(',');
            for (var m = 0; m < items.length; m++) {
                var item = items[m].trim();
                var match = item.match(/^(f\d+)([+\-#]*)$/);
                if (match) {
                    fields.push({
                        field: match[1],
                        sort: match[2] || '+'
                    });
                }
            }
        }

        return { fields: fields, titles: titles, hasTitles: hasTitles };
    }

    var rowConfig = parseFieldsConfig(rowFields);
    var colConfig = parseFieldsConfig(colFields);

    // ğŸ”§ v3.8.3 DEBUG: è¾“å‡ºè§£æåçš„é…ç½®ï¼ˆç”¨äºè¯Šæ–­æ’åºé—®é¢˜ï¼‰
    Console.log('[superPivot DEBUG] rowConfig.fields: ' + JSON.stringify(rowConfig.fields));
    Console.log('[superPivot DEBUG] colConfig.fields: ' + JSON.stringify(colConfig.fields));
    
    // æ•°æ®å­—æ®µéœ€è¦ç‰¹æ®Šå¤„ç†
    var dataConfig;
    if (Array.isArray(dataFields)) {
        if (dataFields.length === 2 && Array.isArray(dataFields[0])) {
            // [[å›è°ƒæ•°ç»„], 'æ ‡é¢˜'] æ ¼å¼
            dataConfig = {
                fields: [{ callbacks: dataFields[0] }],
                titles: dataFields[1].split(','),
                hasTitles: true,
                isCallback: true,
                rawString: null
            };
        } else if (dataFields.length === 2 && typeof dataFields[0] === 'string') {
            // ['count(),sum("f3")', 'æ ‡é¢˜'] æˆ– ['f1,f2', 'æ ‡é¢˜'] æ ¼å¼
            var dfStr = dataFields[0];
            // æ£€æŸ¥æ˜¯å¦åŒ…å«èšåˆå‡½æ•°
            if (dfStr.match(/count|sum|average|max|min|textjoin/)) {
                // æ•°æ®å­—æ®µæ ¼å¼
                dataConfig = {
                    fields: [{ field: dfStr }],
                    titles: dataFields[1].split(','),
                    hasTitles: true,
                    rawString: dfStr
                };
            } else {
                // æ™®é€šå­—æ®µæ ¼å¼ï¼Œä½¿ç”¨ parseFieldsConfig
                dataConfig = parseFieldsConfig(dataFields);
            }
        } else if (typeof dataFields[0] === 'string') {
            // ['count(),sum("f3")'] æ ¼å¼
            dataConfig = {
                fields: [{ field: dataFields[0] }],
                titles: [],
                hasTitles: false,
                rawString: dataFields[0]
            };
        } else {
            dataConfig = parseFieldsConfig(dataFields);
        }
    } else if (typeof dataFields === 'string') {
        // å­—ç¬¦ä¸²æ ¼å¼çš„æ•°æ®å­—æ®µ
        dataConfig = {
            fields: [{ field: dataFields }],
            titles: [],
            hasTitles: false,
            rawString: dataFields
        };
    } else {
        dataConfig = parseFieldsConfig(dataFields);
    }

    // è·³è¿‡æ ‡é¢˜è¡Œ
    var dataStartRow = headerRows || 1;
    var data = arr.slice(dataStartRow);

    // âœ… è¿‡æ»¤ç©ºè¡Œï¼šé¿å…ç”Ÿæˆç©ºç™½è¡Œ
    function isEmptyRow(row) {
        if (!row || row.length === 0) return true;
        for (var i = 0; i < row.length; i++) {
            var val = row[i];
            if (val !== null && val !== undefined && val !== '') return false;
        }
        return true;
    }

    data = data.filter(function(row) {
        return !isEmptyRow(row);
    });

    // å°†æ•°æ®è½¬ä¸ºå¯¹è±¡æ•°ç»„
    var dataObjs = data.map(function(row) {
        return toRowObject(row);
    });

    // æå–æ‰€æœ‰è¡Œå­—æ®µå€¼å¹¶æ’åº
    var rowKeys = [];
    var rowKeyMap = Object.create(null);

    // âœ… è¾…åŠ©å‡½æ•°ï¼šæ£€æŸ¥é”®æ˜¯å¦æœ‰æ•ˆï¼ˆä¸å…¨æ˜¯ç©ºå€¼ï¼‰
    function isValidKey(keyParts) {
        for (var i = 0; i < keyParts.length; i++) {
            var val = keyParts[i];
            if (val !== null && val !== undefined && val !== '') return true;
        }
        return false;
    }

    for (var i = 0; i < dataObjs.length; i++) {
        var obj = dataObjs[i];
        var keyParts = [];
        for (var j = 0; j < rowConfig.fields.length; j++) {
            var rf = rowConfig.fields[j];
            var match = rf.field.match(/^f(\d+)$/);
            if (match) {
                var idx = parseInt(match[1]) - 1;
                keyParts.push(obj[idx]);
            }
        }
        // âœ… è·³è¿‡å…¨ç©ºçš„é”®
        if (!isValidKey(keyParts)) continue;

        var key = keyParts.join(separator);
        if (!rowKeyMap[key]) {
            rowKeyMap[key] = {
                values: keyParts.slice(),
                originalIndex: i
            };
            rowKeys.push(key);
        }
    }

    // å¯¹è¡Œé”®æ’åº
    rowKeys.sort(function(a, b) {
        var aParts = a.split(separator);
        var bParts = b.split(separator);
        for (var k = 0; k < rowConfig.fields.length; k++) {
            var rf = rowConfig.fields[k];
            var aVal = aParts[k];
            var bVal = bParts[k];
            var cmp = 0;
            // å°è¯•è½¬æ¢ä¸ºæ•°å­—è¿›è¡Œæ¯”è¾ƒ
            var aNum = parseFloat(aVal);
            var bNum = parseFloat(bVal);
            if (!isNaN(aNum) && !isNaN(bNum) && String(aNum) === String(aVal).trim() && String(bNum) === String(bVal).trim()) {
                cmp = aNum - bNum;
            } else {
                cmp = String(aVal).localeCompare(String(bVal));
            }
            if (cmp !== 0) {
                return rf.sort === '-' ? -cmp : cmp;
            }
            // ğŸ”§ å¦‚æœå½“å‰å­—æ®µç›¸ç­‰ä¸”æ’åºç¬¦å·ä¸º #ï¼Œä¿æŒåŸå§‹é¡ºåº
            if (rf.sort === '#') {
                // æ¯”è¾ƒåŸå§‹ç´¢å¼•æ¥ä¿æŒé¡ºåº
                var aOrigIdx = rowKeyMap[a].originalIndex;
                var bOrigIdx = rowKeyMap[b].originalIndex;
                return aOrigIdx - bOrigIdx;
            }
        }
        return 0;
    });

    // ğŸ”§ ç¡®ä¿ç¬¬ä¸€ä¸ª rowKey ä¸æ˜¯æ•°æ®å€¼æ±¡æŸ“çš„ï¼ˆé˜²å¾¡æ€§ç¼–ç¨‹ï¼‰
    if (rowKeys.length > 0) {
        var firstKey = rowKeys[0];
        var keyParts = firstKey.split(separator);
        var isValid = true;
        for (var i = 0; i < keyParts.length; i++) {
            if (keyParts[i] === '' || keyParts[i] === null || keyParts[i] === undefined) {
                isValid = false;
                break;
            }
        }
        // å¦‚æœç¬¬ä¸€ä¸ªé”®æ— æ•ˆï¼Œç§»é™¤å®ƒ
        if (!isValid) {
            Console.log('è­¦å‘Š: ç¬¬ä¸€ä¸ª rowKey æ— æ•ˆï¼Œç§»é™¤: ' + firstKey);
            rowKeys.shift();
        }
    }

    // æå–æ‰€æœ‰åˆ—å­—æ®µå€¼å¹¶æ’åº
    var colKeys = [];
    var colKeyMap = Object.create(null);
    for (var m = 0; m < dataObjs.length; m++) {
        var obj = dataObjs[m];
        var keyParts = [];
        for (var n = 0; n < colConfig.fields.length; n++) {
            var cf = colConfig.fields[n];
            var match = cf.field.match(/^f(\d+)$/);
            if (match) {
                var idx = parseInt(match[1]) - 1;
                keyParts.push(obj[idx]);
            }
        }
        // âœ… è·³è¿‡å…¨ç©ºçš„é”®
        if (!isValidKey(keyParts)) continue;

        var key = keyParts.join(separator);
        if (!colKeyMap[key]) {
            colKeyMap[key] = {
                values: keyParts.slice(),
                originalIndex: m
            };
            colKeys.push(key);
        }
    }

    // å¯¹åˆ—é”®æ’åº
    colKeys.sort(function(a, b) {
        var aParts = a.split(separator);
        var bParts = b.split(separator);
        for (var k = 0; k < colConfig.fields.length; k++) {
            var cf = colConfig.fields[k];
            var aVal = aParts[k];
            var bVal = bParts[k];
            var cmp = 0;
            var aNum = parseFloat(aVal);
            var bNum = parseFloat(bVal);
            if (!isNaN(aNum) && !isNaN(bNum) && String(aNum) === String(aVal).trim() && String(bNum) === String(bVal).trim()) {
                cmp = aNum - bNum;
            } else {
                cmp = String(aVal).localeCompare(String(bVal));
            }
            if (cmp !== 0) {
                return cf.sort === '-' ? -cmp : cmp;
            }
            // ğŸ”§ å¦‚æœå½“å‰å­—æ®µç›¸ç­‰ä¸”æ’åºç¬¦å·ä¸º #ï¼Œä¿æŒåŸå§‹é¡ºåº
            if (cf.sort === '#') {
                // æ¯”è¾ƒåŸå§‹ç´¢å¼•æ¥ä¿æŒé¡ºåº
                var aOrigIdx = colKeyMap[a].originalIndex;
                var bOrigIdx = colKeyMap[b].originalIndex;
                return aOrigIdx - bOrigIdx;
            }
        }
        return 0;
    });

    // ğŸ”§ v3.8.3 DEBUG: è¾“å‡ºæ’åºåçš„è¡Œé”®å’Œåˆ—é”®ï¼ˆç”¨äºè¯Šæ–­æ’åºé—®é¢˜ï¼‰
    Console.log('[superPivot DEBUG] åŸå§‹æ•°æ®è¡Œæ•°: ' + dataObjs.length);
    Console.log('[superPivot DEBUG] rowKeys.length: ' + rowKeys.length);
    Console.log('[superPivot DEBUG] colKeys.length: ' + colKeys.length);
    Console.log('[superPivot DEBUG] colKeys sample (first 5):');
    for (var d = 0; d < Math.min(5, colKeys.length); d++) {
        Console.log('[superPivot DEBUG]   ' + d + '. ' + colKeys[d]);
    }
    Console.log('[superPivot DEBUG] è¡Œé”®æ’åºç»“æœ (å‰10ä¸ª):');
    for (var debugIdx = 0; debugIdx < Math.min(10, rowKeys.length); debugIdx++) {
        var keyParts = rowKeys[debugIdx].split(separator);
        Console.log('[superPivot DEBUG]   ' + debugIdx + '. ' + keyParts.join(' | '));
    }

    // åˆ†ç»„æ•°æ®ï¼šè¡Œé”® + åˆ—é”® -> æ•°æ®è¡Œ
    var groupMap = Object.create(null);
    for (var q = 0; q < dataObjs.length; q++) {
        var obj = dataObjs[q];
        var rowKeyParts = [];
        for (var r = 0; r < rowConfig.fields.length; r++) {
            var rf = rowConfig.fields[r];
            var match = rf.field.match(/^f(\d+)$/);
            if (match) {
                var idx = parseInt(match[1]) - 1;
                rowKeyParts.push(obj[idx]);
            }
        }
        var colKeyParts = [];
        for (var s = 0; s < colConfig.fields.length; s++) {
            var cf = colConfig.fields[s];
            var match = cf.field.match(/^f(\d+)$/);
            if (match) {
                var idx = parseInt(match[1]) - 1;
                colKeyParts.push(obj[idx]);
            }
        }
        var rowKey = rowKeyParts.join(separator);
        var colKey = colKeyParts.join(separator);
        var fullKey = rowKey + '|||' + colKey;
        if (!groupMap[fullKey]) {
            groupMap[fullKey] = [];
        }
        // è½¬å›æ™®é€šæ•°ç»„
        var row = [];
        for (var t = 0; t < obj.length; t++) {
            row.push(obj[t]);
        }
        groupMap[fullKey].push(row);
    }

    // è§£ææ•°æ®å­—æ®µæ“ä½œ
    var dataOps = [];
    if (dataConfig.isCallback) {
        dataOps = dataConfig.fields[0].callbacks;
    } else if (dataConfig.rawString) {
        var operations = parseResultSelector(dataConfig.rawString);
        dataOps = operations;
    } else if (dataConfig.fields.length > 0) {
        var opStr = dataConfig.fields[0].field || '';
        var operations = parseResultSelector(opStr);
        dataOps = operations;
    }

    // ğŸ”§ v3.9.0 ä¿®å¤ï¼šæå‰è®¡ç®— numDataFieldsï¼Œä¾› grandTotalValues ä½¿ç”¨
    var numDataFields = Array.isArray(dataOps) && dataOps.length > 0 ? dataOps.length :
                       (dataConfig.titles && dataConfig.titles.length > 0 ? dataConfig.titles.length : 1);

    // æ‰§è¡Œèšåˆæ“ä½œ
    function executeAggregation(group) {
        var groupObj = createGroupObject(group.map(function(r) {
            return toRowObject(r);
        }));
        var results = [];
        if (Array.isArray(dataOps) && dataOps.length > 0 && typeof dataOps[0] === 'function') {
            // å›è°ƒæ¨¡å¼
            for (var v = 0; v < dataOps.length; v++) {
                var result = dataOps[v](groupObj);
                results.push(result);
            }
        } else {
            // å­—ç¬¦ä¸²æ¨¡å¼
            for (var w = 0; w < dataOps.length; w++) {
                var op = dataOps[w];
                var args = op.args || [];
                switch (op.name) {
                    case 'count':
                        results.push(groupObj.count());
                        break;
                    case 'sum':
                        results.push(groupObj.sum(args[0]));
                        break;
                    case 'average':
                        results.push(groupObj.average(args[0]));
                        break;
                    case 'max':
                        results.push(groupObj.max(args[0]));
                        break;
                    case 'min':
                        results.push(groupObj.min(args[0]));
                        break;
                    case 'textjoin':
                        results.push(groupObj.textjoin(args[0], args[1]));
                        break;
                }
            }
        }
        return results;
    }

    // map æ¨¡å¼ï¼šè¿”å›æŸ¥è¯¢æ ‡å‡†å­—å…¸
    if (outputHeader === 'map') {
        var resultMap = new Map();
        for (var x = 0; x < rowKeys.length; x++) {
            var rowKey = rowKeys[x];
            for (var y = 0; y < colKeys.length; y++) {
                var colKey = colKeys[y];
                var fullKey = rowKey + '|||' + colKey;
                if (groupMap[fullKey]) {
                    var agg = executeAggregation(groupMap[fullKey]);
                    var sortKey = rowKey + separator + colKey;
                    var mapKey = '01L' + String(x + 1).padStart(4, '0') + ' ' + sortKey;
                    resultMap.set(mapKey, {
                        agg: agg,
                        group: { '00000': groupMap[fullKey][0] }
                    });
                }
            }
        }
        return resultMap;
    }

    // ğŸ”§ v3.9.0 æ–°å¢ï¼šè®¡ç®—æ€»è®¡å€¼
    var grandTotalValues = null;
    if (grandTotals.row || grandTotals.column || (displayAs.mode && displayAs.mode !== 'value')) {
        grandTotalValues = {
            rowTotals: {},
            colTotals: {},
            grandTotal: []
        };
        
        // è®¡ç®—æ¯è¡Œçš„æ€»è®¡
        for (var rk = 0; rk < rowKeys.length; rk++) {
            var rowKey = rowKeys[rk];
            var rowTotal = [];
            for (var df = 0; df < numDataFields; df++) {
                var sum = 0;
                for (var ck = 0; ck < colKeys.length; ck++) {
                    var colKey = colKeys[ck];
                    var fullKey = rowKey + '|||' + colKey;
                    if (groupMap[fullKey]) {
                        var agg = executeAggregation(groupMap[fullKey]);
                        var val = parseFloat(agg[df]);
                        if (!isNaN(val)) sum += val;
                    }
                }
                rowTotal.push(sum);
            }
            grandTotalValues.rowTotals[rowKey] = rowTotal;
        }
        
        // è®¡ç®—æ¯åˆ—çš„æ€»è®¡
        for (var ck = 0; ck < colKeys.length; ck++) {
            var colKey = colKeys[ck];
            var colTotal = [];
            for (var df = 0; df < numDataFields; df++) {
                var sum = 0;
                for (var rk = 0; rk < rowKeys.length; rk++) {
                    var rowKey = rowKeys[rk];
                    var fullKey = rowKey + '|||' + colKey;
                    if (groupMap[fullKey]) {
                        var agg = executeAggregation(groupMap[fullKey]);
                        var val = parseFloat(agg[df]);
                        if (!isNaN(val)) sum += val;
                    }
                }
                colTotal.push(sum);
            }
            grandTotalValues.colTotals[colKey] = colTotal;
        }
        
        // è®¡ç®—æ€»æ€»è®¡
        for (var df = 0; df < numDataFields; df++) {
            var sum = 0;
            for (var rk = 0; rk < rowKeys.length; rk++) {
                sum += grandTotalValues.rowTotals[rowKeys[rk]][df];
            }
            grandTotalValues.grandTotal.push(sum);
        }
    }

    // ğŸ”§ v3.9.0 æ–°å¢ï¼šåº”ç”¨ç™¾åˆ†æ¯”è½¬æ¢
    function applyDisplayAs(value, rowKey, colKey, dataFieldIndex, parentRowKey, parentColKey) {
        if (!displayAs.mode || displayAs.mode === 'value') {
            return value;
        }
        
        var val = parseFloat(value);
        if (isNaN(val)) return value;
        
        var decimals = displayAs.decimals || 2;
        var pct = 0;
        
        switch (displayAs.mode) {
            case 'percentOfGrandTotal':
                var total = grandTotalValues.grandTotal[dataFieldIndex];
                pct = total !== 0 ? (val / total * 100) : 0;
                break;
            case 'percentOfRowTotal':
                var rowTotal = grandTotalValues.rowTotals[rowKey] ? grandTotalValues.rowTotals[rowKey][dataFieldIndex] : 0;
                pct = rowTotal !== 0 ? (val / rowTotal * 100) : 0;
                break;
            case 'percentOfColTotal':
                var colTotal = grandTotalValues.colTotals[colKey] ? grandTotalValues.colTotals[colKey][dataFieldIndex] : 0;
                pct = colTotal !== 0 ? (val / colTotal * 100) : 0;
                break;
            default:
                return value;
        }
        
        return pct.toFixed(decimals) + '%';
    }

    // ==================== å¤šçº§è¡¨å¤´åˆå¹¶ä¿¡æ¯æ”¶é›† ====================
    // åˆå¹¶ä¿¡æ¯æ ¼å¼: {row1: {col1: {rowSpan: x, colSpan: y}, ...}, ...}
    var mergeInfo = Object.create(null);

    // è¾…åŠ©å‡½æ•°ï¼šè®°å½•åˆå¹¶ä¿¡æ¯
    function recordMerge(rowIdx, colIdx, rowSpan, colSpan) {
        if (rowSpan > 1 || colSpan > 1) {
            if (!mergeInfo[rowIdx]) mergeInfo[rowIdx] = Object.create(null);
            mergeInfo[rowIdx][colIdx] = { rowSpan: rowSpan, colSpan: colSpan };
        }
    }

    // ğŸ”§ v3.8.6 ä¿®å¤ï¼šä¼˜å…ˆä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„æ•°æ®å­—æ®µæ ‡é¢˜
    var defaultDataTitles = [];
    if (dataConfig.titles && dataConfig.titles.length > 0) {
        // ä¼˜å…ˆä½¿ç”¨ç”¨æˆ·æŒ‡å®šçš„è‡ªå®šä¹‰æ ‡é¢˜ï¼ˆå¦‚ 'é”€å”®é‡‘é¢'ï¼‰
        defaultDataTitles = dataConfig.titles.slice();
    } else if (Array.isArray(dataOps) && dataOps.length > 0 && typeof dataOps[0] !== 'function') {
        // æ²¡æœ‰è‡ªå®šä¹‰æ ‡é¢˜æ—¶ï¼Œæ ¹æ®èšåˆå‡½æ•°ç”Ÿæˆé»˜è®¤æ ‡é¢˜
        var opNameMap = {
            'count': 'è®¡æ•°',
            'sum': 'æ±‚å’Œ',
            'average': 'å¹³å‡',
            'max': 'æœ€å¤§',
            'min': 'æœ€å°',
            'textjoin': 'è¿æ¥'
        };
        for (var i = 0; i < dataOps.length; i++) {
            var opName = dataOps[i].name;
            defaultDataTitles.push(opNameMap[opName] || opName);
        }
    } else {
        // é»˜è®¤æ ‡é¢˜
        for (var j = 0; j < numDataFields; j++) {
            defaultDataTitles.push('å€¼' + (j + 1));
        }
    }

    var result = [];
    // Console.log('[superPivot DEBUG] result initialized, length: ' + result.length);

    // ğŸ”§ v3.9.1 ä¿®å¤ï¼šå°† headerRowCount è®¡ç®—ç§»åˆ° if å—å¤–é¢ï¼Œç¡®ä¿åœ¨ outputHeader=0 æ—¶ä¹Ÿèƒ½ä½¿ç”¨
    // è®¡ç®—å±‚çº§æ•°
    var numColFieldLevels = colConfig.fields.length;
    var numRowFieldLevels = rowConfig.fields.length;
    // ğŸ”§ ä¿®å¤ï¼šå•åˆ—å­—æ®µæ—¶éœ€è¦3è¡Œè¡¨å¤´ï¼Œå¤šåˆ—æ—¶éœ€è¦ numColFieldLevels + 1 è¡Œ
    var headerRowCount = (numColFieldLevels === 1) ? 3 : numColFieldLevels + 1;

    // æ„å»ºè¡¨å¤´
    if (outputHeader === 1 || outputHeader === true || outputHeader === -1) {
        // ğŸ”§ v3.8.8 æ–°å¢ï¼šoutputHeader = -1 è¡¨ç¤ºè¾“å‡ºè¡¨å¤´ä½†ä¸åŒ…å«è¡Œæ ‡é¢˜åˆ—
        var hideRowTitles = (outputHeader === -1);

        // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰æ ‡é¢˜
        var hasRowTitles = rowConfig.hasTitles && rowConfig.titles.length > 0;
        var hasColTitles = colConfig.hasTitles && colConfig.titles.length > 0;
        var hasDataTitles = dataConfig.hasTitles && dataConfig.titles.length > 0;

        // ğŸ”§ ==================== å¤šè¡Œå¤šåˆ—é€è§†è¡¨è¡¨å¤´è®¾è®¡ ====================
        // ğŸ”§ v3.8.1 ä¿®å¤ï¼šä¼˜åŒ–è¡¨å¤´ç»“æ„ï¼Œæ”¯æŒå•åˆ—å’Œå¤šåˆ—å­—æ®µ
        //
        // è¡¨å¤´ç»“æ„ï¼ˆå•åˆ—å­—æ®µï¼‰ï¼š
        // - ç¬¬1è¡Œï¼šè¡Œå­—æ®µæ ‡é¢˜ + [ç©ºç™½]ï¼ˆæˆ–åˆ—å­—æ®µæ ‡é¢˜ï¼Œå¦‚æœéœ€è¦ï¼‰
        // - ç¬¬2è¡Œï¼šåˆ—å­—æ®µå€¼ï¼ˆé‡å¤æ•°æ®å­—æ®µæ¬¡ï¼‰
        // - ç¬¬3è¡Œï¼šæ•°æ®å­—æ®µæ ‡é¢˜ï¼ˆé‡å¤æ¯ä¸ªåˆ—é”®ç»„åˆï¼‰
        //
        // è¡¨å¤´ç»“æ„ï¼ˆå¤šåˆ—å­—æ®µï¼‰ï¼š
        // - ç¬¬1è¡Œï¼šè¡Œå­—æ®µæ ‡é¢˜ + åˆ—å­—æ®µ1æ ‡é¢˜ + åˆ—å­—æ®µ2æ ‡é¢˜ + ...
        // - ç¬¬2è¡Œï¼šåˆ—å­—æ®µ1çš„å€¼ + åˆ—å­—æ®µ2çš„å€¼ + ...
        // - ç¬¬3è¡Œï¼šæ•°æ®å­—æ®µæ ‡é¢˜
        //

        // ğŸ”§ è¾…åŠ©å‡½æ•°ï¼šè·å–æŒ‡å®šå±‚çº§çš„å”¯ä¸€å€¼ï¼ˆä¿æŒé¡ºåºï¼‰
        function getLevelValues(keys, level) {
            var seen = Object.create(null);
            var values = [];
            for (var k = 0; k < keys.length; k++) {
                var parts = keys[k].split(separator);
                if (level < parts.length) {
                    var val = parts[level];
                    var valKey = String(val);
                    if (!seen[valKey]) {
                        seen[valKey] = true;
                        values.push(val);
                    }
                }
            }
            return values;
        }

        // ğŸ”§ è¾…åŠ©å‡½æ•°ï¼šè·å–æŒ‡å®šå±‚çº§çš„å”¯ä¸€å€¼æ•°é‡
        function getUniqueLevelCount(keys, level) {
            return getLevelValues(keys, level).length;
        }

        // ğŸ”§ v3.8.1 æ€§èƒ½ä¼˜åŒ–ï¼šé¢„è®¡ç®—æ‰€æœ‰åˆ—å­—æ®µå±‚çº§çš„å”¯ä¸€å€¼
        // è¿™æ ·å¯ä»¥é¿å…åœ¨åµŒå¥—å¾ªç¯ä¸­é‡å¤è°ƒç”¨ getLevelValues å’Œ getUniqueLevelCount
        var levelUniqueValues = [];
        if (numColFieldLevels > 1) {
            for (var lv = 0; lv < numColFieldLevels; lv++) {
                var vals = [];
                var seen = Object.create(null);
                for (var k = 0; k < colKeys.length; k++) {
                    var parts = colKeys[k].split(separator);
                    if (lv < parts.length) {
                        var val = parts[lv];
                        var valKey = String(val);
                        if (!seen[valKey]) {
                            seen[valKey] = true;
                            vals.push(val);
                        }
                    }
                }
                levelUniqueValues.push(vals);
            }
            // ğŸ”§ DEBUG: è¾“å‡ºå±‚çº§å”¯ä¸€å€¼ä¿¡æ¯
            Console.log('[superPivot DEBUG] å±‚çº§å”¯ä¸€å€¼ç»Ÿè®¡:');
            for (var lv = 0; lv < levelUniqueValues.length; lv++) {
                Console.log('[superPivot DEBUG]   å±‚çº§' + lv + ': ' + levelUniqueValues[lv].length + ' ä¸ªå”¯ä¸€å€¼ [' + levelUniqueValues[lv].slice(0, 3).join(', ') + '...]');
            }
        }

        // ğŸ”§ DEBUG: è¡¨å¤´ç”Ÿæˆå‰çŠ¶æ€ï¼ˆå·²ç¦ç”¨ä»¥é¿å…å¡æ­»ï¼‰
        // Console.log('[superPivot DEBUG] numRowFieldLevels: ' + numRowFieldLevels + ', numColFieldLevels: ' + numColFieldLevels + ', headerRowCount: ' + headerRowCount);
        // Console.log('[superPivot DEBUG] colKeys.length: ' + colKeys.length);
        // Console.log('[superPivot DEBUG] colKeys sample: ' + colKeys.slice(0, 5).join(', '));

        // æ„å»ºè¡¨å¤´æ•°ç»„
        var headerRows = [];
        for (var h = 0; h < headerRowCount; h++) {
            headerRows.push([]);
        }

        // ============ æ­¥éª¤1: å¡«å……è¡Œå­—æ®µåŒºåŸŸï¼ˆå·¦ä¸Šè§’ï¼‰============
        // ğŸ”§ ä¿®å¤ï¼šå•åˆ—å­—æ®µæ—¶ï¼Œè¡Œå­—æ®µæ ‡é¢˜æ”¾åœ¨ç¬¬1è¡Œï¼›å¤šåˆ—å­—æ®µæ—¶æ”¾åœ¨æœ€åä¸€è¡Œ

        // ğŸ”§ v3.9.1 æ–°å¢ï¼šå¤„ç†æ— åˆ—å­—æ®µçš„æƒ…å†µï¼ˆä»…è¡Œå­—æ®µï¼‰
        if (numColFieldLevels === 0) {
            // æ— åˆ—å­—æ®µï¼šå•è¡Œè¡¨å¤´ï¼ŒåŒ…å«è¡Œå­—æ®µæ ‡é¢˜å’Œæ•°æ®å­—æ®µæ ‡é¢˜
            // ğŸ”§ v3.8.8 ä¿®å¤ï¼šhideRowTitles = true æ—¶ä¸æ·»åŠ è¡Œæ ‡é¢˜åˆ—
            if (!hideRowTitles) {
                for (var rfIdx = 0; rfIdx < numRowFieldLevels; rfIdx++) {
                    var rowTitle = '';
                    if (hasRowTitles) {
                        rowTitle = rowConfig.titles[rfIdx] || '';
                    } else if (_originalHeader) {
                        var match = rowConfig.fields[rfIdx].field.match(/^f(\d+)$/);
                        if (match) {
                            var origIdx = parseInt(match[1]) - 1;
                            rowTitle = _originalHeader[origIdx] || '';
                        }
                    } else if (arr && arr[0]) {
                        var match = rowConfig.fields[rfIdx].field.match(/^f(\d+)$/);
                        if (match) {
                            var origIdx = parseInt(match[1]) - 1;
                            rowTitle = arr[0][origIdx] || '';
                        }
                    }
                    headerRows[0].push(rowTitle);
                }
            }

            // æ·»åŠ æ•°æ®å­—æ®µæ ‡é¢˜
            for (var dfIdx = 0; dfIdx < numDataFields; dfIdx++) {
                headerRows[0].push(defaultDataTitles[dfIdx] || '');
            }
        } else if (numColFieldLevels === 1) {
            // å•åˆ—å­—æ®µï¼šè¡Œå­—æ®µæ ‡é¢˜æ”¾åœ¨ç¬¬1è¡Œ
            // ğŸ”§ v3.8.8 ä¿®å¤ï¼šhideRowTitles = true æ—¶ä¸æ·»åŠ è¡Œæ ‡é¢˜åˆ—
            if (!hideRowTitles) {
                for (var rfIdx = 0; rfIdx < numRowFieldLevels; rfIdx++) {
                    var rowTitle = '';
                    if (hasRowTitles) {
                        rowTitle = rowConfig.titles[rfIdx] || '';
                    } else if (_originalHeader) {
                        var match = rowConfig.fields[rfIdx].field.match(/^f(\d+)$/);
                        if (match) {
                            var origIdx = parseInt(match[1]) - 1;
                            rowTitle = _originalHeader[origIdx] || '';
                        }
                    } else if (arr && arr[0]) {
                        var match = rowConfig.fields[rfIdx].field.match(/^f(\d+)$/);
                        if (match) {
                            var origIdx = parseInt(match[1]) - 1;
                            rowTitle = arr[0][origIdx] || '';
                        }
                    }
                    headerRows[0].push(rowTitle);
                }
                
                // ğŸ”§ v3.9.0 æ–°å¢ï¼šæ·»åŠ è§’æ ‡é¢˜ï¼ˆå¦‚æœæä¾›äº†ä¸”åªæœ‰1ä¸ªè¡Œå­—æ®µï¼‰
                if (cornerTitle && numRowFieldLevels === 1) {
                    headerRows[0][0] = cornerTitle;
                }
                // ç¬¬2è¡Œå’Œç¬¬3è¡Œçš„é¦–åˆ—æ”¾ç©ºç™½ï¼ˆä¸è¡Œå­—æ®µæ•°é‡å¯¹é½ï¼‰
                for (var i = 0; i < numRowFieldLevels; i++) {
                    headerRows[1].push('');
                    headerRows[2].push('');
                }
            }

            // ğŸ”§ v3.8.3 ä¿®å¤ï¼šæ·»åŠ åˆ—å­—æ®µæ ‡é¢˜åˆ°ç¬¬2è¡Œ
            var colTitle = '';
            if (hasColTitles) {
                colTitle = colConfig.titles[0] || '';
            } else if (_originalHeader) {
                var match = colConfig.fields[0].field.match(/^f(\d+)$/);
                if (match) {
                    var origIdx = parseInt(match[1]) - 1;
                    colTitle = _originalHeader[origIdx] || '';
                }
            } else if (arr && arr[0]) {
                var match = colConfig.fields[0].field.match(/^f(\d+)$/);
                if (match) {
                    var origIdx = parseInt(match[1]) - 1;
                    colTitle = arr[0][origIdx] || '';
                }
            }
            headerRows[1].push(colTitle);

            // ğŸ”§ v3.8.3 ä¿®å¤ï¼šæ·»åŠ åˆ—å­—æ®µå€¼åˆ°ç¬¬1è¡Œ
            for (var ck = 0; ck < colKeys.length; ck++) {
                var colKeyParts = colKeys[ck].split(separator);
                headerRows[0].push(colKeyParts[0]);
                // ç¬¬2è¡Œæ·»åŠ ç©ºç™½å ä½ç¬¦ï¼ˆå¯¹åº”æ¯ä¸ªåˆ—å€¼ï¼‰
                headerRows[1].push('');
            }
            
            // ğŸ”§ v3.9.0 æ–°å¢ï¼šæ·»åŠ åˆ—å°è®¡æ ‡é¢˜
            if (colSubtotals.enabled) {
                headerRows[0].push(colSubtotals.label || 'å°è®¡');
                headerRows[1].push('');
            }

            // ğŸ”§ v3.8.3 ä¿®å¤ï¼šæ·»åŠ æ•°æ®å­—æ®µæ ‡é¢˜åˆ°ç¬¬3è¡Œ
            for (var ck = 0; ck < colKeys.length; ck++) {
                for (var dfIdx = 0; dfIdx < numDataFields; dfIdx++) {
                    headerRows[2].push(defaultDataTitles[dfIdx] || '');
                }
            }
            
            // ğŸ”§ v3.9.0 æ–°å¢ï¼šæ·»åŠ åˆ—å°è®¡çš„æ•°æ®å­—æ®µæ ‡é¢˜
            if (colSubtotals.enabled) {
                for (var dfIdx = 0; dfIdx < numDataFields; dfIdx++) {
                    headerRows[2].push(defaultDataTitles[dfIdx] || '');
                }
            }
        } else {
            // ğŸ”§ v3.8.5 ä¿®å¤ï¼šå¤šåˆ—å­—æ®µ - åŸºäºå®é™…colKeysæ„å»ºè¡¨å¤´
            // è¡¨å¤´ç»“æ„ï¼ˆ4ä¸ªåˆ—å­—æ®µï¼šå¤§åŒºâ†’çœä»½â†’åŸå¸‚â†’åŒºåŸŸï¼‰ï¼š
            // ç¬¬0è¡Œï¼šåˆ—å­—æ®µæ ‡é¢˜(å¤§åŒº) | å¤§åŒºå€¼(ç¬¬1å±‚) | å¤§åŒºå€¼ | ...
            // ç¬¬1è¡Œï¼šåˆ—å­—æ®µæ ‡é¢˜(çœä»½) | çœä»½å€¼(ç¬¬2å±‚) | çœä»½å€¼ | ...
            // ç¬¬2è¡Œï¼šåˆ—å­—æ®µæ ‡é¢˜(åŸå¸‚) | åŸå¸‚å€¼(ç¬¬3å±‚) | åŸå¸‚å€¼ | ...
            // ç¬¬3è¡Œï¼šåˆ—å­—æ®µæ ‡é¢˜(åŒºåŸŸ) | åŒºåŸŸå€¼(ç¬¬4å±‚) | åŒºåŸŸå€¼ | ...
            // ç¬¬4è¡Œï¼šè¡Œå­—æ®µæ ‡é¢˜(éƒ¨é—¨) | æ•°æ®å­—æ®µæ ‡é¢˜ | ...

            // ğŸ”§ v3.8.7 ä¿®å¤ï¼šä¸ºæ¯ä¸ªåˆ—å­—æ®µå±‚çº§å¡«å……å€¼ï¼Œåˆ—å­—æ®µæ ‡é¢˜åªæ˜¾ç¤ºä¸€æ¬¡
            for (var cfIdx = 0; cfIdx < numColFieldLevels; cfIdx++) {
                var targetRow = cfIdx;  // ä»ç¬¬0è¡Œå¼€å§‹

                // å…ˆä¸ºè¡Œå­—æ®µä½ç½®æ·»åŠ ç©ºå­—ç¬¦ä¸²ï¼ˆå·¦ä¸Šè§’ç©ºç™½ï¼‰
                // ğŸ”§ æ³¨æ„ï¼šæ·»åŠ  numRowFieldLevels - 1 ä¸ªç©ºå­—ç¬¦ä¸²ï¼Œåˆ—å­—æ®µæ ‡é¢˜å æ®ç¬¬Nä¸ªä½ç½®
                // ğŸ”§ v3.8.8 ä¿®å¤ï¼šhideRowTitles = true æ—¶ä¸éœ€è¦ç©ºå­—ç¬¦ä¸²
                if (!hideRowTitles) {
                    for (var rfIdx = 0; rfIdx < numRowFieldLevels - 1; rfIdx++) {
                        headerRows[targetRow].push('');
                    }
                }

                // ğŸ”§ v3.9.0 æ–°å¢ï¼šç¬¬ä¸€è¡Œç¬¬ä¸€åˆ—æ·»åŠ è§’æ ‡é¢˜
                if (cfIdx === 0 && cornerTitle && !hideRowTitles) {
                    headerRows[targetRow].push(cornerTitle);
                } else {
                    // ğŸ”§ æ·»åŠ åˆ—å­—æ®µæ ‡é¢˜ï¼ˆäº§å“ç±»åˆ«/äº§å“å­ç±»/äº§å“åç§°ï¼‰- åªæ·»åŠ ä¸€æ¬¡
                    var colTitle = '';
                    if (hasColTitles) {
                        colTitle = colConfig.titles[cfIdx] || '';
                    } else if (_originalHeader) {
                        var match = colConfig.fields[cfIdx].field.match(/^f(\d+)$/);
                        if (match) {
                            var origIdx = parseInt(match[1]) - 1;
                            colTitle = _originalHeader[origIdx] || '';
                        }
                    } else if (arr && arr[0]) {
                        var match = colConfig.fields[cfIdx].field.match(/^f(\d+)$/);
                        if (match) {
                            var origIdx = parseInt(match[1]) - 1;
                            colTitle = arr[0][origIdx] || '';
                        }
                    }
                    headerRows[targetRow].push(colTitle);
                }

                // éå†colKeysï¼Œæå–å½“å‰å±‚çº§çš„å€¼
                for (var ck = 0; ck < colKeys.length; ck++) {
                    var colKeyParts = colKeys[ck].split(separator);
                    if (cfIdx < colKeyParts.length) {
                        // å½“å‰å±‚çº§çš„å€¼ï¼Œé‡å¤numDataFieldsæ¬¡
                        for (var df = 0; df < numDataFields; df++) {
                            headerRows[targetRow].push(colKeyParts[cfIdx]);
                        }
                    } else {
                        // å¦‚æœcolKeyåœ¨å½“å‰å±‚çº§æ²¡æœ‰å€¼ï¼Œå¡«å……ç©ºå­—ç¬¦ä¸²
                        for (var df = 0; df < numDataFields; df++) {
                            headerRows[targetRow].push('');
                        }
                    }
                }
                
                // ğŸ”§ v3.9.0 æ–°å¢ï¼šæ·»åŠ åˆ—å°è®¡æ ‡é¢˜
                if (colSubtotals.enabled) {
                    if (cfIdx === numColFieldLevels - 1) {
                        headerRows[targetRow].push(colSubtotals.label || 'å°è®¡');
                    } else {
                        headerRows[targetRow].push('');
                    }
                }
            }

            // æœ€åä¸€è¡Œï¼šå¡«å……è¡Œå­—æ®µæ ‡é¢˜å’Œæ•°æ®å­—æ®µæ ‡é¢˜
            var lastRow = numColFieldLevels;
            // å…ˆæ·»åŠ è¡Œå­—æ®µæ ‡é¢˜ï¼ˆéƒ¨é—¨ï¼‰
            // ğŸ”§ v3.8.8 ä¿®å¤ï¼šhideRowTitles = true æ—¶ä¸æ·»åŠ è¡Œæ ‡é¢˜
            if (!hideRowTitles) {
                for (var rfIdx = 0; rfIdx < numRowFieldLevels; rfIdx++) {
                    var rowTitle = '';
                    if (hasRowTitles) {
                        rowTitle = rowConfig.titles[rfIdx] || '';
                    } else if (_originalHeader) {
                        var match = rowConfig.fields[rfIdx].field.match(/^f(\d+)$/);
                        if (match) {
                            var origIdx = parseInt(match[1]) - 1;
                            rowTitle = _originalHeader[origIdx] || '';
                        }
                    } else if (arr && arr[0]) {
                        var match = rowConfig.fields[rfIdx].field.match(/^f(\d+)$/);
                        if (match) {
                            var origIdx = parseInt(match[1]) - 1;
                            rowTitle = arr[0][origIdx] || '';
                        }
                    }
                    headerRows[lastRow].push(rowTitle);
                }
            }
            // æ·»åŠ æ•°æ®å­—æ®µæ ‡é¢˜
            for (var ckIdx = 0; ckIdx < colKeys.length; ckIdx++) {
                for (var dfIdx = 0; dfIdx < numDataFields; dfIdx++) {
                    headerRows[lastRow].push(defaultDataTitles[dfIdx] || '');
                }
            }
            
            // ğŸ”§ v3.9.0 æ–°å¢ï¼šæ·»åŠ åˆ—å°è®¡çš„æ•°æ®å­—æ®µæ ‡é¢˜
            if (colSubtotals.enabled) {
                for (var dfIdx = 0; dfIdx < numDataFields; dfIdx++) {
                    headerRows[lastRow].push(defaultDataTitles[dfIdx] || '');
                }
            }
        }

        // å°†è¡¨å¤´è¡Œæ·»åŠ åˆ°ç»“æœä¸­
        for (var h = 0; h < headerRowCount; h++) {
            result.push(headerRows[h]);
        }

        // ğŸ”§ DEBUG: è¾“å‡ºè¡¨å¤´ç»“æ„
        Console.log('[superPivot DEBUG] è¡¨å¤´ç»“æ„ (' + headerRowCount + ' è¡Œ):');
        for (var h = 0; h < Math.min(headerRowCount, 6); h++) {
            var rowStr = '[Row ' + h + '] é•¿åº¦=' + headerRows[h].length + ' | ';
            var preview = headerRows[h].slice(0, Math.min(8, headerRows[h].length));
            rowStr += preview.join(', ');
            if (headerRows[h].length > 8) {
                rowStr += ', ... (å…±' + headerRows[h].length + 'åˆ—)';
            }
            Console.log('[superPivot DEBUG]   ' + rowStr + ']');
        }
    }

    // ğŸ”§ DEBUG: æ„å»ºæ•°æ®è¡Œ

    // ğŸ”§ v3.8.8 æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦éšè—è¡Œæ ‡é¢˜åˆ—
    var hideRowTitles = (outputHeader === -1);

    // ğŸ”§ v3.9.0 ä¿®æ”¹ï¼šæ„å»ºæ•°æ®è¡Œï¼ˆæ”¯æŒå°è®¡ã€æ€»è®¡ã€ç™¾åˆ†æ¯”ï¼‰
    var dataRows = [];
    var prevRowKeyParts = null;
    
    for (var rk = 0; rk < rowKeys.length; rk++) {
        var rowKey = rowKeys[rk];
        var rowKeyParts = rowKey.split(separator);
        
        // ğŸ”§ v3.9.0 æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦éœ€è¦æ’å…¥è¡Œå°è®¡
        if (rowSubtotals.enabled && rk > 0 && prevRowKeyParts) {
            // æ£€æŸ¥å½“å‰è¡Œä¸å‰ä¸€è¡Œæ˜¯å¦æœ‰ç›¸åŒçš„çˆ¶çº§
            var commonParentLen = 0;
            for (var p = 0; p < rowKeyParts.length - 1 && p < prevRowKeyParts.length - 1; p++) {
                if (rowKeyParts[p] === prevRowKeyParts[p]) {
                    commonParentLen = p + 1;
                } else {
                    break;
                }
            }
            
            // å¦‚æœçˆ¶çº§å˜åŒ–ï¼Œæ’å…¥å°è®¡è¡Œ
            if (commonParentLen > 0 && rowKeyParts[commonParentLen - 1] !== prevRowKeyParts[commonParentLen - 1]) {
                // å®é™…åº”è¯¥æ£€æŸ¥æ˜¯å¦éœ€è¦æ ¹æ®å±‚çº§æ’å…¥å°è®¡
                // ç®€åŒ–å¤„ç†ï¼šæ£€æŸ¥æœ€åä¸€æ®µæ˜¯å¦ä¸åŒ
            }
        }
        
        // ğŸ”§ v3.8.8 ä¿®å¤ï¼šhideRowTitles = true æ—¶ä¸åŒ…å«è¡Œå­—æ®µå€¼
        var dataRow = hideRowTitles ? [] : rowKeyParts.slice();
        
        // ğŸ”§ v3.9.0 æ–°å¢ï¼šåº”ç”¨å±‚çº§ç¼©è¿›
        if (rowFieldIndent && layoutMode === 'outline' && !hideRowTitles) {
            for (var rpi = 0; rpi < dataRow.length; rpi++) {
                var indent = rpi * rowFieldIndentSize;
                var spaces = '';
                for (var s = 0; s < indent; s++) spaces += ' ';
                dataRow[rpi] = spaces + dataRow[rpi];
            }
        }

        // ğŸ”§ v3.9.1 æ–°å¢ï¼šå¤„ç†æ— åˆ—å­—æ®µçš„æƒ…å†µ - ç›´æ¥æ·»åŠ èšåˆå€¼
        if (colKeys.length === 0) {
            // æ²¡æœ‰åˆ—å­—æ®µï¼Œä½¿ç”¨ rowKey + '|||' è·å–èšåˆå€¼
            // ï¼ˆgroupMap ä¸­é”®çš„æ ¼å¼æ˜¯ "rowKey|||" å½“æ²¡æœ‰åˆ—å­—æ®µæ—¶ï¼‰
            var emptyColKey = rowKey + '|||';
            if (groupMap[emptyColKey]) {
                var agg = executeAggregation(groupMap[emptyColKey]);
                // ğŸ”§ v3.9.0 æ–°å¢ï¼šåº”ç”¨ç™¾åˆ†æ¯”è½¬æ¢
                for (var ai = 0; ai < agg.length; ai++) {
                    agg[ai] = applyDisplayAs(agg[ai], rowKey, null, ai);
                }
                dataRow = dataRow.concat(agg);
            } else {
                // æ²¡æœ‰æ•°æ®ï¼Œå¡«å……ç©ºå€¼
                for (var c = 0; c < numDataFields; c++) {
                    dataRow.push('');
                }
            }
        } else {
            // ğŸ”§ v3.7.9 æ–¹æ¡ˆ3: æ•°æ®è¡Œä¸è¡¨å¤´å¯¹é½
            for (var ck = 0; ck < colKeys.length; ck++) {
                var colKey = colKeys[ck];
                var fullKey = rowKey + '|||' + colKey;
                if (groupMap[fullKey]) {
                    var agg = executeAggregation(groupMap[fullKey]);
                    // ğŸ”§ v3.9.0 æ–°å¢ï¼šåº”ç”¨ç™¾åˆ†æ¯”è½¬æ¢
                    for (var ai = 0; ai < agg.length; ai++) {
                        agg[ai] = applyDisplayAs(agg[ai], rowKey, colKey, ai);
                    }
                    dataRow = dataRow.concat(agg);
                } else {
                    for (var c = 0; c < numDataFields; c++) {
                        dataRow.push('');
                    }
                }
            }
        }

        // ğŸ”§ v3.9.0 æ–°å¢ï¼šæ·»åŠ åˆ—å°è®¡åˆ—ï¼ˆæ¯è¡Œæœ«å°¾çš„å°è®¡ï¼‰
        if (options.subtotals.col && grandTotalValues && grandTotalValues.rowTotals[rowKey]) {
            var rowTotal = grandTotalValues.rowTotals[rowKey];
            for (var rt = 0; rt < numDataFields; rt++) {
                dataRow.push(applyDisplayAs(rowTotal[rt], rowKey, null, rt));
            }
        }
        
        dataRows.push(dataRow);
        prevRowKeyParts = rowKeyParts;
    }
    
    // ğŸ”§ v3.9.0 æ–°å¢ï¼šæ·»åŠ æ€»è®¡è¡Œ
    if (options.grandTotal.row) {
        var totalLabel = options.grandTotal.label || 'æ€»è®¡';
        var grandTotalRow = hideRowTitles ? [] : [totalLabel];
        // å¡«å……ç©ºç™½ä½¿æ€»è®¡æ ‡ç­¾ä¸è¡Œå­—æ®µæ•°é‡å¯¹é½
        while (grandTotalRow.length < numRowFieldLevels) {
            grandTotalRow.push('');
        }

        // ğŸ”§ v3.9.1 æ–°å¢ï¼šå¤„ç†æ— åˆ—å­—æ®µçš„æ€»è®¡è¡Œ
        if (colKeys.length === 0) {
            // æ²¡æœ‰åˆ—å­—æ®µï¼Œç›´æ¥ä½¿ç”¨æ€»è®¡å€¼
            if (grandTotalValues && grandTotalValues.grandTotal) {
                for (var df = 0; df < numDataFields; df++) {
                    grandTotalRow.push(applyDisplayAs(grandTotalValues.grandTotal[df], null, null, df));
                }
            } else {
                for (var df = 0; df < numDataFields; df++) {
                    grandTotalRow.push('');
                }
            }
        } else {
            // æ·»åŠ åˆ—æ€»è®¡å€¼
            for (var ck = 0; ck < colKeys.length; ck++) {
                var colKey = colKeys[ck];
                if (grandTotalValues && grandTotalValues.colTotals[colKey]) {
                    var colTotal = grandTotalValues.colTotals[colKey];
                    for (var df = 0; df < numDataFields; df++) {
                        grandTotalRow.push(applyDisplayAs(colTotal[df], null, colKey, df));
                    }
                } else {
                    for (var df = 0; df < numDataFields; df++) {
                        grandTotalRow.push('');
                    }
                }
            }
        }

        // æ·»åŠ åˆ—å°è®¡ï¼ˆæ€»è®¡è¡Œçš„æœ€åå‡ åˆ—ï¼‰
        if (options.subtotals.col && grandTotalValues && grandTotalValues.grandTotal) {
            for (var df = 0; df < numDataFields; df++) {
                grandTotalRow.push(applyDisplayAs(grandTotalValues.grandTotal[df], null, null, df));
            }
        }
        
        dataRows.push(grandTotalRow);
    }
    
    // å°†æ‰€æœ‰æ•°æ®è¡Œæ·»åŠ åˆ°ç»“æœ
    for (var dr = 0; dr < dataRows.length; dr++) {
        result.push(dataRows[dr]);
    }

    // ğŸ”§ DEBUG: æœ€ç»ˆç»“æœ
    Console.log('[superPivot DEBUG] æ•°æ®è¡Œæ„å»ºå®Œæˆ: ' + (result.length - headerRowCount) + ' è¡Œ');
    Console.log('[superPivot DEBUG] æ€»è¡Œæ•°: ' + result.length + ' è¡Œ (åŒ…å« ' + headerRowCount + ' è¡Œè¡¨å¤´)');
    if (result.length > 0) {
        Console.log('[superPivot DEBUG] ç¬¬ä¸€è¡Œé•¿åº¦: ' + result[0].length + ' åˆ—');
        if (result.length > headerRowCount) {
            Console.log('[superPivot DEBUG] ç¬¬ä¸€è¡Œæ•°æ®: ' + JSON.stringify(result[headerRowCount]));
        }
    }

    // åŒ…è£…ç»“æœï¼Œè¿”å› Array2D å¯¹è±¡ï¼Œæ·»åŠ  toRange å’Œ getRange æ–¹æ³•
    var wrappedResult = result;
    if (Array.isArray(result)) {
        // åˆ›å»º Array2D å¯¹è±¡
        wrappedResult = new Array2D(result);

        // ğŸ”§ å­˜å‚¨åˆå¹¶ä¿¡æ¯
        wrappedResult._mergeInfo = mergeInfo;

        /**
         * è·å–åˆå¹¶ä¿¡æ¯
         * @returns {Object} åˆå¹¶ä¿¡æ¯å¯¹è±¡
         */
        wrappedResult.getMerges = function() {
            return mergeInfo;
        };

        /**
         * toRange - å°†ç»“æœå†™å…¥å•å…ƒæ ¼
         * @param {Range|string} rng - ç›®æ ‡å•å…ƒæ ¼
         * @param {Boolean} applyMerges - æ˜¯å¦åº”ç”¨åˆå¹¶ï¼Œé»˜è®¤true
         * @returns {Range} Rangeå¯¹è±¡
         */
        wrappedResult.toRange = function(rng, applyMerges) {
            // ğŸ”§ æ€§èƒ½ä¼˜åŒ–ï¼šç¦ç”¨å±å¹•æ›´æ–°å’Œè‡ªåŠ¨è®¡ç®—
            var app = Application;
            var screenUpdating = app.ScreenUpdating;
            var calculation = app.Calculation;
            var eventsEnabled = app.EnableEvents;

            try {
                // ç¦ç”¨ä¸å¿…è¦çš„åŠŸèƒ½ä»¥æé«˜æ€§èƒ½
                app.ScreenUpdating = false;
                app.Calculation = -4135; // xlCalculationManual
                app.EnableEvents = false;

                var targetRange = Array2D.toRange(result, rng);

                // å¦‚æœéœ€è¦åˆå¹¶ä¸”è¾“å‡ºè¡¨å¤´
                if (applyMerges !== false && outputHeader === 1 && mergeInfo) {
                    wrappedResult.applyMerges(targetRange);
                }

                return targetRange;
            } finally {
                // æ¢å¤åŸå§‹è®¾ç½®
                app.ScreenUpdating = screenUpdating;
                app.Calculation = calculation;
                app.EnableEvents = eventsEnabled;
            }
        };

        /**
         * getRange - è·å–ç»“æœå†™å…¥åçš„Rangeå¯¹è±¡
         * @param {Range|string} rng - ç›®æ ‡å•å…ƒæ ¼
         * @param {Boolean} applyMerges - æ˜¯å¦åº”ç”¨åˆå¹¶ï¼Œé»˜è®¤true
         * @returns {Range} Rangeå¯¹è±¡
         */
        wrappedResult.getRange = function(rng, applyMerges) {
            return wrappedResult.toRange(rng, applyMerges);
        };

        /**
         * ğŸ”§ applyMerges - åº”ç”¨è¡¨å¤´åˆå¹¶å•å…ƒæ ¼ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
         * @param {Range|string} rng - ç›®æ ‡å•å…ƒæ ¼åŒºåŸŸ
         * @returns {Array} å·²æ‰§è¡Œçš„åˆå¹¶åˆ—è¡¨ [{row1, col1, row2, col2}, ...]
         * @example
         * // è‡ªåŠ¨åº”ç”¨åˆå¹¶
         * var result = Array2D.zè¶…çº§é€è§†(data, rowFields, colFields, dataFields);
         * result.toRange("A1");  // è‡ªåŠ¨åˆå¹¶
         *
         * // æ‰‹åŠ¨åº”ç”¨åˆå¹¶
         * var result = Array2D.zè¶…çº§é€è§†(data, rowFields, colFields, dataFields);
         * result.toRange("A1", false);  // ä¸åˆå¹¶
         * result.applyMerges("A1");  // æ‰‹åŠ¨åˆå¹¶
         */
        wrappedResult.applyMerges = function(rng) {
            // è½¬æ¢ rng ä¸º Range å¯¹è±¡
            var targetRange;
            if (typeof rng === 'string') {
                targetRange = Application.ActiveSheet.Range(rng);
            } else if (rng && rng.Address) {
                targetRange = rng;
            } else {
                Console.log('applyMerges: æ— æ•ˆçš„Rangeå‚æ•°');
                return [];
            }

            var appliedMerges = [];
            var ws = Application.ActiveSheet;

            // ğŸ”§ æ€§èƒ½ä¼˜åŒ–ï¼šå…ˆæ”¶é›†æ‰€æœ‰åˆå¹¶åŒºåŸŸï¼Œå†æ‰¹é‡æ‰§è¡Œ
            var mergeRanges = [];

            // éå†åˆå¹¶ä¿¡æ¯
            for (var rowIdx in mergeInfo) {
                var r = parseInt(rowIdx);
                for (var colIdx in mergeInfo[rowIdx]) {
                    var c = parseInt(colIdx);
                    var span = mergeInfo[rowIdx][colIdx];

                    if (span.rowSpan > 1 || span.colSpan > 1) {
                        mergeRanges.push({
                            row: r,
                            col: c,
                            rowSpan: span.rowSpan,
                            colSpan: span.colSpan
                        });
                    }
                }
            }

            // ğŸ”§ æ‰¹é‡æ‰§è¡Œåˆå¹¶ï¼ˆå‡å°‘try-catchå¼€é”€ï¼‰
            for (var i = 0; i < mergeRanges.length; i++) {
                var m = mergeRanges[i];
                try {
                    var startCell = targetRange.Item(m.row + 1, m.col + 1);
                    var endCell = targetRange.Item(
                        m.row + m.rowSpan,
                        m.col + m.colSpan
                    );
                    var mergeRange = ws.Range(startCell, endCell);
                    mergeRange.Merge();
                    appliedMerges.push({
                        row1: m.row + 1,
                        col1: m.col + 1,
                        row2: m.row + m.rowSpan,
                        col2: m.col + m.colSpan
                    });
                } catch (e) {
                    // é™é»˜å¤„ç†ï¼Œé¿å…å¤§é‡é”™è¯¯è¾“å‡º
                }
            }

            return appliedMerges;
        };

        /**
         * val - è·å–åŸå§‹æ•°ç»„
         * @returns {Array} åŸå§‹æ•°ç»„
         */
        wrappedResult.val = function() { return result; };

        /**
         * res - è·å–åŸå§‹æ•°ç»„ï¼ˆvalçš„åˆ«åï¼‰
         * @returns {Array} åŸå§‹æ•°ç»„
         */
        wrappedResult.res = function() { return result; };

        /**
         * ğŸ”§ v3.9.0 æ–°å¢ï¼šgetMeta - è·å–é€è§†è¡¨å…ƒæ•°æ®
         * @returns {Object} å…ƒæ•°æ®å¯¹è±¡
         * @example
         * var result = Array2D.zè¶…çº§é€è§†(data, rowFields, colFields, dataFields, 0, 1, '@^@', options);
         * var meta = result.getMeta();
         * console.log(meta.rowFields);  // ['å¤§åŒº', 'çœä»½']
         * console.log(meta.colFields);  // ['å¹´ä»½', 'å­£åº¦']
         * console.log(meta.grandTotal); // æ€»é”€å”®é¢
         */
        wrappedResult.getMeta = function() {
            return {
                version: '3.9.0',
                rowFields: rowConfig.fields.map(function(f) { return f.field; }),
                rowTitles: rowConfig.titles,
                colFields: colConfig.fields.map(function(f) { return f.field; }),
                colTitles: colConfig.titles,
                dataFields: dataOps.map(function(op) { return op.name; }),
                dataTitles: defaultDataTitles,
                rowCount: dataRows ? dataRows.length : rowKeys.length,
                colCount: colKeys.length,
                headerRowCount: headerRowCount,
                grandTotal: grandTotalValues ? grandTotalValues.grandTotal : null,
                options: {
                    cornerTitle: cornerTitle,
                    layoutMode: layoutMode,
                    rowFieldIndent: rowFieldIndent,
                    rowSubtotals: rowSubtotals,
                    colSubtotals: colSubtotals,
                    grandTotals: grandTotals,
                    displayAs: displayAs
                }
            };
        };
    }

    return wrappedResult;
};
Array2D.superPivot = Array2D.zè¶…çº§é€è§†;

/**
 * zè¶…çº§é€è§† - å®ä¾‹æ–¹æ³•ç‰ˆæœ¬
 * è°ƒç”¨é™æ€æ–¹æ³• Array2D.zè¶…çº§é€è§†ï¼Œä½¿ç”¨å½“å‰å®ä¾‹çš„æ•°æ®
 * ğŸ”§ v3.7.7 ä¿®å¤: ä¼ é€’ this è€Œé this._itemsï¼Œä¿ç•™ _header å’Œ _original å±æ€§
 */
Array2D.prototype.zè¶…çº§é€è§† = function(rowFields, colFields, dataFields, headerRows, outputHeader, separator, options) {
    return Array2D.zè¶…çº§é€è§†(this, rowFields, colFields, dataFields, headerRows, outputHeader, separator, options);
};
Array2D.prototype.superPivot = Array2D.prototype.zè¶…çº§é€è§†;

/**
 * ç”Ÿæˆé™æ€æ–¹æ³•ï¼ˆä»å®ä¾‹æ–¹æ³•è‡ªåŠ¨ç”Ÿæˆï¼‰
 */
(function() {
    var propNames = Object.getOwnPropertyNames(Array2D.prototype);
    // å·²ç»æ‰‹åŠ¨å®šä¹‰çš„é™æ€æ–¹æ³•ï¼Œè·³è¿‡è‡ªåŠ¨ç”Ÿæˆ
    var manuallyDefined = ['zé€‰æ‹©åˆ—', 'selectCols', 'zæ‰¹é‡å¡«å……', 'fill', 'zå†™å…¥å•å…ƒæ ¼', 'toRange', 'zè½¬ç½®', 'transpose', 'zæ±‚å’Œ', 'sum', 'zå…‹éš†', 'copy', 'zè¶…çº§é€è§†', 'superPivot',
                          'zç­›é€‰', 'filter', 'zå¤šåˆ—æ’åº', 'sortByCols', 'zæ˜ å°„', 'map', 'zå»é‡', 'distinct'];

    for (var i = 0; i < propNames.length; i++) {
        var name = propNames[i];
        if (manuallyDefined.indexOf(name) >= 0) continue;

        if (name !== 'constructor' && name !== '_init' && name !== '_new' && typeof Array2D.prototype[name] === 'function') {
            (function(methodName) {
                Array2D[methodName] = function() {
                    // ğŸ”§ v3.7.7 ä¿®å¤: ä¿ç•™ _header å±æ€§
                    // ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ•°ç»„æ•°æ®ï¼Œä¼ é€’ç»™æ„é€ å‡½æ•°
                    // æ”¯æŒ Array2D å¯¹è±¡ï¼ˆç›´æ¥ä½¿ç”¨ï¼‰æˆ–æ™®é€šæ•°ç»„
                    var firstArg = arguments.length > 0 ? arguments[0] : null;
                    // ä¸å†æå– _itemsï¼Œç›´æ¥ä¼ é€’ firstArgï¼Œè®©æ„é€ å‡½æ•°å¤„ç† _header
                    var instance = new Array2D(firstArg);
                    // å‰©ä½™å‚æ•°ä¼ é€’ç»™å®ä¾‹æ–¹æ³•
                    var restArgs = [];
                    for (var j = 1; j < arguments.length; j++) {
                        restArgs.push(arguments[j]);
                    }
                    var result = instance[methodName].apply(instance, restArgs);
                    // ğŸ”§ v3.7.7 ä¿®å¤: è¿”å› Array2D å¯¹è±¡è€Œé _itemsï¼Œä¿ç•™ _header
                    return result;
                };
            })(name);
        }
    }
})();

// ==================== [RNGUTILS] RangeåŒºåŸŸå·¥å…·åº“ ====================

/**
 * RngUtils - RangeåŒºåŸŸæ“ä½œå·¥å…·ï¼ˆæ”¯æŒæ™ºèƒ½æç¤ºå’Œé“¾å¼è°ƒç”¨ï¼‰
 * @class
 * @constructor
 * @description WPS RangeåŒºåŸŸæ“ä½œå¢å¼ºå·¥å…·
 * @example
 * RngUtils("A1:C10").zåŠ è¾¹æ¡†().zè‡ªåŠ¨åˆ—å®½()
 */
function RngUtils(initialRange) {
    if (!(this instanceof RngUtils)) {
        return new RngUtils(initialRange);
    }
    this._range = initialRange ? this._toRange(initialRange) : null;
}

/**
 * è½¬æ¢ä¸ºRangeå¯¹è±¡
 * @private
 * @param {Range|string} rng - Rangeå¯¹è±¡æˆ–åœ°å€å­—ç¬¦ä¸²
 * @returns {Range|null} Rangeå¯¹è±¡æˆ–null
 */
RngUtils.prototype._toRange = function(rng) {
    if (!rng) return null;
    if (typeof rng === 'string') return isWPS ? Range(rng) : null;
    return rng;
};

/**
 * è·å–/è®¾ç½®Range
 * @param {Range|string} newRange - æ–°Range
 * @returns {RngUtils|Range} è®¾ç½®æ—¶è¿”å›thisï¼Œå¦åˆ™è¿”å›å½“å‰Range
 */
RngUtils.prototype.rng = function(newRange) {
    if (newRange !== undefined) {
        this._range = this._toRange(newRange);
        return this;
    }
    return this._range;
};

/**
 * è·å–å€¼
 * @returns {Array} äºŒç»´æ•°ç»„
 */
RngUtils.prototype.val = function() {
    if (!this._range) return null;
    return this._range.Value2;
};

// ==================== åŸºç¡€ä¿¡æ¯å‡½æ•° ====================

/**
 * zæœ€åä¸€ä¸ª - è·å–æŒ‡å®šåŒºåŸŸçš„æœ€åä¸€ä¸ªå•å…ƒæ ¼
 * @param {Range|string} rng - å•å…ƒæ ¼åŒºåŸŸ
 * @returns {Range} æœ€åä¸€ä¸ªå•å…ƒæ ¼
 * @example
 * RngUtils.zæœ€åä¸€ä¸ª("A1:A13")  // $A$13
 */
RngUtils.zæœ€åä¸€ä¸ª = function(rng) {
    if (!isWPS) return null;
    var r = typeof rng === 'string' ? Range(rng) : rng;
    return r.Cells(r.Rows.Count, r.Columns.Count);
};
RngUtils.lastCell = RngUtils.zæœ€åä¸€ä¸ª;

/**
 * zå®‰å…¨åŒºåŸŸ - è·å–å½“å‰åŒºåŸŸä¸UsedRangeçš„äº¤é›†
 * @param {Range|string} rng - å•å…ƒæ ¼åŒºåŸŸ
 * @returns {Range} äº¤é›†å•å…ƒæ ¼
 * @example
 * RngUtils.zå®‰å…¨åŒºåŸŸ("A:A")  // $A$1:$A$13
 */
RngUtils.zå®‰å…¨åŒºåŸŸ = function(rng) {
    if (!isWPS) return null;
    var r = typeof rng === 'string' ? Range(rng) : rng;
    var sheet = r.Worksheet;
    var usedRange = sheet.UsedRange;
    if (!usedRange) return r;
    return Application.Intersect(r, usedRange);
};
RngUtils.safeRange = RngUtils.zå®‰å…¨åŒºåŸŸ;

/**
 * zå®‰å…¨æ•°ç»„ - å°†æŒ‡å®šåŒºåŸŸè½¬æ¢ä¸ºå®‰å…¨äºŒç»´æ•°ç»„ï¼ˆè¿”å› Array2D å¯¹è±¡ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ï¼‰
 * @param {Range|string} rng - è¦è½¬æ¢çš„åŒºåŸŸ
 * @returns {Array2D} Array2D å¯¹è±¡ï¼Œæ”¯æŒ filter/map/toRange ç­‰é“¾å¼è°ƒç”¨
 * @example
 * RngUtils.zå®‰å…¨æ•°ç»„("A1:A13").filter(row => row[0] > 0).toRange("C1")
 */
RngUtils.zå®‰å…¨æ•°ç»„ = function(rng) {
    if (!isWPS) return new Array2D([]);
    var r = typeof rng === 'string' ? Range(rng) : rng;
    var arr = r.Value2;
    if (arr === null || arr === undefined) return new Array2D([]);
    // å•ä¸ªå•å…ƒæ ¼è½¬äºŒç»´æ•°ç»„
    if (!Array.isArray(arr)) return new Array2D([[arr]]);
    // ä¸€ç»´æ•°ç»„è½¬äºŒç»´
    if (!Array.isArray(arr[0])) {
        var result = [];
        for (var i = 0; i < arr.length; i++) {
            result.push([arr[i]]);
        }
        return new Array2D(result);
    }
    // ğŸ”§ v3.7.5 ä¿å­˜è¡¨å¤´ä¿¡æ¯åˆ° Array2D å¯¹è±¡
    var result = new Array2D(arr);
    if (arr.length > 0) {
        Object.defineProperty(result, '_header', {
            value: arr[0],
            writable: true,
            enumerable: false,
            configurable: true
        });
    }
    return result;
};
RngUtils.safeArray = RngUtils.zå®‰å…¨æ•°ç»„;

/**
 * zæœ€å¤§è¡Œ - è·å–æŒ‡å®šåŒºåŸŸçš„æœ€å¤§è¡Œæ•°
 * @param {Range|string} rng - è¦è·å–æœ€å¤§è¡Œæ•°çš„åŒºåŸŸ
 * @returns {number} æœ€å¤§è¡Œæ•°
 * @example
 * RngUtils.zæœ€å¤§è¡Œ("A:A")     // 70 (å•åˆ—ï¼Œä»ä¸‹å¾€ä¸ŠæŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ•°æ®)
 * RngUtils.zæœ€å¤§è¡Œ("A1")      // 70 (å•å•å…ƒæ ¼ï¼Œè‡ªåŠ¨æ‰©å±•ä¸ºæ•´åˆ—)
 * RngUtils.zæœ€å¤§è¡Œ("A1:C10")  // 10 (å¤šå•å…ƒæ ¼åŒºåŸŸè¿”å›è¯¥åŒºåŸŸçš„æœ€åä¸€è¡Œ)
 */
RngUtils.zæœ€å¤§è¡Œ = function(rng) {
    if (!isWPS) return 0;
    var r = typeof rng === 'string' ? Range(rng) : rng;
    var sheet = r.Worksheet;
    var usedRange = sheet.UsedRange;
    if (!usedRange) return 0;

    // å•å•å…ƒæ ¼æˆ–å•åˆ—æ—¶ï¼Œä»ä¸‹å¾€ä¸ŠæŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ•°æ®
    if (r.Columns.Count === 1) {
        var col = r.Columns.Count === 1 && r.Rows.Count === 1 ? sheet.Columns(r.Column) : r;
        var safe = Application.Intersect(col, usedRange);
        if (!safe) return 0;
        // ä»ä¸‹å¾€ä¸ŠæŸ¥æ‰¾ç¬¬ä¸€ä¸ªéç©ºå•å…ƒæ ¼
        for (var i = safe.Rows.Count; i >= 1; i--) {
            var cell = safe.Cells(i, 1);
            var val = cell.Value2;
            // è·³è¿‡ nullã€undefinedã€ç©ºå­—ç¬¦ä¸²ï¼ˆåŒ…æ‹¬ =""ï¼‰
            if (val === null || val === undefined || val === '') {
                continue;
            }
            // è·³è¿‡çº¯ç©ºç™½å­—ç¬¦
            if (typeof val === 'string' && val.trim() === '') {
                continue;
            }
            // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ•°æ®ï¼Œè¿”å›è¡Œå·
            return safe.Row + i - 1;
        }
        return 0;
    }

    // å¤šåˆ—åŒºåŸŸï¼Œè¿”å›è¯¥åŒºåŸŸä¸UsedRangeäº¤é›†çš„æœ€åä¸€è¡Œ
    var safe = Application.Intersect(r, usedRange);
    if (!safe) return 0;
    return safe.Row + safe.Rows.Count - 1;
};
RngUtils.endRow = RngUtils.zæœ€å¤§è¡Œ;

/**
 * zæœ€å¤§è¡Œå•å…ƒæ ¼ - è·å–æŒ‡å®šåŒºåŸŸæœ€åä¸€è¡Œçš„å•å…ƒæ ¼
 * @param {Range|string} rng - è¦è·å–çš„åŒºåŸŸ
 * @returns {Range} æœ€åä¸€è¡Œçš„å•å…ƒæ ¼
 * @example
 * RngUtils.zæœ€å¤§è¡Œå•å…ƒæ ¼("A1:A1000")  // $A$13
 */
RngUtils.zæœ€å¤§è¡Œå•å…ƒæ ¼ = function(rng) {
    if (!isWPS) return null;
    var r = typeof rng === 'string' ? Range(rng) : rng;
    var sheet = r.Worksheet;
    var maxRow = RngUtils.zæœ€å¤§è¡Œ(r);
    var col = r.Column;
    return sheet.Cells(maxRow, col);
};
RngUtils.endRowCell = RngUtils.zæœ€å¤§è¡Œå•å…ƒæ ¼;

/**
 * zæœ€å¤§è¡ŒåŒºåŸŸ - è·å–ä»ç¬¬ä¸€è¡Œåˆ°æœ€åä¸€è¡Œçš„åŒºåŸŸ
 * @param {Range|string} rng - è¦è·å–çš„åŒºåŸŸ
 * @param {string} [col="A"] - åˆ—å·ï¼Œå¦‚æœrngæ˜¯æ•´è¡Œæ—¶éœ€è¦æŒ‡å®š
 * @returns {Range} ä»ç¬¬ä¸€è¡Œåˆ°æœ€åä¸€è¡Œçš„åŒºåŸŸ
 * @example
 * RngUtils.zæœ€å¤§è¡ŒåŒºåŸŸ("1:1000","A")  // $1:$13
 * RngUtils.zæœ€å¤§è¡ŒåŒºåŸŸ("A1:J1")       // A1:Jæœ€å¤§è¡Œ
 */
RngUtils.zæœ€å¤§è¡ŒåŒºåŸŸ = function(rng, col) {
    if (!isWPS) return null;
    col = col !== undefined ? col : "A";
    var r = typeof rng === 'string' ? Range(rng) : rng;
    var sheet = r.Worksheet;

    // ç‰¹æ®Šå‚æ•°å¤„ç†
    if (col === '-c') {
        // CurrentRegion
        return r.CurrentRegion;
    }
    if (col === '-u') {
        // UsedRange
        var used = sheet.UsedRange;
        if (!used) return r;
        var startRow = r.Row;
        var endRow = used.Row + used.Rows.Count - 1;
        var startCol = r.Column;
        var endCol = r.Column + r.Columns.Count - 1;
        return sheet.Range(sheet.Cells(startRow, startCol), sheet.Cells(endRow, endCol));
    }

    // æ•´è¡Œå¤„ç† - å½“rngæ˜¯æ•´è¡Œæ—¶ï¼ˆå¦‚ "1:1000"ï¼‰
    if (r.Rows.Count >= 16384) {
        var colNum = typeof col === 'string' ? (col.charCodeAt(0) - 64) : (col || 1);
        var maxR = RngUtils.zæœ€å¤§è¡Œ(sheet.Columns(colNum));
        return sheet.Range(sheet.Cells(1, colNum), sheet.Cells(maxR, colNum)).EntireRow;
    }

    // é»˜è®¤æƒ…å†µ - ä¿æŒåŸåŒºåŸŸçš„åˆ—èŒƒå›´ï¼Œæ‰©å±•è¡Œåˆ°æœ€åä¸€è¡Œ
    // éœ€è¦æ‰¾å‡ºèŒƒå›´å†…æ‰€æœ‰åˆ—çš„æœ€å¤§ä½¿ç”¨è¡Œæ•°
    var startRow = r.Row;
    var startCol = r.Column;
    var endCol = r.Column + r.Columns.Count - 1;

    // éå†æ¯ä¸€åˆ—ï¼Œæ‰¾å‡ºæœ€å¤§ä½¿ç”¨è¡Œæ•°
    var maxEndRow = startRow;
    for (var c = startCol; c <= endCol; c++) {
        var colRange = sheet.Columns(c);
        var endRow = RngUtils.zæœ€å¤§è¡Œ(colRange);
        if (endRow > maxEndRow) {
            maxEndRow = endRow;
        }
    }

    return sheet.Range(sheet.Cells(startRow, startCol), sheet.Cells(maxEndRow, endCol));
};

/**
 * maxRange - è·å–ä»ç¬¬ä¸€è¡Œåˆ°æœ€åä¸€è¡Œçš„åŒºåŸŸï¼ˆè‹±æ–‡åˆ«åï¼‰
 * @static
 * @param {Range|string} rng - è¦è·å–çš„åŒºåŸŸ
 * @param {string} [col="A"] - åˆ—å·ï¼Œå¦‚æœrngæ˜¯æ•´è¡Œæ—¶éœ€è¦æŒ‡å®š
 * @returns {Range} ä»ç¬¬ä¸€è¡Œåˆ°æœ€åä¸€è¡Œçš„åŒºåŸŸ
 * @example
 * RngUtils.maxRange("1:1000","A")  // $1:$13
 * RngUtils.maxRange("A1:J1")       // A1:Jæœ€å¤§è¡Œ
 */
/**
 * maxRange - è·å–ä»ç¬¬ä¸€è¡Œåˆ°æœ€åä¸€è¡Œçš„åŒºåŸŸï¼ˆè‹±æ–‡åˆ«åï¼Œè¿”å› RangeChain æ”¯æŒæ™ºèƒ½æç¤ºï¼‰
 * @static
 * @param {Range|string} rng - è¦è·å–çš„åŒºåŸŸ
 * @param {string} [col="A"] - åˆ—å·ï¼Œå¦‚æœrngæ˜¯æ•´è¡Œæ—¶éœ€è¦æŒ‡å®š
 * @returns {RangeChain} ä»ç¬¬ä¸€è¡Œåˆ°æœ€åä¸€è¡Œçš„åŒºåŸŸï¼ˆæ”¯æŒé“¾å¼è°ƒç”¨å’Œæ™ºèƒ½æç¤ºï¼‰
 * @example
 * RngUtils.maxRange("1:1000","A").safeArray()  // è¿”å›æ•°ç»„
 * RngUtils.maxRange("A1:J1").zåŠ è¾¹æ¡†()         // é“¾å¼è°ƒç”¨
 */
RngUtils.maxRange = function(rng, col) {
    var result = RngUtils.zæœ€å¤§è¡ŒåŒºåŸŸ.apply(RngUtils, arguments);
    if (result && result.Address && typeof result.Address === 'function') {
        return new RangeChain(result);
    }
    return result;
};

/**
 * zæœ€å¤§åˆ— - è·å–æŒ‡å®šåŒºåŸŸçš„æœ€å¤§åˆ—æ•°
 * @param {Range|string} rng - è¦è·å–æœ€å¤§åˆ—æ•°çš„åŒºåŸŸ
 * @returns {number} æœ€å¤§åˆ—æ•°
 * @example
 * RngUtils.zæœ€å¤§åˆ—("1:1")     // 8 (å•è¡Œï¼Œä»å³å¾€å·¦æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ•°æ®)
 * RngUtils.zæœ€å¤§åˆ—("A1")      // 8 (å•å•å…ƒæ ¼ï¼Œè‡ªåŠ¨æ‰©å±•ä¸ºæ•´è¡Œ)
 * RngUtils.zæœ€å¤§åˆ—("A1:C10")  // 3 (å¤šè¡ŒåŒºåŸŸè¿”å›è¯¥åŒºåŸŸçš„æœ€åä¸€åˆ—)
 */
RngUtils.zæœ€å¤§åˆ— = function(rng) {
    if (!isWPS) return 0;
    var r = typeof rng === 'string' ? Range(rng) : rng;
    var sheet = r.Worksheet;
    var usedRange = sheet.UsedRange;
    if (!usedRange) return 0;

    // å•å•å…ƒæ ¼æˆ–å•è¡Œæ—¶ï¼Œä»å³å¾€å·¦æŸ¥æ‰¾ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ•°æ®
    if (r.Rows.Count === 1) {
        var row = r.Rows.Count === 1 && r.Columns.Count === 1 ? sheet.Rows(r.Row) : r;
        var safe = Application.Intersect(row, usedRange);
        if (!safe) return 0;
        // ä»å³å¾€å·¦æŸ¥æ‰¾ç¬¬ä¸€ä¸ªéç©ºå•å…ƒæ ¼
        for (var i = safe.Columns.Count; i >= 1; i--) {
            var cell = safe.Cells(1, i);
            var val = cell.Value2;
            // è·³è¿‡ nullã€undefinedã€ç©ºå­—ç¬¦ä¸²ï¼ˆåŒ…æ‹¬ =""ï¼‰
            if (val === null || val === undefined || val === '') {
                continue;
            }
            // è·³è¿‡çº¯ç©ºç™½å­—ç¬¦
            if (typeof val === 'string' && val.trim() === '') {
                continue;
            }
            // æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœ‰æ•ˆæ•°æ®ï¼Œè¿”å›åˆ—å·
            return safe.Column + i - 1;
        }
        return 0;
    }

    // å¤šè¡ŒåŒºåŸŸï¼Œè¿”å›è¯¥åŒºåŸŸä¸UsedRangeäº¤é›†çš„æœ€åä¸€åˆ—
    var safe = Application.Intersect(r, usedRange);
    if (!safe) return 0;
    return safe.Column + safe.Columns.Count - 1;
};
RngUtils.endCol = RngUtils.zæœ€å¤§åˆ—;

/**
 * zæœ€å¤§åˆ—å•å…ƒæ ¼ - è·å–æŒ‡å®šåŒºåŸŸæœ€åä¸€åˆ—çš„å•å…ƒæ ¼
 * @param {Range|string} rng - è¦è·å–çš„åŒºåŸŸ
 * @returns {Range} æœ€åä¸€åˆ—çš„å•å…ƒæ ¼
 * @example
 * RngUtils.zæœ€å¤§åˆ—å•å…ƒæ ¼("1:1")  // $F$1
 */
RngUtils.zæœ€å¤§åˆ—å•å…ƒæ ¼ = function(rng) {
    if (!isWPS) return null;
    var r = typeof rng === 'string' ? Range(rng) : rng;
    var sheet = r.Worksheet;
    var maxCol = RngUtils.zæœ€å¤§åˆ—(r);
    return sheet.Cells(r.Row, maxCol);
};
RngUtils.endColCell = RngUtils.zæœ€å¤§åˆ—å•å…ƒæ ¼;

/**
 * zå¯è§åŒºæ•°ç»„ - å°†å¯è§å•å…ƒæ ¼è½¬æ¢ä¸ºæ•°ç»„
 * @param {Range|string} rng - è¦è½¬æ¢çš„åŒºåŸŸ
 * @param {Worksheet} [tempSheet] - ä¸´æ—¶å·¥ä½œè¡¨ï¼ˆå¯é€‰ï¼‰
 * @returns {Array} å¯è§å•å…ƒæ ¼å€¼çš„æ•°ç»„
 * @example
 * RngUtils.zå¯è§åŒºæ•°ç»„("1:4")
 */
RngUtils.zå¯è§åŒºæ•°ç»„ = function(rng, tempSheet) {
    if (!isWPS) return [];
    var r = typeof rng === 'string' ? Range(rng) : rng;
    var visible = r.SpecialCells(12); // xlCellTypeVisible
    if (!visible) return [];
    var arr = visible.Value2;
    // ä¿å­˜åˆ°ä¸´æ—¶è¡¨
    if (tempSheet) {
        tempSheet.Range("A1").Resize(visible.Rows.Count, visible.Columns.Count).Value2 = arr;
    }
    return RngUtils.zå®‰å…¨æ•°ç»„(arr);
};
RngUtils.visibleArray = RngUtils.zå¯è§åŒºæ•°ç»„;

/**
 * zå¯è§åŒºåŸŸ - è·å–æŒ‡å®šåŒºåŸŸçš„å¯è§åŒºåŸŸ
 * @param {Range|string} rng - è¦è·å–çš„åŒºåŸŸ
 * @returns {Range} å¯è§åŒºåŸŸ
 * @example
 * RngUtils.zå¯è§åŒºåŸŸ("1:4")  // $1:$4
 */
RngUtils.zå¯è§åŒºåŸŸ = function(rng) {
    if (!isWPS) return null;
    var r = typeof rng === 'string' ? Range(rng) : rng;
    return r.SpecialCells(12); // xlCellTypeVisible
};
RngUtils.visibleRange = RngUtils.zå¯è§åŒºåŸŸ;

/**
 * zåŠ è¾¹æ¡† - ä¸ºæŒ‡å®šåŒºåŸŸæ·»åŠ è¾¹æ¡†
 * @param {Range|string} rng - è¦æ·»åŠ è¾¹æ¡†çš„åŒºåŸŸ
 * @param {number} [LineStyle=1] - è¾¹æ¡†çº¿æ¡æ ·å¼
 * @param {number} [Weight=2] - è¾¹æ¡†çº¿æ¡ç²—ç»†
 * @returns {Borders} è¾¹æ¡†å¯¹è±¡
 * @example
 * RngUtils.zåŠ è¾¹æ¡†("A3:D7")
 */
RngUtils.zåŠ è¾¹æ¡† = function(rng, LineStyle, Weight) {
    if (!isWPS) return null;
    var r = typeof rng === 'string' ? Range(rng) : rng;
    LineStyle = LineStyle !== undefined ? LineStyle : 1;
    Weight = Weight !== undefined ? Weight : 2;
    r.Borders.LineStyle = LineStyle;
    r.Borders.Weight = Weight;
    return r.Borders;
};
RngUtils.addBorders = RngUtils.zåŠ è¾¹æ¡†;

/**
 * zå–å‰å‡ è¡Œ - è·å–æŒ‡å®šåŒºåŸŸçš„å‰å‡ è¡Œ
 * @param {Range|string} rng - æŒ‡å®šåŒºåŸŸ
 * @param {number} count - è·å–çš„è¡Œæ•°
 * @returns {Range} å‰å‡ è¡Œçš„å•å…ƒæ ¼
 * @example
 * RngUtils.zå–å‰å‡ è¡Œ("a3:d7",3)  // $A$3:$D$5
 */
RngUtils.zå–å‰å‡ è¡Œ = function(rng, count) {
    if (!isWPS) return null;
    var r = typeof rng === 'string' ? Range(rng) : rng;
    return r.Rows("1:" + count);
};
RngUtils.takeRows = RngUtils.zå–å‰å‡ è¡Œ;

/**
 * zè·³è¿‡å‰å‡ è¡Œ - è·³è¿‡æŒ‡å®šåŒºåŸŸçš„å‰å‡ è¡Œ
 * @param {Range|string} rng - æŒ‡å®šåŒºåŸŸ
 * @param {number} count - è¦è·³è¿‡çš„è¡Œæ•°
 * @returns {Range} è·³è¿‡åçš„å•å…ƒæ ¼åŒºåŸŸ
 * @example
 * RngUtils.zè·³è¿‡å‰å‡ è¡Œ("a3:d7",3)  // $A$6:$D$7
 */
RngUtils.zè·³è¿‡å‰å‡ è¡Œ = function(rng, count) {
    if (!isWPS) return null;
    var r = typeof rng === 'string' ? Range(rng) : rng;
    var startRow = count + 1;
    var endRow = r.Rows.Count;
    if (startRow > endRow) return null;
    return r.Rows(startRow + ":" + endRow);
};
RngUtils.skipRows = RngUtils.zè·³è¿‡å‰å‡ è¡Œ;

/**
 * zæ’å…¥å¤šè¡Œ - æ’å…¥å¤šè¡Œ
 * @param {Range|string} rng - è¦æ’å…¥è¡Œçš„å•å…ƒæ ¼åŒºåŸŸ
 * @param {any} value - è¡Œå·æ•°ç»„æˆ–å­—ç¬¦ä¸²
 * @param {number} count - è¦æ’å…¥çš„è¡Œæ•°
 * @example
 * RngUtils.zæ’å…¥å¤šè¡Œ("a12:d15", '*', 2)
 */
RngUtils.zæ’å…¥å¤šè¡Œ = function(rng, value, count) {
    if (!isWPS) return;
    var r = typeof rng === 'string' ? Range(rng) : rng;
    count = count || 1;

    for (var i = r.Rows.Count; i >= 1; i--) {
        var insertValue = value;
        if (Array.isArray(value)) {
            insertValue = value[i - 1] !== undefined ? value[i - 1] : '';
        }
        for (var c = 0; c < count; c++) {
            r.Rows(i).Insert();
            var newRow = r.Rows(i);
            for (var j = 1; j <= r.Columns.Count; j++) {
                newRow.Cells(1, j).Value2 = insertValue;
            }
        }
    }
};
RngUtils.insertRows = RngUtils.zæ’å…¥å¤šè¡Œ;

/**
 * zæ’å…¥å¤šåˆ— - æ’å…¥å¤šåˆ—
 * @param {Range|string} rng - è¦æ’å…¥åˆ—çš„å•å…ƒæ ¼åŒºåŸŸ
 * @param {any} value - åˆ—å·æ•°ç»„æˆ–å­—ç¬¦ä¸²
 * @param {number} count - è¦æ’å…¥çš„åˆ—æ•°
 * @example
 * RngUtils.zæ’å…¥å¤šåˆ—("a12:d14", '*', 2)
 */
RngUtils.zæ’å…¥å¤šåˆ— = function(rng, value, count) {
    if (!isWPS) return;
    var r = typeof rng === 'string' ? Range(rng) : rng;
    count = count || 1;

    for (var j = r.Columns.Count; j >= 1; j--) {
        var insertValue = value;
        if (Array.isArray(value)) {
            insertValue = value[j - 1] !== undefined ? value[j - 1][0] : '';
        }
        for (var c = 0; c < count; c++) {
            r.Columns(j).Insert();
            var newCol = r.Columns(j);
            for (var i = 1; i <= r.Rows.Count; i++) {
                newCol.Cells(i, 1).Value2 = insertValue;
            }
        }
    }
};
RngUtils.insertCols = RngUtils.zæ’å…¥å¤šåˆ—;

/**
 * zåˆ é™¤ç©ºç™½è¡Œ - åˆ é™¤æŒ‡å®šåŒºåŸŸä¸­çš„ç©ºç™½è¡Œ
 * @param {Range|string} rng - è¦åˆ é™¤ç©ºç™½è¡Œçš„å•å…ƒæ ¼åŒºåŸŸ
 * @param {boolean} [entireColumn=true] - é»˜è®¤åˆ é™¤æ•´åˆ— falseæ—¶åªä½œç”¨é€‰ä¸­åŒºåŸŸ
 * @example
 * RngUtils.zåˆ é™¤ç©ºç™½è¡Œ("a11:d17")
 */
RngUtils.zåˆ é™¤ç©ºç™½è¡Œ = function(rng, entireColumn) {
    if (!isWPS) return;
    entireColumn = entireColumn !== undefined ? entireColumn : true;
    var r = typeof rng === 'string' ? Range(rng) : rng;

    var blankRows = [];
    for (var i = r.Rows.Count; i >= 1; i--) {
        var row = r.Rows(i);
        var isEmpty = true;
        for (var j = 1; j <= r.Columns.Count; j++) {
            var val = row.Cells(1, j).Value2;
            if (val !== null && val !== undefined && val !== '') {
                isEmpty = false;
                break;
            }
        }
        if (isEmpty) {
            blankRows.push(i);
        }
    }

    for (var k = 0; k < blankRows.length; k++) {
        if (entireColumn) {
            r.Rows(blankRows[k]).EntireRow.Delete();
        } else {
            r.Rows(blankRows[k]).Delete();
        }
    }
};
RngUtils.delBlankRows = RngUtils.zåˆ é™¤ç©ºç™½è¡Œ;

/**
 * zåˆ é™¤ç©ºç™½åˆ— - åˆ é™¤æŒ‡å®šåŒºåŸŸä¸­çš„ç©ºç™½åˆ—
 * @param {Range|string} rng - è¦åˆ é™¤ç©ºç™½åˆ—çš„å•å…ƒæ ¼åŒºåŸŸ
 * @param {boolean} [entireColumn=true] - é»˜è®¤åˆ é™¤æ•´åˆ— falseæ—¶åªä½œç”¨é€‰ä¸­åŒºåŸŸ
 * @example
 * RngUtils.zåˆ é™¤ç©ºç™½åˆ—("A11:G14")
 */
RngUtils.zåˆ é™¤ç©ºç™½åˆ— = function(rng, entireColumn) {
    if (!isWPS) return;
    entireColumn = entireColumn !== undefined ? entireColumn : true;
    var r = typeof rng === 'string' ? Range(rng) : rng;

    var blankCols = [];
    for (var j = r.Columns.Count; j >= 1; j--) {
        var col = r.Columns(j);
        var isEmpty = true;
        for (var i = 1; i <= r.Rows.Count; i++) {
            var val = col.Cells(i, 1).Value2;
            if (val !== null && val !== undefined && val !== '') {
                isEmpty = false;
                break;
            }
        }
        if (isEmpty) {
            blankCols.push(j);
        }
    }

    for (var k = 0; k < blankCols.length; k++) {
        if (entireColumn) {
            r.Columns(blankCols[k]).EntireColumn.Delete();
        } else {
            r.Columns(blankCols[k]).Delete();
        }
    }
};
RngUtils.delBlankCols = RngUtils.zåˆ é™¤ç©ºç™½åˆ—;

/**
 * zæ•´è¡Œ - è·å–æŒ‡å®šå•å…ƒæ ¼åŒºåŸŸçš„æ•´è¡Œ
 * @param {Range|string} rng - è¦è·å–æ•´è¡Œçš„å•å…ƒæ ¼åŒºåŸŸ
 * @returns {Range} æ•´è¡Œå•å…ƒæ ¼
 * @example
 * RngUtils.zæ•´è¡Œ("11:14")  // $11:$14
 */
RngUtils.zæ•´è¡Œ = function(rng) {
    if (!isWPS) return null;
    var r = typeof rng === 'string' ? Range(rng) : rng;
    return r.EntireRow;
};
RngUtils.entireRow = RngUtils.zæ•´è¡Œ;

/**
 * zæ•´åˆ— - è·å–æŒ‡å®šå•å…ƒæ ¼åŒºåŸŸçš„æ•´åˆ—
 * @param {Range|string} rng - è¦è·å–æ•´åˆ—çš„å•å…ƒæ ¼åŒºåŸŸ
 * @returns {Range} æ•´åˆ—å•å…ƒæ ¼
 * @example
 * RngUtils.zæ•´åˆ—("A:B")  // $A:$B
 */
RngUtils.zæ•´åˆ— = function(rng) {
    if (!isWPS) return null;
    var r = typeof rng === 'string' ? Range(rng) : rng;
    return r.EntireColumn;
};
RngUtils.entire_column = RngUtils.zæ•´åˆ—;

/**
 * zè¡Œæ•° - è·å–æŒ‡å®šå•å…ƒæ ¼åŒºåŸŸçš„è¡Œæ•°
 * @param {Range|string} rng - è¦è·å–è¡Œæ•°çš„å•å…ƒæ ¼åŒºåŸŸ
 * @returns {number} è¡Œæ•°
 * @example
 * RngUtils.zè¡Œæ•°("A12:D15")  // 4
 */
RngUtils.zè¡Œæ•° = function(rng) {
    if (!isWPS) return 0;
    var r = typeof rng === 'string' ? Range(rng) : rng;
    return r.Rows.Count;
};
RngUtils.rowsCount = RngUtils.zè¡Œæ•°;

/**
 * zåˆ—æ•° - è·å–æŒ‡å®šå•å…ƒæ ¼åŒºåŸŸçš„åˆ—æ•°
 * @param {Range|string} rng - è¦è·å–åˆ—æ•°çš„å•å…ƒæ ¼åŒºåŸŸ
 * @returns {number} åˆ—æ•°
 * @example
 * RngUtils.zåˆ—æ•°("A12:C15")  // 3
 */
RngUtils.zåˆ—æ•° = function(rng) {
    if (!isWPS) return 0;
    var r = typeof rng === 'string' ? Range(rng) : rng;
    return r.Columns.Count;
};
RngUtils.colsCount = RngUtils.zåˆ—æ•°;

/**
 * zåˆ—å·å­—æ¯äº’è½¬ - å°†æ•°å­—åˆ—å·è½¬æ¢ä¸ºå­—æ¯è¡¨ç¤º
 * @param {number} c - è¦è½¬æ¢çš„æ•°å­—åˆ—å·
 * @returns {string} åˆ—å·çš„å­—æ¯è¡¨ç¤º
 * @example
 * RngUtils.zåˆ—å·å­—æ¯äº’è½¬(3)  // "C"
 */
RngUtils.zåˆ—å·å­—æ¯äº’è½¬ = function(c) {
    var result = '';
    while (c > 0) {
        c--;
        result = String.fromCharCode(65 + (c % 26)) + result;
        c = Math.floor(c / 26);
    }
    return result;
};
RngUtils.colToAbc = RngUtils.zåˆ—å·å­—æ¯äº’è½¬;

/**
 * zå¤åˆ¶ç²˜è´´æ ¼å¼ - å¤åˆ¶ç²˜è´´æ ¼å¼åˆ°ç›®æ ‡åŒºåŸŸ
 * @param {Range|string} rng - æºå•å…ƒæ ¼åŒºåŸŸ
 * @param {Range|string} target - ç›®æ ‡å•å…ƒæ ¼åŒºåŸŸ
 * @example
 * RngUtils.zå¤åˆ¶ç²˜è´´æ ¼å¼("a14:d14","a18:d21")
 */
RngUtils.zå¤åˆ¶ç²˜è´´æ ¼å¼ = function(rng, target) {
    if (!isWPS) return;
    var src = typeof rng === 'string' ? Range(rng) : rng;
    var dest = typeof target === 'string' ? Range(target) : target;
    src.Copy();
    dest.PasteSpecial(-4122); // xlPasteFormats
    Application.CutCopyMode = false;
};
RngUtils.copyFormat = RngUtils.zå¤åˆ¶ç²˜è´´æ ¼å¼;

/**
 * zå¤åˆ¶ç²˜è´´å€¼ - å¤åˆ¶ç²˜è´´å€¼åˆ°ç›®æ ‡åŒºåŸŸ
 * @param {Range|string} rng - æºå•å…ƒæ ¼åŒºåŸŸ
 * @param {Range|string} target - ç›®æ ‡å•å…ƒæ ¼åŒºåŸŸ
 * @example
 * RngUtils.zå¤åˆ¶ç²˜è´´å€¼("a11:d14","a18:d21")
 */
RngUtils.zå¤åˆ¶ç²˜è´´å€¼ = function(rng, target) {
    if (!isWPS) return;
    var src = typeof rng === 'string' ? Range(rng) : rng;
    var dest = typeof target === 'string' ? Range(target) : target;
    src.Copy();
    dest.PasteSpecial(-4163); // xlPasteValues
    Application.CutCopyMode = false;
};
RngUtils.copyValue = RngUtils.zå¤åˆ¶ç²˜è´´å€¼;

/**
 * zè”åˆåŒºåŸŸ - å¯¹å­—ç¬¦ä¸²åœ°å€æˆ–å•å…ƒæ ¼æ•°ç»„è”åˆæˆä¸€ä¸ªå•å…ƒæ ¼åŒºåŸŸ
 * @param {any} rng - å•å…ƒæ ¼åœ°å€æˆ–å•å…ƒæ ¼æ•°ç»„
 * @param {Sheet} [op_sht] - å·¥ä½œè¡¨å¯¹è±¡ï¼Œè·¨è¡¨æ—¶æŒ‡å®š
 * @returns {Range} ç»„åˆåçš„å•å…ƒæ ¼å¯¹è±¡
 * @example
 * RngUtils.zè”åˆåŒºåŸŸ('a1,a2,B4:C10').Address()
 */
RngUtils.zè”åˆåŒºåŸŸ = function(rng, op_sht) {
    if (!isWPS) return null;
    var sheet = op_sht || Application.ActiveSheet;

    if (typeof rng === 'string') {
        // è§£æåœ°å€å­—ç¬¦ä¸²
        var parts = rng.split(',');
        var ranges = [];
        for (var i = 0; i < parts.length; i++) {
            ranges.push(sheet.Range(parts[i].trim()));
        }
        if (ranges.length === 1) return ranges[0];
        return sheet.Union(ranges[0], ranges[1]);
    }

    if (Array.isArray(rng)) {
        if (rng.length === 0) return null;
        if (rng.length === 1) return rng[0];
        return sheet.Union(rng[0], rng[1]);
    }

    return rng;
};
RngUtils.unionAll = RngUtils.zè”åˆåŒºåŸŸ;

/**
 * zå¤šåˆ—æ’åº - å•å…ƒæ ¼å¤šåˆ—æ’åº
 * @param {Range|string} rng - å¾…æ’åºçš„å•å…ƒæ ¼èŒƒå›´
 * @param {string} sortParams - æ’åºå‚æ•° 'f3+,f4-' è¡¨ç¤ºç¬¬3åˆ—å‡åºç¬¬4åˆ—é™åº
 * @param {number} [headerRows=1] - è¡¨å¤´çš„è¡Œæ•°
 * @param {string} [customOrder] - è‡ªå®šä¹‰åºåˆ—
 * @example
 * RngUtils.zå¤šåˆ—æ’åº("A18:D24",'f3+,f4-',1)
 */
RngUtils.zå¤šåˆ—æ’åº = function(rng, sortParams, headerRows, customOrder) {
    if (!isWPS) return;
    var r = typeof rng === 'string' ? Range(rng) : rng;
    headerRows = headerRows || 1;

    // è§£ææ’åºå‚æ•°
    var sorts = [];
    var parts = sortParams.split(',');
    for (var i = 0; i < parts.length; i++) {
        var part = parts[i].trim();
        var match = part.match(/f?(\d+)([+-])/);
        if (match) {
            sorts.push({
                col: parseInt(match[1]),
                order: match[2] === '+' ? 1 : 2 // 1å‡åº 2é™åº
            });
        }
    }

    // è·å–æ•°æ®æ•°ç»„
    var arr = RngUtils.zå®‰å…¨æ•°ç»„(r);
    if (arr.length <= headerRows) return;

    // åˆ†ç¦»è¡¨å¤´å’Œæ•°æ®
    var header = arr.slice(0, headerRows);
    var data = arr.slice(headerRows);

    // æ’åº
    data.sort(function(a, b) {
        for (var s = 0; s < sorts.length; s++) {
            var sort = sorts[s];
            var colIdx = sort.col - 1;
            var valA = a[colIdx];
            var valB = b[colIdx];

            // è‡ªå®šä¹‰åºåˆ—å¤„ç†
            if (customOrder) {
                var orderArr = customOrder.split(',');
                var idxA = orderArr.indexOf(String(valA));
                var idxB = orderArr.indexOf(String(valB));
                if (idxA >= 0 && idxB >= 0) {
                    valA = idxA;
                    valB = idxB;
                }
            }

            if (valA < valB) return sort.order === 1 ? -1 : 1;
            if (valA > valB) return sort.order === 1 ? 1 : -1;
        }
        return 0;
    });

    // å†™å›
    r.Value2 = header.concat(data);
};
RngUtils.rngSortCols = RngUtils.zå¤šåˆ—æ’åº;

/**
 * zåˆå¹¶å•å…ƒæ ¼ - åˆå¹¶æŒ‡å®šåŒºåŸŸ
 *
 * ã€åŠŸèƒ½è¯´æ˜ã€‘å°†æŒ‡å®šçš„å•å…ƒæ ¼åŒºåŸŸåˆå¹¶ä¸ºä¸€ä¸ªå•å…ƒæ ¼ï¼Œåˆå¹¶åå·¦ä¸Šè§’å•å…ƒæ ¼çš„å€¼ä¿ç•™
 *
 * ã€æŠ€æœ¯å®ç°ã€‘
 * 1. ç¯å¢ƒæ£€æµ‹ï¼šæ£€æŸ¥æ˜¯å¦åœ¨WPSç¯å¢ƒä¸­è¿è¡Œ
 * 2. å‚æ•°è½¬æ¢ï¼šæ”¯æŒå­—ç¬¦ä¸²åœ°å€ï¼ˆ"A1:B2"ï¼‰æˆ– Range å¯¹è±¡
 * 3. è°ƒç”¨åŸç”ŸAPIï¼šä½¿ç”¨ WPS çš„ Range.Merge() æ–¹æ³•æ‰§è¡Œåˆå¹¶
 * 4. è¿”å›ç»“æœï¼šè¿”å›åˆå¹¶åçš„ Range å¯¹è±¡ï¼Œä¾¿äºé“¾å¼è°ƒç”¨
 *
 * ã€ä½¿ç”¨åœºæ™¯ã€‘
 * - åˆ›å»ºè¡¨å¤´åˆå¹¶å•å…ƒæ ¼ï¼ˆå¦‚å¤šçº§è¡¨å¤´ï¼‰
 * - æ ‡é¢˜å±…ä¸­æ˜¾ç¤º
 * - æ•°æ®é€è§†è¡¨çš„åˆ†ç»„æ ‡é¢˜
 *
 * @param {Range|string} rng - è¦åˆå¹¶çš„åŒºåŸŸï¼Œå¯ä»¥æ˜¯åœ°å€å­—ç¬¦ä¸²æˆ–Rangeå¯¹è±¡
 * @returns {Range} åˆå¹¶åçš„åŒºåŸŸå¯¹è±¡
 *
 * @example
 * // ç¤ºä¾‹1ï¼šåˆå¹¶æ ‡é¢˜è¡Œ
 * RngUtils.zåˆå¹¶å•å…ƒæ ¼("A1:D1");
 *
 * // ç¤ºä¾‹2ï¼šä½¿ç”¨è‹±æ–‡æ–¹æ³•å
 * RngUtils.mergeCells("A1:C3");
 *
 * // ç¤ºä¾‹3ï¼šé“¾å¼è°ƒç”¨
 * RngUtils.zåˆå¹¶å•å…ƒæ ¼("A1:B2").zåŠ è¾¹æ¡†();
 *
 * // ç¤ºä¾‹4ï¼šå…¨å±€å¿«æ·æ–¹å¼ï¼ˆæ¨èï¼‰
 * $.mergeCells("A1:D1");
 */
RngUtils.zåˆå¹¶å•å…ƒæ ¼ = function(rng) {
    // ç¯å¢ƒæ£€æµ‹ï¼šéWPSç¯å¢ƒç›´æ¥è¿”å›null
    if (!isWPS) return null;

    // å‚æ•°è½¬æ¢ï¼šå­—ç¬¦ä¸²åœ°å€è½¬ä¸ºRangeå¯¹è±¡
    var r = typeof rng === 'string' ? Range(rng) : rng;

    // è°ƒç”¨WPSåŸç”ŸAPIæ‰§è¡Œåˆå¹¶
    r.Merge();

    // è¿”å›Rangeå¯¹è±¡ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨
    return r;
};
// è‹±æ–‡åˆ«åï¼šæ”¯æŒä¸­è‹±æ–‡åŒè¯­è°ƒç”¨
RngUtils.mergeCells = RngUtils.zåˆå¹¶å•å…ƒæ ¼;

/**
 * zå–æ¶ˆåˆå¹¶å•å…ƒæ ¼ - å–æ¶ˆæŒ‡å®šåŒºåŸŸçš„åˆå¹¶
 *
 * ã€åŠŸèƒ½è¯´æ˜ã€‘å°†å·²åˆå¹¶çš„å•å…ƒæ ¼åŒºåŸŸæ‹†åˆ†ä¸ºç‹¬ç«‹çš„å•å…ƒæ ¼
 *
 * ã€æŠ€æœ¯å®ç°ã€‘
 * 1. ç¯å¢ƒæ£€æµ‹ï¼šæ£€æŸ¥æ˜¯å¦åœ¨WPSç¯å¢ƒä¸­è¿è¡Œ
 * 2. å‚æ•°è½¬æ¢ï¼šæ”¯æŒå­—ç¬¦ä¸²åœ°å€ï¼ˆ"A1:B2"ï¼‰æˆ– Range å¯¹è±¡
 * 3. è°ƒç”¨åŸç”ŸAPIï¼šä½¿ç”¨ WPS çš„ Range.UnMerge() æ–¹æ³•å–æ¶ˆåˆå¹¶
 * 4. è¿”å›ç»“æœï¼šè¿”å›å–æ¶ˆåˆå¹¶åçš„ Range å¯¹è±¡
 *
 * ã€ä½¿ç”¨åœºæ™¯ã€‘
 * - é‡æ–°å¸ƒå±€æ•°æ®ç»“æ„
 * - æ‰¹é‡å¤„ç†å‰å–æ¶ˆåˆå¹¶
 * - æ•°æ®å¯¼å…¥å‰çš„é¢„å¤„ç†
 *
 * @param {Range|string} rng - è¦å–æ¶ˆåˆå¹¶çš„åŒºåŸŸï¼Œå¯ä»¥æ˜¯åœ°å€å­—ç¬¦ä¸²æˆ–Rangeå¯¹è±¡
 * @returns {Range} å–æ¶ˆåˆå¹¶åçš„åŒºåŸŸå¯¹è±¡
 *
 * @example
 * // ç¤ºä¾‹1ï¼šå–æ¶ˆåˆå¹¶
 * RngUtils.zå–æ¶ˆåˆå¹¶å•å…ƒæ ¼("A1:B2");
 *
 * // ç¤ºä¾‹2ï¼šä½¿ç”¨è‹±æ–‡æ–¹æ³•å
 * RngUtils.unmergeCells("A1:C3");
 *
 * // ç¤ºä¾‹3ï¼šå…¨å±€å¿«æ·æ–¹å¼ï¼ˆæ¨èï¼‰
 * $.unmergeCells("A1:D1");
 */
RngUtils.zå–æ¶ˆåˆå¹¶å•å…ƒæ ¼ = function(rng) {
    // ç¯å¢ƒæ£€æµ‹ï¼šéWPSç¯å¢ƒç›´æ¥è¿”å›null
    if (!isWPS) return null;

    // å‚æ•°è½¬æ¢ï¼šå­—ç¬¦ä¸²åœ°å€è½¬ä¸ºRangeå¯¹è±¡
    var r = typeof rng === 'string' ? Range(rng) : rng;

    // è°ƒç”¨WPSåŸç”ŸAPIå–æ¶ˆåˆå¹¶
    r.UnMerge();

    // è¿”å›Rangeå¯¹è±¡
    return r;
};
// è‹±æ–‡åˆ«åï¼šæ”¯æŒä¸­è‹±æ–‡åŒè¯­è°ƒç”¨
RngUtils.unmergeCells = RngUtils.zå–æ¶ˆåˆå¹¶å•å…ƒæ ¼;

// ==================== ä½¿ç”¨è¾…åŠ©å‡½æ•°åˆ›å»º RngUtils å®ä¾‹æ–¹æ³•åˆ«å ====================
createBilingualAliases(RngUtils.prototype, [
    ['zåŠ è¾¹æ¡†', 'addBorders'],
    ['zå»è¾¹æ¡†', 'removeBorders'],
    ['zæ¸…é™¤å†…å®¹', 'clearContents'],
    ['zæ¸…é™¤æ ¼å¼', 'clearFormats'],
    ['zè‡ªåŠ¨åˆ—å®½', 'autoFitColumns'],
    ['zè‡ªåŠ¨è¡Œé«˜', 'autoFitRows'],
    ['zè®¾ç½®èƒŒæ™¯è‰²', 'backgroundColor'],
    ['zè®¾ç½®å­—ä½“è‰²', 'fontColor'],
    ['zè¡Œæ•°', 'rowsCount'],
    ['zåˆ—æ•°', 'colsCount'],
    ['zåœ°å€', 'address']
]);

/**
 * åŠ è¾¹æ¡†
 * @param {Number} lineStyle - çº¿æ¡æ ·å¼ï¼ˆé»˜è®¤1ï¼‰
 * @param {Number} weight - çº¿æ¡ç²—ç»†ï¼ˆé»˜è®¤2ï¼‰
 * @returns {RngUtils} å½“å‰å®ä¾‹
 * @example
 * RngUtils("A1:C10").zåŠ è¾¹æ¡†()
 * RngUtils("A1:C10").zåŠ è¾¹æ¡†(1, 3).zè®¾ç½®èƒŒæ™¯è‰²(0xFFFF00)
 */
RngUtils.prototype.zåŠ è¾¹æ¡† = function(lineStyle, weight) {
    if (!this._range) return this;
    lineStyle = lineStyle !== undefined ? lineStyle : 1;
    weight = weight !== undefined ? weight : 2;
    this._range.Borders.LineStyle = lineStyle;
    this._range.Borders.Weight = weight;
    return this;
};
RngUtils.prototype.addBorders = RngUtils.prototype.zåŠ è¾¹æ¡†;

/**
 * å»è¾¹æ¡†
 * @returns {RngUtils} å½“å‰å®ä¾‹
 * @example
 * RngUtils("A1:C10").zå»è¾¹æ¡†()
 */
RngUtils.prototype.zå»è¾¹æ¡† = function() {
    if (!this._range) return this;
    this._range.Borders.LineStyle = -4142; // xlLineStyleNone
    return this;
};
RngUtils.prototype.removeBorders = RngUtils.prototype.zå»è¾¹æ¡†;

/**
 * æ¸…é™¤å†…å®¹
 * @returns {RngUtils} å½“å‰å®ä¾‹
 * @example
 * RngUtils("A1:C10").zæ¸…é™¤å†…å®¹()
 */
RngUtils.prototype.zæ¸…é™¤å†…å®¹ = function() {
    if (!this._range) return this;
    this._range.ClearContents();
    return this;
};
RngUtils.prototype.clearContents = RngUtils.prototype.zæ¸…é™¤å†…å®¹;

/**
 * æ¸…é™¤æ ¼å¼
 * @returns {RngUtils} å½“å‰å®ä¾‹
 * @example
 * RngUtils("A1:C10").zæ¸…é™¤æ ¼å¼()
 */
RngUtils.prototype.zæ¸…é™¤æ ¼å¼ = function() {
    if (!this._range) return this;
    this._range.ClearFormats();
    return this;
};
RngUtils.prototype.clearFormats = RngUtils.prototype.zæ¸…é™¤æ ¼å¼;

/**
 * è‡ªåŠ¨åˆ—å®½
 * @returns {RngUtils} å½“å‰å®ä¾‹
 * @example
 * RngUtils("A1:C10").zè‡ªåŠ¨åˆ—å®½()
 * RngUtils("A:Z").zè‡ªåŠ¨åˆ—å®½()  // æ•´åˆ—è‡ªåŠ¨è°ƒæ•´
 */
RngUtils.prototype.zè‡ªåŠ¨åˆ—å®½ = function() {
    if (!this._range) return this;
    this._range.Columns.AutoFit();
    return this;
};
RngUtils.prototype.autoFitColumns = RngUtils.prototype.zè‡ªåŠ¨åˆ—å®½;

/**
 * è‡ªåŠ¨è¡Œé«˜
 * @returns {RngUtils} å½“å‰å®ä¾‹
 * @example
 * RngUtils("A1:C10").zè‡ªåŠ¨è¡Œé«˜()
 */
RngUtils.prototype.zè‡ªåŠ¨è¡Œé«˜ = function() {
    if (!this._range) return this;
    this._range.Rows.AutoFit();
    return this;
};
RngUtils.prototype.autoFitRows = RngUtils.prototype.zè‡ªåŠ¨è¡Œé«˜;

/**
 * è®¾ç½®èƒŒæ™¯è‰²
 * @param {Number} color - RGBé¢œè‰²å€¼
 * @returns {RngUtils} å½“å‰å®ä¾‹
 * @example
 * RngUtils("A1:C10").zè®¾ç½®èƒŒæ™¯è‰²(RGB(255, 0, 0))  // çº¢è‰²èƒŒæ™¯
 * RngUtils("A1:C10").zè®¾ç½®èƒŒæ™¯è‰²(0xFFFF00)        // é»„è‰²èƒŒæ™¯
 */
RngUtils.prototype.zè®¾ç½®èƒŒæ™¯è‰² = function(color) {
    if (!this._range) return this;
    this._range.Interior.Color = color;
    return this;
};
RngUtils.prototype.backgroundColor = RngUtils.prototype.zè®¾ç½®èƒŒæ™¯è‰²;

/**
 * è®¾ç½®å­—ä½“è‰²
 * @param {Number} color - RGBé¢œè‰²å€¼
 * @returns {RngUtils} å½“å‰å®ä¾‹
 * @example
 * RngUtils("A1:C10").zè®¾ç½®å­—ä½“è‰²(RGB(255, 0, 0))  // çº¢è‰²å­—ä½“
 * RngUtils("A1:C10").zè®¾ç½®å­—ä½“è‰²(0xFF0000)        // çº¢è‰²å­—ä½“
 */
RngUtils.prototype.zè®¾ç½®å­—ä½“è‰² = function(color) {
    if (!this._range) return this;
    this._range.Font.Color = color;
    return this;
};
RngUtils.prototype.fontColor = RngUtils.prototype.zè®¾ç½®å­—ä½“è‰²;

/**
 * è·å–è¡Œæ•°
 * @returns {Number} è¡Œæ•°
 */
RngUtils.prototype.zè¡Œæ•° = function() {
    if (!this._range) return 0;
    return this._range.Rows.Count;
};
RngUtils.prototype.rowsCount = RngUtils.prototype.zè¡Œæ•°;

/**
 * è·å–åˆ—æ•°
 * @returns {Number} åˆ—æ•°
 */
RngUtils.prototype.zåˆ—æ•° = function() {
    if (!this._range) return 0;
    return this._range.Columns.Count;
};
RngUtils.prototype.colsCount = RngUtils.prototype.zåˆ—æ•°;

/**
 * è·å–åœ°å€
 * @returns {String} å•å…ƒæ ¼åœ°å€
 */
RngUtils.prototype.zåœ°å€ = function() {
    if (!this._range) return '';
    return this._range.Address();
};
RngUtils.prototype.address = RngUtils.prototype.zåœ°å€;

// ==================== [SUPERMAP] å¢å¼ºMapï¼ˆæ”¯æŒå±€éƒ¨å˜é‡çª—å£æŸ¥çœ‹ï¼‰ ====================

/**
 * SuperMap - å¯åœ¨å±€éƒ¨å˜é‡çª—å£å®æ—¶å±•å¼€æŸ¥çœ‹çš„å¢å¼ºç‰ˆ Map
 *
 * ç‰¹ç‚¹ï¼š
 * 1. å®Œå…¨å…¼å®¹åŸç”Ÿ Map çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•
 * 2. all å±æ€§è‡ªåŠ¨åˆå§‹åŒ–ï¼Œåˆ›å»ºåç«‹å³å¯åœ¨å±€éƒ¨å˜é‡çª—å£æŸ¥çœ‹
 * 3. æ”¯æŒåµŒå¥— SuperMapã€äºŒç»´æ•°ç»„ã€Map æ•°ç»„
 * 4. å±‚çº§å‰ç¼€æ ‡è¯†ï¼ˆ01L00001 = å±‚æ•°+åºå·+keyï¼‰
 * 5. è°ƒè¯•æ¨¡å¼å¼€å…³ï¼Œå…³é—­åæ€§èƒ½æ¥è¿‘åŸç”Ÿ Map
 */
function SuperMap(entries) {
    if (!(this instanceof SuperMap)) {
        return new SuperMap(entries);
    }
    this._map = new Map(entries);
    this._debug = true;
    this._all = null;  // å­˜å‚¨ all å±æ€§å€¼
    this._updateAll();  // æ„é€ æ—¶ç«‹å³åˆå§‹åŒ–
}

// ========== è°ƒè¯•æ¨¡å¼æ§åˆ¶ ==========

Object.defineProperty(SuperMap.prototype, 'debug', {
    get: function() {
        return this._debug;
    },
    set: function(value) {
        this._debug = !!value;
        this._updateAll();
    },
    enumerable: true,
    configurable: true
});

Object.defineProperty(SuperMap, 'debug', {
    get: function() {
        return SuperMap._staticDebug;
    },
    set: function(value) {
        SuperMap._staticDebug = !!value;
    },
    enumerable: true,
    configurable: true
});
SuperMap._staticDebug = true;

// ========== å®šä¹‰ all å±æ€§ ==========

Object.defineProperty(SuperMap.prototype, 'all', {
    get: function() {
        return this._all;
    },
    enumerable: true,
    configurable: true
});

// ========== å®šä¹‰ size å±æ€§ ==========

Object.defineProperty(SuperMap.prototype, 'size', {
    get: function() {
        return this._map.size;
    },
    enumerable: true,
    configurable: true
});

// ========== åŸå‹æ–¹æ³• ==========

/**
 * æ›´æ–° all å±æ€§ï¼ˆæ„é€ æ—¶å’Œæ¯æ¬¡ä¿®æ”¹åè‡ªåŠ¨è°ƒç”¨ï¼‰
 */
SuperMap.prototype._updateAll = function() {
    if (!this._debug && !SuperMap._staticDebug) {
        this._all = { _æç¤º: "è°ƒè¯•æ¨¡å¼å·²å…³é—­ï¼Œè®¾ç½® debug=true æŸ¥çœ‹" };
        return;
    }
    this._all = this._buildAllView(1);
};

/**
 * æ„å»ºæ ‘å½¢è§†å›¾
 * æ ¼å¼ï¼š01L00001 keyï¼ˆå±‚æ•°+åºå·+åŸkeyï¼‰
 */
SuperMap.prototype._buildAllView = function(level, maxRows) {
    level = level || 1;
    maxRows = maxRows || 255;

    var result = {};
    var count = 0;

    for (var entry of this._map) {
        var key = entry[0];
        var value = entry[1];

        if (count >= maxRows) {
            result['_çœç•¥å‰©ä½™' + (this._map.size - count) + 'é¡¹'] = "...";
            break;
        }

        // æ ¼å¼ï¼š01L00001 keyï¼ˆå±‚æ•°+åºå·+åŸkeyï¼‰
        var prefix = (level < 10 ? '0' : '') + level + 'L';
        var seqNum = '0000' + (count + 1);
        var displayKey = prefix + seqNum.slice(-5) + ' ' + key;

        // åˆ¤æ–­å€¼ç±»å‹å¹¶å¤„ç†
        if (value instanceof SuperMap) {
            // åµŒå¥— SuperMapï¼šé€’å½’å±•å¼€
            result[displayKey] = value._buildAllView(level + 1, maxRows);
        } else if (value instanceof Map) {
            // æ™®é€š Mapï¼šè½¬ä¸º SuperMap åå±•å¼€
            var superMap = SuperMap.fromMap(value, false);
            superMap._debug = this._debug;
            result[displayKey] = superMap._buildAllView(level + 1, maxRows);
        } else if (this._is2DArray(value)) {
            // äºŒç»´æ•°ç»„ï¼šæŒ‰åºå·å±•å¼€
            var arrObj = {};
            for (var i = 0; i < value.length && i < maxRows; i++) {
                arrObj[i + 1] = value[i];
            }
            result[displayKey] = arrObj;
        } else if (Array.isArray(value) && value.length > 0 && value[0] instanceof Map) {
            // Map æ•°ç»„ï¼šè½¬ä¸º SuperMap æ•°ç»„
            var arrObj = {};
            for (var i = 0; i < value.length && i < maxRows; i++) {
                var sm = SuperMap.fromMap(value[i], false);
                sm._debug = this._debug;
                arrObj[i + 1] = sm._buildAllView(level + 1, maxRows);
            }
            result[displayKey] = arrObj;
        } else if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
            // æ™®é€šå¯¹è±¡ï¼šç›´æ¥å±•ç¤º
            result[displayKey] = value;
        } else {
            // åŸºç¡€æ•°æ®ç±»å‹
            result[displayKey] = value;
        }

        count++;
    }

    return result;
};

/**
 * åˆ¤æ–­æ˜¯å¦ä¸ºäºŒç»´æ•°ç»„
 */
SuperMap.prototype._is2DArray = function(value) {
    if (!Array.isArray(value)) return false;
    if (value.length === 0) return false;
    return Array.isArray(value[0]);
};

// ========== Map åŸç”Ÿæ–¹æ³•ï¼ˆè‡ªåŠ¨æ›´æ–° allï¼‰==========

/**
 * è®¾ç½®é”®å€¼å¯¹ï¼ˆæ”¯æŒé“¾å¼è°ƒç”¨ï¼‰
 */
SuperMap.prototype.set = function(key, value) {
    this._map.set(key, value);
    this._updateAll();  // è‡ªåŠ¨æ›´æ–°
    return this;  // è¿”å› this æ”¯æŒé“¾å¼è°ƒç”¨
};

/**
 * è·å–å€¼
 */
SuperMap.prototype.get = function(key) {
    return this._map.get(key);
};

/**
 * æ£€æŸ¥æ˜¯å¦åŒ…å«é”®
 */
SuperMap.prototype.has = function(key) {
    return this._map.has(key);
};

/**
 * åˆ é™¤é”®å€¼å¯¹
 */
SuperMap.prototype.delete = function(key) {
    var result = this._map.delete(key);
    this._updateAll();  // è‡ªåŠ¨æ›´æ–°
    return result;
};

/**
 * æ¸…ç©ºæ‰€æœ‰é”®å€¼å¯¹
 */
SuperMap.prototype.clear = function() {
    this._map.clear();
    this._updateAll();  // è‡ªåŠ¨æ›´æ–°
    return this;
};

/**
 * éå†æ‰€æœ‰é”®å€¼å¯¹
 */
SuperMap.prototype.forEach = function(callback, thisArg) {
    this._map.forEach(callback, thisArg);
    return this;
};

/**
 * è·å–æ‰€æœ‰é”®çš„æ•°ç»„
 */
SuperMap.prototype.keys = function() {
    return Array.from(this._map.keys());
};

/**
 * è·å–æ‰€æœ‰å€¼çš„æ•°ç»„
 */
SuperMap.prototype.values = function() {
    return Array.from(this._map.values());
};

/**
 * è·å–æ‰€æœ‰é”®å€¼å¯¹çš„æ•°ç»„
 */
SuperMap.prototype.entries = function() {
    return Array.from(this._map.entries());
};

// ========== è½¬æ¢æ–¹æ³• ==========

/**
 * è½¬ä¸ºæ™®é€š Map å¯¹è±¡
 */
SuperMap.prototype.toMap = function(deep) {
    deep = deep !== undefined ? deep : true;

    var result = new Map();
    for (var entry of this._map) {
        var key = entry[0];
        var value = entry[1];

        if (deep && value instanceof SuperMap) {
            result.set(key, value.toMap(deep));
        } else if (deep && value instanceof Map) {
            result.set(key, new Map(value));
        } else if (deep && Array.isArray(value)) {
            result.set(key, value.map(function(item) {
                return item instanceof SuperMap ? item.toMap(deep) : item;
            }));
        } else {
            result.set(key, value);
        }
    }
    return result;
};

/**
 * é™æ€æ–¹æ³•ï¼šå°†æ™®é€š Map è½¬ä¸º SuperMap
 */
SuperMap.fromMap = function(map, deep) {
    if (!(map instanceof Map)) {
        throw new Error("å‚æ•°å¿…é¡»æ˜¯ Map ç±»å‹");
    }

    deep = deep !== undefined ? deep : true;
    var entries = [];

    // ä½¿ç”¨ forEach æ›¿ä»£ for...ofï¼Œå…¼å®¹ WPS JSA (ES3/ES5)
    map.forEach(function(value, key) {
        if (deep && value instanceof Map) {
            entries.push([key, SuperMap.fromMap(value, deep)]);
        } else if (deep && Array.isArray(value)) {
            entries.push([key, value.map(function(item) {
                return item instanceof Map ? SuperMap.fromMap(item, deep) : item;
            })]);
        } else {
            entries.push([key, value]);
        }
    });

    return new SuperMap(entries);
};
SuperMap.zä»Map = SuperMap.fromMap;

/**
 * å°†SuperMapå†…å®¹å†™å…¥å•å…ƒæ ¼
 * @param {String|Range} rng - ç›®æ ‡å•å…ƒæ ¼åœ°å€æˆ–Rangeå¯¹è±¡
 * @returns {SuperMap} å½“å‰å®ä¾‹
 * @example
 * SuperMap.fromMap(map).toRange('A1');
 */
SuperMap.prototype.toRange = function(rng) {
    if (!isWPS) return this;
    if (this._map.size === 0) return this;

    var arr = [['é”®', 'èšåˆç»“æœ', 'åŸå§‹æ•°æ®']];
    this._map.forEach(function(value, key) {
        var aggText = Array.isArray(value.agg) ? value.agg.join(', ') : JSON.stringify(value.agg);
        arr.push([key, aggText, JSON.stringify(value.group || {})]);
    });

    var targetRng = typeof rng === 'string' ? Range(rng) : rng;
    var rows = arr.length;
    var cols = arr[0].length;
    var endRng = targetRng.Item(rows, cols);
    var sheet = targetRng.Worksheet || Application.ActiveSheet;
    var writeRng = sheet.Range(targetRng, endRng);
    // è§£é™¤åˆå¹¶å•å…ƒæ ¼ - é€ä¸ªå•å…ƒæ ¼æ£€æŸ¥å¹¶å–æ¶ˆåˆå¹¶
    for (var i = 1; i <= writeRng.Rows.Count; i++) {
        for (var j = 1; j <= writeRng.Columns.Count; j++) {
            var cell = writeRng.Cells(i, j);
            if (cell.MergeCells) {
                cell.MergeArea.UnMerge();
            }
        }
    }
    writeRng.Value2 = arr;
    return this;
};
SuperMap.prototype.zå†™å…¥å•å…ƒæ ¼ = SuperMap.prototype.toRange;

/**
 * æ‰“å° all å†…å®¹åˆ°æ§åˆ¶å°
 */
SuperMap.prototype.print = function(title) {
    title = title || "SuperMap å†…å®¹";
    Console.log("===== " + title + " =====");
    Console.log(JSON.stringify(this.all, null, 2));
    Console.log("========================");
};
SuperMap.prototype.zæ‰“å° = SuperMap.prototype.print;

// ==================== [SHTUTILS] å·¥ä½œè¡¨å·¥å…·åº“ ====================

/**
 * ShtUtils - å·¥ä½œè¡¨æ“ä½œå·¥å…·ï¼ˆæ”¯æŒæ™ºèƒ½æç¤ºå’Œé“¾å¼è°ƒç”¨ï¼‰
 * @class
 * @constructor
 * @description WPSå·¥ä½œè¡¨æ“ä½œå¢å¼ºå·¥å…·
 * @example
 * ShtUtils.zå®‰å…¨å·²ä½¿ç”¨åŒºåŸŸ("Sheet1")
 */
function ShtUtils(initialSheet) {
    if (!(this instanceof ShtUtils)) {
        return new ShtUtils(initialSheet);
    }
    this._sheet = initialSheet ? this._getSheet(initialSheet) : null;
}

/**
 * è·å–å·¥ä½œè¡¨å¯¹è±¡
 * @private
 * @param {String|Worksheet} sht - å·¥ä½œè¡¨åç§°æˆ–å¯¹è±¡
 * @returns {Worksheet|null} å·¥ä½œè¡¨å¯¹è±¡æˆ–null
 */
ShtUtils.prototype._getSheet = function(sht) {
    if (typeof sht === 'string') {
        return isWPS ? Sheets(sht) : null;
    }
    return sht;
};

/**
 * å®‰å…¨å·²ä½¿ç”¨åŒºåŸŸ
 * @param {String|Worksheet} å·¥ä½œè¡¨ - å·¥ä½œè¡¨åç§°æˆ–å¯¹è±¡
 * @returns {Range} å·²ä½¿ç”¨åŒºåŸŸ
 */
ShtUtils.prototype.zå®‰å…¨å·²ä½¿ç”¨åŒºåŸŸ = function(å·¥ä½œè¡¨) {
    var sheet = å·¥ä½œè¡¨ ? this._getSheet(å·¥ä½œè¡¨) : (this._sheet || (isWPS ? Application.ActiveSheet : null));
    if (!sheet) return null;

    var usedRange;
    try {
        usedRange = sheet.UsedRange;
    } catch (e) {
        return sheet.Range("A1");
    }

    if (!usedRange) return sheet.Range("A1");

    var lastRow = usedRange.Row + usedRange.Rows.Count - 1;
    var lastCol = usedRange.Column + usedRange.Columns.Count - 1;

    return sheet.Range(sheet.Cells(1, 1), sheet.Cells(lastRow, lastCol));
};
ShtUtils.prototype.safeUsedRange = ShtUtils.prototype.zå®‰å…¨å·²ä½¿ç”¨åŒºåŸŸ;

/**
 * åŒ…å«è¡¨åï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰
 * @param {String} è¡¨å - è¡¨åæ¨¡å¼
 * @param {Object} è¡¨é›†åˆ - è¡¨é›†åˆï¼ˆå¯é€‰ï¼‰
 * @returns {Boolean} æ˜¯å¦åŒ…å«
 */
ShtUtils.prototype.zåŒ…å«è¡¨å = function(è¡¨å, è¡¨é›†åˆ) {
    var shts = è¡¨é›†åˆ || (isWPS ? Sheets : null);
    if (!shts) return false;

    var pattern = this._wildcardToRegex(è¡¨å);
    for (var i = 1; i <= shts.Count; i++) {
        if (pattern.test(shts(i).Name)) return true;
    }
    return false;
};
ShtUtils.prototype.includesSht = ShtUtils.prototype.zåŒ…å«è¡¨å;

/**
 * é€šé…ç¬¦è½¬æ­£åˆ™
 * @private
 * @param {String} wildcard - é€šé…ç¬¦æ¨¡å¼ï¼ˆæ”¯æŒ * å’Œ ?ï¼‰
 * @returns {RegExp} æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡
 */
ShtUtils.prototype._wildcardToRegex = function(wildcard) {
    var pattern = wildcard.replace(/[.+^${}()|[\]\\]/g, '\\$&')
        .replace(/\*/g, '.*')
        .replace(/\?/g, '.');
    return new RegExp('^' + pattern + '$', 'i');
};

/**
 * è¡¨åç­›é€‰
 * @param {String} è¡¨å - è¡¨åæ¨¡å¼
 * @param {Sheets} è¡¨é›†åˆ - è¡¨é›†åˆï¼ˆå¯é€‰ï¼‰
 * @returns {Array} åŒ¹é…çš„è¡¨åæ•°ç»„
 */
ShtUtils.prototype.zè¡¨åç­›é€‰ = function(è¡¨å, è¡¨é›†åˆ) {
    var shts = è¡¨é›†åˆ || (isWPS ? Sheets : null);
    if (!shts) return [];

    var pattern = this._wildcardToRegex(è¡¨å);
    var result = [];
    for (var i = 1; i <= shts.Count; i++) {
        if (pattern.test(shts(i).Name)) {
            result.push(shts(i).Name);
        }
    }
    return result;
};
ShtUtils.prototype.filterShts = ShtUtils.prototype.zè¡¨åç­›é€‰;

/**
 * æ¿€æ´»å·¥ä½œè¡¨
 * @param {String|Worksheet} å·¥ä½œè¡¨ - å·¥ä½œè¡¨ï¼ˆå¯é€‰ï¼‰
 * @returns {ShtUtils} å½“å‰å®ä¾‹
 */
ShtUtils.prototype.zæ¿€æ´»è¡¨ = function(å·¥ä½œè¡¨) {
    var sheet = å·¥ä½œè¡¨ ? this._getSheet(å·¥ä½œè¡¨) : this._sheet;
    if (sheet) sheet.Activate();
    this._sheet = sheet;
    return this;
};
ShtUtils.prototype.shtActivate = ShtUtils.prototype.zæ¿€æ´»è¡¨;

// ==================== [DATEUTILS] æ—¥æœŸå·¥å…·åº“ ====================

/**
 * DateUtils - æ—¥æœŸæ“ä½œå·¥å…·ï¼ˆæ”¯æŒæ™ºèƒ½æç¤ºå’Œé“¾å¼è°ƒç”¨ï¼‰
 * @class
 * @constructor
 * @description æ—¥æœŸæ—¶é—´å¤„ç†å·¥å…·
 * @example
 * DateUtils.dt().zåŠ å¤©(5).zæœˆåº•().val()
 */
function DateUtils(initialDate) {
    if (!(this instanceof DateUtils)) {
        return new DateUtils(initialDate);
    }
    this._date = initialDate ? new Date(initialDate) : new Date();
}

/**
 * è·å–/è®¾ç½®æ—¥æœŸ
 * @param {Date|number|string} newDate - æ–°æ—¥æœŸ
 * @returns {DateUtils|Date} è®¾ç½®æ—¶è¿”å›thisï¼Œå¦åˆ™è¿”å›å½“å‰æ—¥æœŸ
 */
DateUtils.prototype.dt = function(newDate) {
    if (newDate !== undefined) {
        this._date = new Date(newDate);
        return this;
    }
    return this._date;
};

/**
 * è·å–å€¼
 * @returns {Date} å½“å‰æ—¥æœŸå¯¹è±¡
 */
DateUtils.prototype.val = function() {
    return this._date;
};

/**
 * åŠ å¤©æ•°
 * @param {Number} days - å¤©æ•°
 * @returns {DateUtils} å½“å‰å®ä¾‹
 */
DateUtils.prototype.zåŠ å¤© = function(days) {
    var result = new Date(this._date);
    result.setDate(result.getDate() + days);
    this._date = result;
    return this;
};
DateUtils.prototype.addDays = DateUtils.prototype.zåŠ å¤©;

/**
 * åŠ æœˆæ•°
 * @param {Number} months - æœˆæ•°
 * @returns {DateUtils} å½“å‰å®ä¾‹
 */
DateUtils.prototype.zåŠ æœˆ = function(months) {
    var result = new Date(this._date);
    result.setMonth(result.getMonth() + months);
    this._date = result;
    return this;
};
DateUtils.prototype.addMonths = DateUtils.prototype.zåŠ æœˆ;

/**
 * åŠ å¹´æ•°
 * @param {Number} years - å¹´æ•°
 * @returns {DateUtils} å½“å‰å®ä¾‹
 */
DateUtils.prototype.zåŠ å¹´ = function(years) {
    var result = new Date(this._date);
    result.setFullYear(result.getFullYear() + years);
    this._date = result;
    return this;
};
DateUtils.prototype.addYears = DateUtils.prototype.zåŠ å¹´;

/**
 * æœˆåˆ
 * @returns {DateUtils} å½“å‰å®ä¾‹
 */
DateUtils.prototype.zæœˆåˆ = function() {
    this._date = new Date(this._date.getFullYear(), this._date.getMonth(), 1);
    return this;
};
DateUtils.prototype.firstDayOfMonth = DateUtils.prototype.zæœˆåˆ;

/**
 * æœˆåº•
 * @returns {DateUtils} å½“å‰å®ä¾‹
 */
DateUtils.prototype.zæœˆåº• = function() {
    this._date = new Date(this._date.getFullYear(), this._date.getMonth() + 1, 0);
    return this;
};
DateUtils.prototype.endOfMonth = DateUtils.prototype.zæœˆåº•;

/**
 * è½¬è¡¨æ ¼æ—¥æœŸ
 * @param {Date} jsdate - JSæ—¥æœŸ
 * @returns {Number} Excelæ—¥æœŸæ•°å€¼
 */
DateUtils.prototype.zè½¬è¡¨æ ¼æ—¥æœŸ = function(jsdate) {
    if (!(jsdate instanceof Date)) {
        jsdate = new Date(jsdate);
    }
    var excelBase = new Date(1900, 0, 1).getTime();
    var dateMs = jsdate.getTime();
    var dayInMs = 24 * 60 * 60 * 1000;
    return (dateMs - excelBase) / dayInMs + 2;
};
DateUtils.prototype.toExcelDate = DateUtils.prototype.zè½¬è¡¨æ ¼æ—¥æœŸ;

/**
 * æ—¥æœŸæ ¼å¼åŒ–
 * @param {Date} jsdate - æ—¥æœŸ
 * @param {String} fmt - æ ¼å¼
 * @returns {String} æ ¼å¼åŒ–å­—ç¬¦ä¸²
 */
DateUtils.prototype.zæ—¥æœŸæ ¼å¼åŒ– = function(jsdate, fmt) {
    if (!(jsdate instanceof Date)) {
        jsdate = new Date(jsdate);
    }
    var weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
    return fmt.replace(/(y+|Y+)|(M+)|(d+|D+)|(H+)|(m+)|(s+|S+)|(SSS)|(a+)/g, function(match, year, month, day, hour, minute, second, millisecond, week) {
        if (year) return jsdate.getFullYear().toString().padStart(year.length, '0');
        if (month) return (jsdate.getMonth() + 1).toString().padStart(month.length, '0');
        if (day) return jsdate.getDate().toString().padStart(day.length, '0');
        if (hour) return jsdate.getHours().toString().padStart(hour.length, '0');
        if (minute) return jsdate.getMinutes().toString().padStart(minute.length, '0');
        if (second) return jsdate.getSeconds().toString().padStart(second.length, '0');
        if (millisecond) return jsdate.getMilliseconds().toString().padStart(3, '0');
        if (week) return 'å‘¨' + weekDays[jsdate.getDay()];
        return match;
    });
};
DateUtils.prototype.format = DateUtils.prototype.zæ—¥æœŸæ ¼å¼åŒ–;

/**
 * è·å–å¹´ä»½
 * @returns {Number} å¹´ä»½ï¼ˆ4ä½æ•°å­—ï¼‰
 * @example
 * asDate("2023-9-21").zå¹´ä»½()  // 2023
 */
DateUtils.prototype.zå¹´ä»½ = function() {
    return this._date.getFullYear();
};
DateUtils.prototype.getYear = DateUtils.prototype.zå¹´ä»½;

/**
 * è·å–æœˆä»½ï¼ˆ1-12ï¼‰
 * @returns {Number} æœˆä»½ï¼ˆ1-12ï¼‰
 * @example
 * asDate("2023-9-21").zæœˆä»½()  // 9
 */
DateUtils.prototype.zæœˆä»½ = function() {
    return this._date.getMonth() + 1;
};
DateUtils.prototype.getMonth = DateUtils.prototype.zæœˆä»½;

/**
 * è·å–æ—¥æœŸï¼ˆ1-31ï¼‰
 * @returns {Number} æ—¥æœŸï¼ˆ1-31ï¼‰
 * @example
 * asDate("2023-9-21").zæ—¥æœŸ()  // 21
 */
DateUtils.prototype.zæ—¥æœŸ = function() {
    return this._date.getDate();
};
DateUtils.prototype.getDate = DateUtils.prototype.zæ—¥æœŸ;

/**
 * è·å–æ˜ŸæœŸï¼ˆ1-7ï¼Œ7=å‘¨æ—¥ï¼‰
 * @returns {Number} æ˜ŸæœŸï¼ˆ1-7ï¼‰
 * @example
 * asDate("2023-9-21").zæ˜ŸæœŸ()  // 4 (å‘¨å››)
 * asDate("2023-9-24").zæ˜ŸæœŸ()  // 7 (å‘¨æ—¥)
 */
DateUtils.prototype.zæ˜ŸæœŸ = function() {
    var day = this._date.getDay();
    return day === 0 ? 7 : day;
};
DateUtils.prototype.getDay = DateUtils.prototype.zæ˜ŸæœŸ;

/**
 * è·å–å°æ—¶ï¼ˆ0-23ï¼‰
 * @returns {Number} å°æ—¶ï¼ˆ0-23ï¼‰
 */
DateUtils.prototype.zå°æ—¶ = function() {
    return this._date.getHours();
};
DateUtils.prototype.getHour = DateUtils.prototype.zå°æ—¶;

/**
 * è·å–åˆ†é’Ÿï¼ˆ0-59ï¼‰
 * @returns {Number} åˆ†é’Ÿï¼ˆ0-59ï¼‰
 */
DateUtils.prototype.zåˆ†é’Ÿ = function() {
    return this._date.getMinutes();
};
DateUtils.prototype.getMinute = DateUtils.prototype.zåˆ†é’Ÿ;

/**
 * è·å–ç§’æ•°ï¼ˆ0-59ï¼‰
 * @returns {Number} ç§’æ•°ï¼ˆ0-59ï¼‰
 */
DateUtils.prototype.zç§’ = function() {
    return this._date.getSeconds();
};
DateUtils.prototype.getSecond = DateUtils.prototype.zç§’;

/**
 * è·å–æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
 * @returns {Number} æ—¶é—´æˆ³
 */
DateUtils.prototype.zæ—¶é—´æˆ³ = function() {
    return this._date.getTime();
};
DateUtils.prototype.getTime = DateUtils.prototype.zæ—¶é—´æˆ³;

// ==================== [JSA] é€šç”¨å‡½æ•°åº“ ====================

/**
 * JSA - é€šç”¨å‡½æ•°å·¥å…·ï¼ˆé™æ€æ–¹æ³•ï¼‰
 * @class
 * @description å¸¸ç”¨å‡½æ•°é›†åˆ
 */
function JSA() {}

/**
 * è½¬ç½®æ•°ç»„
 * @param {Array} arr - æ•°ç»„
 * @returns {Array} è½¬ç½®åçš„æ•°ç»„
 */
JSA.zè½¬ç½® = function(arr) {
    if (!arr || arr.length === 0) return [];
    var rows = arr.length;
    var cols = arr[0].length;
    var result = [];
    for (var j = 0; j < cols; j++) {
        result[j] = [];
        for (var i = 0; i < rows; i++) {
            result[j][i] = arr[i][j];
        }
    }
    return result;
};
JSA.transpose = JSA.zè½¬ç½®;

/**
 * è½¬æ•°å€¼
 * @param {String} text - æ–‡æœ¬
 * @returns {Number} æ•°å€¼
 */
JSA.zè½¬æ•°å€¼ = function(text) {
    if (typeof text === 'number') return text;
    if (typeof text === 'string') {
        text = text.trim();
        var match = text.match(/^[-+]?[0-9]*\.?[0-9]+/);
        if (match) return parseFloat(match[0]);
        return 0;
    }
    return 0;
};
JSA.val = JSA.zè½¬æ•°å€¼;

/**
 * å†™å…¥å•å…ƒæ ¼ï¼ˆæ ¹æ®æ•°ç»„å¤§å°è‡ªåŠ¨æ‰©å±•åŒºåŸŸï¼‰
 * @param {Array} arr - æ•°ç»„
 * @param {Range|string} rng - å•å…ƒæ ¼åŒºåŸŸï¼ˆå·¦ä¸Šè§’å•å…ƒæ ¼ï¼‰
 * @param {Boolean} clearDown - æ˜¯å¦æ¸…ç©ºä¸‹æ–¹ï¼ˆä¿ç•™å‚æ•°å…¼å®¹æ€§ï¼‰
 * @returns {Range} å†™å…¥çš„Range
 */
JSA.zå†™å…¥å•å…ƒæ ¼ = function(arr, rng, clearDown) {
    if (!isWPS) return null;
    var targetRng = typeof rng === 'string' ? Range(rng) : rng;
    var rows = arr.length;
    var cols = rows > 0 ? (Array.isArray(arr[0]) ? arr[0].length : 1) : 0;
    // æ ¹æ®æ•°ç»„å¤§å°è°ƒæ•´ç›®æ ‡åŒºåŸŸ
    var endRng = targetRng.Item(rows, cols);
    var sheet = targetRng.Worksheet || Application.ActiveSheet;
    var writeRng = sheet.Range(targetRng, endRng);
    writeRng.Value2 = arr;
    return writeRng;
};
JSA.toRange = JSA.zå†™å…¥å•å…ƒæ ¼;

/**
 * è·å–ä»Šå¤©æ—¥æœŸ
 * @returns {String} ä»Šå¤©æ—¥æœŸ YYYY-MM-DD
 */
JSA.zä»Šå¤© = function() {
    var now = new Date();
    return now.getFullYear() + '-' +
           String(now.getMonth() + 1).padStart(2, '0') + '-' +
           String(now.getDate()).padStart(2, '0');
};
JSA.today = JSA.zä»Šå¤©;

/**
 * è½¬æ—¥æœŸæ•°å€¼
 * @param {Date|string} d - æ—¥æœŸ
 * @returns {Number} Excelæ—¥æœŸæ•°å€¼
 */
JSA.zè½¬æ—¥æœŸæ•°å€¼ = function(d) {
    var date = typeof d === 'string' ? new Date(d) : d;
    var excelEpoch = new Date(1900, 0, 1);
    var msPerDay = 24 * 60 * 60 * 1000;
    return Math.floor((date - excelEpoch) / msPerDay) + 2;
};
JSA.cdate = JSA.zè½¬æ—¥æœŸæ•°å€¼;

/**
 * æ›¿æ¢
 * @param {String} str - å­—ç¬¦ä¸²
 * @param {String} find - æŸ¥æ‰¾
 * @param {String} replaceWith - æ›¿æ¢
 * @returns {String} ç»“æœ
 */
JSA.zæ›¿æ¢ = function(str, find, replaceWith) {
    return str.split(find).join(replaceWith);
};
JSA.replace = JSA.zæ›¿æ¢;

/**
 * æ•°ç»„è½¬JSONå­—ç¬¦ä¸²ï¼ˆæ•°ç»„æ‰©å±•æ–¹æ³•ï¼‰
 * @returns {String} JSONå­—ç¬¦ä¸²
 * @description å°†æ•°ç»„è½¬æ¢ä¸ºJSONæ ¼å¼å­—ç¬¦ä¸²
 * @example [1,2,3].toJson()              // è¿”å› "[1,2,3]"
 * @example ["a","b"].toJson()            // è¿”å› "[\"a\",\"b\"]"
 * @example [{x:1},{y:2}].toJson()        // è¿”å› "[{\"x\":1},{\"y\":2}]"
 */
Array.prototype.toJson = function() {
    return JSON.stringify(this);
};

/**
 * æ•°ç»„è½¬JSONå­—ç¬¦ä¸²ï¼ˆæ•°ç»„æ‰©å±•æ–¹æ³• - ä¸­æ–‡åˆ«åï¼‰
 */
Array.prototype.zè½¬JSON = Array.prototype.toJson;

/**
 * æ•°ç»„å…ƒç´ è½¬æ•°å€¼ï¼ˆæ•°ç»„æ‰©å±•æ–¹æ³•ï¼‰
 * @returns {Array} æ•°å€¼æ•°ç»„
 * @description å°†æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ è½¬æ¢ä¸ºæ•°å€¼
 * @example "1a2b3c4asd5".match(/\d/g).val()        // è¿”å› [1,2,3,4,5]
 * @example ["1","2","3"].val()                    // è¿”å› [1,2,3]
 * @example ["10","20","abc"].val()                // è¿”å› [10,20,0]
 */
Array.prototype.val = function() {
    return this.map(function(item) {
        var num = Number(item);
        return isNaN(num) ? 0 : num;
    });
};

/**
 * æ•°ç»„å…ƒç´ è½¬æ•°å€¼ï¼ˆæ•°ç»„æ‰©å±•æ–¹æ³• - ä¸­æ–‡åˆ«åï¼‰
 */
Array.prototype.zè½¬æ•°å€¼ = Array.prototype.val;

/**
 * æ•°ç»„å†™å…¥å•å…ƒæ ¼ï¼ˆæ•°ç»„æ‰©å±•æ–¹æ³•ï¼Œæ ¹æ®æ•°ç»„å¤§å°è‡ªåŠ¨æ‰©å±•åŒºåŸŸï¼‰
 * @param {Range|string} rng - å•å…ƒæ ¼åŒºåŸŸï¼ˆå·¦ä¸Šè§’å•å…ƒæ ¼ï¼‰
 * @returns {Range} å†™å…¥çš„Range
 * @description å°†äºŒç»´æ•°ç»„å†™å…¥æŒ‡å®šå•å…ƒæ ¼
 * @example
 * var arr = [[1, 'A'], [2, 'B'], [3, 'C']];
 * arr.toRange("J2");                    // å†™å…¥J2:L4
 * arr.toRange(Range("A1"));             // å†™å…¥A1:C4
 */
Array.prototype.toRange = function(rng) {
    if (!isWPS) return null;
    var targetRng = typeof rng === 'string' ? Range(rng) : rng;
    var rows = this.length;
    var cols = rows > 0 ? (Array.isArray(this[0]) ? this[0].length : 1) : 0;
    // æ ¹æ®æ•°ç»„å¤§å°è°ƒæ•´ç›®æ ‡åŒºåŸŸ
    var endRng = targetRng.Item(rows, cols);
    var sheet = targetRng.Worksheet || Application.ActiveSheet;
    var writeRng = sheet.Range(targetRng, endRng);
    writeRng.Value2 = this;
    return writeRng;
};

/**
 * æ•°ç»„å†™å…¥å•å…ƒæ ¼ï¼ˆæ•°ç»„æ‰©å±•æ–¹æ³• - ä¸­æ–‡åˆ«åï¼‰
 */
Array.prototype.zå†™å…¥å•å…ƒæ ¼ = Array.prototype.toRange;

/**
 * æˆªå–å­—ç¬¦
 * @param {String} str - å­—ç¬¦ä¸²
 * @param {Number} start - èµ·å§‹ä½ç½®ï¼ˆä»1å¼€å§‹ï¼‰
 * @param {Number} len - é•¿åº¦
 * @returns {String} ç»“æœ
 */
JSA.zæˆªå–å­—ç¬¦ = function(str, start, len) {
    var startIndex = start - 1;
    if (len === undefined) return str.substring(startIndex);
    return str.substring(startIndex, startIndex + len);
};
JSA.mid = JSA.zæˆªå–å­—ç¬¦;

/**
 * å·¦å–å­—ç¬¦
 * @param {String} str - å­—ç¬¦ä¸²
 * @param {Number} len - é•¿åº¦
 * @returns {String} ç»“æœ
 */
JSA.zå·¦å–å­—ç¬¦ = function(str, len) {
    return str.substring(0, len);
};
JSA.left = JSA.zå·¦å–å­—ç¬¦;

/**
 * å³å–å­—ç¬¦
 * @param {String} str - å­—ç¬¦ä¸²
 * @param {Number} len - é•¿åº¦
 * @returns {String} ç»“æœ
 */
JSA.zå³å–å­—ç¬¦ = function(str, len) {
    return str.substring(str.length - len);
};
JSA.right = JSA.zå³å–å­—ç¬¦;

/**
 * æ±‚å’Œ
 * @param {...Number} args - æ•°å€¼
 * @returns {Number} å’Œ
 */
JSA.zæ±‚å’Œ = function() {
    return Array.prototype.slice.call(arguments).reduce(function(acc, val) {
        return acc + (Number(val) || 0);
    }, 0);
};
JSA.sum = JSA.zæ±‚å’Œ;

/**
 * æœ€å¤§å€¼
 * @param {...Number} args - æ•°å€¼
 * @returns {Number} æœ€å¤§å€¼
 */
JSA.zæœ€å¤§å€¼ = function() {
    return Math.max.apply(null, Array.prototype.slice.call(arguments).map(function(v) { return Number(v) || 0; }));
};
JSA.max = JSA.zæœ€å¤§å€¼;

/**
 * æœ€å°å€¼
 * @param {...Number} args - æ•°å€¼
 * @returns {Number} æœ€å°å€¼
 */
JSA.zæœ€å°å€¼ = function() {
    return Math.min.apply(null, Array.prototype.slice.call(arguments).map(function(v) { return Number(v) || 0; }));
};
JSA.min = JSA.zæœ€å°å€¼;

/**
 * å¹³å‡å€¼
 * @param {...Number} args - æ•°å€¼
 * @returns {Number} å¹³å‡å€¼
 */
JSA.zå¹³å‡å€¼ = function() {
    var args = Array.prototype.slice.call(arguments);
    return args.length > 0 ? JSA.zæ±‚å’Œ.apply(null, args) / args.length : 0;
};
JSA.average = JSA.zå¹³å‡å€¼;

/**
 * æ¨¡ç³ŠåŒ¹é…
 * @param {String} str - å­—ç¬¦ä¸²
 * @param {String} pattern - æ¨¡å¼ï¼ˆæ”¯æŒ*å’Œ?ï¼‰
 * @returns {Number} åŒ¹é…è¿”å›-1ï¼Œä¸åŒ¹é…è¿”å›0
 * @description åŒ…å«æ¨¡å¼åŒ¹é…ï¼Œè‡ªåŠ¨åœ¨æ¨¡å¼å‰åæ·»åŠ  *ï¼Œé™¤éæ¨¡å¼ä»¥ ^ å¼€å¤´æˆ– $ ç»“å°¾
 */
JSA.zæ¨¡ç³ŠåŒ¹é… = function(str, pattern) {
    if (pattern === undefined || pattern === null) return 0;
    // è½¬ä¹‰æ­£åˆ™ç‰¹æ®Šå­—ç¬¦ï¼Œä½†ä¿ç•™ * å’Œ ?
    var regexPattern = pattern.replace(/[.+^${}()|[\]\\]/g, '\\$&')
                              .replace(/\*/g, '.*')
                              .replace(/\?/g, '.');
    // åŒ…å«æ¨¡å¼ï¼šè‡ªåŠ¨åœ¨å‰ååŠ ä¸Š .*ï¼Œé™¤éæ¨¡å¼å·²ç»ä»¥ ^ å¼€å¤´æˆ– $ ç»“å°¾
    var anchored = regexPattern;
    if (anchored.indexOf('^') !== 0) anchored = '.*' + anchored;
    if (anchored.charAt(anchored.length - 1) !== '$') anchored = anchored + '.*';
    var regex = new RegExp('^' + anchored + '$');
    // åŒ¹é…è¿”å›-1ï¼Œä¸åŒ¹é…è¿”å›0
    return regex.test(str) ? -1 : 0;
};
JSA.like = JSA.zæ¨¡ç³ŠåŒ¹é…;

/**
 * è¡¨è¾¾å¼æ±‚å€¼
 * @param {String} expr - å­—ç¬¦ä¸²è¡¨è¾¾å¼ï¼ˆå¦‚ '5*6+5'ï¼‰
 * @returns {Number} è®¡ç®—ç»“æœ
 * @description å¯¹å­—ç¬¦ä¸²è¡¨è¾¾å¼è¿›è¡Œæ±‚å€¼è®¡ç®—
 * @example JSA.eval880('5*6+5')     // è¿”å› 35
 * @example JSA.eval880('10+20*3')   // è¿”å› 70
 * @example JSA.eval880('(1+2)*3')   // è¿”å› 9
 */
JSA.zè¡¨è¾¾å¼æ±‚å€¼ = function(expr) {
    if (typeof expr !== 'string') return Number(expr) || 0;
    // ä½¿ç”¨ Function æ„é€ å‡½æ•°å®‰å…¨åœ°è®¡ç®—è¡¨è¾¾å¼
    try {
        return new Function('return ' + expr)();
    } catch (e) {
        return 0;
    }
};
JSA.eval880 = JSA.zè¡¨è¾¾å¼æ±‚å€¼;

/**
 * ç”Ÿæˆæ•°å­—åºåˆ—
 * @param {Number} start - èµ·å§‹
 * @param {Number} end - ç»“æŸ
 * @param {Number} step - æ­¥é•¿
 * @returns {Array} åºåˆ—
 */
JSA.zç”Ÿæˆæ•°å­—åºåˆ— = function(start, end, step) {
    step = step || 1;
    var result = [];
    for (var i = start; i <= end; i += step) {
        result.push(i);
    }
    return result;
};
JSA.getNumberArray = JSA.zç”Ÿæˆæ•°å­—åºåˆ—;

/**
 * äººæ°‘å¸å¤§å†™
 * @param {Number} n - æ•°å­—
 * @returns {String} å¤§å†™
 */
JSA.zäººæ°‘å¸å¤§å†™ = function(n) {
    var digits = ["é›¶", "å£¹", "è´°", "å", "è‚†", "ä¼", "é™†", "æŸ’", "æŒ", "ç–"];
    var units = ["", "æ‹¾", "ä½°", "ä»Ÿ"];
    var bigUnits = ["", "ä¸‡", "äº¿"];

    if (n === 0) return "é›¶å…ƒæ•´";

    var num = Math.abs(n);
    var integerPart = Math.floor(num);
    var decimalPart = Math.round((num - integerPart) * 100);

    var result = _convertIntegerPart(integerPart, digits, units, bigUnits) + "å…ƒ";

    if (decimalPart > 0) {
        if (decimalPart >= 10) {
            var jiao = Math.floor(decimalPart / 10);
            var fen = decimalPart % 10;
            result += digits[jiao] + "è§’";
            if (fen > 0) result += digits[fen] + "åˆ†";
        } else {
            result += digits[decimalPart] + "åˆ†";
        }
    } else {
        result += "æ•´";
    }

    if (n < 0) result += "ï¼ˆè´Ÿï¼‰";
    return result;

    function _convertIntegerPart(num, digits, units, bigUnits) {
        if (num === 0) return "";
        var result = "";
        var bigUnitIndex = 0;
        while (num > 0) {
            var section = num % 10000;
            if (section > 0) {
                var sectionResult = _convertSection(section, digits, units);
                result = sectionResult + bigUnits[bigUnitIndex] + result;
            }
            num = Math.floor(num / 10000);
            bigUnitIndex++;
        }
        return result;
    }

    function _convertSection(num, digits, units) {
        var result = "";
        var unitIndex = 0;
        var lastZero = false;
        while (num > 0) {
            var digit = num % 10;
            if (digit === 0) {
                if (!lastZero && result !== "") {
                    result = digits[0] + result;
                    lastZero = true;
                }
            } else {
                result = digits[digit] + units[unitIndex] + result;
                lastZero = false;
            }
            num = Math.floor(num / 10);
            unitIndex++;
        }
        return result;
    }
};
JSA.rmbdx = JSA.zäººæ°‘å¸å¤§å†™;

/**
 * éšæœºæ•´æ•°
 * @param {Number} start - èµ·å§‹
 * @param {Number} end - ç»“æŸ
 * @returns {Number} éšæœºæ•´æ•°
 */
JSA.zéšæœºæ•´æ•° = function(start, end) {
    return Math.floor(Math.random() * (end - start + 1)) + start;
};
JSA.rndInt = JSA.zéšæœºæ•´æ•°;

/**
 * éšæœºæ‰“ä¹±
 * @param {Array} array - æ•°ç»„
 * @returns {Array} æ‰“ä¹±åçš„æ•°ç»„
 */
JSA.zéšæœºæ‰“ä¹± = function(array) {
    var result = array.slice();
    for (var i = result.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = result[i];
        result[i] = result[j];
        result[j] = temp;
    }
    return result;
};
JSA.shuffle = JSA.zéšæœºæ‰“ä¹±;

/**
 * å»¶æ—¶
 * @param {Number} ts - æ¯«ç§’
 */
JSA.zå»¶æ—¶ = function(ts) {
    var start = Date.now();
    while (Date.now() - start < ts) {
        // ç­‰å¾…
    }
};
JSA.delay = JSA.zå»¶æ—¶;

/**
 * æ—¥æœŸé—´éš”
 * @param {Date|string} d1 - æ—¥æœŸ1
 * @param {Date|string} d2 - æ—¥æœŸ2
 * @param {String} format - æ ¼å¼
 * @returns {String|Number} é—´éš”
 */
JSA.zæ—¥æœŸé—´éš” = function(d1, d2, format) {
    var date1 = typeof d1 === 'string' ? new Date(d1) : d1;
    var date2 = typeof d2 === 'string' ? new Date(d2) : d2;

    if (format === 'Y') return date2.getFullYear() - date1.getFullYear();
    if (format === 'M') {
        var years = date2.getFullYear() - date1.getFullYear();
        var months = date2.getMonth() - date1.getMonth();
        return years * 12 + months;
    }
    if (format === 'D') {
        var msPerDay = 24 * 60 * 60 * 1000;
        return Math.round((date2 - date1) / msPerDay);
    }
    // é»˜è®¤è¿”å›å®Œæ•´é—´éš”
    var years = date2.getFullYear() - date1.getFullYear();
    var months = date2.getMonth() - date1.getMonth();
    var days = date2.getDate() - date1.getDate();

    if (days < 0) {
        months--;
        var prevMonth = new Date(date2.getFullYear(), date2.getMonth(), 0);
        days += prevMonth.getDate();
    }
    if (months < 0) {
        years--;
        months += 12;
    }

    var result = "";
    if (years > 0) result += years + "å¹´";
    if (months > 0) result += months + "ä¸ªæœˆ";
    if (days > 0) result += days + "å¤©";
    return result || "0å¤©";
};
JSA.datedif = JSA.zæ—¥æœŸé—´éš”;

/**
 * é€‰æ‹©åˆ—
 * @param {Array} arr - äºŒç»´æ•°ç»„
 * @param {Array} colIndexes - åˆ—ç´¢å¼•
 * @param {Array} newHeaders - æ–°è¡¨å¤´
 * @returns {Array} ç»“æœæ•°ç»„
 */
JSA.zé€‰æ‹©åˆ— = function(arr, colIndexes, newHeaders) {
    if (!arr || arr.length === 0) return [];

    var indexes = [];

    // æ£€æŸ¥æ˜¯å¦æŒ‰è¡¨å¤´é€‰æ‹©
    if (arr.length > 0 && colIndexes.length > 0 && typeof colIndexes[0] === 'string') {
        var headers = arr[0];
        var headerMap = {};
        for (var i = 0; i < headers.length; i++) {
            headerMap[String(headers[i])] = i;
        }

        for (var j = 0; j < colIndexes.length; j++) {
            var col = colIndexes[j];
            if (headerMap.hasOwnProperty(col)) {
                indexes.push(headerMap[col]);
            }
        }

        var result = [];
        if (newHeaders && newHeaders.length > 0) {
            result.push(newHeaders);
        } else {
            var newRow = [];
            for (var k = 0; k < colIndexes.length; k++) {
                var col = colIndexes[k];
                var idx = headerMap[col];
                newRow.push(idx !== undefined ? headers[idx] : col);
            }
            result.push(newRow);
        }

        for (var i = 1; i < arr.length; i++) {
            var row = arr[i];
            var newRow = [];
            for (var k = 0; k < indexes.length; k++) {
                newRow.push(row[indexes[k]]);
            }
            result.push(newRow);
        }

        return result;
    } else {
        // æŒ‰åˆ—å·é€‰æ‹©
        indexes = [];
        for (var j = 0; j < colIndexes.length; j++) {
            indexes.push(typeof colIndexes[j] === 'number' ? colIndexes[j] : parseInt(colIndexes[j]));
        }

        var result = [];
        for (var i = 0; i < arr.length; i++) {
            var row = arr[i];
            var newRow = [];
            for (var k = 0; k < indexes.length; k++) {
                newRow.push(row[indexes[k]]);
            }
            result.push(newRow);
        }

        return result;
    }
};
JSA.selectCols = JSA.zé€‰æ‹©åˆ—;

/**
 * çŸ©é˜µåˆ†å¸ƒ
 * @param {Number} totalRows - æ€»è¡Œæ•°
 * @param {Number} cols - åˆ—æ•°
 * @param {String} direction - æ–¹å‘ 'r'æˆ–'c'
 * @returns {Array} åˆ†å¸ƒåçš„æ•°ç»„
 */
JSA.zçŸ©é˜µåˆ†å¸ƒ = function(totalRows, cols, direction) {
    direction = direction || 'r';
    var result = [];
    var numbers = [];
    for (var i = 0; i < totalRows; i++) {
        numbers.push(i);
    }

    if (direction === 'r') {
        var rows = Math.ceil(totalRows / cols);
        for (var i = 0; i < rows; i++) {
            var row = [];
            for (var j = 0; j < cols; j++) {
                var index = i * cols + j;
                if (index < totalRows) row.push(numbers[index]);
            }
            if (row.length > 0) result.push(row);
        }
    } else {
        var rows = Math.ceil(totalRows / cols);
        for (var i = 0; i < rows; i++) {
            var row = [];
            for (var j = 0; j < cols; j++) {
                var index = j * rows + i;
                if (index < totalRows) row.push(numbers[index]);
            }
            if (row.length > 0) result.push(row);
        }
    }

    return result;
};
JSA.getMatrix = JSA.zçŸ©é˜µåˆ†å¸ƒ;

// ==================== [IO] æ–‡ä»¶æ“ä½œåº“ ====================

/**
 * IO - æ–‡ä»¶æ“ä½œå·¥å…·
 * @class
 * @description æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼ˆæ”¯æŒ WPS å’Œ Node.js ç¯å¢ƒï¼‰
 */
function IO() {}

/**
 * æ˜¯å¦æ–‡ä»¶
 * @param {String} path - è·¯å¾„
 * @returns {Boolean} æ˜¯å¦ä¸ºæ–‡ä»¶
 */
IO.zæ˜¯å¦æ–‡ä»¶ = function(path) {
    if (!isWPS) return false;
    
    try {
        const fso = new ActiveXObject("Scripting.FileSystemObject");
        return fso.FileExists(path);
    } catch (e) {
        return false;
    }
};
IO.IsFile = IO.zæ˜¯å¦æ–‡ä»¶;

/**
 * æ˜¯å¦æ–‡ä»¶å¤¹
 * @param {String} path - è·¯å¾„
 * @returns {Boolean} æ˜¯å¦ä¸ºæ–‡ä»¶å¤¹
 */
IO.zæ˜¯å¦æ–‡ä»¶å¤¹ = function(path) {
    if (!isWPS) return false;
    
    try {
        const fso = new ActiveXObject("Scripting.FileSystemObject");
        return fso.FolderExists(path);
    } catch (e) {
        return false;
    }
};
IO.IsDirectory = IO.zæ˜¯å¦æ–‡ä»¶å¤¹;

/**
 * æ–‡ä»¶å
 * @param {String} path - è·¯å¾„
 * @returns {String} æ–‡ä»¶å
 */
IO.zæ–‡ä»¶å = function(path) {
    if (!path) return '';
    var parts = path.replace(/\\/g, '/').split('/');
    return parts[parts.length - 1] || '';
};
IO.getFileName = IO.zæ–‡ä»¶å;

/**
 * çº¯æ–‡ä»¶å
 * @param {String} path - è·¯å¾„
 * @returns {String} çº¯æ–‡ä»¶å
 */
IO.zçº¯æ–‡ä»¶å = function(path) {
    var fileName = IO.zæ–‡ä»¶å(path);
    var lastDotIndex = fileName.lastIndexOf('.');
    if (lastDotIndex > 0) {
        return fileName.substring(0, lastDotIndex);
    }
    return fileName;
};
IO.getFileNameNoType = IO.zçº¯æ–‡ä»¶å;

/**
 * æ–‡ä»¶åç¼€
 * @param {String} path - è·¯å¾„
 * @returns {String} åç¼€
 */
IO.zæ–‡ä»¶åç¼€ = function(path) {
    var fileName = IO.zæ–‡ä»¶å(path);
    var lastDotIndex = fileName.lastIndexOf('.');
    if (lastDotIndex > 0 && lastDotIndex < fileName.length - 1) {
        return fileName.substring(lastDotIndex + 1);
    }
    return '';
};
IO.getFileType = IO.zæ–‡ä»¶åç¼€;

/**
 * ä¸Šçº§æ–‡ä»¶å¤¹
 * @param {String} path - è·¯å¾„
 * @param {Number} çº§æ•° - çº§æ•°
 * @returns {String} ä¸Šçº§è·¯å¾„
 */
IO.zä¸Šçº§æ–‡ä»¶å¤¹ = function(path, çº§æ•°) {
    çº§æ•° = çº§æ•° || 1;
    var result = path;
    for (var i = 0; i < çº§æ•°; i++) {
        result = result.replace(/\\/g, '/').replace(/\/+$/, '');
        var lastSlashIndex = result.lastIndexOf('/');
        if (lastSlashIndex > 0) {
            result = result.substring(0, lastSlashIndex);
        } else {
            break;
        }
    }
    return result;
};
IO.lastDirectoty = IO.zä¸Šçº§æ–‡ä»¶å¤¹;

// ==================== [GLOBAL_FUNCS] å…¨å±€è¾…åŠ©å‡½æ•° ====================

/**
 * æ—¥å¿—è¾“å‡º
 * @param {...any} args - å‚æ•°
 */
function log() {
    if (isWPS && typeof Console !== 'undefined') {
        Array.prototype.slice.call(arguments).forEach(function(arg) {
            Console.log(arg);
        });
    }
}

/**
 * æ‰¹é‡åˆ›å»ºä¸­è‹±æ–‡æ–¹æ³•åˆ«å
 * @private
 * @param {Object} prototype - åŸå‹å¯¹è±¡
 * @param {Array} aliases - åˆ«åé…ç½®æ•°ç»„ [[ä¸­æ–‡å, è‹±æ–‡å], ...]
 */
function createBilingualAliases(prototype, aliases) {
    for (var i = 0; i < aliases.length; i++) {
        var cnName = aliases[i][0];
        var enName = aliases[i][1];
        if (prototype[cnName] && !prototype[enName]) {
            prototype[enName] = prototype[cnName];
        } else if (prototype[enName] && !prototype[cnName]) {
            prototype[cnName] = prototype[enName];
        }
    }
}

/**
 * JSONæ—¥å¿—è¾“å‡º
 * @param {any} x - å¯¹è±¡
 * @param {Boolean} wrapopt - æ˜¯å¦åŒ…è£…JSONå¯¹è±¡(å³æ˜¯å¦è¦è¾“å‡ºæ—¥æœŸç­‰ä¿¡æ¯)ï¼Œé»˜è®¤true
 * @example
 * logjson([[1,2],[3,4],[5,6]],0);  // è¾“å‡º: [[1,2],[3,4],[5,6]]
 * logjson([1,2,3])                  // ä¸€ç»´æ•°ç»„è¾“å‡ºä¸ºç´§å‡‘å•è¡Œ
 */
function logjson(x, wrapopt) {
    wrapopt = wrapopt !== undefined ? wrapopt : true;

    // å¤„ç† Array2D å¯¹è±¡ï¼ˆæå– _items å±æ€§ï¼‰
    if (x && typeof x === 'object' && x._items && Array.isArray(x._items)) {
        x = x._items;
    }

    // äºŒç»´æ•°ç»„ç‰¹æ®Šå¤„ç†
    if (Array.isArray(x) && x.length > 0 && Array.isArray(x[0])) {
        // wrapopt=0 æ—¶è¾“å‡ºç´§å‡‘æ ¼å¼
        if (wrapopt === false || wrapopt === 0) {
            var output = JSON.stringify(x);
            if (isWPS && typeof Console !== 'undefined') {
                Console.log(output);
            }
        } else {
            // æ ¼å¼åŒ–è¾“å‡ºï¼ˆå¯¹é½ï¼‰
            var lines = formatArray2DAsJSON(x);
            for (var i = 0; i < lines.length; i++) {
                if (isWPS && typeof Console !== 'undefined') {
                    Console.log(lines[i]);
                }
            }
        }
        return;
    }

    // ä¸€ç»´æ•°ç»„è¾“å‡ºä¸ºç´§å‡‘å•è¡Œæ ¼å¼
    if (Array.isArray(x)) {
        var str = '[' + x.map(function(item) {
            if (item === null || item === undefined) return '';
            return String(item);
        }).join(',') + ']';
        if (isWPS && typeof Console !== 'undefined') {
            Console.log(str);
        }
        return;
    }

    // å…¶ä»–ç±»å‹ï¼šå¤„ç†å¾ªç¯å¼•ç”¨å’Œæ—¥æœŸ
    var output;
    if (wrapopt && typeof x === 'object' && x !== null) {
        var seen = new WeakSet();
        var replacer = function(key, value) {
            if (typeof value === 'object' && value !== null) {
                if (seen.has(value)) {
                    return '[Circular]';
                }
                seen.add(value);
            }
            if (value instanceof Date) {
                return value.toISOString();
            }
            return value;
        };
        output = JSON.stringify(x, replacer, 2);
    } else {
        output = typeof x === 'object' ? JSON.stringify(x, null, wrapopt ? 2 : 0) : String(x);
    }

    if (isWPS && typeof Console !== 'undefined') {
        Console.log(output);
    }

    return;
}

/**
 * æ ¼å¼åŒ–äºŒç»´æ•°ç»„ä¸ºJSONï¼ˆæ”¯æŒå¯¹é½æ˜¾ç¤ºï¼‰
 * @private
 * @param {Array} arr - äºŒç»´æ•°ç»„
 * @returns {Array} æ ¼å¼åŒ–çš„å­—ç¬¦ä¸²æ•°ç»„
 */
function formatArray2DAsJSON(arr) {
    if (!arr || arr.length === 0) return ['[]'];

    /**
     * è®¡ç®—å­—ç¬¦ä¸²çš„æ˜¾ç¤ºå®½åº¦ï¼ˆåŸºäºç­‰å®½å­—ä½“ç¯å¢ƒï¼‰
     * è§„åˆ™ï¼š
     * - ASCII å­—ç¬¦ï¼ˆU+0000 - U+007Fï¼‰= 1
     * - éASCII å­—ç¬¦ï¼ˆåŒ…æ‹¬ä¸­æ–‡ç­‰å®½å­—ç¬¦ï¼‰= 2
     */
    var getDisplayWidth = function(str) {
        var width = 0;
        for (var i = 0; i < str.length; i++) {
            var code = str.charCodeAt(i);
            if (code < 128) {
                // ASCII å­—ç¬¦å®½åº¦ä¸º 1
                width += 1;
            } else {
                // éASCII å­—ç¬¦ï¼ˆåŒ…æ‹¬ä¸­æ–‡ï¼‰å®½åº¦ä¸º 2
                width += 2;
            }
        }
        return width;
    };

    // å…ˆå°†æ¯è¡Œè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œä»¥ä¾¿è®¡ç®—æ˜¾ç¤ºå®½åº¦
    var stringRows = [];
    var colCount = arr[0].length;

    for (var row = 0; row < arr.length; row++) {
        var stringCells = [];
        for (var col = 0; col < colCount; col++) {
            var cellValue = col < arr[row].length ? arr[row][col] : '';
            var cellStr = cellValue === null || cellValue === undefined ? '' : String(cellValue);
            stringCells.push(cellStr);
        }
        stringRows.push(stringCells);
    }

    // è®¡ç®—æ¯åˆ—å†…å®¹çš„æœ€å¤§æ˜¾ç¤ºå®½åº¦ï¼ˆä¸åŒ…æ‹¬å¼•å·å’Œé€—å·ï¼‰
    var contentWidths = [];
    for (var col = 0; col < colCount; col++) {
        var maxWidth = 0;
        for (var row = 0; row < arr.length; row++) {
            maxWidth = Math.max(maxWidth, getDisplayWidth(stringRows[row][col]));
        }
        contentWidths.push(maxWidth);
    }

    var lines = [];

    // æ„å»ºæ‰€æœ‰è¡Œï¼Œç¡®ä¿å¯¹é½
    for (var row = 0; row < arr.length; row++) {
        var rowParts = [];
        for (var col = 0; col < colCount; col++) {
            var cellStr = stringRows[row][col];
            var displayWidth = getDisplayWidth(cellStr);

            // è®¡ç®—éœ€è¦å¡«å……çš„å®½åº¦
            var paddingNeeded = contentWidths[col] - displayWidth;

            // ä½¿ç”¨æ™®é€šç©ºæ ¼å¡«å……ï¼ˆæ¯ä¸ªç©ºæ ¼å 1ä¸ªæ˜¾ç¤ºå®½åº¦ï¼‰
            // ä½¿ç”¨ Array().join() æ›¿ä»£ String.repeat() ä»¥æå‡å…¼å®¹æ€§
            var paddingStr = paddingNeeded > 0 ? Array(paddingNeeded + 1).join(' ') : '';

            // æ„å»ºå•å…ƒæ ¼ï¼šå‰é¢å¡«å…… + "å†…å®¹"
            var cell = '"' + paddingStr + cellStr + '"';

            rowParts.push(cell);
        }

        // ç”¨é€—å·è¿æ¥å„åˆ—ï¼ˆé€—å·åæ— ç©ºæ ¼ï¼‰
        var rowStr = '[' + rowParts.join(',') + ']';
        lines.push(rowStr);
    }

    // æ·»åŠ å‰å¯¼ç©ºæ ¼å’Œè¡Œå°¾é€—å·
    for (var i = 0; i < lines.length; i++) {
        if (i < lines.length - 1) {
            lines[i] = ' ' + lines[i] + ',';
        } else {
            lines[i] = ' ' + lines[i];
        }
    }

    lines.push(']');
    lines.unshift('[');
    return lines;
}

// ==================== [GLOBAL_FUNCS] å…¨å±€å·¥å…·å‡½æ•°ï¼ˆf1, $fx, $toArrayï¼‰====================

/**
 * f1å‡½æ•° - åœ¨WPS JSAç«‹å³çª—å£å¿«é€Ÿæ‰“å¼€JSA880å¸®åŠ©
 * @param {String} fxname - å‡½æ•°åï¼Œå¦‚Array2D.pad
 * @example
 * f1("Array2D.pad")  // æ‰“å¼€å¸®åŠ©
 */
function f1(fxname) {
    const helpUrl = "https://vbayyds.com/api/help/" + fxname;
    try {
        const browser = new ActiveXObject("InternetExplorer.Application");
        browser.Visible = true;
        browser.Navigate(helpUrl);
    } catch (e) {
        if (typeof Console !== 'undefined') {
            Console.log("å¸®åŠ©åœ°å€: " + helpUrl);
        }
    }
}

/**
 * $fxå‡½æ•° - WorksheetFunctionå¯¹è±¡çš„ç®€å†™
 * @param {string} path - å‡½æ•°å¯¹è±¡çš„è·¯å¾„
 * @returns {Function} å·¥ä½œè¡¨å‡½æ•°
 * @example
 * $fx.Sum(1,2,3)  // 6
 */
function $fx(path) {
    const parts = path.split('.');
    var obj = WorksheetFunction;
    for (var i = 0; i < parts.length; i++) {
        if (obj[parts[i]]) {
            obj = obj[parts[i]];
        } else {
            return null;
        }
    }
    return typeof obj === 'function' ? obj : null;
}

/**
 * $toArrayå‡½æ•° - å°†å‚æ•°è½¬æ¢ä¸ºæ•°ç»„ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰
 * @param {...any} args - è¦è½¬æ¢ä¸ºæ•°ç»„çš„å‚æ•°
 * @returns {Array} è½¬æ¢åçš„æ•°ç»„
 * @example
 * $toArray("äº§å“1", "äº§å“2", "äº§å“3")  // ["äº§å“1","äº§å“2","äº§å“3"]
 */
function $toArray() {
    var result = [];
    for (var i = 0; i < arguments.length; i++) {
        result.push(arguments[i]);
    }
    return result;
}

// ==================== [TYPE_CONVERT] ç±»å‹è½¬æ¢å‡½æ•°ï¼ˆasç³»åˆ—ï¼‰ ====================

/**
 * asStringå‡½æ•° - å°†å¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¯¹è±¡
 * @param {any} s - è¦è½¬æ¢çš„å¯¹è±¡
 * @returns {String} å­—ç¬¦ä¸²
 * @example
 * asString(123)  // "123"
 */
function asString(s) {
    return String(s === null || s === undefined ? '' : s);
}

/**
 * asArrayå‡½æ•° - å°†å€¼è½¬æ¢ä¸ºArray2Då¯¹è±¡ï¼ˆæ”¯æŒé“¾å¼è°ƒç”¨å’ŒtoRangeï¼‰
 * @param {any} a - è¦è½¬æ¢çš„å€¼
 * @returns {Array2D} Array2Då¯¹è±¡
 * @example
 * asArray(123)                      // Array2D([[123]])
 * asArray("abc")                    // Array2D([["abc"]])
 * asArray([1,2,3])                  // Array2D([[1],[2],[3]])
 * asArray([[1,2],[3,4]])            // Array2D([[1,2],[3,4]])
 * asArray(Array2D([[1,2]]))         // Array2D([[1,2]]) (åŸæ ·è¿”å›)
 * asArray("a,b,c")                  // Array2D([["a"],["b"],["c"]])
 */
function asArray(a) {
    // å¦‚æœå·²ç»æ˜¯ Array2Dï¼Œç›´æ¥è¿”å›
    if (a instanceof Array2D) return a;

    var arr;
    if (Array.isArray(a)) {
        arr = a;
    } else if (a === null || a === undefined) {
        arr = [];
    } else if (typeof a === 'string') {
        // å°è¯•æŒ‰é€—å·åˆ†å‰²
        if (a.indexOf(',') >= 0) {
            var parts = a.split(',').map(function(s) { return s.trim(); });
            // è½¬ä¸ºäºŒç»´æ•°ç»„
            arr = [];
            for (var i = 0; i < parts.length; i++) {
                arr.push([parts[i]]);
            }
        } else {
            arr = [[a]];
        }
    } else {
        arr = [[a]];
    }

    // ç¡®ä¿ arr æ˜¯äºŒç»´æ•°ç»„
    if (arr.length > 0 && !Array.isArray(arr[0])) {
        var newArr = [];
        for (var j = 0; j < arr.length; j++) {
            newArr.push([arr[j]]);
        }
        arr = newArr;
    }

    return new Array2D(arr);
}

/**
 * asArray2Då‡½æ•° - å°†å€¼è½¬æ¢ä¸ºArray2Då¯¹è±¡ï¼ˆasArrayçš„åˆ«åï¼‰
 * @param {any} a - è¦è½¬æ¢çš„å€¼
 * @returns {Array2D} Array2Då¯¹è±¡
 * @example
 * asArray2D([[1,2],[3,4]])           // Array2D([[1,2],[3,4]])
 * asArray2D([1,2,3])                  // Array2D([[1],[2],[3]])
 * asArray2D("a,b,c")                  // Array2D([["a"],["b"],["c"]])
 * asArray2D(Array2D([[1,2]]))         // Array2D([[1,2]]) (åŸæ ·è¿”å›)
 */
var asArray2D = asArray;

/**
 * asNumberå‡½æ•° - å°†å€¼è½¬æ¢ä¸ºæ•°å­—
 * @param {any} a - è¦è½¬æ¢çš„å€¼
 * @returns {Number} æ•°å­—ï¼Œè½¬æ¢å¤±è´¥è¿”å›0
 * @example
 * asNumber("123")        // 123
 * asNumber("12.34")      // 12.34
 * asNumber("abc")        // 0
 * asNumber(null)         // 0
 */
function asNumber(a) {
    if (typeof a === 'number') return a;
    if (typeof a === 'boolean') return a ? 1 : 0;
    if (a === null || a === undefined || a === '') return 0;
    var num = Number(a);
    return isNaN(num) ? 0 : num;
}

/**
 * asDateå‡½æ•° - å°†å€¼è½¬æ¢ä¸ºDateUtilså¯¹è±¡ï¼ˆæ”¯æŒæ™ºèƒ½æç¤ºå’Œé“¾å¼è°ƒç”¨ï¼‰
 * @param {any} a - è¦è½¬æ¢çš„å€¼
 * @returns {DateUtils} DateUtilså®ä¾‹
 * @example
 * asDate("2023-9-1").zæœˆä»½()     // 9
 * asDate(45170).zå¹´ä»½()          // 2023 (Excelæ—¥æœŸåºå·)
 * asDate("2023/09/01").zæ—¥æœŸ()   // 1
 */
function asDate(a) {
    var date;
    if (a instanceof DateUtils) return a;
    if (a instanceof Date) {
        date = a;
    } else if (typeof a === 'number') {
        // Excelæ—¥æœŸåºå·è½¬JS Date
        date = new Date((a - 25569) * 86400 * 1000);
    } else if (typeof a === 'string') {
        date = new Date(a);
        if (isNaN(date.getTime())) {
            date = new Date();
        }
    } else {
        date = new Date();
    }
    return new DateUtils(date);
}

/**
 * asRangeå‡½æ•° - å°†å€¼è½¬æ¢ä¸ºRangeå¯¹è±¡
 * @param {any} a - è¦è½¬æ¢çš„å€¼ï¼ˆåœ°å€å­—ç¬¦ä¸²ã€Rangeå¯¹è±¡ç­‰ï¼‰
 * @returns {Range|null} Rangeå¯¹è±¡
 * @example
 * asRange("A1")          // Rangeå¯¹è±¡
 * asRange(Range("A1"))   // Rangeå¯¹è±¡
 * asRange("A1:C10")      // Rangeå¯¹è±¡
 */
function asRange(a) {
    if (!isWPS) return null;
    if (a && a.Address) return a; // å·²ç»æ˜¯Rangeå¯¹è±¡
    if (typeof a === 'string') {
        try {
            return Range(a);
        } catch (e) {
            return null;
        }
    }
    return null;
}

/**
 * asMapå‡½æ•° - å°†å€¼è½¬æ¢ä¸ºMapå¯¹è±¡
 * @param {any} a - è¦è½¬æ¢çš„å€¼ï¼ˆå¯¹è±¡ã€Mapã€äºŒç»´æ•°ç»„ç­‰ï¼‰
 * @returns {Map} Mapå¯¹è±¡
 * @example
 * asMap({a:1,b:2})       // Map(2) {"a"=>1,"b"=>2}
 * asMap([['a',1],['b',2]])// Map(2) {"a"=>1,"b"=>2}
 */
function asMap(a) {
    if (a instanceof Map) return a;
    var map = new Map();
    if (a === null || a === undefined) return map;
    if (Array.isArray(a)) {
        // äºŒç»´æ•°ç»„è½¬Map: [['key','value'],...]
        a.forEach(function(item) {
            if (Array.isArray(item) && item.length >= 2) {
                map.set(item[0], item[1]);
            }
        });
    } else if (typeof a === 'object') {
        // å¯¹è±¡è½¬Map
        for (var key in a) {
            if (a.hasOwnProperty(key)) {
                map.set(key, a[key]);
            }
        }
    }
    return map;
}

/**
 * asObjectå‡½æ•° - å°†å€¼è½¬æ¢ä¸ºæ™®é€šå¯¹è±¡
 * @param {any} a - è¦è½¬æ¢çš„å€¼ï¼ˆMapã€å¯¹è±¡ç­‰ï¼‰
 * @returns {Object} æ™®é€šå¯¹è±¡
 * @example
 * asObject(new Map([['a',1],['b',2]]))  // {a:1,b:2}
 * asObject({a:1})                        // {a:1}
 */
function asObject(a) {
    if (a instanceof Map) {
        var obj = {};
        a.forEach(function(value, key) {
            obj[key] = value;
        });
        return obj;
    }
    if (typeof a === 'object' && a !== null) {
        return a;
    }
    return {};
}

/**
 * asShapeå‡½æ•° - å°†å¯¹è±¡è½¬æ¢ä¸ºShapeå¯¹è±¡
 * @param {any} shp - è¦è½¬æ¢çš„å¯¹è±¡
 * @returns {Shape|null} Shapeå¯¹è±¡
 * @example
 * asShape('çŸ©å½¢ 2')  // Shapeå¯¹è±¡
 */
function asShape(shp) {
    if (!isWPS) return null;
    if (typeof shp === 'string') {
        // éå†æ‰€æœ‰å·¥ä½œè¡¨çš„å½¢çŠ¶
        for (var i = 1; i <= Sheets.Count; i++) {
            var sht = Sheets(i);
            for (var j = 1; j <= sht.Shapes.Count; j++) {
                if (sht.Shapes(j).Name === shp) return sht.Shapes(j);
                if (sht.Shapes(j).Name.indexOf(shp) !== -1) return sht.Shapes(j);
            }
        }
        return null;
    }
    if (shp && shp.Name) return shp;
    return null;
}

// ==================== [SHEETCHAIN] å·¥ä½œè¡¨é“¾å¼è°ƒç”¨ç±» ====================

/**
 * SheetChain - å·¥ä½œè¡¨é“¾å¼è°ƒç”¨åŒ…è£…ç±»ï¼ˆæ”¯æŒæ™ºèƒ½æç¤ºå’Œé“¾å¼è°ƒç”¨ï¼‰
 * @class
 * @constructor
 * @description åŒ…è£…WPSå·¥ä½œè¡¨å¯¹è±¡ï¼Œæä¾›é“¾å¼è°ƒç”¨å’Œæ™ºèƒ½æç¤º
 * @example
 * asSheet("Sheet1").zæ¿€æ´»().zåç§°()
 * asSheet(1).zå·²ä½¿ç”¨åŒºåŸŸ().zå®‰å…¨æ•°ç»„()
 */
function SheetChain(sht) {
    if (!(this instanceof SheetChain)) {
        return new SheetChain(sht);
    }
    this._sheet = null;

    // æ£€æŸ¥WPSç¯å¢ƒå’ŒSheetså¯ç”¨æ€§
    if (typeof Sheets === 'undefined') return;

    // å¦‚æœå·²ç»æ˜¯Sheetå¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨
    if (sht && sht.Activate && sht.Name) {
        this._sheet = sht;
        return;
    }

    if (typeof sht === 'number') {
        try {
            this._sheet = Sheets(sht);
        } catch (e) {
            this._sheet = null;
        }
        return;
    }

    if (typeof sht === 'string') {
        try {
            // é¦–å…ˆå°è¯•ç²¾ç¡®åŒ¹é…
            this._sheet = Sheets(sht);
        } catch (e) {
            // ç²¾ç¡®åŒ¹é…å¤±è´¥ï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…
            try {
                for (var i = 1; i <= Sheets.Count; i++) {
                    var sheet = Sheets(i);
                    // åŒ…å«åŒ¹é…
                    if (sheet.Name.indexOf(sht) >= 0) {
                        this._sheet = sheet;
                        return;
                    }
                    // å¿½ç•¥å¤§å°å†™åŒ¹é…
                    if (sheet.Name.toLowerCase() === sht.toLowerCase()) {
                        this._sheet = sheet;
                        return;
                    }
                }
            } catch (e2) {
                console.log("SheetChainæ¨¡ç³ŠåŒ¹é…å¤±è´¥: " + e2.message);
            }
            this._sheet = null;
        }
        return;
    }
}

/**
 * Value - è·å–åŸå§‹Sheetå¯¹è±¡
 * @returns {Worksheet|null} å·¥ä½œè¡¨å¯¹è±¡
 */
SheetChain.prototype.Value = function() {
    return this._sheet;
};

/**
 * Name - è·å–å·¥ä½œè¡¨åç§°
 * @returns {String} å·¥ä½œè¡¨åç§°
 */
SheetChain.prototype.zåç§° = function() {
    return this._sheet ? this._sheet.Name : '';
};
SheetChain.prototype.Name = SheetChain.prototype.zåç§°;

/**
 * Activate - æ¿€æ´»å·¥ä½œè¡¨
 * @returns {SheetChain} å½“å‰å®ä¾‹
 */
SheetChain.prototype.zæ¿€æ´» = function() {
    if (this._sheet) this._sheet.Activate();
    return this;
};
SheetChain.prototype.Activate = SheetChain.prototype.zæ¿€æ´»;

/**
 * UsedRange - è·å–å·²ä½¿ç”¨åŒºåŸŸ
 * @returns {RangeChain|null} RangeChainå¯¹è±¡
 */
SheetChain.prototype.zå·²ä½¿ç”¨åŒºåŸŸ = function() {
    if (!this._sheet) return null;
    try {
        return new RangeChain(this._sheet.UsedRange);
    } catch (e) {
        return null;
    }
};
SheetChain.prototype.UsedRange = SheetChain.prototype.zå·²ä½¿ç”¨åŒºåŸŸ;

/**
 * SafeUsedRange - è·å–å®‰å…¨å·²ä½¿ç”¨åŒºåŸŸï¼ˆå¤„ç†ç©ºè¡¨æƒ…å†µï¼‰
 * @returns {RangeChain|null} RangeChainå¯¹è±¡
 */
SheetChain.prototype.zå®‰å…¨å·²ä½¿ç”¨åŒºåŸŸ = function() {
    if (!this._sheet) return null;

    var usedRange;
    try {
        usedRange = this._sheet.UsedRange;
    } catch (e) {
        return new RangeChain(this._sheet.Range("A1"));
    }

    if (!usedRange) return new RangeChain(this._sheet.Range("A1"));

    var lastRow = usedRange.Row + usedRange.Rows.Count - 1;
    var lastCol = usedRange.Column + usedRange.Columns.Count - 1;

    return new RangeChain(this._sheet.Range(this._sheet.Cells(1, 1), this._sheet.Cells(lastRow, lastCol)));
};
SheetChain.prototype.SafeUsedRange = SheetChain.prototype.zå®‰å…¨å·²ä½¿ç”¨åŒºåŸŸ;

/**
 * Range - è·å–Rangeå¯¹è±¡
 * @param {String} address - åœ°å€
 * @returns {RangeChain|null} RangeChainå¯¹è±¡
 */
SheetChain.prototype.zåŒºåŸŸ = function(address) {
    if (!this._sheet) return null;
    try {
        return new RangeChain(this._sheet.Range(address));
    } catch (e) {
        return null;
    }
};
SheetChain.prototype.Range = SheetChain.prototype.zåŒºåŸŸ;

/**
 * Cells - è·å–Cellså¯¹è±¡
 * @param {Number} row - è¡Œå·
 * @param {Number} col - åˆ—å·
 * @returns {RangeChain|null} RangeChainå¯¹è±¡
 */
SheetChain.prototype.zå•å…ƒæ ¼ = function(row, col) {
    if (!this._sheet) return null;
    try {
        return new RangeChain(this._sheet.Cells(row, col));
    } catch (e) {
        return null;
    }
};
SheetChain.prototype.Cells = SheetChain.prototype.zå•å…ƒæ ¼;

/**
 * Delete - åˆ é™¤å·¥ä½œè¡¨
 * @returns {SheetChain} å½“å‰å®ä¾‹
 */
SheetChain.prototype.zåˆ é™¤ = function() {
    if (this._sheet) {
        try {
            this._sheet.Delete();
        } catch (e) {
            console.log("åˆ é™¤å·¥ä½œè¡¨å¤±è´¥: " + e.message);
        }
    }
    return this;
};
SheetChain.prototype.Delete = SheetChain.prototype.zåˆ é™¤;

/**
 * Copy - å¤åˆ¶å·¥ä½œè¡¨
 * @param {Worksheet} [before] - åœ¨æ­¤å·¥ä½œè¡¨ä¹‹å‰æ’å…¥
 * @param {Worksheet} [after] - åœ¨æ­¤å·¥ä½œè¡¨ä¹‹åæ’å…¥
 * @returns {SheetChain} å½“å‰å®ä¾‹
 */
SheetChain.prototype.zå¤åˆ¶ = function(before, after) {
    if (!this._sheet) return this;
    try {
        if (before) {
            this._sheet.Copy(before);
        } else if (after) {
            this._sheet.Copy(undefined, after);
        } else {
            this._sheet.Copy();
        }
    } catch (e) {
        console.log("å¤åˆ¶å·¥ä½œè¡¨å¤±è´¥: " + e.message);
    }
    return this;
};
SheetChain.prototype.Copy = SheetChain.prototype.zå¤åˆ¶;

/**
 * Protect - ä¿æŠ¤å·¥ä½œè¡¨
 * @param {String} [password] - å¯†ç 
 * @returns {SheetChain} å½“å‰å®ä¾‹
 */
SheetChain.prototype.zä¿æŠ¤ = function(password) {
    if (!this._sheet) return this;
    try {
        if (password) {
            this._sheet.Protect(password);
        } else {
            this._sheet.Protect();
        }
    } catch (e) {
        console.log("ä¿æŠ¤å·¥ä½œè¡¨å¤±è´¥: " + e.message);
    }
    return this;
};
SheetChain.prototype.Protect = SheetChain.prototype.zä¿æŠ¤;

/**
 * Unprotect - å–æ¶ˆä¿æŠ¤å·¥ä½œè¡¨
 * @param {String} [password] - å¯†ç 
 * @returns {SheetChain} å½“å‰å®ä¾‹
 */
SheetChain.prototype.zå–æ¶ˆä¿æŠ¤ = function(password) {
    if (!this._sheet) return this;
    try {
        if (password) {
            this._sheet.Unprotect(password);
        } else {
            this._sheet.Unprotect();
        }
    } catch (e) {
        console.log("å–æ¶ˆä¿æŠ¤å·¥ä½œè¡¨å¤±è´¥: " + e.message);
    }
    return this;
};
SheetChain.prototype.Unprotect = SheetChain.prototype.zå–æ¶ˆä¿æŠ¤;

/**
 * éšè—å·¥ä½œè¡¨
 * @returns {SheetChain} å½“å‰å®ä¾‹
 */
SheetChain.prototype.zéšè— = function() {
    if (!this._sheet) return this;
    this._sheet.Visible = false;
    return this;
};

/**
 * æ˜¾ç¤ºå·¥ä½œè¡¨
 * @returns {SheetChain} å½“å‰å®ä¾‹
 */
SheetChain.prototype.zæ˜¾ç¤º = function() {
    if (!this._sheet) return this;
    this._sheet.Visible = true;
    return this;
};

/**
 * Index - è·å–å·¥ä½œè¡¨ç´¢å¼•
 * @returns {Number} å·¥ä½œè¡¨ç´¢å¼•
 */
SheetChain.prototype.zç´¢å¼• = function() {
    return this._sheet ? this._sheet.Index : 0;
};
SheetChain.prototype.Index = SheetChain.prototype.zç´¢å¼•;

/**
 * SetName - è®¾ç½®å·¥ä½œè¡¨åç§°
 * @param {String} newName - æ–°åç§°
 * @returns {SheetChain} å½“å‰å®ä¾‹
 */
SheetChain.prototype.zè®¾ç½®åç§° = function(newName) {
    if (this._sheet) {
        this._sheet.Name = newName;
    }
    return this;
};
SheetChain.prototype.SetName = SheetChain.prototype.zè®¾ç½®åç§°;

/**
 * Exists - åˆ¤æ–­å·¥ä½œè¡¨æ˜¯å¦å­˜åœ¨
 * @returns {Boolean} æ˜¯å¦å­˜åœ¨
 */
SheetChain.prototype.zå­˜åœ¨ = function() {
    return this._sheet !== null;
};
SheetChain.prototype.Exists = SheetChain.prototype.zå­˜åœ¨;

// ==================== [TYPE_CONVERT] ç±»å‹è½¬æ¢å‡½æ•°ï¼ˆasSheet, asWorkbookï¼‰====================

/**
 * asSheetå‡½æ•° - å°†å¯¹è±¡è½¬æ¢ä¸ºSheetChainå¯¹è±¡ï¼ˆæ”¯æŒæ™ºèƒ½æç¤ºå’Œé“¾å¼è°ƒç”¨ï¼‰
 * @param {any} sht - è¦è½¬æ¢çš„å¯¹è±¡
 * @returns {SheetChain} SheetChainå®ä¾‹
 * @example
 * asSheet("1æœˆ").zæ¿€æ´»().zåç§°()
 * asSheet(1).zå·²ä½¿ç”¨åŒºåŸŸ().zå®‰å…¨æ•°ç»„()
 * asSheet().zæ¿€æ´»()
 */
function asSheet(sht) {
    return new SheetChain(sht);
}

/**
 * asWorkbookå‡½æ•° - å°†å¯¹è±¡è½¬æ¢ä¸ºå·¥ä½œç°¿å¯¹è±¡
 * @param {any} wbk - è¦è½¬æ¢çš„å¯¹è±¡
 * @returns {Workbook} å·¥ä½œç°¿å¯¹è±¡
 * @example
 * asWorkbook("æµ‹è¯•æ’åº")  // å·¥ä½œç°¿å¯¹è±¡
 */
function asWorkbook(wbk) {
    if (!isWPS) return null;
    if (typeof wbk === 'string') {
        for (var i = 1; i <= Workbooks.Count; i++) {
            if (Workbooks(i).Name === wbk) return Workbooks(i);
        }
        return null;
    }
    if (wbk && wbk.Name) return wbk;
    return null;
}

// ==================== As - ç±»å‹è½¬æ¢åŒ…è£…ç±» ====================

/**
 * Asç±» - ç±»å‹è½¬æ¢åŒ…è£…ç±»ï¼ˆæ”¯æŒæ™ºèƒ½æç¤ºå’Œé“¾å¼è°ƒç”¨ï¼‰
 * @class
 * @constructor
 * @description æä¾›ç±»å‹è½¬æ¢å’Œå¸¸ç”¨æ“ä½œæ–¹æ³•ï¼Œæ”¯æŒä¸­è‹±åŒè¯­API
 * @example
 * // åŸºæœ¬ä½¿ç”¨
 * As([[1,2,3],[4,5,6]]).toArray().zæ±‚å’Œ()        // 21
 * As("123").toNumber()                           // 123
 * As(123).toString()                             // "123"
 * // é“¾å¼è°ƒç”¨
 * As([[1,2],[3,4]]).toArray().zè½¬ç½®().zæ‰å¹³åŒ–().val()  // [1,3,2,4]
 */
function As(value) {
    // æ”¯æŒå·¥å‚æ¨¡å¼è°ƒç”¨
    if (!(this instanceof As)) {
        return new As(value);
    }

    this._original = value;
    this._value = value;
}

/**
 * åˆ›å»ºæ–°å®ä¾‹ï¼ˆé“¾å¼è°ƒç”¨æ ¸å¿ƒï¼‰
 * @private
 * @param {any} data - æ–°å€¼
 * @returns {As} æ–°å®ä¾‹
 */
As.prototype._new = function(value) {
    const instance = new As();
    instance._original = this._original;
    instance._value = value;
    return instance;
};

/**
 * è·å–/è®¾ç½®å½“å‰å€¼
 * @param {any} [newValue] - æ–°å€¼ï¼ˆå¯é€‰ï¼‰
 * @returns {As|any} è®¾ç½®æ—¶è¿”å›thisï¼Œå¦åˆ™è¿”å›å½“å‰å€¼
 * @example
 * As(123).val()           // 123
 * As(123).val(456)        // è¿”å›é“¾å¼å¯¹è±¡
 */
As.prototype.val = function(newValue) {
    if (newValue !== undefined) {
        this._value = newValue;
        return this;
    }
    return this._value;
};

// ==================== [AS] ç±»å‹è½¬æ¢åŒ…è£…ç±» ====================

/**
 * è½¬æ¢ä¸ºæ•°ç»„
 * @returns {Array2D} äºŒç»´æ•°ç»„å·¥å…·å¯¹è±¡ï¼ˆå¦‚æœæ˜¯äºŒç»´æ•°ç»„ï¼‰æˆ– AsåŒ…è£…å¯¹è±¡
 * @example
 * As([1,2,3]).toArray()              // [1,2,3]
 * As("a,b,c").toArray()              // ["a","b","c"]
 * As([[1,2],[3,4]]).toArray()        // Array2Då¯¹è±¡ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨
 */
As.prototype.toArray = function() {
    const arr = asArray(this._value);
    // å¦‚æœæ˜¯äºŒç»´æ•°ç»„ï¼Œè¿”å› Array2D å¯¹è±¡ä»¥è·å¾—æ›´å¤šåŠŸèƒ½
    if (arr.length > 0 && Array.isArray(arr[0])) {
        return Array2D(arr);
    }
    return this._new(arr);
};

/**
 * è½¬æ¢ä¸ºæ•°å­—
 * @returns {As} åŒ…è£…å¯¹è±¡
 * @example
 * As("123").toNumber().val()         // 123
 * As("abc").toNumber().val()         // 0
 */
As.prototype.toNumber = function() {
    return this._new(asNumber(this._value));
};

/**
 * è½¬æ¢ä¸ºå­—ç¬¦ä¸²
 * @returns {As} åŒ…è£…å¯¹è±¡
 * @example
 * As(123).toString().val()           // "123"
 * As(null).toString().val()          // ""
 */
As.prototype.toString = function() {
    return this._new(asString(this._value));
};

/**
 * è½¬æ¢ä¸ºæ—¥æœŸ
 * @returns {As} åŒ…è£…å¯¹è±¡
 * @example
 * As("2023-9-1").toDate().val()      // Dateå¯¹è±¡
 * As(45170).toDate().val()           // Dateå¯¹è±¡
 */
As.prototype.toDate = function() {
    return this._new(asDate(this._value));
};

/**
 * è½¬æ¢ä¸ºMapå¯¹è±¡
 * @returns {As} åŒ…è£…å¯¹è±¡
 * @example
 * As({a:1,b:2}).toMap().val()        // Mapå¯¹è±¡
 */
As.prototype.toMap = function() {
    return this._new(asMap(this._value));
};

/**
 * è½¬æ¢ä¸ºæ™®é€šå¯¹è±¡
 * @returns {As} åŒ…è£…å¯¹è±¡
 * @example
 * const map = new Map([['a',1]]);
 * As(map).toObject().val()           // {a:1}
 */
As.prototype.toObject = function() {
    return this._new(asObject(this._value));
};

/**
 * è½¬æ¢ä¸ºRangeå¯¹è±¡ï¼ˆWPSç¯å¢ƒï¼‰
 * @returns {As|null} åŒ…è£…å¯¹è±¡æˆ–null
 * @example
 * As("A1:C10").toRange().val()       // Rangeå¯¹è±¡
 */
As.prototype.toRange = function() {
    const rng = asRange(this._value);
    return rng !== null ? this._new(rng) : null;
};

/**
 * è½¬æ¢ä¸ºå·¥ä½œè¡¨å¯¹è±¡ï¼ˆWPSç¯å¢ƒï¼‰
 * @returns {As|null} åŒ…è£…å¯¹è±¡æˆ–null
 * @example
 * As("Sheet1").toSheet().val()       // Worksheetå¯¹è±¡
 */
As.prototype.toSheet = function() {
    const sht = asSheet(this._value);
    return sht !== null ? this._new(sht) : null;
};

/**
 * è½¬æ¢ä¸ºå·¥ä½œç°¿å¯¹è±¡ï¼ˆWPSç¯å¢ƒï¼‰
 * @returns {As|null} åŒ…è£…å¯¹è±¡æˆ–null
 * @example
 * As("å·¥ä½œç°¿1.xlsx").toWorkbook().val()  // Workbookå¯¹è±¡
 */
As.prototype.toWorkbook = function() {
    const wbk = asWorkbook(this._value);
    return wbk !== null ? this._new(wbk) : null;
};

// ==================== [TYPE_CONVERT] è¾…åŠ©å‡½æ•°ï¼ˆcdate, cstrï¼‰====================
As.prototype.zè½¬æ•°ç»„ = As.prototype.toArray;
As.prototype.zè½¬æ•°å­— = As.prototype.toNumber;
As.prototype.zè½¬å­—ç¬¦ä¸² = As.prototype.toString;
As.prototype.zè½¬æ—¥æœŸ = As.prototype.toDate;
As.prototype.zè½¬Map = As.prototype.toMap;
As.prototype.zè½¬å¯¹è±¡ = As.prototype.toObject;

/**
 * cdateå‡½æ•° - å°†æ—¥æœŸè½¬æ¢ä¸ºExcelæ—¥æœŸæ•°å€¼
 * @param {any} v - æ—¥æœŸå­—ç¬¦ä¸²æˆ–JSæ—¥æœŸå¯¹è±¡
 * @returns {Number} Excelæ—¥æœŸæ•°å€¼
 * @example
 * cdate('2023-9-1')  // 45170
 */
function cdate(v) {
    if (typeof v === 'number') return v;
    var date;
    if (typeof v === 'string') {
        // å¤„ç†ç®€çŸ­æ—¥æœŸæ ¼å¼
        if (v.match(/^\d{1,2}-\d{1,2}$/)) {
            v = '20' + v;  // 23-9-1 -> 2023-9-1
        }
        date = new Date(v);
    } else if (v instanceof Date) {
        date = v;
    } else {
        return 0;
    }
    var excelEpoch = new Date(1900, 0, 1);
    var msPerDay = 24 * 60 * 60 * 1000;
    return Math.floor((date - excelEpoch) / msPerDay) + 2;
}

/**
 * cstrå‡½æ•° - å°†å€¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²
 * @param {any} v - è¦è½¬æ¢çš„å€¼
 * @returns {String} å­—ç¬¦ä¸²
 * @example
 * cstr(1537789)  // "1537789"
 */
const cstr = (v) => v === null || v === undefined ? '' : String(v);

// ==================== [TYPE_CHECK] ç±»å‹æ£€æŸ¥å‡½æ•°ï¼ˆisç³»åˆ—ï¼‰ ====================

/**
 * isArrayå‡½æ•° - æ£€æŸ¥å€¼æ˜¯å¦ä¸ºæ•°ç»„
 * @param {any} v - è¦æ£€æŸ¥çš„å€¼
 * @returns {Boolean} æ˜¯å¦ä¸ºæ•°ç»„
 * @example
 * isArray([1,2,3])  // true
 */
const isArray = (v) => Array.isArray(v);

/**
 * isArray2Då‡½æ•° - æ£€æŸ¥å€¼æ˜¯å¦ä¸ºäºŒç»´æ•°ç»„
 * @param {any} v - è¦æ£€æŸ¥çš„å€¼
 * @returns {Boolean} æ˜¯å¦ä¸ºäºŒç»´æ•°ç»„
 * @example
 * isArray2D([[1],[2],[3]])  // true
 */
const isArray2D = (v) => {
    if (!Array.isArray(v)) return false;
    if (v.length === 0) return false;
    return v.every(row => Array.isArray(row));
};

/**
 * isBooleanå‡½æ•° - æ£€æŸ¥å€¼æ˜¯å¦ä¸ºå¸ƒå°”å€¼
 * @param {any} v - è¦æ£€æŸ¥çš„å€¼
 * @returns {Boolean} æ˜¯å¦ä¸ºå¸ƒå°”å€¼
 * @example
 * isBoolean(false)  // true
 */
const isBoolean = (v) => typeof v === 'boolean';

/**
 * isCollectionå‡½æ•° - æ£€æŸ¥å¯¹è±¡æ˜¯å¦ä¸ºé›†åˆå¯¹è±¡
 * @param {any} obj - è¦æ£€æŸ¥çš„å¯¹è±¡
 * @returns {Boolean} æ˜¯å¦ä¸ºé›†åˆå¯¹è±¡
 * @example
 * isCollection(Sheets)  // true
 */
const isCollection = (obj) => {
    if (!obj) return false;
    // æ£€æŸ¥æ˜¯å¦æ˜¯WPSé›†åˆå¯¹è±¡
    if (obj && typeof obj === 'object') {
        // WPSé›†åˆå¯¹è±¡é€šå¸¸æœ‰Countå’ŒItemå±æ€§
        if (obj.Count !== undefined && typeof obj.Item === 'unknown') return true;
        // æ£€æŸ¥æ˜¯å¦æœ‰æšä¸¾å™¨
        try {
            const enumerator = new Enumerator(obj);
            return true;
        } catch (e) {
            // ä¸æ˜¯é›†åˆ
        }
    }
    return false;
};

/**
 * isDateå‡½æ•° - æ£€æŸ¥å€¼æ˜¯å¦ä¸ºæ—¥æœŸå¯¹è±¡
 * @param {any} v - è¦æ£€æŸ¥çš„å€¼
 * @returns {Boolean} æ˜¯å¦ä¸ºæ—¥æœŸå¯¹è±¡
 * @example
 * isDate(new Date())  // true
 */
const isDate = (v) => v instanceof Date;

/**
 * isEmptyå‡½æ•° - æ£€æŸ¥å€¼æ˜¯å¦ä¸ºç©ºå€¼
 * @param {any} value - è¦æ£€æŸ¥çš„å€¼
 * @returns {Boolean} æ˜¯å¦ä¸ºç©ºå€¼
 * @example
 * isEmpty(undefined)  // true
 * isEmpty('')         // true
 * isEmpty(null)       // true
 */
const isEmpty = (value) => value === null || value === undefined || value === '';

/**
 * isNumbericå‡½æ•° - æ£€æŸ¥å€¼æ˜¯å¦ä¸ºæ•°å€¼ç±»å‹
 * @param {any} v - è¦æ£€æŸ¥çš„å€¼
 * @returns {Boolean} æ˜¯å¦ä¸ºæ•°å€¼ç±»å‹
 * @example
 * isNumberic(557)  // true
 */
const isNumberic = (v) => typeof v === 'number' && !isNaN(v);

/**
 * isRangeå‡½æ•° - æ£€æŸ¥å€¼æ˜¯å¦ä¸ºRangeå¯¹è±¡
 * @param {any} v - è¦æ£€æŸ¥çš„å€¼
 * @returns {Boolean} æ˜¯å¦ä¸ºRangeå¯¹è±¡
 * @example
 * isRange(Range("A1"))  // true
 */
const isRange = (v) => isWPS && v && typeof v === 'object' && v.Address !== undefined;

/**
 * isRegexå‡½æ•° - æ£€æŸ¥å€¼æ˜¯å¦ä¸ºæ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡
 * @param {any} v - è¦æ£€æŸ¥çš„å€¼
 * @returns {Boolean} æ˜¯å¦ä¸ºæ­£åˆ™è¡¨è¾¾å¼
 * @example
 * isRegex(/\d+/g)  // true
 */
const isRegex = (v) => v instanceof RegExp;

/**
 * isSameClasså‡½æ•° - æ£€æŸ¥ä¸¤ä¸ªå€¼æ˜¯å¦å±äºåŒä¸€ç±»åˆ«
 * @param {any} x - ç¬¬ä¸€ä¸ªå¯¹è±¡
 * @param {any} y - ç¬¬äºŒä¸ªå¯¹è±¡
 * @returns {Boolean} æ˜¯å¦å±äºåŒä¸€ç±»åˆ«
 * @example
 * isSameClass(560, 789)  // true
 */
const isSameClass = (x, y) => Object.prototype.toString.call(x) === Object.prototype.toString.call(y);

/**
 * isSheetå‡½æ•° - æ£€æŸ¥å€¼æ˜¯å¦ä¸ºå·¥ä½œè¡¨å¯¹è±¡
 * @param {any} v - è¦æ£€æŸ¥çš„å€¼
 * @returns {Boolean} æ˜¯å¦ä¸ºå·¥ä½œè¡¨å¯¹è±¡
 * @example
 * isSheet(Sheets(1))  // true
 */
const isSheet = (v) => isWPS && v && typeof v === 'object' && v.Name !== undefined && v.Cells !== undefined;

/**
 * isStringå‡½æ•° - æ£€æŸ¥å€¼æ˜¯å¦ä¸ºå­—ç¬¦ä¸²ç±»å‹
 * @param {any} v - è¦æ£€æŸ¥çš„å€¼
 * @returns {Boolean} æ˜¯å¦ä¸ºå­—ç¬¦ä¸²
 * @example
 * isString('äº§å“5')  // true
 */
const isString = (v) => typeof v === 'string';

/**
 * isWorkbookå‡½æ•° - æ£€æŸ¥å€¼æ˜¯å¦ä¸ºå·¥ä½œç°¿å¯¹è±¡
 * @param {any} v - è¦æ£€æŸ¥çš„å€¼
 * @returns {Boolean} æ˜¯å¦ä¸ºå·¥ä½œç°¿å¯¹è±¡
 * @example
 * isWorkbook(ActiveWorkbook)  // true
 */
const isWorkbook = (v) => isWPS && v && typeof v === 'object' && v.Name !== undefined && v.Sheets !== undefined && v.Close !== undefined;

/**
 * typeNameå‡½æ•° - è·å–å€¼çš„ç±»å‹åç§°
 * @param {any} x - è¦è·å–ç±»å‹åç§°çš„å€¼
 * @returns {String} ç±»å‹åç§°
 * @example
 * typeName('äº§å“5')  // "[object String]"
 */
const typeName = (x) => Object.prototype.toString.call(x);

// ==================== [GLOBAL_FUNCS] å…¶ä»–å·¥å…·å‡½æ•°ï¼ˆval, roundï¼‰====================

/**
 * valå‡½æ•° - å­—ç¬¦ä¸²åŠå¸ƒå°”å€¼è½¬ä¸ºæ•°å€¼ï¼ˆä¸VBAçš„valä¿æŒä¸€è‡´ï¼‰
 * @param {String} s - è¦è½¬æ¢çš„å­—ç¬¦ä¸²
 * @returns {Number} æ•°å€¼
 * @example
 * val('5')      // 5
 * val('123abc') // 123
 * val('abc123') // 0
 */
const val = (s) => {
    if (typeof s === 'number') return s;
    if (typeof s === 'boolean') return s ? 1 : 0;
    if (typeof s !== 'string') return 0;
    s = s.trim();
    if (s === '') return 0;
    // VBAçš„valè¡Œä¸ºï¼šè¯»å–å­—ç¬¦ä¸²å¼€å¤´çš„æ•°å­—å­—ç¬¦
    const match = s.match(/^[-+]?[0-9]*\.?[0-9]+/);
    if (match) return parseFloat(match[0]);
    return 0;
};

/**
 * roundå‡½æ•° - ä½¿ç”¨Excelè®¡ç®—è§„åˆ™å¯¹æ•°å­—è¿›è¡Œå››èˆäº”å…¥
 * @param {number} number - è¦è¿›è¡Œå››èˆäº”å…¥çš„æ•°å­—
 * @param {number} [decimals=2] - ä¿ç•™çš„å°æ•°ä½æ•°ï¼ˆé»˜è®¤ä¸º2ï¼‰
 * @returns {number} å››èˆäº”å…¥åçš„ç»“æœ
 * @example
 * round(5.786543224, 3)  // 5.787
 */
const round = (number, decimals = 2) => {
    // ä½¿ç”¨Excelçš„RoundWorksheetFunctionç¡®ä¿ä¸Excelè¡Œä¸ºä¸€è‡´
    if (isWPS && typeof WorksheetFunction.Round !== 'undefined') {
        try {
            return WorksheetFunction.Round(number, decimals);
        } catch (e) {
            // é™çº§å¤„ç†
        }
    }
    // æ ‡å‡†å››èˆäº”å…¥
    const factor = Math.pow(10, decimals);
    return Math.round(number * factor) / factor;
};

// uboundå‡½æ•° - è·å–æ•°ç»„çš„æŒ‡å®šç»´åº¦çš„ä¸Šç•Œ
// åœ¨å¯¼å‡ºéƒ¨åˆ†å®šä¹‰ä»¥é¿å…WPSæ‰“å°å‡½æ•°å®šä¹‰

// ==================== [RANGECHAIN] Rangeé“¾å¼è°ƒç”¨ç±» ====================

/**
 * RangeChain - Rangeé“¾å¼è°ƒç”¨åŒ…è£…ç±»ï¼ˆæ”¯æŒæ™ºèƒ½æç¤ºå’Œé“¾å¼è°ƒç”¨ï¼‰
 * @private
 * @class
 * @constructor
 * @description æ”¯æŒRangeæ–¹æ³•çš„é“¾å¼è°ƒç”¨å’Œæ™ºèƒ½æç¤º
 * @example
 * $.maxRange("A1:J1").safeArray()     // é“¾å¼è°ƒç”¨
 * $(5, 2).zå€¼()                       // è·å–ç¬¬5è¡Œç¬¬2åˆ—çš„å€¼
 * $(5, 2).zå€¼("æ–°å€¼").zåŠ ç²—()         // é“¾å¼è®¾ç½®
 */
function RangeChain(rng, colIndex) {
    if (!(this instanceof RangeChain)) {
        return new RangeChain(rng, colIndex);
    }
    this._range = null;

    // ä¸¤ä¸ªå‚æ•°æ¨¡å¼ï¼šRangeChain(è¡Œå·, åˆ—å·)
    if (typeof rng === 'number' && typeof colIndex === 'number') {
        this._range = isWPS ? Cells(rng, colIndex) : null;
    }
    // å­—ç¬¦ä¸²åœ°å€æ¨¡å¼
    else if (typeof rng === 'string') {
        this._range = isWPS ? Range(rng) : null;
    }
    // Rangeå¯¹è±¡æ¨¡å¼
    else if (rng && rng.Address) {
        this._range = rng;
    }
}

/**
 * Value - è·å–åŸå§‹Rangeå¯¹è±¡
 * @returns {Range|null} Rangeå¯¹è±¡
 */
RangeChain.prototype.Value = function() {
    return this._range;
};

/**
 * Value2 - è·å–/è®¾ç½®å€¼ï¼ˆValue2å±æ€§ï¼‰
 * @param {any} [newValue] - æ–°å€¼ï¼ˆå¯é€‰ï¼‰
 * @returns {RangeChain|any} è®¾ç½®æ—¶è¿”å›thisï¼Œå¦åˆ™è¿”å›å½“å‰å€¼
 */
RangeChain.prototype.zå€¼ = function(newValue) {
    if (newValue !== undefined) {
        if (this._range) this._range.Value2 = newValue;
        return this;
    }
    return this._range ? this._range.Value2 : undefined;
};
RangeChain.prototype.Value2 = RangeChain.prototype.zå€¼;

/**
 * CurrentRegion - è·å–å½“å‰åŒºåŸŸï¼ˆè¿ç»­æ•°æ®åŒºåŸŸï¼‰
 * @returns {RangeChain|null} å½“å‰åŒºåŸŸçš„RangeChainå¯¹è±¡
 */
RangeChain.prototype.zå½“å‰åŒºåŸŸ = function() {
    if (!this._range) return null;
    try {
        return new RangeChain(this._range.CurrentRegion);
    } catch (e) {
        return null;
    }
};
RangeChain.prototype.CurrentRegion = RangeChain.prototype.zå½“å‰åŒºåŸŸ;

/**
 * safeArray - è½¬æ¢ä¸ºå®‰å…¨æ•°ç»„ï¼ˆè¿”å› Array2D å¯¹è±¡ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ï¼‰
 * @returns {Array2D} Array2D å¯¹è±¡ï¼Œæ”¯æŒ filter/map/toRange ç­‰é“¾å¼è°ƒç”¨
 */
RangeChain.prototype.zå®‰å…¨æ•°ç»„ = function() {
    return RngUtils.zå®‰å…¨æ•°ç»„(this._range);
};
RangeChain.prototype.safeArray = RangeChain.prototype.zå®‰å…¨æ•°ç»„;

/**
 * VisibleArray - è½¬æ¢å¯è§åŒºåŸŸä¸ºæ•°ç»„
 * @param {Worksheet} [tempSheet] - ä¸´æ—¶å·¥ä½œè¡¨
 * @returns {Array} æ•°ç»„
 */
RangeChain.prototype.zå¯è§åŒºæ•°ç»„ = function(tempSheet) {
    return RngUtils.zå¯è§åŒºæ•°ç»„(this._range, tempSheet);
};
RangeChain.prototype.VisibleArray = RangeChain.prototype.zå¯è§åŒºæ•°ç»„;

/**
 * RowsCount - è·å–è¡Œæ•°
 * @returns {number} è¡Œæ•°
 */
RangeChain.prototype.zè¡Œæ•° = function() {
    return this._range ? this._range.Rows.Count : 0;
};
RangeChain.prototype.RowsCount = RangeChain.prototype.zè¡Œæ•°;

/**
 * ColsCount - è·å–åˆ—æ•°
 * @returns {number} åˆ—æ•°
 */
RangeChain.prototype.zåˆ—æ•° = function() {
    return this._range ? this._range.Columns.Count : 0;
};
RangeChain.prototype.ColsCount = RangeChain.prototype.zåˆ—æ•°;

/**
 * Columns - è·å–åˆ—é›†åˆ
 * @returns {Range} Rangeå¯¹è±¡çš„Columnså±æ€§
 */
Object.defineProperty(RangeChain.prototype, 'Columns', {
    get: function() {
        return this._range ? this._range.Columns : null;
    },
    enumerable: true,
    configurable: true
});

/**
 * Rows - è·å–è¡Œé›†åˆ
 * @returns {Range} Rangeå¯¹è±¡çš„Rowså±æ€§
 */
Object.defineProperty(RangeChain.prototype, 'Rows', {
    get: function() {
        return this._range ? this._range.Rows : null;
    },
    enumerable: true,
    configurable: true
});

/**
 * Font - è·å–å­—ä½“å¯¹è±¡
 * @returns {Font} Fontå¯¹è±¡
 */
Object.defineProperty(RangeChain.prototype, 'Font', {
    get: function() {
        return this._range ? this._range.Font : null;
    },
    enumerable: true,
    configurable: true
});

/**
 * Interior - è·å–å†…éƒ¨å¯¹è±¡ï¼ˆèƒŒæ™¯è‰²ç­‰ï¼‰
 * @returns {Interior} Interiorå¯¹è±¡
 */
Object.defineProperty(RangeChain.prototype, 'Interior', {
    get: function() {
        return this._range ? this._range.Interior : null;
    },
    enumerable: true,
    configurable: true
});

/**
 * Address - è·å–åœ°å€
 * @returns {string} åœ°å€
 */
RangeChain.prototype.zåœ°å€ = function() {
    return this._range ? this._range.Address() : '';
};
RangeChain.prototype.Address = RangeChain.prototype.zåœ°å€;

/**
 * AddBorders - æ·»åŠ è¾¹æ¡†
 * @param {number} [lineStyle=1] - çº¿æ¡æ ·å¼
 * @param {number} [weight=2] - çº¿æ¡ç²—ç»†
 * @returns {RangeChain} å½“å‰å®ä¾‹
 */
RangeChain.prototype.zåŠ è¾¹æ¡† = function(lineStyle, weight) {
    if (this._range) {
        RngUtils.zåŠ è¾¹æ¡†(this._range, lineStyle, weight);
    }
    return this;
};
RangeChain.prototype.AddBorders = RangeChain.prototype.zåŠ è¾¹æ¡†;

/**
 * AutoFitColumns - è‡ªåŠ¨åˆ—å®½
 * @returns {RangeChain} å½“å‰å®ä¾‹
 */
RangeChain.prototype.zè‡ªåŠ¨åˆ—å®½ = function() {
    if (this._range) {
        this._range.Columns.AutoFit();
    }
    return this;
};
RangeChain.prototype.AutoFitColumns = RangeChain.prototype.zè‡ªåŠ¨åˆ—å®½;

/**
 * AutoFitRows - è‡ªåŠ¨è¡Œé«˜
 * @returns {RangeChain} å½“å‰å®ä¾‹
 */
RangeChain.prototype.zè‡ªåŠ¨è¡Œé«˜ = function() {
    if (this._range) {
        this._range.Rows.AutoFit();
    }
    return this;
};
RangeChain.prototype.AutoFitRows = RangeChain.prototype.zè‡ªåŠ¨è¡Œé«˜;

/**
 * ClearContents - æ¸…é™¤å†…å®¹
 * @returns {RangeChain} å½“å‰å®ä¾‹
 */
RangeChain.prototype.zæ¸…é™¤å†…å®¹ = function() {
    if (this._range) {
        this._range.ClearContents();
    }
    return this;
};
RangeChain.prototype.ClearContents = RangeChain.prototype.zæ¸…é™¤å†…å®¹;

/**
 * ClearFormats - æ¸…é™¤æ ¼å¼
 * @returns {RangeChain} å½“å‰å®ä¾‹
 */
RangeChain.prototype.zæ¸…é™¤æ ¼å¼ = function() {
    if (this._range) {
        this._range.ClearFormats();
    }
    return this;
};
RangeChain.prototype.ClearFormats = RangeChain.prototype.zæ¸…é™¤æ ¼å¼;

/**
 * Value2 - è·å–/è®¾ç½®å€¼ï¼ˆValue2å±æ€§ï¼Œæ¯”Valueæ›´å¿«ï¼‰
 * @param {any} [newValue] - æ–°å€¼ï¼ˆå¯é€‰ï¼‰
 * @returns {RangeChain|any} è®¾ç½®æ—¶è¿”å›thisï¼Œå¦åˆ™è¿”å›å½“å‰å€¼
 * @example
 * $(5, 2).zå€¼()                    // è·å–å€¼
 * $(5, 2).zå€¼("æ–°å€¼")              // è®¾ç½®å€¼
 * $(5, 2).zå€¼("æ–°å€¼").zåŠ ç²—()      // é“¾å¼è°ƒç”¨
 */
// æ³¨æ„ï¼šzå€¼ æ–¹æ³•å·²åœ¨ç¬¬5734è¡Œå®šä¹‰ï¼Œæ­¤å¤„åˆ é™¤é‡å¤å®šä¹‰ä»¥é¿å…è¦†ç›–

// ä½¿ç”¨å±æ€§æ–¹å¼å®šä¹‰ Value2ï¼Œæ”¯æŒ $(i,2).Value2 = rs è¯­æ³•
Object.defineProperty(RangeChain.prototype, 'Value2', {
    get: function() {
        return this._range ? this._range.Value2 : undefined;
    },
    set: function(newValue) {
        if (this._range) this._range.Value2 = newValue;
    },
    enumerable: true,
    configurable: true
});

/**
 * Formula - è·å–/è®¾ç½®å…¬å¼
 * @param {string} [newFormula] - æ–°å…¬å¼ï¼ˆå¯é€‰ï¼‰
 * @returns {RangeChain|string} è®¾ç½®æ—¶è¿”å›thisï¼Œå¦åˆ™è¿”å›å…¬å¼
 */
RangeChain.prototype.zå…¬å¼ = function(newFormula) {
    if (newFormula !== undefined) {
        if (this._range) this._range.Formula = newFormula;
        return this;
    }
    return this._range ? this._range.Formula : '';
};

// ä½¿ç”¨å±æ€§æ–¹å¼å®šä¹‰ Formula
Object.defineProperty(RangeChain.prototype, 'Formula', {
    get: function() {
        return this._range ? this._range.Formula : '';
    },
    set: function(newFormula) {
        if (this._range) this._range.Formula = newFormula;
    },
    enumerable: true,
    configurable: true
});

/**
 * Text - è·å–æ˜¾ç¤ºæ–‡æœ¬
 * @returns {string} æ˜¾ç¤ºæ–‡æœ¬
 */
RangeChain.prototype.zæ–‡æœ¬ = function() {
    return this._range ? this._range.Text : '';
};

// ä½¿ç”¨å±æ€§æ–¹å¼å®šä¹‰ Textï¼ˆåªè¯»ï¼‰
Object.defineProperty(RangeChain.prototype, 'Text', {
    get: function() {
        return this._range ? this._range.Text : '';
    },
    enumerable: true,
    configurable: true
});

/**
 * Row - è·å–è¡Œå·
 * @returns {number} è¡Œå·
 */
RangeChain.prototype.zè¡Œ = function() {
    return this._range ? this._range.Row : 0;
};

// ä½¿ç”¨å±æ€§æ–¹å¼å®šä¹‰ Rowï¼ˆåªè¯»ï¼‰
Object.defineProperty(RangeChain.prototype, 'Row', {
    get: function() {
        return this._range ? this._range.Row : 0;
    },
    enumerable: true,
    configurable: true
});

/**
 * Column - è·å–åˆ—å·
 * @returns {number} åˆ—å·
 */
RangeChain.prototype.zåˆ— = function() {
    return this._range ? this._range.Column : 0;
};

// ä½¿ç”¨å±æ€§æ–¹å¼å®šä¹‰ Columnï¼ˆåªè¯»ï¼‰
Object.defineProperty(RangeChain.prototype, 'Column', {
    get: function() {
        return this._range ? this._range.Column : 0;
    },
    enumerable: true,
    configurable: true
});

/**
 * Select - é€‰ä¸­åŒºåŸŸ
 * @returns {RangeChain} å½“å‰å®ä¾‹
 */
RangeChain.prototype.zé€‰ä¸­ = function() {
    if (this._range) this._range.Select();
    return this;
};
RangeChain.prototype.Select = RangeChain.prototype.zé€‰ä¸­;

/**
 * Activate - æ¿€æ´»å•å…ƒæ ¼
 * @returns {RangeChain} å½“å‰å®ä¾‹
 */
RangeChain.prototype.zæ¿€æ´» = function() {
    if (this._range) this._range.Activate();
    return this;
};
RangeChain.prototype.Activate = RangeChain.prototype.zæ¿€æ´»;

/**
 * Bold - è·å–/è®¾ç½®åŠ ç²—
 * @param {boolean} [isBold] - æ˜¯å¦åŠ ç²—ï¼ˆå¯é€‰ï¼‰
 * @returns {RangeChain|boolean} è®¾ç½®æ—¶è¿”å›thisï¼Œå¦åˆ™è¿”å›åŠ ç²—çŠ¶æ€
 */
RangeChain.prototype.zåŠ ç²— = function(isBold) {
    if (isBold !== undefined) {
        if (this._range) this._range.Font.Bold = isBold;
        return this;
    }
    return this._range ? this._range.Font.Bold : false;
};

// ä½¿ç”¨å±æ€§æ–¹å¼å®šä¹‰ Bold
Object.defineProperty(RangeChain.prototype, 'Bold', {
    get: function() {
        return this._range ? this._range.Font.Bold : false;
    },
    set: function(isBold) {
        if (this._range) this._range.Font.Bold = isBold;
    },
    enumerable: true,
    configurable: true
});

/**
 * Italic - è·å–/è®¾ç½®æ–œä½“
 * @param {boolean} [isItalic] - æ˜¯å¦æ–œä½“ï¼ˆå¯é€‰ï¼‰
 * @returns {RangeChain|boolean} è®¾ç½®æ—¶è¿”å›thisï¼Œå¦åˆ™è¿”å›æ–œä½“çŠ¶æ€
 */
RangeChain.prototype.zæ–œä½“ = function(isItalic) {
    if (isItalic !== undefined) {
        if (this._range) this._range.Font.Italic = isItalic;
        return this;
    }
    return this._range ? this._range.Font.Italic : false;
};

// ä½¿ç”¨å±æ€§æ–¹å¼å®šä¹‰ Italic
Object.defineProperty(RangeChain.prototype, 'Italic', {
    get: function() {
        return this._range ? this._range.Font.Italic : false;
    },
    set: function(isItalic) {
        if (this._range) this._range.Font.Italic = isItalic;
    },
    enumerable: true,
    configurable: true
});

/**
 * FontColor - è·å–/è®¾ç½®å­—ä½“é¢œè‰²
 * @param {number} [color] - RGBé¢œè‰²å€¼ï¼ˆå¯é€‰ï¼‰
 * @returns {RangeChain|number} è®¾ç½®æ—¶è¿”å›thisï¼Œå¦åˆ™è¿”å›é¢œè‰²å€¼
 */
RangeChain.prototype.zå­—ä½“é¢œè‰² = function(color) {
    if (color !== undefined) {
        if (this._range) this._range.Font.Color = color;
        return this;
    }
    return this._range ? this._range.Font.Color : 0;
};

// ä½¿ç”¨å±æ€§æ–¹å¼å®šä¹‰ FontColor
Object.defineProperty(RangeChain.prototype, 'FontColor', {
    get: function() {
        return this._range ? this._range.Font.Color : 0;
    },
    set: function(color) {
        if (this._range) this._range.Font.Color = color;
    },
    enumerable: true,
    configurable: true
});

/**
 * FontSize - è·å–/è®¾ç½®å­—ä½“å¤§å°
 * @param {number} [size] - å­—ä½“å¤§å°ï¼ˆå¯é€‰ï¼‰
 * @returns {RangeChain|number} è®¾ç½®æ—¶è¿”å›thisï¼Œå¦åˆ™è¿”å›å­—ä½“å¤§å°
 */
RangeChain.prototype.zå­—å· = function(size) {
    if (size !== undefined) {
        if (this._range) this._range.Font.Size = size;
        return this;
    }
    return this._range ? this._range.Font.Size : 11;
};

// ä½¿ç”¨å±æ€§æ–¹å¼å®šä¹‰ FontSize
Object.defineProperty(RangeChain.prototype, 'FontSize', {
    get: function() {
        return this._range ? this._range.Font.Size : 11;
    },
    set: function(size) {
        if (this._range) this._range.Font.Size = size;
    },
    enumerable: true,
    configurable: true
});

/**
 * FontName - è·å–/è®¾ç½®å­—ä½“åç§°
 * @param {string} [fontName] - å­—ä½“åç§°ï¼ˆå¯é€‰ï¼‰
 * @returns {RangeChain|string} è®¾ç½®æ—¶è¿”å›thisï¼Œå¦åˆ™è¿”å›å­—ä½“åç§°
 */
RangeChain.prototype.zå­—ä½“åç§° = function(fontName) {
    if (fontName !== undefined) {
        if (this._range) this._range.Font.Name = fontName;
        return this;
    }
    return this._range ? this._range.Font.Name : '';
};

// ä½¿ç”¨å±æ€§æ–¹å¼å®šä¹‰ FontName
Object.defineProperty(RangeChain.prototype, 'FontName', {
    get: function() {
        return this._range ? this._range.Font.Name : '';
    },
    set: function(fontName) {
        if (this._range) this._range.Font.Name = fontName;
    },
    enumerable: true,
    configurable: true
});

/**
 * InteriorColor - è·å–/è®¾ç½®èƒŒæ™¯é¢œè‰²
 * @param {number} [color] - RGBé¢œè‰²å€¼ï¼ˆå¯é€‰ï¼‰
 * @returns {RangeChain|number} è®¾ç½®æ—¶è¿”å›thisï¼Œå¦åˆ™è¿”å›é¢œè‰²å€¼
 */
RangeChain.prototype.zèƒŒæ™¯é¢œè‰² = function(color) {
    if (color !== undefined) {
        if (this._range) this._range.Interior.Color = color;
        return this;
    }
    return this._range ? this._range.Interior.Color : 16777215; // é»˜è®¤ç™½è‰²
};

// ä½¿ç”¨å±æ€§æ–¹å¼å®šä¹‰ InteriorColor
Object.defineProperty(RangeChain.prototype, 'InteriorColor', {
    get: function() {
        return this._range ? this._range.Interior.Color : 16777215;
    },
    set: function(color) {
        if (this._range) this._range.Interior.Color = color;
    },
    enumerable: true,
    configurable: true
});

/**
 * HorizontalAlignment - è·å–/è®¾ç½®æ°´å¹³å¯¹é½
 * @param {number} [align] - å¯¹é½æ–¹å¼ï¼ˆå¯é€‰ï¼‰
 * @returns {RangeChain|number} è®¾ç½®æ—¶è¿”å›thisï¼Œå¦åˆ™è¿”å›å¯¹é½æ–¹å¼
 */
RangeChain.prototype.zæ°´å¹³å¯¹é½ = function(align) {
    if (align !== undefined) {
        if (this._range) this._range.HorizontalAlignment = align;
        return this;
    }
    return this._range ? this._range.HorizontalAlignment : -4151; // é»˜è®¤å¸¸è§„
};

// ä½¿ç”¨å±æ€§æ–¹å¼å®šä¹‰ HorizontalAlignment
Object.defineProperty(RangeChain.prototype, 'HorizontalAlignment', {
    get: function() {
        return this._range ? this._range.HorizontalAlignment : -4151;
    },
    set: function(align) {
        if (this._range) this._range.HorizontalAlignment = align;
    },
    enumerable: true,
    configurable: true
});

/**
 * VerticalAlignment - è·å–/è®¾ç½®å‚ç›´å¯¹é½
 * @param {number} [align] - å¯¹é½æ–¹å¼ï¼ˆå¯é€‰ï¼‰
 * @returns {RangeChain|number} è®¾ç½®æ—¶è¿”å›thisï¼Œå¦åˆ™è¿”å›å¯¹é½æ–¹å¼
 */
RangeChain.prototype.zå‚ç›´å¯¹é½ = function(align) {
    if (align !== undefined) {
        if (this._range) this._range.VerticalAlignment = align;
        return this;
    }
    return this._range ? this._range.VerticalAlignment : -4160; // é»˜è®¤åº•éƒ¨
};

// ä½¿ç”¨å±æ€§æ–¹å¼å®šä¹‰ VerticalAlignment
Object.defineProperty(RangeChain.prototype, 'VerticalAlignment', {
    get: function() {
        return this._range ? this._range.VerticalAlignment : -4160;
    },
    set: function(align) {
        if (this._range) this._range.VerticalAlignment = align;
    },
    enumerable: true,
    configurable: true
});

/**
 * NumberFormat - è·å–/è®¾ç½®æ•°å­—æ ¼å¼
 * @param {string} [format] - æ ¼å¼å­—ç¬¦ä¸²ï¼ˆå¯é€‰ï¼‰
 * @returns {RangeChain|string} è®¾ç½®æ—¶è¿”å›thisï¼Œå¦åˆ™è¿”å›æ ¼å¼å­—ç¬¦ä¸²
 */
RangeChain.prototype.zæ•°å­—æ ¼å¼ = function(format) {
    if (format !== undefined) {
        if (this._range) this._range.NumberFormat = format;
        return this;
    }
    return this._range ? this._range.NumberFormat : 'General';
};

// ä½¿ç”¨å±æ€§æ–¹å¼å®šä¹‰ NumberFormat
Object.defineProperty(RangeChain.prototype, 'NumberFormat', {
    get: function() {
        return this._range ? this._range.NumberFormat : 'General';
    },
    set: function(format) {
        if (this._range) this._range.NumberFormat = format;
    },
    enumerable: true,
    configurable: true
});

/**
 * WrapText - è·å–/è®¾ç½®è‡ªåŠ¨æ¢è¡Œ
 * @param {boolean} [wrap] - æ˜¯å¦è‡ªåŠ¨æ¢è¡Œï¼ˆå¯é€‰ï¼‰
 * @returns {RangeChain|boolean} è®¾ç½®æ—¶è¿”å›thisï¼Œå¦åˆ™è¿”å›æ¢è¡ŒçŠ¶æ€
 */
RangeChain.prototype.zè‡ªåŠ¨æ¢è¡Œ = function(wrap) {
    if (wrap !== undefined) {
        if (this._range) this._range.WrapText = wrap;
        return this;
    }
    return this._range ? this._range.WrapText : false;
};

// ä½¿ç”¨å±æ€§æ–¹å¼å®šä¹‰ WrapText
Object.defineProperty(RangeChain.prototype, 'WrapText', {
    get: function() {
        return this._range ? this._range.WrapText : false;
    },
    set: function(wrap) {
        if (this._range) this._range.WrapText = wrap;
    },
    enumerable: true,
    configurable: true
});

/**
 * Merge - åˆå¹¶å•å…ƒæ ¼
 * @returns {RangeChain} å½“å‰å®ä¾‹
 */
RangeChain.prototype.zåˆå¹¶ = function() {
    if (this._range) this._range.Merge();
    return this;
};
RangeChain.prototype.Merge = RangeChain.prototype.zåˆå¹¶;

/**
 * Clear - æ¸…é™¤å†…å®¹å’Œæ ¼å¼
 * @returns {RangeChain} å½“å‰å®ä¾‹
 * @example
 * $("K2").Resize(1000, 5000).Clear()
 * $.Resize("K2", 1000, 5000).Clear()
 */
RangeChain.prototype.Clear = function() {
    if (this._range) {
        // WPS JSA å…¼å®¹ï¼šä½¿ç”¨ ClearContents å’Œ ClearFormats
        try {
            this._range.ClearContents();
        } catch (e) {}
        try {
            this._range.ClearFormats();
        } catch (e) {}
    }
    return this;
};

/**
 * zæ¸…é™¤ - Clearçš„ä¸­æ–‡åˆ«å
 */
RangeChain.prototype.zæ¸…é™¤ = RangeChain.prototype.Clear;

/**
 * UnMerge - å–æ¶ˆåˆå¹¶å•å…ƒæ ¼
 * @returns {RangeChain} å½“å‰å®ä¾‹
 */
RangeChain.prototype.zå–æ¶ˆåˆå¹¶ = function() {
    if (this._range) this._range.UnMerge();
    return this;
};
RangeChain.prototype.UnMerge = RangeChain.prototype.zå–æ¶ˆåˆå¹¶;

/**
 * Resize - è°ƒæ•´åŒºåŸŸå¤§å°
 * @param {number} rows - è¡Œæ•°
 * @param {number} cols - åˆ—æ•°
 * @returns {RangeChain} è°ƒæ•´å¤§å°åçš„æ–°RangeChainå¯¹è±¡
 * @example
 * $("K2").Resize(10, 5).zæ¸…é™¤å†…å®¹()
 * $("K2").Resize(1000, 5000).zæ¸…é™¤å†…å®¹()
 */
RangeChain.prototype.Resize = function(rows, cols) {
    if (!this._range) return new RangeChain(null);
    try {
        var resizedRng = this._range.Resize(rows, cols);
        return new RangeChain(resizedRng);
    } catch (e) {
        console.log("Resizeå¤±è´¥: " + e.message);
        return this;
    }
};

/**
 * MergeCells - æ£€æŸ¥æ˜¯å¦ä¸ºåˆå¹¶å•å…ƒæ ¼
 * @returns {boolean} æ˜¯å¦åˆå¹¶
 */
RangeChain.prototype.zå·²åˆå¹¶ = function() {
    return this._range ? this._range.MergeCells : false;
};

// ä½¿ç”¨å±æ€§æ–¹å¼å®šä¹‰ MergeCellsï¼ˆåªè¯»ï¼‰
Object.defineProperty(RangeChain.prototype, 'MergeCells', {
    get: function() {
        return this._range ? this._range.MergeCells : false;
    },
    enumerable: true,
    configurable: true
});

/**
 * Delete - åˆ é™¤åŒºåŸŸ
 * @param {number} [shift] - ç§»åŠ¨æ–¹å‘ï¼ˆå¯é€‰ï¼‰
 * @returns {RangeChain} å½“å‰å®ä¾‹
 */
RangeChain.prototype.zåˆ é™¤ = function(shift) {
    if (this._range) this._range.Delete(shift);
    return this;
};
RangeChain.prototype.Delete = RangeChain.prototype.zåˆ é™¤;

/**
 * Insert - æ’å…¥åŒºåŸŸ
 * @param {number} [shift] - ç§»åŠ¨æ–¹å‘ï¼ˆå¯é€‰ï¼‰
 * @returns {RangeChain} å½“å‰å®ä¾‹
 */
RangeChain.prototype.zæ’å…¥ = function(shift) {
    if (this._range) this._range.Insert(shift);
    return this;
};
RangeChain.prototype.Insert = RangeChain.prototype.zæ’å…¥;

/**
 * Copy - å¤åˆ¶åŒºåŸŸ
 * @param {Range} [destination] - ç›®æ ‡åŒºåŸŸï¼ˆå¯é€‰ï¼‰
 * @returns {RangeChain} å½“å‰å®ä¾‹
 */
RangeChain.prototype.zå¤åˆ¶ = function(destination) {
    if (this._range) {
        if (destination) {
            this._range.Copy(destination);
        } else {
            this._range.Copy();
        }
    }
    return this;
};
RangeChain.prototype.Copy = RangeChain.prototype.zå¤åˆ¶;

/**
 * Paste - ç²˜è´´åŒºåŸŸ
 * @param {Range} [destination] - ç›®æ ‡åŒºåŸŸï¼ˆå¯é€‰ï¼‰
 * @param {number} [type] - ç²˜è´´ç±»å‹ï¼ˆå¯é€‰ï¼‰
 * @returns {RangeChain} å½“å‰å®ä¾‹
 */
RangeChain.prototype.zç²˜è´´ = function(destination, type) {
    if (destination && destination.Paste) {
        destination.Paste(type);
    }
    return this;
};
RangeChain.prototype.Paste = RangeChain.prototype.zç²˜è´´;

/**
 * åˆ›å»ºRngUtilsé™æ€æ–¹æ³•ä»£ç†å¯¹è±¡
 * @private
 */
function createRngUtilsProxy() {
    var proxy = {};
    var staticMethods = [
        'zæœ€åä¸€ä¸ª', 'lastCell',
        'zå®‰å…¨åŒºåŸŸ', 'safeRange',
        'zå®‰å…¨æ•°ç»„', 'safeArray',
        'zæœ€å¤§è¡Œ', 'endRow',
        'zæœ€å¤§è¡Œå•å…ƒæ ¼', 'endRowCell',
        'zæœ€å¤§è¡ŒåŒºåŸŸ', 'maxRange',
        'zæœ€å¤§åˆ—', 'endCol',
        'zæœ€å¤§åˆ—å•å…ƒæ ¼', 'endColCell',
        'zå¯è§åŒºæ•°ç»„', 'visibleArray',
        'zå¯è§åŒºåŸŸ', 'visibleRange',
        'zåŠ è¾¹æ¡†', 'addBorders',
        'zå–å‰å‡ è¡Œ', 'takeRows',
        'zè·³è¿‡å‰å‡ è¡Œ', 'skipRows',
        'zæ’å…¥å¤šè¡Œ', 'insertRows',
        'zæ’å…¥å¤šåˆ—', 'insertCols',
        'zåˆ é™¤ç©ºç™½è¡Œ', 'delBlankRows',
        'zåˆ é™¤ç©ºç™½åˆ—', 'delBlankCols',
        'zæ•´è¡Œ', 'entireRow',
        'zæ•´åˆ—', 'entire_column',
        'zè¡Œæ•°', 'rowsCount',
        'zåˆ—æ•°', 'colsCount',
        'zåˆ—å·å­—æ¯äº’è½¬', 'colToAbc',
        'zå¤åˆ¶ç²˜è´´æ ¼å¼', 'copyFormat',
        'zå¤åˆ¶ç²˜è´´å€¼', 'copyValue',
        'zè”åˆåŒºåŸŸ', 'unionAll',
        'zå¤šåˆ—æ’åº', 'rngSortCols'
    ];

    for (var i = 0; i < staticMethods.length; i++) {
        var methodName = staticMethods[i];
        if (RngUtils[methodName]) {
            (function(name) {
                proxy[name] = function() {
                    var result = RngUtils[name].apply(RngUtils, arguments);
                    // å¦‚æœè¿”å›çš„æ˜¯Rangeå¯¹è±¡ï¼ŒåŒ…è£…æˆRangeChainæ”¯æŒé“¾å¼è°ƒç”¨
                    if (result && result.Address && typeof result.Address === 'function') {
                        return new RangeChain(result);
                    }
                    return result;
                };
            })(methodName);
        }
    }

    return proxy;
}

/**
 * $å‡½æ•° - Rangeå¿«æ·æ–¹å¼å’ŒRngUtilsæ–¹æ³•ä»£ç†ï¼ˆæ”¯æŒæ™ºèƒ½æç¤ºå’Œé“¾å¼è°ƒç”¨ï¼‰
 * @param {string|number} x - åœ°å€æˆ–è¡Œå·
 * @param {number} [y] - åˆ—å·ï¼ˆå¯é€‰ï¼Œå½“ä¼ å…¥ä¸¤ä¸ªæ•°å­—å‚æ•°æ—¶ï¼‰
 * @returns {RangeChain} RangeChainåŒ…è£…å¯¹è±¡ï¼Œæ”¯æŒæ™ºèƒ½æç¤ºå’Œé“¾å¼è°ƒç”¨
 * @example
 * $("A1")                          // è¿”å›RangeChainï¼Œæ”¯æŒé“¾å¼è°ƒç”¨
 * $(5, 2)                          // ç¬¬5è¡Œç¬¬2åˆ—ï¼Œè¿”å›RangeChain
 * $(5, 2).zå€¼()                    // è·å–å€¼
 * $(5, 2).zå€¼("æ–°å€¼")              // è®¾ç½®å€¼
 * $(5, 2).zå€¼("æ–°å€¼").zåŠ ç²—()      // é“¾å¼è°ƒç”¨
 * $.maxRange("A1:J1").safeArray()  // é“¾å¼è°ƒç”¨
 */
function $(x, y) {
    // ä¸¤ä¸ªå‚æ•°æ¨¡å¼ï¼š$(è¡Œ, åˆ—) - è¿”å›RangeChain
    if (arguments.length === 2 && typeof x === 'number' && typeof y === 'number') {
        return new RangeChain(x, y);
    }
    // å•ä¸ªå‚æ•°æ¨¡å¼ - è¿”å›RangeChain
    if (typeof x === 'string') {
        return new RangeChain(x);
    } else if (typeof x === 'number') {
        return new RangeChain(x, 1);
    } else if (x && x.Address) {
        return new RangeChain(x);
    }
    // è¿”å›ç©ºçš„RangeChain
    return new RangeChain(null);
}

// ==================== [SHORTCUT_$] å°†å¸¸ç”¨é™æ€æ–¹æ³•æ·»åŠ åˆ° $ å¯¹è±¡ ====================
// ç›´æ¥å®šä¹‰ä»¥æ”¯æŒæ™ºèƒ½æç¤º

/**
 * $.maxRange - è·å–ä»ç¬¬ä¸€è¡Œåˆ°æœ€åä¸€è¡Œçš„åŒºåŸŸ
 * @param {Range|string} rng - è¦è·å–çš„åŒºåŸŸ
 * @param {string} [col="A"] - åˆ—å·
 * @returns {RangeChain} RangeChainå¯¹è±¡
 * @example
 * $.maxRange("A1:J1").safeArray()
 * $.maxRange("1:1000", "A").zåŠ è¾¹æ¡†()
 */
$.maxRange = function(rng, col) {
    var result = RngUtils.maxRange.apply(RngUtils, arguments);
    if (result && result.Address && typeof result.Address === 'function') {
        return new RangeChain(result);
    }
    return result;
};

/**
 * $.zæœ€å¤§è¡ŒåŒºåŸŸ - maxRangeçš„ä¸­æ–‡åˆ«å
 */
$.zæœ€å¤§è¡ŒåŒºåŸŸ = $.maxRange;

/**
 * $.safeArray - å°†åŒºåŸŸè½¬æ¢ä¸ºå®‰å…¨æ•°ç»„ï¼ˆè¿”å› Array2D å¯¹è±¡ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ï¼‰
 * @param {Range|string} rng - åŒºåŸŸ
 * @returns {Array2D} Array2D å¯¹è±¡ï¼Œæ”¯æŒ filter/map/toRange ç­‰é“¾å¼è°ƒç”¨
 */
$.safeArray = RngUtils.safeArray;

/**
 * $.zå®‰å…¨æ•°ç»„ - safeArrayçš„ä¸­æ–‡åˆ«å
 */
$.zå®‰å…¨æ•°ç»„ = $.safeArray;

/**
 * $.maxArray - è·å–ä»ç¬¬ä¸€è¡Œåˆ°æœ€å¤§è¡Œçš„åŒºåŸŸå¹¶è½¬æ¢ä¸ºæ•°ç»„ï¼ˆè¿”å› Array2D å¯¹è±¡ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ï¼‰
 * @param {Range|string} rng - è¦è·å–çš„åŒºåŸŸï¼ˆå¦‚ "A1:H1"ï¼‰
 * @param {string} [col="A"] - åˆ—å·ï¼Œå¦‚æœrngæ˜¯æ•´è¡Œæ—¶éœ€è¦æŒ‡å®š
 * @returns {Array2D} Array2D å¯¹è±¡ï¼Œæ”¯æŒ skip/take/filter/sortByCols/toRange ç­‰é“¾å¼è°ƒç”¨
 * @example
 * // åŸºæœ¬ç”¨æ³•ï¼šè·å– A1:H1 æ‰©å±•åˆ°æœ€å¤§è¡Œçš„æ•°ç»„
 * var arr = $.maxArray("A1:H1");
 * 
 * // é“¾å¼è°ƒç”¨ï¼šè·³è¿‡å‰3è¡Œï¼Œå–å‰10è¡Œï¼ŒæŒ‰ç¬¬2åˆ—æ’åºï¼Œç­›é€‰å¹´ä»½ä¸º2023çš„è¡Œï¼Œè¾“å‡ºåˆ°K4
 * $.maxArray("A1:H1")
 *   .skip(3)
 *   .take(10)
 *   .sortByCols('f2')
 *   .filter('f6==2023')
 *   .toRange("K4");
 * 
 * // ä½¿ç”¨é™æ€æ–¹æ³•å¤„ç†
 * var arr = $.maxArray("A1:H1");
 * var rs = Array2D.skip(arr, 3);
 * rs = Array2D.take(rs, 10);
 * rs = Array2D.sortByCols(rs, 'f2');
 * rs = Array2D.filter(rs, 'f6==2023');
 * Array2D.toRange(rs, "K4");
 */
$.maxArray = function(rng, col) {
    if (!isWPS) return new Array2D([]);
    // è·å–æœ€å¤§è¡ŒåŒºåŸŸ
    var maxRng = RngUtils.zæœ€å¤§è¡ŒåŒºåŸŸ.apply(RngUtils, arguments);
    if (!maxRng) return new Array2D([]);
    // è½¬æ¢ä¸º Array2D å¯¹è±¡
    return RngUtils.zå®‰å…¨æ•°ç»„(maxRng);
};

/**
 * $.zæœ€å¤§æ•°ç»„ - maxArrayçš„ä¸­æ–‡åˆ«å
 */
$.zæœ€å¤§æ•°ç»„ = $.maxArray;

/**
 * $.endRow - è·å–åŒºåŸŸæœ€å¤§è¡Œæ•°
 * @param {Range|string} rng - åŒºåŸŸ
 * @returns {number} è¡Œæ•°
 */
$.endRow = RngUtils.endRow;

/**
 * $.zæœ€å¤§è¡Œ - endRowçš„ä¸­æ–‡åˆ«å
 */
$.zæœ€å¤§è¡Œ = $.endRow;

/**
 * $.addBorders - æ·»åŠ è¾¹æ¡†
 * @param {Range|string} rng - åŒºåŸŸ
 * @param {number} [lineStyle=1] - çº¿æ¡æ ·å¼
 * @param {number} [weight=2] - çº¿æ¡ç²—ç»†
 * @returns {RangeChain} RangeChainå¯¹è±¡
 */
$.addBorders = function(rng, lineStyle, weight) {
    var result = RngUtils.addBorders.apply(RngUtils, arguments);
    if (result && result.Address && typeof result.Address === 'function') {
        return new RangeChain(result);
    }
    return result;
};

/**
 * $.zåŠ è¾¹æ¡† - addBordersçš„ä¸­æ–‡åˆ«å
 */
$.zåŠ è¾¹æ¡† = $.addBorders;

/**
 * $.autoFitColumns - è‡ªåŠ¨åˆ—å®½
 * @param {Range|string} rng - åŒºåŸŸ
 * @returns {RangeChain} RangeChainå¯¹è±¡
 */
$.autoFitColumns = function(rng) {
    var result = RngUtils.autoFitColumns.apply(RngUtils, arguments);
    if (result && result.Address && typeof result.Address === 'function') {
        return new RangeChain(result);
    }
    return result;
};

/**
 * $.zè‡ªåŠ¨åˆ—å®½ - autoFitColumnsçš„ä¸­æ–‡åˆ«å
 */
$.zè‡ªåŠ¨åˆ—å®½ = $.autoFitColumns;

/**
 * $.autoFitRows - è‡ªåŠ¨è¡Œé«˜
 * @param {Range|string} rng - åŒºåŸŸ
 * @returns {RangeChain} RangeChainå¯¹è±¡
 */
$.autoFitRows = function(rng) {
    var result = RngUtils.autoFitRows.apply(RngUtils, arguments);
    if (result && result.Address && typeof result.Address === 'function') {
        return new RangeChain(result);
    }
    return result;
};

/**
 * $.zè‡ªåŠ¨è¡Œé«˜ - autoFitRowsçš„ä¸­æ–‡åˆ«å
 */
$.zè‡ªåŠ¨è¡Œé«˜ = $.autoFitRows;

/**
 * $.delBlankRows - åˆ é™¤ç©ºç™½è¡Œ
 * @param {Range|string} rng - åŒºåŸŸ
 * @param {boolean} [entireColumn=false] - æ˜¯å¦åˆ é™¤æ•´è¡Œ
 * @returns {RangeChain} RangeChainå¯¹è±¡
 */
$.delBlankRows = function(rng, entireColumn) {
    RngUtils.delBlankRows.apply(RngUtils, arguments);
    return new RangeChain(rng);
};

/**
 * $.zåˆ é™¤ç©ºç™½è¡Œ - delBlankRowsçš„ä¸­æ–‡åˆ«å
 */
$.zåˆ é™¤ç©ºç™½è¡Œ = $.delBlankRows;

/**
 * $.delBlankCols - åˆ é™¤ç©ºç™½åˆ—
 * @param {Range|string} rng - åŒºåŸŸ
 * @param {boolean} [entireColumn=false] - æ˜¯å¦åˆ é™¤æ•´åˆ—
 * @returns {RangeChain} RangeChainå¯¹è±¡
 */
$.delBlankCols = function(rng, entireColumn) {
    RngUtils.delBlankCols.apply(RngUtils, arguments);
    return new RangeChain(rng);
};

/**
 * $.zåˆ é™¤ç©ºç™½åˆ— - delBlankColsçš„ä¸­æ–‡åˆ«å
 */
$.zåˆ é™¤ç©ºç™½åˆ— = $.delBlankCols;

/**
 * $.rngSortCols - å¤šåˆ—æ’åº
 * @param {Range|string} rng - åŒºåŸŸ
 * @param {Array} sortCols - æ’åºåˆ—æ•°ç»„
 * @returns {RangeChain} RangeChainå¯¹è±¡
 */
$.rngSortCols = function(rng, sortCols) {
    RngUtils.rngSortCols.apply(RngUtils, arguments);
    return new RangeChain(rng);
};

/**
 * $.zå¤šåˆ—æ’åº - rngSortColsçš„ä¸­æ–‡åˆ«å
 */
$.zå¤šåˆ—æ’åº = $.rngSortCols;

/**
 * $.colToAbc - åˆ—å·ä¸å­—æ¯äº’è½¬
 * @param {number|string} input - åˆ—å·æˆ–å­—æ¯
 * @returns {string|number} å­—æ¯æˆ–åˆ—å·
 */
$.colToAbc = RngUtils.colToAbc;

/**
 * $.zåˆ—å·å­—æ¯äº’è½¬ - colToAbcçš„ä¸­æ–‡åˆ«å
 */
$.zåˆ—å·å­—æ¯äº’è½¬ = $.colToAbc;

/**
 * $.rowsCount - è·å–è¡Œæ•°
 * @param {Range|string} rng - åŒºåŸŸ
 * @returns {number} è¡Œæ•°
 */
$.rowsCount = RngUtils.rowsCount;

/**
 * $.zè¡Œæ•° - rowsCountçš„ä¸­æ–‡åˆ«å
 */
$.zè¡Œæ•° = $.rowsCount;

/**
 * $.colsCount - è·å–åˆ—æ•°
 * @param {Range|string} rng - åŒºåŸŸ
 * @returns {number} åˆ—æ•°
 */
$.colsCount = RngUtils.colsCount;

/**
 * $.zåˆ—æ•° - colsCountçš„ä¸­æ–‡åˆ«å
 */
$.zåˆ—æ•° = $.colsCount;

/**
 * $.copyValue - å¤åˆ¶ç²˜è´´å€¼
 * @param {Range|string} fromRng - æºåŒºåŸŸ
 * @param {Range|string} toRng - ç›®æ ‡åŒºåŸŸ
 * @returns {RangeChain} RangeChainå¯¹è±¡
 */
$.copyValue = function(fromRng, toRng) {
    RngUtils.copyValue.apply(RngUtils, arguments);
    return new RangeChain(toRng);
};

/**
 * $.zå¤åˆ¶ç²˜è´´å€¼ - copyValueçš„ä¸­æ–‡åˆ«å
 */
$.zå¤åˆ¶ç²˜è´´å€¼ = $.copyValue;

/**
 * $.copyFormat - å¤åˆ¶ç²˜è´´æ ¼å¼
 * @param {Range|string} fromRng - æºåŒºåŸŸ
 * @param {Range|string} toRng - ç›®æ ‡åŒºåŸŸ
 * @returns {RangeChain} RangeChainå¯¹è±¡
 */
$.copyFormat = function(fromRng, toRng) {
    RngUtils.copyFormat.apply(RngUtils, arguments);
    return new RangeChain(toRng);
};

/**
 * $.zå¤åˆ¶ç²˜è´´æ ¼å¼ - copyFormatçš„ä¸­æ–‡åˆ«å
 */
$.zå¤åˆ¶ç²˜è´´æ ¼å¼ = $.copyFormat;

/**
 * $.Resize - è°ƒæ•´åŒºåŸŸå¤§å°ï¼ˆé™æ€æ–¹æ³•ï¼‰
 * @param {Range|string} rng - æºåŒºåŸŸ
 * @param {number} rows - è¡Œæ•°
 * @param {number} cols - åˆ—æ•°
 * @returns {RangeChain} è°ƒæ•´å¤§å°åçš„ RangeChain å¯¹è±¡
 * @example
 * $.Resize("K2", 1000, 5000).zæ¸…é™¤å†…å®¹()
 * $.Resize(Range("A1"), 10, 5).zåŠ è¾¹æ¡†()
 */
$.Resize = function(rng, rows, cols) {
    var targetRng = typeof rng === 'string' ? Range(rng) : rng;
    if (!targetRng) return new RangeChain(null);
    try {
        var resizedRng = targetRng.Resize(rows, cols);
        return new RangeChain(resizedRng);
    } catch (e) {
        console.log("Resizeå¤±è´¥: " + e.message);
        return new RangeChain(rng);
    }
};

/**
 * $.zè°ƒæ•´å¤§å° - Resizeçš„ä¸­æ–‡åˆ«å
 */
$.zè°ƒæ•´å¤§å° = $.Resize;

/**
 * $.ClearContents - æ¸…é™¤å†…å®¹ï¼ˆé™æ€æ–¹æ³•ï¼‰
 * @param {Range|string} rng - åŒºåŸŸ
 * @returns {RangeChain} RangeChainå¯¹è±¡
 * @example
 * $.ClearContents("K2").Resize(1000, 5000).zæ¸…é™¤å†…å®¹()
 */
$.ClearContents = function(rng) {
    var targetRng = typeof rng === 'string' ? Range(rng) : rng;
    if (targetRng) {
        targetRng.ClearContents();
    }
    return new RangeChain(targetRng);
};

/**
 * $.zæ¸…é™¤å†…å®¹ - ClearContentsçš„ä¸­æ–‡åˆ«å
 */
$.zæ¸…é™¤å†…å®¹ = $.ClearContents;

/**
 * $.UnMerge - å–æ¶ˆåˆå¹¶ï¼ˆé™æ€æ–¹æ³•ï¼‰
 * @param {Range|string} rng - åŒºåŸŸ
 * @returns {RangeChain} RangeChainå¯¹è±¡
 * @example
 * $.UnMerge("K2").Resize(1000, 1000).zå–æ¶ˆåˆå¹¶()
 */
$.UnMerge = function(rng) {
    var targetRng = typeof rng === 'string' ? Range(rng) : rng;
    if (targetRng) {
        targetRng.UnMerge();
    }
    return new RangeChain(targetRng);
};

/**
 * $.zå–æ¶ˆåˆå¹¶ - UnMergeçš„ä¸­æ–‡åˆ«å
 */
$.zå–æ¶ˆåˆå¹¶ = $.UnMerge;

// ==================== [SHORTCUT_$] å°† RngUtils æ–¹æ³•æ·»åŠ åˆ° $.RngUtils ====================
// æ”¯æŒç›´æ¥è°ƒç”¨ $.addBorders() è€Œä¸æ˜¯ $.RngUtils.addBorders()

// å®šä¹‰éœ€è¦ç›´æ¥æ·»åŠ åˆ° $ çš„å¸¸ç”¨æ–¹æ³•
var directMethods = [
    'zåŠ è¾¹æ¡†', 'addBorders',
    'zæ’å…¥å¤šè¡Œ', 'insertRows',
    'zæ’å…¥å¤šåˆ—', 'insertCols',
    'zåˆ é™¤ç©ºç™½è¡Œ', 'delBlankRows',
    'zåˆ é™¤ç©ºç™½åˆ—', 'delBlankCols',
    'zåˆå¹¶å•å…ƒæ ¼', 'mergeCells',
    'zå–æ¶ˆåˆå¹¶å•å…ƒæ ¼', 'unmergeCells'
];

for (var i = 0; i < directMethods.length; i++) {
    var methodName = directMethods[i];
    if (RngUtils[methodName]) {
        (function(name) {
            $[name] = function() {
                return RngUtils[name].apply(RngUtils, arguments);
            };
        })(methodName);
    }
}

// ==================== [SHORTCUT_$] å°†å·¥å…·ç±»å·¥å‚æ·»åŠ åˆ° $ å¯¹è±¡ ====================

/**
 * $.Array2D - äºŒç»´æ•°ç»„å·¥å…·ç±»å·¥å‚ï¼ˆæ”¯æŒæ™ºèƒ½æç¤ºå’Œé“¾å¼è°ƒç”¨ï¼‰
 * @param {Array} data - è¾“å…¥æ•°æ®
 * @returns {Array2D} Array2Då®ä¾‹ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨å’Œæ™ºèƒ½æç¤º
 * @example
 * $.Array2D([[1,2],[3,4]]).zæ±‚å’Œ()      // 10
 * $.Array2D([1,2,3]).zè½¬ç½®()           // [[1],[2],[3]]
 * $.Array2D([[1,2],[3,4]]).toRange("A1")  // å†™å…¥A1:B2
 */
$.Array2D = function(data) {
    return new Array2D(data);
};

/**
 * $.RngUtils - Rangeå·¥å…·ç±»å·¥å‚
 * @param {string|Range} [initialRange] - åˆå§‹Rangeï¼ˆå¯é€‰ï¼‰
 * @returns {RngUtils|Object} RngUtilså®ä¾‹æˆ–é™æ€æ–¹æ³•å¯¹è±¡
 * @example
 * $.RngUtils("A1:B10").zå®‰å…¨æ•°ç»„()    // å®ä¾‹æ–¹æ³•
 * $.RngUtils.maxRange("A1:J1")        // é™æ€æ–¹æ³•
 */
$.RngUtils = function(initialRange) {
    // æ— å‚æ•°è°ƒç”¨æ—¶ï¼Œè¿”å›é™æ€æ–¹æ³•ä»£ç†å¯¹è±¡
    if (arguments.length === 0) {
        return createRngUtilsStaticProxy();
    }
    return new RngUtils(initialRange);
};

// ==================== [SHORTCUT_$] æ·»åŠ  $.RngUtils é™æ€æ–¹æ³•ä»£ç† ====================
// æ”¯æŒæ™ºèƒ½æç¤ºå’Œ $.RngUtils.maxRange() è°ƒç”¨

/**
 * $.RngUtils.maxRange - è·å–ä»ç¬¬ä¸€è¡Œåˆ°æœ€åä¸€è¡Œçš„åŒºåŸŸ
 * @static
 * @param {Range|string} rng - è¦è·å–çš„åŒºåŸŸ
 * @param {string} [col="A"] - åˆ—å·ï¼Œå¦‚æœrngæ˜¯æ•´è¡Œæ—¶éœ€è¦æŒ‡å®š
 * @returns {RangeChain} RangeChainå¯¹è±¡ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨
 * @memberof $.RngUtils
 * @example
 * $.RngUtils.maxRange("1:1000","A").safeArray()  // è¿”å›æ•°ç»„
 * $.RngUtils.maxRange("A1:J1").zåŠ è¾¹æ¡†()         // é“¾å¼è°ƒç”¨
 */
$.RngUtils.maxRange = function(rng, col) {
    var result = RngUtils.maxRange.apply(RngUtils, arguments);
    if (result && result.Address && typeof result.Address === 'function') {
        return new RangeChain(result);
    }
    return result;
};

/**
 * $.RngUtils.safeArray - å°†æŒ‡å®šåŒºåŸŸè½¬æ¢ä¸ºå®‰å…¨äºŒç»´æ•°ç»„ï¼ˆè¿”å› Array2D å¯¹è±¡ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ï¼‰
 * @static
 * @param {Range|string} rng - è¦è½¬æ¢çš„åŒºåŸŸ
 * @returns {Array2D} Array2D å¯¹è±¡ï¼Œæ”¯æŒ filter/map/toRange ç­‰é“¾å¼è°ƒç”¨
 * @memberof $.RngUtils
 */
$.RngUtils.safeArray = RngUtils.safeArray;

/**
 * $.RngUtils.zå®‰å…¨æ•°ç»„ - å°†æŒ‡å®šåŒºåŸŸè½¬æ¢ä¸ºå®‰å…¨äºŒç»´æ•°ç»„ï¼ˆè¿”å› Array2D å¯¹è±¡ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ï¼‰
 * @static
 * @param {Range|string} rng - è¦è½¬æ¢çš„åŒºåŸŸ
 * @returns {Array2D} Array2D å¯¹è±¡ï¼Œæ”¯æŒ filter/map/toRange ç­‰é“¾å¼è°ƒç”¨
 * @memberof $.RngUtils
 */
$.RngUtils.zå®‰å…¨æ•°ç»„ = RngUtils.zå®‰å…¨æ•°ç»„;

/**
 * $.RngUtils.endRow - è·å–æŒ‡å®šåŒºåŸŸçš„æœ€å¤§è¡Œæ•°
 * @static
 * @param {Range|string} rng - è¦è·å–æœ€å¤§è¡Œæ•°çš„åŒºåŸŸ
 * @returns {number} æœ€å¤§è¡Œæ•°
 * @memberof $.RngUtils
 */
$.RngUtils.endRow = RngUtils.endRow;

/**
 * $.RngUtils.zæœ€å¤§è¡Œ - è·å–æŒ‡å®šåŒºåŸŸçš„æœ€å¤§è¡Œæ•°
 * @static
 * @param {Range|string} rng - è¦è·å–æœ€å¤§è¡Œæ•°çš„åŒºåŸŸ
 * @returns {number} æœ€å¤§è¡Œæ•°
 * @memberof $.RngUtils
 */
$.RngUtils.zæœ€å¤§è¡Œ = RngUtils.zæœ€å¤§è¡Œ;

/**
 * $.RngUtils.maxArray - è·å–ä»ç¬¬ä¸€è¡Œåˆ°æœ€å¤§è¡Œçš„åŒºåŸŸå¹¶è½¬æ¢ä¸ºæ•°ç»„ï¼ˆè¿”å› Array2D å¯¹è±¡ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨ï¼‰
 * @static
 * @param {Range|string} rng - è¦è·å–çš„åŒºåŸŸï¼ˆå¦‚ "A1:H1"ï¼‰
 * @param {string} [col="A"] - åˆ—å·ï¼Œå¦‚æœrngæ˜¯æ•´è¡Œæ—¶éœ€è¦æŒ‡å®š
 * @returns {Array2D} Array2D å¯¹è±¡ï¼Œæ”¯æŒ skip/take/filter/sortByCols/toRange ç­‰é“¾å¼è°ƒç”¨
 * @memberof $.RngUtils
 * @example
 * $.RngUtils.maxArray("A1:H1").skip(3).take(10).toRange("K4");
 */
$.RngUtils.maxArray = $.maxArray;

/**
 * $.RngUtils.zæœ€å¤§æ•°ç»„ - maxArrayçš„ä¸­æ–‡åˆ«å
 * @static
 * @memberof $.RngUtils
 */
$.RngUtils.zæœ€å¤§æ•°ç»„ = $.RngUtils.maxArray;

// å…¶ä»–å¸¸ç”¨é™æ€æ–¹æ³•ï¼ˆå¯æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤šï¼‰
var staticMethods = [
    'zæœ€åä¸€ä¸ª', 'lastCell',
    'zå®‰å…¨åŒºåŸŸ', 'safeRange',
    'zæœ€å¤§è¡Œå•å…ƒæ ¼', 'endRowCell',
    'zæœ€å¤§è¡ŒåŒºåŸŸ',
    'zæœ€å¤§åˆ—', 'endCol',
    'zæœ€å¤§åˆ—å•å…ƒæ ¼', 'endColCell',
    'zå¯è§åŒºæ•°ç»„', 'visibleArray',
    'zå¯è§åŒºåŸŸ', 'visibleRange',
    'zåŠ è¾¹æ¡†', 'addBorders',
    'zå–å‰å‡ è¡Œ', 'takeRows',
    'zè·³è¿‡å‰å‡ è¡Œ', 'skipRows',
    'zæ’å…¥å¤šè¡Œ', 'insertRows',
    'zæ’å…¥å¤šåˆ—', 'insertCols',
    'zåˆ é™¤ç©ºç™½è¡Œ', 'delBlankRows',
    'zåˆ é™¤ç©ºç™½åˆ—', 'delBlankCols',
    'zæ•´è¡Œ', 'entireRow',
    'zæ•´åˆ—', 'entire_column',
    'zè¡Œæ•°', 'rowsCount',
    'zåˆ—æ•°', 'colsCount',
    'zåˆ—å·å­—æ¯äº’è½¬', 'colToAbc',
    'zå¤åˆ¶ç²˜è´´æ ¼å¼', 'copyFormat',
    'zå¤åˆ¶ç²˜è´´å€¼', 'copyValue',
    'zè”åˆåŒºåŸŸ', 'unionAll',
    'zå¤šåˆ—æ’åº', 'rngSortCols'
];

for (var i = 0; i < staticMethods.length; i++) {
    var methodName = staticMethods[i];
    if (RngUtils[methodName]) {
        (function(name) {
            $.RngUtils[name] = function() {
                var result = RngUtils[name].apply(RngUtils, arguments);
                // å¦‚æœè¿”å›çš„æ˜¯Rangeå¯¹è±¡ï¼ŒåŒ…è£…æˆRangeChainæ”¯æŒé“¾å¼è°ƒç”¨
                if (result && result.Address && typeof result.Address === 'function') {
                    return new RangeChain(result);
                }
                return result;
            };
        })(methodName);
    }
}

/**
 * $.ShtUtils - Sheetå·¥å…·ç±»å·¥å‚
 * @param {Worksheet} initialSheet - åˆå§‹Sheet
 * @returns {ShtUtils} ShtUtilså®ä¾‹
 * @example
 * $.ShtUtils().zå½“å‰å·¥ä½œè¡¨()
 */
$.ShtUtils = function(initialSheet) {
    return new ShtUtils(initialSheet);
};

/**
 * $.DateUtils - æ—¥æœŸå·¥å…·ç±»å·¥å‚
 * @param {Date|string} initialDate - åˆå§‹æ—¥æœŸ
 * @returns {DateUtils} DateUtilså®ä¾‹
 * @example
 * $.DateUtils().zæ ¼å¼åŒ–("yyyy-MM-dd")
 */
$.DateUtils = function(initialDate) {
    return new DateUtils(initialDate);
};

// ==================== [EXPORTS] å…¨å±€å˜é‡ç»Ÿä¸€å¯¼å‡º ====================

// WPSç°ä»£ç‰ˆ - ä½¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°å¯¼å‡ºå…¨å±€å˜é‡ï¼Œæ”¯æŒES6+
(function() {
    (function() {
        this.Array2D = Array2D;

        this.As = As;
        this.RngUtils = RngUtils;
        this.ShtUtils = ShtUtils;
        this.DateUtils = DateUtils;
        this.JSA = JSA;
        this.IO = IO;
        this.$ = $;
        this.log = log;
        this.logjson = logjson;
        // Globalå‡½æ•°
        this.f1 = f1;
        this.$fx = $fx;
        this.$toArray = $toArray;
        // As å·²åœ¨ç¬¬6891è¡Œå¯¼å‡ºï¼Œæ­¤å¤„åˆ é™¤é‡å¤å®šä¹‰
        this.asArray = asArray;
        this.asDate = asDate;
        this.asMap = asMap;
        this.asNumber = asNumber;
        this.asObject = asObject;
        this.asRange = asRange;
        this.asShape = asShape;
        this.asSheet = asSheet;
        this.asString = asString;
        this.asWorkbook = asWorkbook;
        this.cdate = cdate;
        this.cstr = cstr;
        this.isArray = isArray;
        this.isArray2D = isArray2D;
        this.isBoolean = isBoolean;
        this.isCollection = isCollection;
        this.isDate = isDate;
        this.isEmpty = isEmpty;
        this.isNumberic = isNumberic;
        this.isRange = isRange;
        this.isRegex = isRegex;
        this.isSameClass = isSameClass;
        this.isSheet = isSheet;
        this.isString = isString;
        this.isWorkbook = isWorkbook;
        this.typeName = typeName;
        this.val = val;
        this.round = round;
        // uboundå‡½æ•° - è·å–æ•°ç»„çš„æŒ‡å®šç»´åº¦çš„ä¸Šç•Œ
        this.ubound = function(arr, dimension) {
            dimension = dimension || 1;
            if (!Array.isArray(arr)) return -1;
            if (dimension === 1) return arr.length - 1;
            if (dimension === 2) {
                var maxLen = 0;
                for (var i = 0; i < arr.length; i++) {
                    if (Array.isArray(arr[i]) && arr[i].length > maxLen) {
                        maxLen = arr[i].length;
                    }
                }
                return maxLen - 1;
            }
            return -1;
        };
        
        // ==================== JSA880å¿«æ·API - ä¸€è¡Œä»£ç èµ°å¤©ä¸‹ ====================
        
        /**
         * JSA880 - éƒ‘å¹¿å­¦JSA880å¿«é€Ÿå¼€å‘æ¡†æ¶ä¸»å…¥å£
         * @description æä¾›è¶…ç®€æ´çš„ä¸€è¡Œä»£ç APIï¼Œé›†æˆæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
         * @namespace
         * @example
         * // ä¸€è¡Œä»£ç å®Œæˆæ•°æ®é€è§†
         * JSA880.é€è§†(æ•°æ®, 'äº§å“+,æœˆä»½+', 'åœ°åŒº+', 'sum(é”€é‡),count()');
         * 
         * // ä¸€è¡Œä»£ç ç­›é€‰æ•°æ®
         * JSA880.ç­›é€‰(æ•°æ®, 'x=>x[0]=="åŒ—äº¬" && x[3]>100');
         * 
         * // ä¸€è¡Œä»£ç è¯»å–è¡¨æ ¼æ•°æ®
         * JSA880.è¯»è¡¨("A1:D100");
         * 
         * // ä¸€è¡Œä»£ç å†™å…¥è¡¨æ ¼æ•°æ®
         * JSA880.å†™è¡¨([[1,2],[3,4]], "G1");
         * 
         * // ä¸€è¡Œä»£ç è·å–æœ€å¤§è¡Œæ•°
         * JSA880.æœ€å¤§è¡Œ("A:A");
         * 
         * // ä¸€è¡Œä»£ç åˆ é™¤ç©ºç™½è¡Œ
         * JSA880.åˆ ç©ºè¡Œ("A1:F100");
         * 
         * // ä¸€è¡Œä»£ç æ’åº
         * JSA880.æ’åº(æ•°æ®, 'f3+,f4-');
         */ 
        this.JSA880 = {
            /**
             * æ•°æ®é€è§†ï¼ˆè¶…ç®€åŒ–ç‰ˆï¼‰
             * @param {Array} data - äºŒç»´æ•°ç»„æ•°æ®
             * @param {string} rowFields - è¡Œå­—æ®µï¼Œæ”¯æŒæ’åºç¬¦å· f1+,f2-
             * @param {string} colFields - åˆ—å­—æ®µï¼Œæ”¯æŒæ’åºç¬¦å· f3+,f4-
             * @param {string} dataFields - æ•°æ®å­—æ®µï¼Œæ ¼å¼: 'count(),sum(f5),average(f6)'
             * @param {number} [headerRows=1] - æ ‡é¢˜è¡Œæ•°
             * @returns {Array} é€è§†ç»“æœ
             * @example
             * JSA880.é€è§†(é”€å”®æ•°æ®, 'äº§å“+,åœ°åŒº-', 'æœˆä»½+', 'sum(é‡‘é¢),count()');
             */
            é€è§†: function(data, rowFields, colFields, dataFields, headerRows) {
                return Array2D.zè¶…çº§é€è§†(data, [rowFields], [colFields], [dataFields], headerRows);
            },
            
            /**
             * è¶…çº§é€è§†ï¼ˆå®Œæ•´ç‰ˆï¼‰
             */
            è¶…çº§é€è§†: Array2D.zè¶…çº§é€è§†,
            
            /**
             * æ•°æ®ç­›é€‰
             * @param {Array} data - äºŒç»´æ•°ç»„
             * @param {string|Function} predicate - ç­›é€‰æ¡ä»¶
             * @returns {Array2D} Array2Då¯¹è±¡
             * @example
             * JSA880.ç­›é€‰(æ•°æ®, 'x=>x[0]=="åŒ—äº¬" && x[3]>100');
             */
            ç­›é€‰: function(data, predicate) {
                return new Array2D(data).zç­›é€‰(predicate);
            },
            
            /**
             * å¤šæ¡ä»¶ç­›é€‰ï¼ˆç®€åŒ–ç‰ˆï¼‰
             * @param {Array} data - äºŒç»´æ•°ç»„
             * @param {Array} conditions - æ¡ä»¶æ•°ç»„ï¼Œå¦‚ [[0, 'åŒ—äº¬'], [3, 100]]
             * @returns {Array2D} Array2Då¯¹è±¡
             * @example
             * JSA880.å¤šæ¡ä»¶ç­›é€‰(æ•°æ®, [[0, 'åŒ—äº¬'], [3, 100]]);
             */
            å¤šæ¡ä»¶ç­›é€‰: function(data, conditions) {
                var arr = new Array2D(data);
                for (var i = 0; i < conditions.length; i++) {
                    var col = conditions[i][0];
                    var val = conditions[i][1];
                    arr = arr.zç­›é€‰(function(row) { 
                        return row[col] == val || (typeof val === 'number' && row[col] > val);
                    });
                }
                return arr;
            },
            
            /**
             * åˆ†ç»„æ±‡æ€»
             * @param {Array} data - äºŒç»´æ•°ç»„
             * @param {string} groupCol - åˆ†ç»„åˆ— f1
             * @param {string} aggCol - æ±‡æ€»åˆ— f2
             * @param {string} [aggType='sum'] - æ±‡æ€»ç±»å‹: sum, count, average, max, min
             * @returns {Array} æ±‡æ€»ç»“æœ
             * @example
             * JSA880.åˆ†ç»„æ±‡æ€»(æ•°æ®, 'f1', 'f3', 'sum');
             */
            åˆ†ç»„æ±‡æ€»: function(data, groupCol, aggCol, aggType) {
                aggType = aggType || 'sum';
                var aggExpr = aggType + '("' + aggCol + '")';
                return Array2D.zåˆ†ç»„æ±‡æ€»(data, groupCol, aggExpr);
            },
            
            /**
             * åˆ†ç»„æ±‡æ€»è¿æ¥ - ä¼˜åŒ–sumifså’ŒCountifsæ‰¹é‡æ¡ä»¶ç»Ÿè®¡
             * @param {Array} targetData - ç»Ÿè®¡ç›®æ ‡æ•°æ®ï¼ˆå·¦è¡¨ï¼‰
             * @param {Array} sourceData - æ•°æ®æºï¼ˆå³è¡¨ï¼‰
             * @param {string} groupKey - åˆ†ç»„é”®é€‰æ‹©å™¨ï¼Œå¦‚ 'f2' æˆ– 'f2,f3'
             * @param {string} aggFunc - æ±‡æ€»å‡½æ•°ï¼Œå¦‚ 'sum("f4")' æˆ– 'count(),sum("f5")'
             * @returns {Array} è¿æ¥æ±‡æ€»åçš„ç»“æœ
             * @example
             * // ä¸€è¡Œä»£ç å®Œæˆsumifs/countifsæ‰¹é‡ç»Ÿè®¡
             * JSA880.åˆ†ç»„æ±‡æ€»è¿æ¥(ç›®æ ‡è¡¨, æºæ•°æ®, 'f2', 'sum("f4")');
             * JSA880.åˆ†ç»„æ±‡æ€»è¿æ¥(ç›®æ ‡è¡¨, æºæ•°æ®, 'æœˆä»½,äº§å“', 'count(),sum("é”€é‡"),average("é‡‘é¢")');
             */
            åˆ†ç»„æ±‡æ€»è¿æ¥: function(targetData, sourceData, groupKey, aggFunc) {
                return Array2D.groupIntoJoin(targetData, sourceData, groupKey, aggFunc);
            },
            
            /**
             * è¯»å–è¡¨æ ¼æ•°æ®ï¼ˆç®€åŒ–ç‰ˆï¼‰
             * @param {string} range - å•å…ƒæ ¼åœ°å€ï¼Œå¦‚ "A1:D100" æˆ– "A:A"
             * @returns {Array} äºŒç»´æ•°ç»„
             * @example
             * JSA880.è¯»è¡¨("A1:D100");
             * JSA880.è¯»è¡¨("A:A");  // è¯»å–æ•´åˆ—åˆ°æœ€å¤§è¡Œ
             */
            è¯»è¡¨: function(range) {
                if (!isWPS) return [];
                var rng = typeof range === 'string' ? Range(range) : range;
                var arr = rng.Value2;
                if (arr === null || arr === undefined) return [];
                if (!Array.isArray(arr)) return [[arr]];
                if (!Array.isArray(arr[0])) {
                    var result = [];
                    for (var i = 0; i < arr.length; i++) {
                        result.push([arr[i]]);
                    }
                    return result;
                }
                return arr;
            },
            
            /**
             * å†™å…¥è¡¨æ ¼æ•°æ®ï¼ˆç®€åŒ–ç‰ˆï¼‰
             * @param {Array} data - äºŒç»´æ•°ç»„
             * @param {string} startCell - èµ·å§‹å•å…ƒæ ¼ï¼Œå¦‚ "A1"
             * @returns {Range} å†™å…¥çš„å•å…ƒæ ¼åŒºåŸŸ
             * @example
             * JSA880.å†™è¡¨([[1,2],[3,4]], "G1");
             */
            å†™è¡¨: function(data, startCell) {
                return JSA.zå†™å…¥å•å…ƒæ ¼(data, startCell);
            },
            
            /**
             * è·å–æœ€å¤§è¡Œæ•°
             * @param {string} column - åˆ—èŒƒå›´ï¼Œå¦‚ "A:A" æˆ– "A1"
             * @returns {number} æœ€å¤§è¡Œæ•°
             * @example
             * JSA880.æœ€å¤§è¡Œ("A:A");
             */
            æœ€å¤§è¡Œ: function(column) {
                return RngUtils.zæœ€å¤§è¡Œ(column);
            },
            
            /**
             * è·å–æœ€å¤§åˆ—æ•°
             * @param {string} row - è¡ŒèŒƒå›´ï¼Œå¦‚ "1:1" æˆ– "A1"
             * @returns {number} æœ€å¤§åˆ—æ•°
             * @example
             * JSA880.æœ€å¤§åˆ—("1:1");
             */
            æœ€å¤§åˆ—: function(row) {
                return RngUtils.zæœ€å¤§åˆ—(row);
            },
            
            /**
             * åˆ é™¤ç©ºç™½è¡Œ
             * @param {string} range - å•å…ƒæ ¼èŒƒå›´
             * @param {boolean} [entireRow=true] - æ˜¯å¦åˆ é™¤æ•´è¡Œ
             * @returns {boolean} æ˜¯å¦æˆåŠŸ
             * @example
             * JSA880.åˆ ç©ºè¡Œ("A1:F100");
             */
            åˆ ç©ºè¡Œ: function(range, entireRow) {
                RngUtils.zåˆ é™¤ç©ºç™½è¡Œ(range, entireRow !== false);
                return true;
            },
            
            /**
             * åˆ é™¤ç©ºç™½åˆ—
             * @param {string} range - å•å…ƒæ ¼èŒƒå›´
             * @param {boolean} [entireColumn=true] - æ˜¯å¦åˆ é™¤æ•´åˆ—
             * @returns {boolean} æ˜¯å¦æˆåŠŸ
             * @example
             * JSA880.åˆ ç©ºåˆ—("A1:Z100");
             */
            åˆ ç©ºåˆ—: function(range, entireColumn) {
                RngUtils.zåˆ é™¤ç©ºç™½åˆ—(range, entireColumn !== false);
                return true;
            },
            
            /**
             * å¤šåˆ—æ’åºï¼ˆç®€åŒ–ç‰ˆï¼‰
             * @param {Array} data - äºŒç»´æ•°ç»„
             * @param {string} sortParams - æ’åºå‚æ•°ï¼Œå¦‚ 'f3+,f4-'
             * @param {number} [headerRows=1] - æ ‡é¢˜è¡Œæ•°
             * @returns {Array} æ’åºåæ•°ç»„
             * @example
             * JSA880.æ’åº(æ•°æ®, 'f3+,f4-', 1);
             */
            æ’åº: function(data, sortParams, headerRows) {
                return new Array2D(data).zå¤šåˆ—æ’åº(sortParams, headerRows || 1);
            },
            
            /**
             * å»é‡
             * @param {Array} data - äºŒç»´æ•°ç»„
             * @param {number} [colIndex] - æŒ‡å®šåˆ—å»é‡
             * @returns {Array} å»é‡åæ•°ç»„
             * @example
             * JSA880.å»é‡(æ•°æ®);
             * JSA880.å»é‡(æ•°æ®, 0);  // æŒ‰ç¬¬1åˆ—å»é‡
             */
            å»é‡: function(data, colIndex) {
                return new Array2D(data).zå»é‡(colIndex).val();
            },
            
            /**
             * è½¬ç½®
             * @param {Array} data - äºŒç»´æ•°ç»„
             * @returns {Array} è½¬ç½®åæ•°ç»„
             * @example
             * JSA880.è½¬ç½®([[1,2],[3,4]]);  // è¿”å› [[1,3],[2,4]]
             */
            è½¬ç½®: function(data) {
                return new Array2D(data).zè½¬ç½®().val();
            },
            
            /**
             * æ•°ç»„æ±‚å’Œ
             * @param {Array} data - äºŒç»´æ•°ç»„
             * @param {string} [colSelector] - åˆ—é€‰æ‹©å™¨ï¼Œå¦‚ 'f1'
             * @returns {number} æ±‚å’Œç»“æœ
             * @example
             * JSA880.æ±‚å’Œ([[1,2],[3,4]]);        // 10
             * JSA880.æ±‚å’Œ([[1,2],[3,4]], 'f1');  // 4 (ç¬¬1åˆ—æ±‚å’Œ)
             */
            æ±‚å’Œ: function(data, colSelector) {
                return new Array2D(data).zæ±‚å’Œ(colSelector);
            },
            
            /**
             * æ·»åŠ è¾¹æ¡†ï¼ˆå¿«é€Ÿç‰ˆï¼‰
             * @param {string} range - å•å…ƒæ ¼èŒƒå›´
             * @param {number} [style=1] - çº¿æ¡æ ·å¼
             * @returns {boolean} æ˜¯å¦æˆåŠŸ
             * @example
             * JSA880.åŠ è¾¹æ¡†("A1:D10");
             */
            åŠ è¾¹æ¡†: function(range, style) {
                RngUtils.zåŠ è¾¹æ¡†(range, style || 1);
                return true;
            },
            
            /**
             * è‡ªåŠ¨åˆ—å®½ï¼ˆå¿«é€Ÿç‰ˆï¼‰
             * @param {string} range - å•å…ƒæ ¼èŒƒå›´
             * @returns {boolean} æ˜¯å¦æˆåŠŸ
             * @example
             * JSA880.è‡ªåŠ¨åˆ—å®½("A:Z");
             */
            è‡ªåŠ¨åˆ—å®½: function(range) {
                RngUtils.zè‡ªåŠ¨åˆ—å®½(range);
                return true;
            },
            
            /**
             * è‡ªåŠ¨è¡Œé«˜ï¼ˆå¿«é€Ÿç‰ˆï¼‰
             * @param {string} range - å•å…ƒæ ¼èŒƒå›´
             * @returns {boolean} æ˜¯å¦æˆåŠŸ
             * @example
             * JSA880.è‡ªåŠ¨è¡Œé«˜("1:100");
             */
            è‡ªåŠ¨è¡Œé«˜: function(range) {
                RngUtils.zè‡ªåŠ¨è¡Œé«˜(range);
                return true;
            },
            
            /**
             * å®‰å…¨è¯»å–å·²ä½¿ç”¨åŒºåŸŸ
             * @param {string} [sheetName] - å·¥ä½œè¡¨åç§°ï¼Œä¸ä¼ åˆ™ä½¿ç”¨å½“å‰è¡¨
             * @returns {Array} äºŒç»´æ•°ç»„
             * @example
             * JSA880.è¯»å·²ç”¨åŒº();              // å½“å‰è¡¨
             * JSA880.è¯»å·²ç”¨åŒº("Sheet1");      // æŒ‡å®šè¡¨
             */
            è¯»å·²ç”¨åŒº: function(sheetName) {
                if (!isWPS) return [];
                var sheet = sheetName ? Sheets(sheetName) : Application.ActiveSheet;
                var usedRange;
                try {
                    usedRange = sheet.UsedRange;
                } catch (e) {
                    return [];
                }
                if (!usedRange) return [];
                var arr = usedRange.Value2;
                if (arr === null || arr === undefined) return [];
                if (!Array.isArray(arr)) return [[arr]];
                if (!Array.isArray(arr[0])) {
                    var result = [];
                    for (var i = 0; i < arr.length; i++) {
                        result.push([arr[i]]);
                    }
                    return result;
                }
                return arr;
            },
            
            /**
             * ç”Ÿæˆæ•°å­—åºåˆ—
             * @param {number} start - èµ·å§‹æ•°å­—
             * @param {number} end - ç»“æŸæ•°å­—
             * @param {number} [step=1] - æ­¥é•¿
             * @returns {Array} åºåˆ—æ•°ç»„
             * @example
             * JSA880.åºåˆ—(1, 10);      // [1,2,3,4,5,6,7,8,9,10]
             * JSA880.åºåˆ—(1, 10, 2);  // [1,3,5,7,9]
             */
            åºåˆ—: function(start, end, step) {
                step = step || 1;
                var result = [];
                for (var i = start; i <= end; i += step) {
                    result.push(i);
                }
                return result;
            },
            
            /**
             * éšæœºæ‰“ä¹±æ•°ç»„
             * @param {Array} array - æ•°ç»„
             * @returns {Array} æ‰“ä¹±åçš„æ•°ç»„
             * @example
             * JSA880.æ‰“ä¹±([1,2,3,4,5]);
             */
            æ‰“ä¹±: function(array) {
                var result = array.slice();
                for (var i = result.length - 1; i > 0; i--) {
                    var j = Math.floor(Math.random() * (i + 1));
                    var temp = result[i];
                    result[i] = result[j];
                    result[j] = temp;
                }
                return result;
            },
            
            /**
             * éšæœºæ•´æ•°
             * @param {number} min - æœ€å°å€¼
             * @param {number} max - æœ€å¤§å€¼
             * @returns {number} éšæœºæ•´æ•°
             * @example
             * JSA880.éšæœº(1, 100);
             */
            éšæœº: function(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            },
            
            /**
             * åˆ›å»ºSuperMapï¼ˆå¯è§†åŒ–è°ƒè¯•å­—å…¸ï¼‰
             * @returns {SuperMap} SuperMapå®ä¾‹
             * @example
             * var map = JSA880.è¶…çº§å­—å…¸();
             * map.set('user1', {name: 'å¼ ä¸‰', age: 25});
             * map.debug(true); // å¼€å¯è°ƒè¯•æ¨¡å¼
             */
            è¶…çº§å­—å…¸: function() {
                return new SuperMap();
            },
            
            /**
             * ä»Mapåˆ›å»ºSuperMap
             * @param {Map} map - æ™®é€šMapå¯¹è±¡
             * @returns {SuperMap} SuperMapå®ä¾‹
             * @example
             * var nativeMap = new Map();
             * nativeMap.set('a', 1);
             * var superMap = JSA880.SuperMapä»Map(nativeMap);
             */
            SuperMapä»Map: function(map) {
                return SuperMap.fromMap(map);
            },
            
            /**
             * ä»å¯¹è±¡åˆ›å»ºSuperMap
             * @param {Object} obj - æ™®é€šå¯¹è±¡
             * @returns {SuperMap} SuperMapå®ä¾‹
             * @example
             * var superMap = JSA880.SuperMapä»å¯¹è±¡({a: 1, b: 2});
             */
            SuperMapä»å¯¹è±¡: function(obj) {
                return SuperMap.fromObject(obj);
            },
            
            /**
             * ä»æ•°ç»„åˆ›å»ºSuperMap
             * @param {Array} arr - äºŒç»´æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ ä¸º[key, value]
             * @returns {SuperMap} SuperMapå®ä¾‹
             * @example
             * var superMap = JSA880.SuperMapä»æ•°ç»„([['key1', 'value1'], ['key2', 'value2']]);
             */
            SuperMapä»æ•°ç»„: function(arr) {
                return SuperMap.fromArray(arr);
            },
            
            /**
             * æ—¥æœŸæ ¼å¼åŒ–
             * @param {Date|string} date - æ—¥æœŸ
             * @param {string} format - æ ¼å¼å­—ç¬¦ä¸²ï¼Œå¦‚ 'yyyy-MM-dd HH:mm:ss'
             * @returns {string} æ ¼å¼åŒ–åçš„æ—¥æœŸå­—ç¬¦ä¸²
             * @example
             * JSA880.æ—¥æœŸæ ¼å¼(new Date(), 'yyyy-MM-dd');
             */
            æ—¥æœŸæ ¼å¼: function(date, format) {
                date = typeof date === 'string' ? new Date(date) : date;
                var weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                return format.replace(/(y+|Y+)|(M+)|(d+|D+)|(H+)|(m+)|(s+|S+)|(SSS)|(a+)/g, function(match, year, month, day, hour, minute, second, millisecond, week) {
                    if (year) return date.getFullYear().toString().padStart(year.length, '0');
                    if (month) return (date.getMonth() + 1).toString().padStart(month.length, '0');
                    if (day) return date.getDate().toString().padStart(day.length, '0');
                    if (hour) return date.getHours().toString().padStart(hour.length, '0');
                    if (minute) return date.getMinutes().toString().padStart(minute.length, '0');
                    if (second) return date.getSeconds().toString().padStart(second.length, '0');
                    if (millisecond) return date.getMilliseconds().toString().padStart(3, '0');
                    if (week) return 'å‘¨' + weekDays[date.getDay()];
                    return match;
                });
            },
            
            /**
             * äººæ°‘å¸å¤§å†™
             * @param {number} n - æ•°å­—
             * @returns {string} äººæ°‘å¸å¤§å†™
             * @example
             * JSA880.äººæ°‘å¸å¤§å†™(12345.67);  // å£¹ä¸‡è´°ä»Ÿåä½°è‚†æ‹¾ä¼å…ƒé™†è§’æŸ’åˆ†
             */
            äººæ°‘å¸å¤§å†™: JSA.zäººæ°‘å¸å¤§å†™,
            
            /**
             * å­—ç¬¦ä¸²å…¨å±€æ›¿æ¢
             * @param {string} str - åŸå­—ç¬¦ä¸²
             * @param {string} search - æŸ¥æ‰¾å­—ç¬¦ä¸²
             * @param {string} replacement - æ›¿æ¢å­—ç¬¦ä¸²
             * @returns {string} æ›¿æ¢åçš„å­—ç¬¦ä¸²
             * @example
             * JSA880.æ›¿æ¢("hello world", "world", "JSA880");  // "hello JSA880"
             */
            æ›¿æ¢: function(str, search, replacement) {
                return str.split(search).join(replacement);
            },
            
            /**
             * æ•°ç»„æ‰å¹³åŒ–
             * @param {Array} arr - å¤šç»´æ•°ç»„
             * @returns {Array} ä¸€ç»´æ•°ç»„
             * @example
             * JSA880.æ‰å¹³åŒ–([[1,2],[3,4],[5,6]]);  // [1,2,3,4,5,6]
             */
            æ‰å¹³åŒ–: function(arr) {
                return new Array2D(arr).zæ‰å¹³åŒ–();
            },
            
            /**
             * åˆ—å·è½¬å­—æ¯ï¼ˆExcelåˆ—åï¼‰
             * @param {number} n - åˆ—å·ï¼ˆä»1å¼€å§‹ï¼‰
             * @returns {string} åˆ—å­—æ¯ï¼Œå¦‚ 1->A, 27->AA
             * @example
             * JSA880.åˆ—å·(1);   // "A"
             * JSA880.åˆ—å·(27);  // "AA"
             */
            åˆ—å·: function(n) {
                var result = '';
                while (n > 0) {
                    n--;
                    result = String.fromCharCode(65 + (n % 26)) + result;
                    n = Math.floor(n / 26);
                }
                return result;
            },
            
            /**
             * åˆ†ç»„æ±‡æ€»è¿æ¥ - ä¼˜åŒ–sumifså’ŒCountifsæ‰¹é‡æ¡ä»¶ç»Ÿè®¡
             * @param {Array} targetData - ç»Ÿè®¡ç›®æ ‡æ•°æ®ï¼ˆå·¦è¡¨ï¼‰
             * @param {Array} sourceData - æ•°æ®æºï¼ˆå³è¡¨ï¼‰
             * @param {string} groupKey - åˆ†ç»„é”®ï¼Œå¦‚ 'f2' æˆ– 'f2,f3'
             * @param {string} aggFunc - æ±‡æ€»å‡½æ•°ï¼Œå¦‚ 'sum("f4")' æˆ– 'count(),sum("f5")'
             * @returns {Array} è¿æ¥æ±‡æ€»åçš„ç»“æœ
             * @example
             * // ä¸€è¡Œä»£ç å®Œæˆsumifs/countifsæ‰¹é‡ç»Ÿè®¡ï¼ˆé«˜é¢‘åŠå…¬åœºæ™¯ä¼˜åŒ–ï¼‰
             * JSA880.åˆ†ç»„æ±‡æ€»è¿æ¥(ç›®æ ‡è¡¨, æºæ•°æ®è¡¨, 'f2', 'sum("f4")');
             * JSA880.åˆ†ç»„æ±‡æ€»è¿æ¥(ç›®æ ‡è¡¨, æºæ•°æ®è¡¨, 'æœˆä»½,äº§å“', 'count(),sum("é”€é‡"),average("é‡‘é¢")');
             * 
             * // å¯¹æ¯”ä¼ ç»Ÿæ–¹å¼ï¼šgroupInto + leftJoin éœ€è¦ä¸¤è¡Œä»£ç 
             * // JSA880.åˆ†ç»„æ±‡æ€»è¿æ¥ åªéœ€ä¸€è¡Œï¼Œé€Ÿåº¦æå‡100å€ï¼
             */
            åˆ†ç»„æ±‡æ€»è¿æ¥: function(targetData, sourceData, groupKey, aggFunc) {
                return Array2D.groupIntoJoin(targetData, sourceData, groupKey, aggFunc);
            },
            
            /**
             * åˆ—å­—æ¯è½¬åˆ—å·
             * @param {string} col - åˆ—å­—æ¯ï¼Œå¦‚ "A", "AA"
             * @returns {number} åˆ—å·ï¼ˆä»1å¼€å§‹ï¼‰
             * @example
             * JSA880.åˆ—å­—æ¯("A");   // 1
             * JSA880.åˆ—å­—æ¯("AA");  // 27
             */
            åˆ—å­—æ¯: function(col) {
                var result = 0;
                for (var i = 0; i < col.length; i++) {
                    result = result * 26 + (col.charCodeAt(i) - 64);
                }
                return result;
            }
        };

    }).call(this);

    // å¯¼å‡ºJSA880å¿«æ·å¯¹è±¡åˆ°å…¨å±€ï¼ˆWPSç¯å¢ƒï¼‰
    // JSA880 å’Œ SuperMap ç›´æ¥æˆä¸ºå…¨å±€å˜é‡ï¼Œä¸ Array2Dã€RngUtils ç­‰åŒçº§
    if (typeof Application !== 'undefined') {
        Application.JSA880 = this.JSA880;
        Application.SuperMap = SuperMap;
    }
}).call(this);

// ==================== JSA880.js æ–‡ä»¶ç»“æŸ ====================
// è¡Œæ•°ç»Ÿè®¡: 12870è¡Œ
// ç‰ˆæœ¬: WPSç°ä»£ç‰ˆ v3.8.2
// æœ€åæ›´æ–°: 2026-02-07
// ============================================================
